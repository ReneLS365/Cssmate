import{initMaterialsScrollLock}from"./src/modules/materialsscrolllock.js";import{calculateTotals}from"./src/modules/calculatetotals.js";import{normalizeKey}from"./src/lib/string-utils.js";import{EXCLUDED_MATERIAL_KEYS,shouldExcludeMaterialEntry}from"./src/lib/materials/exclusions.js";import{resolveKmInputValue}from"./src/lib/extras-helpers.js";import{createMaterialRow}from"./src/modules/materialrowtemplate.js";import{sha256Hex,constantTimeEquals}from"./src/lib/sha256.js";import{setupNumpad}from"./js/numpad.js";import{exportMeta,setSlaebFormulaText}from"./js/export-meta.js";import{buildAkkordData as buildSharedAkkordData}from"./js/akkord-data.js";import{createVirtualMaterialsList}from"./src/modules/materialsvirtuallist.js";import{initClickGuard}from"./src/ui/guards/clickguard.js";import{setAdminOk,restoreAdminState,isAdminUnlocked}from"./src/state/admin.js";import{setActiveJob}from"./src/state/jobs.js";import"./boot-inline.js";function getCurrentAppVersion(){return"undefined"!=typeof window&&"string"==typeof window.CSSMATE_APP_VERSION?window.CSSMATE_APP_VERSION:"undefined"!=typeof self&&"string"==typeof self.CSSMATE_APP_VERSION?self.CSSMATE_APP_VERSION:"dev"}function showUpdateBanner(e,t){if("undefined"==typeof document)return;if(document.getElementById("cssmate-update-banner"))return;const n=document.createElement("div");if(n.id="cssmate-update-banner",n.style.position="fixed",n.style.left="0",n.style.right="0",n.style.bottom="0",n.style.zIndex="9999",n.style.padding="8px 12px",n.style.fontSize="12px",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.background="#222",n.style.color="#fff",n.innerHTML=`\n    <span>Ny version af Cssmate er klar (fra ${t} til ${e}).</span>\n    <button type="button" id="cssmate-update-btn">Opdater nu</button>\n  `,!document.body)return;document.body.appendChild(n);const r=document.getElementById("cssmate-update-btn");r&&(r.style.marginLeft="12px",r.style.padding="4px 10px",r.style.fontSize="12px",r.style.cursor="pointer",r.addEventListener("click",(()=>{"undefined"!=typeof window&&("undefined"!=typeof navigator&&"serviceWorker"in navigator?navigator.serviceWorker.getRegistrations().then((e=>Promise.all(e.map((e=>e.update()))))).finally((()=>{window.location.reload(!0)})):window.location.reload(!0))})))}function runWhenIdle(e){"function"!=typeof requestIdleCallback?setTimeout(e,150):requestIdleCallback(e,{timeout:1500})}async function ensureExportPanelModule(){return exportPanelPromise||(exportPanelPromise=import("./js/akkord-export-ui.js").then((e=>("function"==typeof e?.initExportPanel&&e.initExportPanel(),exportPanelReady=!0,e))).catch((e=>{throw exportPanelPromise=null,e})),exportPanelPromise)}function bindLazyExportAction(e,t){const n="undefined"!=typeof document?document.getElementById(e):null;n&&n.addEventListener("click",(async e=>{if(!exportPanelReady){e.preventDefault(),e.stopImmediatePropagation();try{const n=await ensureExportPanelModule(),r=n?.[t];"function"==typeof r&&r(e)}catch(e){console.error("Eksport-panel kunne ikke indlæses",e),updateActionHint("Kunne ikke indlæse eksport-funktionerne. Prøv igen.","error")}}}),{capture:!0})}function setupLazyExportPanelTriggers(){if("undefined"==typeof document)return;const e=document.querySelector(".export-panel");if(!e)return;const t=()=>{ensureExportPanelModule().catch((e=>{console.warn("Kunne ikke forberede eksportpanelet",e)}))};["pointerenter","touchstart","focusin"].forEach((n=>{e.addEventListener(n,t,{once:!0})})),bindLazyExportAction("btn-export-akkord-pdf","handleExportAkkordPDF"),bindLazyExportAction("btn-export-akkord-zip","handleExportAkkordZIP"),bindLazyExportAction("btn-export-akkord-json","handleExportAkkordJSON"),bindLazyExportAction("btn-import-akkord","handleImportAkkordAction"),bindLazyExportAction("btn-print-akkord","handlePrintAkkord")}async function ensureExportLibsLazy(){return exportLibsLoader||(exportLibsLoader=import("./src/features/export/lazy-libs.js").then((e=>e.ensureExportLibs()))),exportLibsLoader}async function ensureZipLibLazy(){return zipLibLoader||(zipLibLoader=import("./src/features/export/lazy-libs.js").then((e=>e.ensureZipLib()))),zipLibLoader}async function loadExcelExporter(){return excelExporterLoader||(excelExporterLoader=import("./src/export/akkord-excel.js").then((e=>e.exportAkkordExcelForActiveJob))),excelExporterLoader}!function(){if("undefined"==typeof window)return;const e=getCurrentAppVersion(),t="cssmate_app_version";try{const n=window.localStorage;if(!n)return;const r=n.getItem(t);r&&r!==e&&showUpdateBanner(e,r),n.setItem(t,e)}catch(e){console.warn("Unable to access localStorage for version check",e)}}();const IOS_INSTALL_PROMPT_DISMISSED_KEY="csmate.iosInstallPromptDismissed",TAB_STORAGE_KEY="csmate:lastTab",LEGACY_TAB_STORAGE_KEYS=["sscaff:lastTab","cssmate:lastActiveTab"],KNOWN_TAB_ID_ORDER=["sagsinfo","optaelling","lon","historik","hjaelp"],KNOWN_TAB_IDS=new Set(KNOWN_TAB_ID_ORDER),DEFAULT_TAB_ID=KNOWN_TAB_ID_ORDER[0],INSTALL_BUTTON_DISABLED_TOOLTIP="Tilføj via browsermenu på denne platform",PWA_INSTALL_AVAILABLE_EVENT="csmate:pwa-install-available",PWA_INSTALL_CONSUMED_EVENT="csmate:pwa-install-consumed";let DEFAULT_ADMIN_CODE_HASH="",materialsVirtualListController=null,currentTabId=null,exportPanelReady=!1,exportPanelPromise=null,exportLibsLoader=null,zipLibLoader=null,excelExporterLoader=null,tabButtons=[],tabPanels=[];const domCache=new Map;let deferredInstallPromptEvent=null,historyPersistencePaused=!1;function setDeferredInstallPromptEvent(e){if(deferredInstallPromptEvent=e,"undefined"==typeof window||"function"!=typeof window.dispatchEvent)return;const t=e?PWA_INSTALL_AVAILABLE_EVENT:PWA_INSTALL_CONSUMED_EVENT;window.dispatchEvent(new Event(t))}function getDeferredInstallPromptEvent(){return deferredInstallPromptEvent}function consumeDeferredInstallPromptEvent(){const e=deferredInstallPromptEvent;return e&&setDeferredInstallPromptEvent(null),e}function pauseHistoryPersistence(){historyPersistencePaused=!0}function resumeHistoryPersistence(){historyPersistencePaused=!1}function isKnownTabId(e){return"string"==typeof e&&KNOWN_TAB_IDS.has(e)}function getDomElement(e){if(!e||"undefined"==typeof document||"function"!=typeof document.getElementById)return null;const t=domCache.get(e);if(t&&t.isConnected)return t;const n=document.getElementById(e);return n?domCache.set(e,n):domCache.delete(e),n}"undefined"!=typeof window&&(window.addEventListener("beforeinstallprompt",(e=>{e.preventDefault(),setDeferredInstallPromptEvent(e)})),window.addEventListener("appinstalled",(()=>{setDeferredInstallPromptEvent(null)})));const KNOWN_ADMIN_CODE_HASHES=new Set(["ff0a69fa196820f9529e3c20cfa809545e6697f5796527f7657a83bb7e6acd0d"]),KNOWN_ADMIN_CODES=new Set(["StilAce"]);async function loadDefaultAdminCode(){try{const e=await fetch("./data/tenants/hulmose.json");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();t&&"string"==typeof t._meta?.admin_code&&(DEFAULT_ADMIN_CODE_HASH=t._meta.admin_code,KNOWN_ADMIN_CODE_HASHES.add(DEFAULT_ADMIN_CODE_HASH))}catch(e){console.warn("Kunne ikke indlæse standard admin-kode",e)}}loadDefaultAdminCode();let admin=restoreAdminState();function updateSlaebFormulaInfo(e){const t=document.getElementById("slaebPercentCalcInfo");if(!t)return;const n="string"==typeof e?e.trim():"";t.textContent=n?`Formel (A9): ${n}`:""}"undefined"!=typeof document&&initClickGuard();let guideModalLastFocus=null,guideModalEscapeHandler=null;function getGuideModalElement(){return document.getElementById("guideModal")}function attachGuideModalEscapeHandler(){guideModalEscapeHandler||"undefined"==typeof document||(guideModalEscapeHandler=e=>{"Escape"===e.key&&isGuideModalOpen()&&(e.preventDefault(),closeGuideModal())},document.addEventListener("keydown",guideModalEscapeHandler))}function detachGuideModalEscapeHandler(){guideModalEscapeHandler&&"undefined"!=typeof document&&(document.removeEventListener("keydown",guideModalEscapeHandler),guideModalEscapeHandler=null)}function openGuideModal(){const e=getGuideModalElement();if(!e)return;guideModalLastFocus=document.activeElement instanceof HTMLElement?document.activeElement:null,e.removeAttribute("hidden"),e.dataset.open="true",e.classList.add("open"),e.setAttribute("aria-hidden","false");const t=e.querySelector(".modal-content");t&&"function"==typeof t.focus&&t.focus(),attachGuideModalEscapeHandler()}function closeGuideModal(){const e=getGuideModalElement();if(!e)return;e.classList.remove("open"),e.removeAttribute("data-open"),e.setAttribute("aria-hidden","true"),e.setAttribute("hidden",""),detachGuideModalEscapeHandler();const t=guideModalLastFocus;guideModalLastFocus=null,t&&document.contains(t)&&"function"==typeof t.focus&&t.focus()}function isGuideModalOpen(){const e=getGuideModalElement();return Boolean(e&&"true"===e.dataset.open)}function setupGuideModal(){const e=getGuideModalElement();if(!e)return;const t=e.querySelector(".modal-close");t&&t.addEventListener("click",(()=>closeGuideModal())),e.addEventListener("click",(t=>{t.target===e&&closeGuideModal()})),document.getElementById("btnOpenGuideModal")?.addEventListener("click",(()=>{openGuideModal()}))}function setupAdminControls(){const e=document.getElementById("btnHardResetApp");if(!e)return;const t=t=>{t?(e.removeAttribute("hidden"),e.disabled=!1):(e.setAttribute("hidden",""),e.disabled=!0)};t(isAdminUnlocked()),document.addEventListener("csmate:admin-change",(e=>{t(Boolean(e?.detail?.unlocked))}))}function getStoredTabId(){try{const e=window.localStorage;if(!e)return"";const t=e.getItem(TAB_STORAGE_KEY);if(isKnownTabId(t))return t;for(const t of LEGACY_TAB_STORAGE_KEYS){const n=e.getItem(t);if(isKnownTabId(n))return n}}catch{}return""}function focusTabByIndex(e){if(!ensureTabCollections())return;const t=(e+tabButtons.length)%tabButtons.length,n=tabButtons[t];n&&setActiveTab(n.dataset.tabId,{focus:!0})}function handleTabKeydown(e,t){const n=e.key;if("ArrowRight"!==n&&"ArrowLeft"!==n){if("Home"===n)return e.preventDefault(),void focusTabByIndex(0);if("End"===n)return e.preventDefault(),void focusTabByIndex(tabButtons.length-1);if(" "===n||"Enter"===n){e.preventDefault();const n=tabButtons[t];n&&setActiveTab(n.dataset.tabId,{focus:!0})}}else{e.preventDefault();focusTabByIndex(t+("ArrowRight"===n?1:-1))}}function refreshTabCollections(){if("undefined"==typeof document)return tabButtons=[],void(tabPanels=[]);tabButtons=Array.from(document.querySelectorAll('[role="tab"][data-tab-id]')).filter((e=>isKnownTabId(e.dataset.tabId))),tabPanels=Array.from(document.querySelectorAll('[role="tabpanel"][data-tab-panel]')).filter((e=>isKnownTabId(e.dataset.tabPanel)))}function ensureTabCollections(){return tabButtons.length&&tabPanels.length||refreshTabCollections(),tabButtons.length&&tabPanels.length}function findFirstAvailableTabId(){const e=KNOWN_TAB_ID_ORDER.find((e=>tabButtons.some((t=>t.dataset.tabId===e))));return e||(tabButtons[0]?.dataset.tabId||DEFAULT_TAB_ID)}function setActiveTab(e,{focus:t=!1}={}){if(!ensureTabCollections())return;const n=isKnownTabId(e)?e:DEFAULT_TAB_ID,r=tabButtons.find((e=>e.dataset.tabId===n))||tabButtons.find((e=>e.dataset.tabId===DEFAULT_TAB_ID))||tabButtons[0];if(!r)return void console.warn("Faneknap ikke fundet for id",e);const a=r.dataset.tabId;if(!a)return void console.warn("Faneknap mangler data-tab-id",r);const o=tabPanels.find((e=>e.dataset.tabPanel===a));if(o)if(currentTabId!==a){tabButtons.forEach((e=>{const t=e===r;e.classList.toggle("tab--active",t),e.setAttribute("aria-selected",t?"true":"false"),e.tabIndex=t?0:-1})),tabPanels.forEach((e=>{const t=e===o;e.classList.toggle("tab-panel--active",t),t?(e.removeAttribute("hidden"),e.setAttribute("aria-hidden","false")):(e.setAttribute("hidden",""),e.setAttribute("aria-hidden","true"))})),currentTabId=a;try{const e=window.localStorage;e&&isKnownTabId(a)&&(e.setItem(TAB_STORAGE_KEY,a),LEGACY_TAB_STORAGE_KEYS.forEach((t=>{try{e.setItem(t,a)}catch{}})))}catch{}t&&"function"==typeof r.focus&&r.focus()}else t&&"function"==typeof r.focus&&r.focus();else console.warn("Tab-panel ikke fundet for id",a)}function initTabs(){if(refreshTabCollections(),!tabButtons.length||!tabPanels.length)return void console.warn("Faner kunne ikke initialiseres – mangler markup");tabButtons.forEach(((e,t)=>{const n=e.dataset.tabId,r="true"===e.getAttribute("aria-selected");e.tabIndex=r?0:-1,e.addEventListener("click",(()=>setActiveTab(n))),e.addEventListener("keydown",(e=>handleTabKeydown(e,t)))}));const e=getStoredTabId();setActiveTab(tabButtons.some((t=>t.dataset.tabId===e))?e:tabButtons.find((e=>"true"===e.getAttribute("aria-selected")))?.dataset.tabId||findFirstAvailableTabId(),{focus:!1}),"undefined"!=typeof window&&(window.__cssmateSetActiveTab=(e,t)=>setActiveTab(e,t))}function setupA9Integration(){const e=document.querySelector('input[data-a9-slaeb="true"]'),t=document.querySelector(".js-slaeb-calc-link");if(t){const e=t.dataset.calcUrl||"https://cala9.netlify.app/";t.addEventListener("click",(t=>{t&&(t.preventDefault(),t.stopPropagation()),window.open(e,"_blank","noopener,noreferrer")}))}if(!e)return;e.addEventListener("a9-commit",(e=>{const t="string"==typeof e?.detail?.formulaText?e.detail.formulaText:"";setSlaebFormulaText(t),updateSlaebFormulaInfo(t)}));const n=()=>{if("1"===e.dataset.a9Commit)return;setSlaebFormulaText("");const t=e.value?.trim();updateSlaebFormulaInfo(t?`Manuel værdi: ${t}`:"")};e.addEventListener("input",n),e.addEventListener("change",n),updateSlaebFormulaInfo(exportMeta.slaebFormulaText)}function formatCurrency(e){return new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0)}function toNumber(e){if("number"==typeof e)return Number.isFinite(e)?e:0;if(null==e)return 0;const t=String(e).trim();if(!t)return 0;const n=t.replace(/\s+/g,"").replace(/'/g,""),r=n.match(/[.,]/g)||[];let a=n.replace(/[^0-9.,-]/g,"");if(r.length>1){const e=r[r.length-1],t=a.lastIndexOf(e),n=a.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=a.slice(t+1).replace(/[^0-9]/g,"");a=`${n||"0"}.${o}`}else if(1===r.length)if(/^-?\d{1,3}(?:[.,]\d{3})+$/.test(a))a=a.replace(/[.,]/g,"").replace(/(?!^)-/g,"");else{const e=r[0],t=a.lastIndexOf(e),n=a.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=a.slice(t+1).replace(/[^0-9]/g,"");a=`${n||"0"}.${o}`}else a=a.replace(/(?!^)-/g,"");const o=Number.parseFloat(a);return Number.isFinite(o)?o:0}function formatNumber(e){const t=Number.isFinite(e)?e:parseFloat(e)||0;return new Intl.NumberFormat("da-DK",{minimumFractionDigits:0,maximumFractionDigits:2}).format(t)}let workerCount=0,laborEntries=[],lastLoensum=0,lastMaterialSum=0,lastEkompletData=null,lastJobSummary=null,recentCasesCache=[];function syncRecentProjectsGlobal(e=recentCasesCache){if("undefined"==typeof window)return;const t=Array.isArray(e)?e.slice():[];window.__cssmateRecentProjects=t}syncRecentProjectsGlobal([]);let cachedDBPromise=null;const DEFAULT_ACTION_HINT="Udfyld Sagsinfo for at fortsætte.",DB_NAME="csmate_projects",DB_STORE="projects",TRAELLE_RATE35=10.44,TRAELLE_RATE50=14.62,BORING_HULLER_RATE=4.7,LUK_HULLER_RATE=3.45,BORING_BETON_RATE=11.49,OPSKYDELIGT_RATE=9.67,KM_RATE=2.12,TILLAEG_UDD1=42.98,TILLAEG_UDD2=49.38,DEFAULT_MENTOR_RATE=22.26,AKKORD_EXCEL_SYSTEMS=[{id:"bosta",label:"BOSTA 2025"},{id:"haki",label:"HAKI 2025"},{id:"modex",label:"MODEX 2025"},{id:"alfix",label:"ALFIX 2025"}],AKKORD_EXCEL_STORAGE_KEY="csmate.akkordExcelSystem";let systemDatasets={},dataBosta=[],dataHaki=[],dataModex=[],dataAlfix=[],systemOptions=[],systemLabelMap=new Map;const selectedSystemKeys=new Set;let excelSystemSelectionCache=new Set(["bosta"]),datasetModulePromise=null,materialsReady=!1,showOnlySelectedMaterials=!1,lastRenderShowSelected=null,lonOutputsRevealed=!1;function loadMaterialDatasetModule(){return datasetModulePromise||(datasetModulePromise=import("./dataset.js")),datasetModulePromise}function createSystemMaterialState(e){return e&&Array.isArray(e.items)?e.items.filter((e=>{const t="string"==typeof e?.category?e.category.toLowerCase():"material";if(t&&"material"!==t&&"materiale"!==t)return!1;const n=normalizeKey(String(e?.name||e?.navn||e?.beskrivelse||"").trim());return n&&!EXCLUDED_MATERIAL_KEYS.includes(n)})).map(((t,n)=>{const r=t?.name||t?.navn||t?.beskrivelse||"",a=r?.trim()||`${e.id} materiale ${n+1}`;return{id:t?.id||t?.varenr||`${e.id}-${n+1}`,name:a,price:toNumber(t?.price??t?.pris??0),unit:t?.unit||t?.enhed||"",quantity:0,systemKey:e.id,category:"string"==typeof t?.category?t.category.toLowerCase():"material"}})):[]}async function ensureMaterialDatasets(){if(systemOptions.length)return systemOptions;const e=await loadMaterialDatasetModule(),t="function"==typeof e.getAllSystems?e.getAllSystems():[];systemDatasets={},t.forEach((e=>{systemDatasets[e.id]=createSystemMaterialState(e)})),dataBosta=systemDatasets.bosta??[],dataHaki=systemDatasets.haki??[],dataModex=systemDatasets.modex??[],dataAlfix=systemDatasets.alfix??[],systemOptions=t.map((e=>({key:e.id,label:e.label,dataset:systemDatasets[e.id]??[]})));const n=Object.keys(e.MATERIAL_SYSTEMS||{}).map((t=>{const n="function"==typeof e.getSystemList?e.getSystemList(t):null;return[t,n?.label??t]}));return systemLabelMap=new Map(n),materialsReady=!0,ensureSystemSelection(),systemOptions}function ensureSystemSelection(){0===selectedSystemKeys.size&&systemOptions.length&&selectedSystemKeys.add(systemOptions[0].key)}function getSelectedSystemKeys(){return ensureSystemSelection(),Array.from(selectedSystemKeys)}function isSupportedExcelSystem(e){return!!e&&AKKORD_EXCEL_SYSTEMS.some((t=>t.id===e))}function normalizeExcelSystemId(e){return"string"==typeof e?e.trim().toLowerCase():""}function sanitizeExcelSystemSelection(e){const t=Array.isArray(e)?e:"string"==typeof e?[e]:e&&"function"==typeof e[Symbol.iterator]?Array.from(e):[],n=[];return t.forEach((e=>{const t=normalizeExcelSystemId(e);isSupportedExcelSystem(t)&&!n.includes(t)&&n.push(t)})),n}function getStoredExcelSystems(){if("undefined"==typeof localStorage)return Array.from(excelSystemSelectionCache);try{const e=localStorage.getItem(AKKORD_EXCEL_STORAGE_KEY);if(null===e)return Array.from(excelSystemSelectionCache);let t=[];try{t=JSON.parse(e)}catch{t=e?[e]:[]}const n=sanitizeExcelSystemSelection(t);return excelSystemSelectionCache=new Set(n),n}catch(e){return console.warn("Kunne ikke læse Excel-systemer fra storage",e),Array.from(excelSystemSelectionCache)}}function setStoredExcelSystems(e){const t=sanitizeExcelSystemSelection(e);if(excelSystemSelectionCache=new Set(t),"undefined"!=typeof localStorage)try{localStorage.setItem(AKKORD_EXCEL_STORAGE_KEY,JSON.stringify(t))}catch(e){console.warn("Kunne ikke gemme Excel-systemer",e)}}function getPreferredExcelSystem(){const e=getStoredExcelSystems();if(e.length>0&&isSupportedExcelSystem(e[0]))return e[0];const t=getSelectedSystemKeys().find((e=>isSupportedExcelSystem(e)));return t||(AKKORD_EXCEL_SYSTEMS[0]?.id||"bosta")}function getDatasetForSelectedSystems(e){const t=[],n=(Array.isArray(e)?e:e&&"function"==typeof e[Symbol.iterator]?Array.from(e):[]).map((e=>normalizeKey(e))),r=new Set(n),a=(e,n)=>{if(!Array.isArray(n))return;e.some((e=>r.has(normalizeKey(e))))&&t.push(n)};return a(["bosta","bostadata"],dataBosta),a(["haki","hakidata"],dataHaki),a(["modex","modexdata"],dataModex),a(["alfix","alfixdata"],dataAlfix),t.flat()}function toggleDuplicateWarning(e=[],t=[]){const n=document.getElementById("systemDuplicateWarning");if(!n)return;const r=Array.from(new Set(e.filter(Boolean))).slice(0,6),a=Array.from(new Set(t.filter(Boolean))).slice(0,6);if(0===r.length&&0===a.length)return n.textContent="",void n.setAttribute("hidden","");const o=[];r.length&&o.push(`Materialer slået sammen: ${r.join(", ")}`),a.length&&o.push(`Kontroller varenr.: ${a.join(", ")}`),n.textContent=o.join(". "),n.removeAttribute("hidden")}function aggregateSelectedSystemData(){const e=getDatasetForSelectedSystems(getSelectedSystemKeys()),t=[],n=new Map,r=new Map,a=new Set,o=new Set;return e.forEach((e=>{if(!e)return;const s=null!=e.id?String(e.id):null,i=e.name?normalizeKey(e.name):null,l=i?`${e.systemKey||"global"}::${i}`:null,d=l?r.get(l):null;if(d&&d!==e)return a.add(d.name),void a.add(e.name);const u=s?n.get(s):null;if(u&&u!==e){const t=u.name?normalizeKey(u.name):null;if(t&&i&&t===i)return a.add(u.name),void a.add(e.name);o.add(u.name),o.add(e.name)}t.push(e),s&&n.set(s,e),l&&r.set(l,e)})),toggleDuplicateWarning(Array.from(a),Array.from(o)),t}const manualMaterials=Array.from({length:3},((e,t)=>({id:`manual-${t+1}`,name:"",price:0,quantity:0,manual:!0})));function getAllData(e=!0){const t=aggregateSelectedSystemData();return e?t.concat(manualMaterials):t}function getActiveMaterialList(){return aggregateSelectedSystemData()}function getRenderMaterials(){const e=getActiveMaterialList(),t=Array.isArray(e)?e.concat(manualMaterials):manualMaterials.slice();return showOnlySelectedMaterials?t.filter((e=>toNumber(e?.quantity)>0)):t}function findMaterialById(e){const t=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const n of t){const t=n.find((t=>String(t.id)===String(e)));if(t)return t}return null}function setupListSelectors(){const e=getDomElement("listSelectors");if(!e)return;const t="systemSelectionWarning",n=systemOptions.map((e=>{const t=selectedSystemKeys.has(e.key)?"checked":"";return`\n        <label class="system-option">\n          <input type="checkbox" value="${e.key}" ${t}>\n          <span>${e.label}</span>\n        </label>\n      `})).join("");e.innerHTML=`\n    <div class="system-selector" role="group" aria-labelledby="systemSelectorLabel">\n      <span id="systemSelectorLabel" class="cell-label">Systemer</span>\n      <div class="system-selector-options">${n}</div>\n    </div>\n    <p id="${t}" class="hint system-warning" hidden>Vælg mindst ét system.</p>\n    <p id="systemDuplicateWarning" class="hint system-warning" hidden></p>\n  `,syncSystemSelectorState();const r=document.getElementById(t);e.addEventListener("change",(e=>{const t=e.target;if(!(t instanceof HTMLInputElement)||"checkbox"!==t.type)return;const{value:n}=t;if(t.checked)selectedSystemKeys.add(n);else if(selectedSystemKeys.delete(n),0===selectedSystemKeys.size)return r?.removeAttribute("hidden"),selectedSystemKeys.add(n),t.checked=!0,void updateActionHint("Vælg mindst ét system for at fortsætte optællingen.","error");r?.setAttribute("hidden","");const a=getDomElement("actionHint");a&&"Vælg mindst ét system for at fortsætte optællingen."===a.textContent&&updateActionHint(""),renderOptaelling(),updateTotals(!0)}))}function syncSystemSelectorState(){const e=getDomElement("listSelectors");e&&e.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=selectedSystemKeys.has(e.value)}))}function renderOptaelling(){const e=getDomElement("optaellingContainer");if(!e)return;const t=document.getElementById("showSelectedOnly");t&&(t.checked=showOnlySelectedMaterials,t.onchange=()=>{showOnlySelectedMaterials=t.checked,lastRenderShowSelected=null,renderOptaelling()});const n=t=>{e.textContent="";const n=document.createElement("p");n.className="empty-state",n.textContent=t,e.appendChild(n),materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null)};if(!materialsReady)return void n("Indlæser materialelister...");syncSystemSelectorState();const r=getActiveMaterialList(),a=Array.isArray(r)?r.concat(manualMaterials):manualMaterials.slice(),o=getRenderMaterials();if(!a.length)return void n("Ingen systemer valgt. Vælg et eller flere systemer for at starte optællingen.");if(!o.length)return void n("Ingen materialer med antal.");e.querySelectorAll(".empty-state").forEach((e=>e.remove()));let s=e.querySelector(".materials-list");s||(e.textContent="",s=document.createElement("div"),s.className="materials-list csm-materials-list",e.appendChild(s)),s.classList.add("csm-materials-list");const i=(e,t)=>{const n=createMaterialRow(e,{admin:admin,toNumber:toNumber,formatCurrency:formatCurrency,systemLabelMap:systemLabelMap}),r=n?.row||n;return r&&(r.dataset.index=String(t)),n};if(lastRenderShowSelected!==showOnlySelectedMaterials&&materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null),lastRenderShowSelected=showOnlySelectedMaterials,materialsVirtualListController&&materialsVirtualListController.container===s)materialsVirtualListController.controller.update(o);else{const e=createVirtualMaterialsList({container:s,items:o,renderRow:i,rowHeight:64,overscan:8});materialsVirtualListController={container:s,controller:e}}initMaterialsScrollLock(e),updateTotals(!0)}function handleOptaellingInput(e){const t=e.target;t&&t.classList&&(t.classList.contains("qty")?handleQuantityChange(e):t.classList.contains("price")?handlePriceChange(e):t.classList.contains("manual-name")&&handleManualNameChange(e))}function handleQuantityChange(e){const{id:t}=e.target.dataset;updateQty(t,e.target.value)}function handlePriceChange(e){const{id:t}=e.target.dataset;updatePrice(t,e.target.value)}function handleManualNameChange(e){const{id:t}=e.target.dataset,n=findMaterialById(t);n&&n.manual&&(n.name=e.target.value)}function findMaterialRowElement(e){const t=document.querySelectorAll(".material-row");return Array.from(t).find((t=>Array.from(t.querySelectorAll("input[data-id]")).some((t=>t.dataset.id===String(e)))))||null}function updateQty(e,t){const n=findMaterialById(e);if(!n)return;const r=toNumber(n.quantity),a=toNumber(t);if(n.quantity=a,refreshMaterialRowDisplay(e),updateTotals(),showOnlySelectedMaterials){r>0!==a>0&&renderOptaelling()}}function updatePrice(e,t){const n=findMaterialById(e);n&&(n.manual||admin)&&(n.price=toNumber(t),refreshMaterialRowDisplay(e),updateTotals())}function refreshMaterialRowDisplay(e){const t=findMaterialById(e);if(!t)return;const n=findMaterialRowElement(e);if(!n)return;const r=n.querySelector("input.qty");if(r&&document.activeElement!==r)if(t.manual){const e=null!==t.quantity&&void 0!==t.quantity&&""!==t.quantity;r.value=e?String(t.quantity):""}else{const e=null!=t.quantity?t.quantity:0;r.value=String(e)}const a=n.querySelector("input.price");if(a&&document.activeElement!==a){const e=null!==t.price&&void 0!==t.price&&""!==t.price,n=e?toNumber(t.price):"";if(t.manual)a.value=e?String(n):"",a.readOnly=!1;else{const e=toNumber(t.price);a.value=Number.isFinite(e)?e.toFixed(2):"0.00",a.readOnly=!admin}a.dataset.price=e?String(n):""}const o=n.querySelector(".mat-line");if(o)if("undefined"!=typeof window&&"function"==typeof window.updateMaterialLine)window.updateMaterialLine(n,{formatPrice:!0,shouldUpdateTotals:!1});else{const e=`${formatCurrency(toNumber(t.price)*toNumber(t.quantity))} kr`;o instanceof HTMLInputElement?o.value=e:o.textContent=e}}function calcMaterialesum(){return getAllData().reduce(((e,t)=>e+toNumber(t.price)*toNumber(t.quantity)),0)}function renderCurrency(e,t){let n=[];if("string"==typeof e?n=Array.from(document.querySelectorAll(e)):e instanceof Element?n=[e]:e&&"number"==typeof e.length&&(n=Array.from(e)),0===n.length)return;const r=`${formatCurrency(t)} kr`;n.forEach((e=>{e.textContent=r}))}let totalsUpdateTimer=null;function computeTraelleTotals(){const e=toNumber(document.getElementById("traelleloeft35")?.value),t=toNumber(document.getElementById("traelleloeft50")?.value),n={n35:e,n50:t,RATE35:10.44,RATE50:14.62,sum:10.44*e+14.62*t};return"undefined"!=typeof window&&(window.__traelleloeft=n),n}function performTotalsUpdate(){const e=computeTraelleTotals(),t=e&&Number.isFinite(e.sum)?e.sum:0,n="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,r=getAllData().map((e=>({qty:toNumber(e?.quantity),unitPrice:toNumber(e?.price)*n}))),a=calcMaterialesum()+t,o=toNumber(document.getElementById("slaebePct")?.value),s=a*(Number.isFinite(o)?o/100:0),i={"tralleløft":t,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},l=Array.isArray(laborEntries)?laborEntries.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)}))):[],d=l.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),u=calculateTotals({materialLines:r,slaebeBelob:s,extra:i,workers:l,totalHours:d});lastMaterialSum=u.samletAkkordsum,lastLoensum=u.montoerLonMedTillaeg,renderCurrency('[data-total="material"]',u.samletAkkordsum),renderCurrency('[data-total="labor"]',u.montoerLonMedTillaeg),renderCurrency('[data-total="project"]',u.projektsum);const c=document.getElementById("montagepris");c&&(c.value=a.toFixed(2));const m=document.getElementById("demontagepris");m&&(m.value=(.5*a).toFixed(2))}function updateTotals(e={}){if(!0===e||e?.immediate)return totalsUpdateTimer&&(clearTimeout(totalsUpdateTimer),totalsUpdateTimer=null),void performTotalsUpdate();totalsUpdateTimer&&clearTimeout(totalsUpdateTimer),totalsUpdateTimer=setTimeout((()=>{totalsUpdateTimer=null,performTotalsUpdate()}),80)}function updateTotal(){updateTotals()}const sagsinfoFieldIds=["sagsnummer","sagsnavn","sagsadresse","sagskunde","sagsdato","sagsmontoer"];function collectSagsinfo(){const e=e=>getDomElement(e)?.value??"";return{sagsnummer:e("sagsnummer").trim(),navn:e("sagsnavn").trim(),adresse:e("sagsadresse").trim(),kunde:e("sagskunde").trim(),dato:e("sagsdato"),montoer:e("sagsmontoer").trim()}}function setSagsinfoField(e,t){const n=getDomElement(e);n&&(n.value=t)}function updateActionHint(e="",t="info"){const n=getDomElement("actionHint");if(n){if(n.classList.remove("error","success"),!e)return n.textContent=DEFAULT_ACTION_HINT,void(n.style.display="none");n.textContent=e,"error"===t?n.classList.add("error"):"success"===t&&n.classList.add("success"),n.style.display=""}}function promisifyRequest(e){return e?new Promise(((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)})):Promise.resolve(void 0)}function openDB(){return cachedDBPromise||("undefined"==typeof indexedDB?(cachedDBPromise=Promise.reject(new Error("IndexedDB er ikke tilgængelig")),cachedDBPromise.catch((()=>{})),cachedDBPromise):(cachedDBPromise=new Promise(((e,t)=>{const n=indexedDB.open(DB_NAME,1);n.onupgradeneeded=e=>{const t=e.target?.result;t&&!t.objectStoreNames.contains(DB_STORE)&&t.createObjectStore(DB_STORE,{keyPath:"id",autoIncrement:!0})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error||new Error("IndexedDB kunne ikke åbnes"))})),cachedDBPromise.catch((()=>{cachedDBPromise=null})),cachedDBPromise))}async function saveProject(e){if(e)try{const t=await openDB();if(!t)return;const n=t.transaction(DB_STORE,"readwrite"),r=new Promise(((e,t)=>{n.oncomplete=()=>e(),n.onabort=()=>t(n.error||new Error("Transaktionen blev afbrudt")),n.onerror=()=>t(n.error||new Error("Transaktionen fejlede"))})),a=n.objectStore(DB_STORE);await promisifyRequest(a.add({data:e,ts:Date.now()}));const o=await promisifyRequest(a.getAll());if(Array.isArray(o)&&o.length>20){o.sort(((e,t)=>(e.ts||0)-(t.ts||0)));const e=o.length-20;for(let t=0;t<e;t+=1){const e=o[t];e&&null!=e.id&&await promisifyRequest(a.delete(e.id))}}await r}catch(e){console.warn("Kunne ikke gemme sag lokalt",e)}}async function deleteProjectById(e){if(!Number.isFinite(e)||e<=0)return!1;try{const t=await openDB();if(!t)return!1;const n=t.transaction(DB_STORE,"readwrite"),r=new Promise(((e,t)=>{n.oncomplete=()=>e(!0),n.onabort=()=>t(n.error||new Error("Transaktionen blev afbrudt")),n.onerror=()=>t(n.error||new Error("Transaktionen fejlede"))}));return n.objectStore(DB_STORE).delete(Number(e)),await r,!0}catch(e){return console.warn("Kunne ikke slette sag",e),!1}}async function getRecentProjects(){try{const e=await openDB();if(!e)return[];const t=e.transaction(DB_STORE,"readonly"),n=new Promise(((e,n)=>{t.oncomplete=()=>e(),t.onabort=()=>n(t.error||new Error("Transaktionen blev afbrudt")),t.onerror=()=>n(t.error||new Error("Transaktionen fejlede"))})),r=t.objectStore(DB_STORE),a=await promisifyRequest(r.getAll());return await n,Array.isArray(a)?a.filter((e=>e&&e.data)).sort(((e,t)=>(t.ts||0)-(e.ts||0))):[]}catch(e){return console.warn("Kunne ikke hente lokale sager",e),[]}}function setHistoryListBusy(e){const t=getDomElement("historyList");t&&t.setAttribute("aria-busy",e?"true":"false")}function formatHistoryTimestamp(e){if(!e)return"";const t=new Date(e);if(Number.isNaN(t.valueOf()))return"";try{return new Intl.DateTimeFormat("da-DK",{dateStyle:"medium",timeStyle:"short"}).format(t)}catch{return t.toLocaleString("da-DK")}}function renderHistoryList(e=recentCasesCache){const t=getDomElement("historyList");if(!t)return;t.innerHTML="";const n=Array.isArray(e)?e.filter((e=>e&&e.data)):[];if(!n.length){const e=document.createElement("li");return e.className="history-list__empty",e.textContent="Ingen historik endnu.",t.appendChild(e),void setHistoryListBusy(!1)}n.slice(0,10).forEach((e=>{const n=document.createElement("li");n.className="history-list__item";const r=e.data?.sagsinfo||{},a=r.navn?.trim()||r.sagsnummer?.trim()||"Sag uden navn",o=document.createElement("span");o.className="history-list__title",o.textContent=a;const s=document.createElement("span");s.className="history-list__meta";const i=[];r.sagsnummer&&i.push(r.sagsnummer);const l=Array.isArray(e.data?.systems)?e.data.systems.map((e=>systemLabelMap.get(e)||e)).filter(Boolean):[];l.length&&i.push(l.join(", "));const d=formatHistoryTimestamp(e.ts||e.data?.timestamp);d&&i.push(d);const u=e.data?.totals;if(u){const e=toNumber(u.materialSum)+toNumber(u.laborSum);e>0&&i.push(`Sum ${formatCurrency(e)}`)}s.textContent=i.join(" • "),n.appendChild(o),i.length&&n.appendChild(s);const c=document.createElement("div");c.className="history-list__actions";const m=document.createElement("button");m.type="button",m.className="history-list__delete",m.dataset.id=e.id,m.dataset.action="delete-history",m.textContent="Slet",c.appendChild(m),n.appendChild(c),t.appendChild(n)})),setHistoryListBusy(!1)}function setupHistoryListActions(){const e=getDomElement("historyList");e&&"true"!==e.dataset.boundDelete&&(e.dataset.boundDelete="true",e.addEventListener("click",(async e=>{const t=e.target instanceof HTMLElement?e.target.closest('[data-action="delete-history"]'):null;if(!t)return;const n=Number(t.dataset.id);if(!(n>0))return;if(!window.confirm("Er du sikker på, at du vil slette denne sag?"))return;t.disabled=!0;await deleteProjectById(n)?(recentCasesCache=recentCasesCache.filter((e=>Number(e?.id)!==n)),syncRecentProjectsGlobal(recentCasesCache),renderHistoryList(recentCasesCache),populateRecentCases()):t.disabled=!1})))}function findHistoryEntryById(e){return!Number.isFinite(e)||e<=0?null:recentCasesCache.find((t=>Number(t?.id)===e))||null}function buildHistorySummary(e){if(!e||!e.data)return null;const t=e.data.totals||{},n=toNumber(t.timer??t.totalHours),r=toNumber(t.hourlyBase??t.akkordTimeLon??t.timeprisUdenTillaeg),a=toNumber(t.mentorRate),o=a>0?a:22.26;let s=toNumber(t.hourlyUdd1),i=toNumber(t.hourlyUdd2),l=toNumber(t.hourlyUdd2Mentor);const d=r>0;return s>0||!d||(s=r+42.98),i>0||!d||(i=r+49.38),l>0||!d||(l=r+49.38+o),{date:formatHistoryTimestamp(e.ts||e.data.timestamp),timer:n>0?n:0,hourlyBase:d?r:0,hourlyUdd1:s>0?s:0,hourlyUdd2:i>0?i:0,hourlyUdd2Mentor:l>0?l:0}}function renderJobHistorySummary(e){const t=getDomElement("job-history-summary-body");if(!t)return;t.innerHTML="";const n=buildHistorySummary(e);if(!n){const e=document.createElement("tr"),n=document.createElement("td");return n.colSpan=6,n.textContent="Ingen historik endnu.",e.appendChild(n),void t.appendChild(e)}const r=e=>e>0?`${formatCurrency(e)} kr`:"–",a=[n.date||"–",n.timer>0?formatNumber(n.timer):"–",r(n.hourlyBase),r(n.hourlyUdd1),r(n.hourlyUdd2),r(n.hourlyUdd2Mentor)],o=document.createElement("tr");a.forEach((e=>{const t=document.createElement("td");t.textContent=e,o.appendChild(t)})),t.appendChild(o)}function updateHistorySummaryFromSelect(){const e=getDomElement("jobHistorySelect"),t=Number(e?.value);let n=null;Number.isFinite(t)&&t>0&&(n=findHistoryEntryById(t)),!n&&recentCasesCache.length&&(n=recentCasesCache[0],n&&e&&e.value!==String(n.id)&&(e.value=String(n.id))),renderJobHistorySummary(n||null);const r=getDomElement("btnLoadHistoryJob");r&&(r.disabled=!(n&&null!=n.id))}async function populateRecentCases(){const e=getDomElement("jobHistorySelect"),t=getDomElement("btnLoadHistoryJob");if(!Boolean(e||getDomElement("historyList")))return;setupHistoryListActions(),setHistoryListBusy(!0);const n=await getRecentProjects();recentCasesCache=n,syncRecentProjectsGlobal(recentCasesCache);const r=e?.value||"";if(e&&(e.innerHTML=""),renderHistoryList(n),!n.length){if(e){const t=document.createElement("option");t.value="",t.textContent="Ingen gemte sager endnu",t.disabled=!0,t.selected=!0,e.appendChild(t)}return t&&(t.disabled=!0),void renderJobHistorySummary(null)}if(!e)return renderJobHistorySummary(n[0]||null),void(t&&(t.disabled=!(n[0]&&null!=n[0].id)));n.forEach((t=>{const n=document.createElement("option");n.value=String(t.id);const r=t.data?.sagsinfo||{},a=[];r.sagsnummer&&a.push(r.sagsnummer),r.navn&&a.push(r.navn),n.textContent=a.length?a.join(" – "):`Sag #${t.id}`,e.appendChild(n)}));const a=n.find((e=>String(e.id)===r))||n[0];a&&(e.value=String(a.id)),t&&(t.disabled=!e.value),updateHistorySummaryFromSelect()}"undefined"!=typeof window&&(window.cssmateUpdateActionHint=updateActionHint);let zipHistoryBound=!1;function setupZipExportHistoryHook(){zipHistoryBound||"undefined"==typeof window||(zipHistoryBound=!0,window.addEventListener("cssmate:zip-exported",(e=>{const t=e?.detail||{};persistProjectSnapshot({type:"zip",baseName:t.baseName||"",zipName:t.zipName||"",files:Array.isArray(t.files)?t.files:[],timestamp:t.timestamp||Date.now()})})),window.addEventListener("cssmate:exported",(e=>{const t=e?.detail||{};persistProjectSnapshot({type:t.type||"export",baseName:t.baseName||"",fileName:t.fileName||"",files:Array.isArray(t.files)?t.files:[],timestamp:t.timestamp||Date.now()})})))}function collectExtrasState(){const e=e=>getDomElement(e)?.value??"",t=toNumber(e("km")),n=2.12*t;return{jobType:getDomElement("jobType")?.value||"montage",montagepris:e("montagepris"),demontagepris:e("demontagepris"),slaebePct:e("slaebePct"),slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:e("antalBoringHuller"),antalLukHuller:e("antalLukHuller"),antalBoringBeton:e("antalBoringBeton"),opskydeligtRaekvaerk:e("antalOpskydeligt"),km:n,kmBelob:n,kmAntal:t,kmIsAmount:!0,traelle35:e("traelleloeft35"),traelle50:e("traelleloeft50")}}function collectProjectSnapshot(e){const t=getAllData().map((e=>({id:e.id,name:e.name,price:toNumber(e.price),quantity:toNumber(e.quantity),manual:Boolean(e.manual),varenr:e.varenr||null}))),n=Array.isArray(laborEntries)?laborEntries.map((e=>({...e}))):[],r={materialSum:lastMaterialSum,laborSum:lastLoensum};lastJobSummary&&(r.timer=lastJobSummary.totalHours,r.hourlyBase=lastJobSummary.hourlyBase,r.hourlyUdd1=lastJobSummary.hourlyUdd1,r.hourlyUdd2=lastJobSummary.hourlyUdd2,r.hourlyUdd2Mentor=lastJobSummary.hourlyUdd2Mentor,r.mentorRate=lastJobSummary.mentorRate);const a=Date.now(),o={timestamp:a,sagsinfo:collectSagsinfo(),systems:Array.from(selectedSystemKeys),materials:t,labor:n,extras:collectExtrasState(),totals:r};return e&&"zip"===e.type&&(o.exportInfo={type:"zip",baseName:e.baseName||"",zipName:e.zipName||"",files:Array.isArray(e.files)?e.files.filter(Boolean):[],exportedAt:e.timestamp||a}),o}async function persistProjectSnapshot(e){if(!historyPersistencePaused)try{const t=collectProjectSnapshot(e);await saveProject(t),await populateRecentCases()}catch(e){console.warn("Kunne ikke gemme projekt snapshot",e)}}function applyExtrasSnapshot(e={}){const t=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t??"")},n=document.getElementById("jobType");n&&e.jobType&&(n.value=e.jobType),t("montagepris",e.montagepris),t("demontagepris",e.demontagepris),t("slaebePct",e.slaebePct),setSlaebFormulaText(e?.slaebeFormulaText??""),updateSlaebFormulaInfo(exportMeta.slaebFormulaText),t("antalBoringHuller",e.antalBoringHuller),t("antalLukHuller",e.antalLukHuller),t("antalBoringBeton",e.antalBoringBeton),t("antalOpskydeligt",e.opskydeligtRaekvaerk),t("km",resolveKmInputValue(e,2.12)),t("traelleloeft35",e.traelle35),t("traelleloeft50",e.traelle50),computeTraelleTotals()}function applyMaterialsSnapshot(e=[],t=[]){resetMaterials(),Array.isArray(t)&&t.length&&(selectedSystemKeys.clear(),t.forEach((e=>selectedSystemKeys.add(e)))),Array.isArray(e)&&e.forEach((e=>{if(shouldExcludeMaterialEntry(e))return;const t=toNumber(e?.quantity),n=toNumber(e?.price);let r=null;if(e?.id&&(r=findMaterialById(e.id)),r&&!r.manual)return r.quantity=t,void(Number.isFinite(n)&&n>0&&(r.price=n));if(e?.manual){const r=manualMaterials.find((t=>t.id===e.id))||manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));return void(r&&(r.name=e.name||r.name,r.price=Number.isFinite(n)?n:r.price,r.quantity=t))}const a=manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));a&&(a.name=e?.name||"",a.price=Number.isFinite(n)?n:0,a.quantity=t)})),renderOptaelling()}function applyLaborSnapshot(e=[]){laborEntries=Array.isArray(e)?e.map((e=>({...e}))):[],populateWorkersFromLabor(laborEntries)}function mapAkkordJsonV1ToSnapshot(e={}){const t=e.type||e.extras?.jobType||"montage",n="demontage"===t?.5:1,r={...e.extras||{},jobType:t},a=Array.isArray(e.wage?.workers)?e.wage.workers:[],o=a.map((e=>e?.name||e?.worker||"")).filter(Boolean).join(", ");return{sagsinfo:{sagsnummer:e.jobId||e.info?.sagsnummer||"",navn:e.jobName||e.info?.navn||"",adresse:e.info?.adresse||e.info?.address||e.site||e.address||"",kunde:e.customer||e.info?.kunde||"",dato:normalizeDateValue(e.createdAt||e.info?.dato),montoer:o||e.info?.montoer||""},systems:Array.isArray(e.systems)&&e.systems.length?e.systems:e.system?[e.system]:[],materials:Array.isArray(e.materials)?e.materials.map((e=>({id:e?.id||e?.varenr||e?.lineId||"",name:e?.name||e?.label||"",quantity:toNumber(e?.qty??e?.quantity??0),price:toNumber(e?.unitPrice??e?.price??0)/n}))).filter((e=>e.id||e.name)):[],labor:a.length?a.map((n=>({type:n?.type||t,hours:toNumber(n?.hours??n?.time??0),rate:toNumber(n?.rate??n?.hourlyWithAllowances??e.wage?.hourlyRate),udd:n?.udd||n?.educationLevel||e.wage?.educationLevel||"",mentortillaeg:toNumber(n?.mentortillaeg)}))):Array.isArray(e.labor)?e.labor:[],extras:r,totals:e.totals?{materialSum:toNumber(e.totals.materialsSum??e.totals.materialSum),laborSum:toNumber(e.totals.laborSum??e.totals.laborSumWithAllowance)}:e.summary?{materialSum:toNumber(e.summary.materialSum),laborSum:toNumber(e.summary.laborSum)}:void 0}}function normalizeLegacyJsonSnapshot(e={}){const t=e.type||e.jobType||e.extras?.jobType||"montage",n={...e.extras||{},jobType:t},r={...e.sagsinfo||e.info||{}};return!r.dato&&e.createdAt&&(r.dato=normalizeDateValue(e.createdAt)),{sagsinfo:r,systems:Array.isArray(e.systems)?e.systems:e.system?[e.system]:[],materials:Array.isArray(e.materials)?e.materials:[],labor:Array.isArray(e.labor)?e.labor:[],extras:n,totals:e.totals||e.summary}}function normalizeImportedJsonSnapshot(e={}){const t=Number(e?.version);return Number.isFinite(t)&&t>=AKKORD_JSON_VERSION?mapAkkordJsonV1ToSnapshot(e):normalizeLegacyJsonSnapshot(e)}function applyProjectSnapshot(e,t={}){if(!e||"object"!=typeof e)return;const n=e.sagsinfo||{};setSagsinfoField("sagsnummer",n.sagsnummer||""),setSagsinfoField("sagsnavn",n.navn||""),setSagsinfoField("sagsadresse",n.adresse||""),setSagsinfoField("sagskunde",n.kunde||""),setSagsinfoField("sagsdato",n.dato||""),setSagsinfoField("sagsmontoer",n.montoer||""),applyMaterialsSnapshot(e.materials,e.systems),applyExtrasSnapshot(e.extras),applyLaborSnapshot(e.labor),e.totals&&(Number.isFinite(e.totals.materialSum)&&(lastMaterialSum=e.totals.materialSum),Number.isFinite(e.totals.laborSum)&&(lastLoensum=e.totals.laborSum)),updateTotals(!0),validateSagsinfo(),t?.skipHint||updateActionHint("Sag er indlæst.","success")}async function handleLoadCase(){const e=getDomElement("jobHistorySelect");if(!e)return;const t=Number(e.value);if(!Number.isFinite(t)||t<=0)return;let n=recentCasesCache.find((e=>Number(e.id)===t));if(!n){const e=await getRecentProjects();recentCasesCache=e,syncRecentProjectsGlobal(recentCasesCache),n=e.find((e=>Number(e.id)===t)),renderHistoryList(recentCasesCache)}pauseHistoryPersistence();try{n&&n.data?(applyProjectSnapshot(n.data,{skipHint:!1}),renderJobHistorySummary(n)):updateActionHint("Kunne ikke indlæse den valgte sag.","error")}finally{resumeHistoryPersistence()}}function validateSagsinfo(){let e=!0;return sagsinfoFieldIds.forEach((t=>{const n=getDomElement(t);if(!n)return;const r=(n.value||"").trim();let a=r.length>0;"sagsdato"===t&&(a=r.length>0&&!Number.isNaN(new Date(r).valueOf())),a||(e=!1),n.classList.toggle("invalid",!a)})),["btn-export-akkord-zip","btn-print-akkord"].forEach((t=>{const n=getDomElement(t);n&&(n.disabled=!e)})),e?updateActionHint(""):updateActionHint(DEFAULT_ACTION_HINT,"error"),e}function escapeCSV(e){if(null==e)return"";const t=String(e);return/[";\n\r]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function sanitizeFilename(e){return(e||"akkordseddel").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9-_]+/gi,"_")}function formatNumberForCSV(e){return toNumber(e).toFixed(2).replace(".",",")}function formatPercentForCSV(e){return`${toNumber(e).toFixed(2).replace(".",",")} %`}function collectJobType(){return document.getElementById("jobType")?.value||"montage"}function formatDateForDisplay(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.valueOf())?String(e):t.toLocaleDateString("da-DK")}function getExcelSystemInputs(){return"undefined"==typeof document?[]:Array.from(document.querySelectorAll('input[name="akkordExcelSystem"][type="checkbox"]'))}function getExcelSystemSelectionFromInputs(){const e=getExcelSystemInputs();if(0===e.length)return Array.from(excelSystemSelectionCache);return sanitizeExcelSystemSelection(e.filter((e=>e.checked)).map((e=>e.value)))}function syncExcelSystemSelector(){const e=getExcelSystemInputs();if(0===e.length)return;const t=getSelectedSystemKeys(),n=new Set(getStoredExcelSystems());e.forEach((e=>{const r=normalizeExcelSystemId(e.value);e.checked=n.has(r);const a=e.closest(".export-system-option"),o=a?.querySelector(".export-system-option__label"),s=a?.querySelector(".export-system-option__hint"),i=AKKORD_EXCEL_SYSTEMS.find((e=>e.id===r));o&&i&&(o.textContent=i.label);const l=t.includes(r);s&&(s.textContent=l?"Aktiv i sag":"Ikke aktiv i sag"),a&&a.classList.toggle("export-system-option--inactive",!l)}))}function initExcelSystemSelector(){syncExcelSystemSelector();const e=document.getElementById("akkordExcelSystemOptions");e&&e.addEventListener("change",(e=>{const t=e.target;if(!t||"function"!=typeof t.getAttribute)return;if("akkordExcelSystem"!==t.getAttribute("name"))return;setStoredExcelSystems(getExcelSystemSelectionFromInputs())}))}function requireExcelSystemSelection(){const e=getExcelSystemSelectionFromInputs();if(0===e.length){return updateActionHint('Vælg mindst ét Excel 25-ark under "Eksport & deling".',"error"),null}return e}function triggerBlobDownload(e,t){if("undefined"==typeof document)return;const n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}async function downloadExcelPayloads(e,t){if(!Array.isArray(e)||0===e.length)return{count:0,zipped:!1};const n=e.filter((e=>e?.blob&&e?.fileName));if(0===n.length)return{count:0,zipped:!1};if(1===n.length)return triggerBlobDownload(n[0].blob,n[0].fileName),{count:1,zipped:!1};const{JSZip:r}=await ensureZipLibLazy(),a=new r;n.forEach((e=>{a.file(e.fileName,e.blob)}));return triggerBlobDownload(await a.generateAsync({type:"blob"}),`${sanitizeFilename(t?.sagsinfo?.sagsnummer||t?.caseNo||"akkordsedler")||"akkordsedler"}_excel.zip`),{count:n.length,zipped:!0}}function buildExcelExportMessage(e){return e&&0!==e.count?1===e.count?"1 Excel-ark blev genereret og downloadet direkte. ZIP bruges kun ved flere valg.":`${e.count} Excel-ark blev samlet i én ZIP-fil. ZIP bruges kun ved flere valg.`:""}async function exportExcelSelection(e,t){if(!e)return{count:0,zipped:!1};const n=sanitizeExcelSystemSelection(t);if(0===n.length)return{count:0,zipped:!1};const r=await loadExcelExporter();return downloadExcelPayloads("function"==typeof r?await r(e,n):[],e)}function inferSystemFromLine(e){if(!e)return"";if(e.system)return e.system;if(e.systemKey)return e.systemKey;const t=String(e.varenr||e.id||"").trim().toLowerCase();return t.startsWith("b")?"bosta":t.startsWith("h")?"haki":t.startsWith("m")?"modex":""}function buildAkkordJobSnapshot(e=lastEkompletData){const t=e||lastEkompletData;if(!t)return null;const n=collectSagsinfo(),r={...t.sagsinfo||{},...n},a=t.jobType||document.getElementById("jobType")?.value||"montage",o=r.montoer||"",s="demontage"===a?"":o,i="demontage"===a?o:"",l=r.dato?formatDateForDisplay(r.dato):"",d={id:r.sagsnummer||r.navn||r.adresse||"akkord",caseNo:r.sagsnummer||"",site:r.adresse||"",address:r.adresse||"",task:r.navn||"",title:r.navn||"",customer:r.kunde||"",date:l||r.dato||"",montageWorkers:s,demontageWorkers:i,montor:o,worker:o,system:getPreferredExcelSystem()},u=(Array.isArray(t.materialer)?t.materialer:[]).map((e=>({id:e?.varenr||e?.id||"",label:e?.name||e?.label||"",name:e?.name||e?.label||"",qty:toNumber(e?.quantity??e?.qty??0),amount:toNumber(e?.quantity??e?.qty??0),system:inferSystemFromLine(e)}))).filter((e=>e.label&&e.qty>0));return d.lines=u,d.items=u,d.materials=u,d}function buildRawAkkordData(e={}){const t=collectSagsinfo();e.customSagsnummer&&(t.sagsnummer=e.customSagsnummer);const n=getAllData().filter((e=>toNumber(e.quantity)>0)),r=Array.isArray(laborEntries)?laborEntries:[],a="undefined"!=typeof window?window.__beregnLonCache:null,o=collectJobType(),s="demontage"===o?.5:1,i=getStoredExcelSystems(),l={boringHuller:toNumber(document.getElementById("antalBoringHuller")?.value),lukHuller:toNumber(document.getElementById("antalLukHuller")?.value),boringBeton:toNumber(document.getElementById("antalBoringBeton")?.value),opskydeligt:toNumber(document.getElementById("antalOpskydeligt")?.value),km:toNumber(document.getElementById("km")?.value),slaebePctInput:toNumber(document.getElementById("slaebePct")?.value)},d=computeTraelleTotals(),u=d&&Number.isFinite(d.sum)?d.sum:0,c=n.map((e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*s}))),m=calcMaterialesum()+u,p=m*(Number.isFinite(l.slaebePctInput)?l.slaebePctInput/100:0),y={"tralleløft":u,traelle35:d?.n35||0,traelle50:d?.n50||0,huller:4.7*l.boringHuller,lukAfHul:3.45*l.lukHuller,boringBeton:11.49*l.boringBeton,boring:11.49*l.boringBeton,opskydeligt:9.67*l.opskydeligt,km:2.12*l.km,oevrige:0,slaebePct:l.slaebePctInput,slaebeBelob:p},f={jobType:o,slaebePct:l.slaebePctInput,slaebeBelob:p,slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:l.boringHuller,antalLukHuller:l.lukHuller,antalBoringBeton:l.boringBeton,boringBeton:y.boring,boring:y.boring,huller:y.huller,lukAfHul:y.lukAfHul,opskydeligtRaekvaerk:l.opskydeligt,opskydeligt:y.opskydeligt,km:y.km,traelle35:d?.n35||0,traelle50:d?.n50||0,"tralleløft":u},g=r.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)}))),b=g.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),S=calculateTotals({materialLines:c,slaebeBelob:p,extra:y,workers:g,totalHours:b}),h={sagsnummer:t.sagsnummer||"akkordseddel",dato:t.dato||(new Date).toISOString(),kunde:t.kunde,adresse:t.adresse,navn:t.navn,systems:Array.from(selectedSystemKeys),excelSystems:i,createdAt:(new Date).toISOString()};return{version:"1.0",info:t,materials:n,labor:r,cache:a,jobType:o,jobFactor:s,systems:Array.from(selectedSystemKeys),excelSystems:i,tralleState:d,tralleSum:u,materialLinesForTotals:c,montageBase:m,slaebePctInput:l.slaebePctInput,slaebeBelob:p,extraInputs:l,extras:f,laborTotals:g,totalHours:b,totals:S,meta:h,createdAt:h.createdAt}}function buildAkkordData(e={}){const t=buildRawAkkordData(e);return buildSharedAkkordData(t)}function syncActiveJobState(){const e=buildAkkordJobSnapshot();return e&&setActiveJob(e),e}function normalizeDateValue(e){if(!e)return"";const t=String(e).trim();if(!t)return"";const n=t.split(/[-\/.]/);if(3===n.length){const[e,t,r]=n;if(4===e.length)return`${e}-${t.padStart(2,"0")}-${r.padStart(2,"0")}`;if(4===r.length)return`${r}-${t.padStart(2,"0")}-${e.padStart(2,"0")}`}const r=new Date(t);return Number.isNaN(r.valueOf())?"":r.toISOString().slice(0,10)}function parseCSV(e){const t=String(e).split(/\r?\n/).filter((e=>e.trim().length>0));if(0===t.length)return[];const n=t[0].includes(";")?";":",",r=e=>{const t=[];let r="",a=!1;for(let o=0;o<e.length;o++){const s=e[o];'"'===s?a&&'"'===e[o+1]?(r+='"',o++):a=!a:s!==n||a?r+=s:(t.push(r.trim()),r="")}return t.push(r.trim()),t},a=r(t[0]),o=[];for(let e=1;e<t.length;e++){const n=r(t[e]);if(n.every((e=>""===e)))continue;const s={};a.forEach(((e,t)=>{s[e]=n[t]??""})),o.push(s)}return o}function resetMaterials(){[dataBosta,dataHaki,dataModex,dataAlfix].forEach((e=>{e.forEach((e=>{e.quantity=0}))})),manualMaterials.forEach((e=>{e.name="",e.price=0,e.quantity=0}))}function resetWorkers(){workerCount=0;const e=document.getElementById("workers");e&&(e.innerHTML="")}function populateWorkersFromLabor(e){if(resetWorkers(),!Array.isArray(e)||0===e.length)return addWorker(),void updateTotals(!0);e.forEach(((e,t)=>{addWorker();const n=document.getElementById(`worker${t+1}`);if(!n)return;const r=n.querySelector(".worker-hours"),a=n.querySelector(".worker-tillaeg"),o=n.querySelector(".worker-udd");if(r&&(r.value=formatNumber(toNumber(e.hours))),a&&(a.value=formatNumber(toNumber(e.mentortillaeg))),o instanceof HTMLSelectElement){const t=(e?.udd??"").toString().trim();if(t){Array.from(o.options).some((e=>e.value===t))?o.value=t:o.options.length>0&&(o.selectedIndex=0)}else o.options.length>0&&(o.selectedIndex=0)}})),updateTotals(!0);e.some((e=>toNumber(e.hours)>0))&&"function"==typeof beregnLon&&beregnLon()}function matchMaterialByName(e){if(!e)return null;const t=normalizeKey(e),n=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const e of n){const n=e.find((e=>normalizeKey(e.name)===t));if(n)return n}return null}function assignMaterialRow(e){const t=e.id?.trim?.()||"",n=e.name?.trim?.()||"",r=toNumber(e.quantity),a=toNumber(e.price);if(!n&&!t&&0===r&&0===a)return;if(shouldExcludeMaterialEntry({id:t,name:n}))return;let o=null;if(t&&(o=findMaterialById(t)),!o&&n&&(o=matchMaterialByName(n)),o&&!o.manual)return o.quantity=r,void(a>0&&(o.price=a));const s=manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));if(!s)return;const i=manualMaterials.indexOf(s)+1;s.name=n||s.name||`Manuelt materiale ${i}`,s.quantity=r,s.price=a}function applyCSVRows(e){if(!Array.isArray(e)||0===e.length)return;resetMaterials();const t=collectSagsinfo(),n=[],r=[],a=[];if(e.forEach((e=>{const o={};Object.entries(e).forEach((([e,t])=>{o[normalizeKey(e)]=(t??"").toString().trim()}));const s=o.sagsnummer||o.sagsnr||o.sag||o.caseid;s&&(t.sagsnummer=s);const i=o.navnopgave||o.navn||o.opgave||o.projekt;i&&(t.navn=i);const l=o.adresse||o.addresse;l&&(t.adresse=l);const d=o.kunde||o.customer;d&&(t.kunde=d);const u=normalizeDateValue(o.dato||o.date);u&&(t.dato=u);const c=o.montoer||o.montor||o.montornavne||o.montornavn;c&&n.push(c);const m=o.materialenavn||o.materiale||o.varenavn||o.navn,p=o.antal||o.quantity||o.qty||o.maengde,y=o.pris||o.price||o.enhedspris||o.stkpris,f=o.id||o.materialeid||o.varenummer;(m||f||p||y)&&r.push({id:f,name:m,quantity:p,price:y});const g=o.arbejdstype||o.type||o.jobtype,b=o.timer||o.hours||o.antalttimer,S=o.sats||o.rate||o.timelon||o.timeloen;(g||b||S)&&a.push({type:g||"",hours:toNumber(b),rate:toNumber(S)})})),setSagsinfoField("sagsnummer",t.sagsnummer||""),setSagsinfoField("sagsnavn",t.navn||""),setSagsinfoField("sagsadresse",t.adresse||""),setSagsinfoField("sagskunde",t.kunde||""),setSagsinfoField("sagsdato",t.dato||""),n.length){setSagsinfoField("sagsmontoer",n.flatMap((e=>e.split(/[\n,]/))).map((e=>e.trim())).filter(Boolean).join("\n"))}r.forEach(assignMaterialRow);const o=systemOptions.filter((e=>e.dataset.some((e=>toNumber(e.quantity)>0))));if(o.length>0&&(selectedSystemKeys.clear(),o.forEach((e=>selectedSystemKeys.add(e.key)))),renderOptaelling(),laborEntries=a.filter((e=>e.hours>0||e.rate>0||e.type)),populateWorkersFromLabor(laborEntries),updateTotals(!0),laborEntries.length>0){const e=laborEntries[0].type?.toLowerCase()||"",t=document.getElementById("jobType");t&&(e.includes("demo")?t.value="demontage":e.includes("montage")&&(t.value="montage"))}validateSagsinfo()}function setupCSVImport(){const e=document.getElementById("dropArea"),t=document.getElementById("csvFileInput");if(!e||!t)return;const n=()=>t.click();["dragenter","dragover"].forEach((t=>{e.addEventListener(t,(t=>{t.preventDefault(),e.classList.add("dragover"),t.dataTransfer&&(t.dataTransfer.dropEffect="copy")}))})),["dragleave","dragend"].forEach((t=>{e.addEventListener(t,(()=>e.classList.remove("dragover")))})),e.addEventListener("drop",(n=>{n.preventDefault(),e.classList.remove("dragover");const r=n.dataTransfer?.files?.[0];r&&(handleImportFile(r),t.value="")})),e.addEventListener("click",n),e.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n())})),t.addEventListener("change",(e=>{const n=e.target.files?.[0];n&&(handleImportFile(n),t.value="")}))}function applyImportedAkkordData(e){if(!e||"object"!=typeof e)return void updateActionHint("Kunne ikke læse akkordseddel-data.","error");const t=e.data&&!e.materials?e.data:e,n=t.version||t.meta?.version;n&&1!==n&&"1.0"!==n&&console.warn("Uventet akkordseddel-version",n);const r=(t.type||t.jobType||"montage").toLowerCase(),a=t.extras||t.akkord||{},o=t.info||t.meta||{},s=(Array.isArray(t.materials)?t.materials:Array.isArray(t.lines)?t.lines:Array.isArray(t.linjer)?t.linjer.map((e=>({id:e.varenr,name:e.navn,qty:e.antal,unitPrice:e.stkPris,system:e.system}))):[]).map((e=>({id:e.id||e.varenr||"",name:e.name||e.label||e.title||"",price:toNumber(e.unitPrice??e.price),quantity:toNumber(e.qty??e.quantity??e.amount),system:e.system||e.systemKey||inferSystemFromLine(e)}))).filter((e=>e.quantity>0||e.name||e.id)),i=t.wage||{},l=Array.isArray(i.workers)?i.workers:Array.isArray(t.workers)?t.workers:Array.isArray(t.labor)?t.labor:[],d=[];if(l.length)l.forEach((e=>{const t=toNumber(e?.hours),n=toNumber(e?.rate??e?.hourlyWithAllowances??e?.hourlyRate),a=e?.udd||e?.education||e?.educationLevel||"",o=toNumber(e?.mentortillaeg??e?.mentorAllowance),s=e?.type||r;(t>0||n>0||s)&&d.push({type:s,hours:t,rate:n,udd:a,mentortillaeg:o})}));else{const e=toNumber(i.montageHours??i.demontageHours??i.totalHours),t=toNumber(i.hourlyRate);(e>0||t>0)&&d.push({type:r,hours:e,rate:t,udd:i.educationLevel||i.udd||"",mentortillaeg:toNumber(i.mentorAllowance)})}const u=Array.isArray(t.systems)?t.systems:t.system?[normalizeExcelSystemId(t.system)]:Array.isArray(o.systems)?o.systems:Array.from(selectedSystemKeys),c=toNumber(a.tralleløft??a.tralleloeft??a.tralleløft);let m=a.traelle35??a.tralle35??a.tralleloeft35??a.tralleløft35,p=a.traelle50??a.tralle50??a.tralleloeft50??a.tralleløft50;if(!m&&!p&&Number.isFinite(c)&&c>0){const e=c/10.44;m=Number.isFinite(e)?e.toFixed(2):""}const y=Number(resolveKmInputValue(a,2.12)),f=Number.isFinite(y)&&y>=0?2.12*y:toNumber(a.kmBelob??a.km??a.kilometer??0),g={sagsinfo:{sagsnummer:t.jobId||o.sagsnummer||t.caseNo||t.id||"",navn:t.jobName||o.navn||t.name||t.title||"",adresse:t.jobAddress||t.address||t.site||o.adresse||"",kunde:t.customer||t.kunde||o.kunde||"",dato:t.createdAt||t.date||o.dato||"",montoer:t.montageWorkers||t.demontageWorkers||t.worker||t.montor||o.montoer||""},systems:u,materials:s,labor:d,extras:{jobType:r,montagepris:a.montagepris,demontagepris:a.demontagepris,slaebePct:a.slaebePct,slaebeFormulaText:a.slaebeFormulaText,antalBoringHuller:a.huller??a.antalBoringHuller??0,antalLukHuller:a.lukAfHul??a.antalLukHuller??0,antalBoringBeton:a.boringBeton??a.antalBoringBeton??0,opskydeligtRaekvaerk:a.opskydeligt??a.opskydeligtRaekvaerk??0,km:f,kmBelob:f,kmAntal:Number.isFinite(y)&&y>=0?y:void 0,kmIsAmount:!0,traelle35:m,traelle50:p},totals:t.totals||{}};pauseHistoryPersistence();try{applyProjectSnapshot(g,{skipHint:!0})}finally{resumeHistoryPersistence()}updateActionHint("Akkordseddel er importeret. Bekræft arbejdstype og tal.","success"),persistProjectSnapshot({type:"import",source:t?.meta?.source||"json"})}async function handleAkkordImport(e){if(e)try{const t=await e.text();applyImportedAkkordData(JSON.parse(t))}catch(e){console.error("Kunne ikke importere akkordseddel",e),updateActionHint("Kunne ikke importere akkordseddel-filen.","error")}}function handleImportFile(e){if(!e)return;const t=e.name||"";/\.json$/i.test(t)||e.type&&e.type.includes("json")?importJSONProject(e):uploadCSV(e)}async function verifyAdminCodeInput(e,t=null){const n="string"==typeof e?e.trim():"";if(!n)return{ok:!1,reason:"empty"};const r=new Set([...KNOWN_ADMIN_CODES,...Array.isArray(t?.KNOWN_ADMIN_CODES)?t.KNOWN_ADMIN_CODES:[],...Array.isArray(t?.admin_codes_plain)?t.admin_codes_plain:[]].filter((e=>"string"==typeof e&&e.trim().length)));for(const e of r)if(e===n)return{ok:!0,method:"plaintext"};const a=new Set([...KNOWN_ADMIN_CODE_HASHES,DEFAULT_ADMIN_CODE_HASH,t?._meta?.admin_code,...Array.isArray(t?.HASHED_ADMIN_CODES)?t.HASHED_ADMIN_CODES:[]].filter((e=>"string"==typeof e&&e.length)));if(a.size>0){const e=await sha256Hex(n);for(const t of a)if(constantTimeEquals(e,t))return{ok:!0,method:"sha256"}}return{ok:!1,reason:"no_match"}}function handleAdminLogout(e){admin=!1,setAdminOk(!1),renderOptaelling(),updateTotals(!0),e&&(e.textContent="Admin-tilstand er slået fra.",e.classList.remove("error"),e.classList.add("success"),e.removeAttribute("hidden")),updateActionHint("Admin-tilstand er slået fra.","success")}async function login(){const e=document.getElementById("adminCode"),t=document.getElementById("adminFeedback");if(!e)return;const n=e.value.trim();if(!n)return void(isAdminUnlocked()?handleAdminLogout(t):t&&(t.textContent="Indtast admin-kode for at logge ind.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden")));(await verifyAdminCodeInput(n)).ok?(admin=!0,setAdminOk(!0),e.value="",t?.classList.remove("error"),t?.classList.add("success"),t&&(t.textContent="Admin-tilstand aktiveret. Prisfelter er nu redigerbare.",t.removeAttribute("hidden")),renderOptaelling(),updateTotals(!0)):t&&(t.textContent="Forkert kode. Prøv igen.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden"))}"undefined"!=typeof window&&(window.cssmateBuildAkkordDataRaw=buildRawAkkordData),"undefined"!=typeof window&&(window.cssmateBuildAkkordData=buildAkkordData),"undefined"!=typeof window&&(window.cssmateHandleAkkordImport=handleAkkordImport);const adminLoginButton=document.getElementById("btnAdminLogin");function addWorker(){workerCount++;const e=document.createElement("fieldset");e.className="worker-row",e.id=`worker${workerCount}`,e.innerHTML=`\n    <legend>Mand ${workerCount}</legend>\n    <div class="worker-grid">\n      <label>\n        <span>Timer</span>\n        <input type="text" class="worker-hours" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-hours-${workerCount}">\n      </label>\n      <label>\n        <span>Uddannelse</span>\n        <select class="worker-udd">\n          <option value="udd1">Udd1 (42,98 kr)</option>\n          <option value="udd2">Udd2 (49,38 kr)</option>\n        </select>\n      </label>\n      <label>\n        <span>Mentortillæg (22,26 kr/t)</span>\n        <input type="text" class="worker-tillaeg" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-tillaeg-${workerCount}">\n      </label>\n    </div>\n    <div class="worker-output" aria-live="polite"></div>\n  `,document.getElementById("workers").appendChild(e)}function debounce(e,t){let n;return(...r)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,r)),t)}}async function saveLocalData(e,t){localStorage.setItem(e,JSON.stringify(t))}async function loadLocalData(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}function showLonOutputSections(){if(lonOutputsRevealed)return;lonOutputsRevealed=!0;document.querySelectorAll("[data-lon-output]").forEach((e=>{e.hidden=!1,e.removeAttribute("hidden")}))}function beregnLon(){const e=collectSagsinfo(),t=e.sagsnummer?.trim()||"uspecified",n=document.getElementById("jobType")?.value||"montage",r="demontage"===n?.5:1,a=getSelectedSystemKeys(),o=a.map((e=>normalizeKey(e))).find((e=>["bosta","haki","modex"].includes(e)))||"",s=toNumber(document.getElementById("slaebePct")?.value),i=toNumber(document.getElementById("antalBoringHuller")?.value),l=toNumber(document.getElementById("antalLukHuller")?.value),d=toNumber(document.getElementById("antalBoringBeton")?.value),u=toNumber(document.getElementById("antalOpskydeligt")?.value),c=toNumber(document.getElementById("km")?.value),m=document.querySelectorAll(".worker-row");lastEkompletData=null,lastJobSummary=null;const p=computeTraelleTotals(),y=p&&Number.isFinite(p.sum)?p.sum:0,f=[],g=[],b=[],S=getAllData();Array.isArray(S)&&S.forEach((e=>{const t=toNumber(e?.quantity);if(t<=0)return;const n=toNumber(e?.price),a=n*r,o=t*a;f.push({qty:t,unitPrice:a});const s=manualMaterials.indexOf(e),i=e?.manual?e.name?.trim()||`Manuelt materiale ${s+1}`:e?.name;g.push({label:i,quantity:t,unitPrice:n,lineTotal:o,ackUnitPrice:a});const l=t>0?o/t:a;b.push({varenr:e?.varenr||e?.id||"",name:i,quantity:t,unitPrice:l,baseUnitPrice:n,lineTotal:o,system:e?.systemKey||"",systemKey:e?.systemKey||""})}));const h=4.7*i,k=3.45*l,E=11.49*d,A=9.67*u,v=2.12*c,w=calcMaterialesum()+y,x=w*(Number.isFinite(s)?s/100:0),L={"tralleløft":y,huller:h,boring:E,lukAfHul:k,opskydeligt:A,km:v,oevrige:0};let N=0;if(m.forEach((e=>{const t=e.querySelector(".worker-hours"),n=toNumber(t?.value);n>0&&(N+=n)})),0===N){const e=document.getElementById("lonResult");if(e){e.innerHTML="";const t=document.createElement("div");t.style.color="red",t.textContent="Indtast arbejdstimer for mindst én person",e.appendChild(t)}return laborEntries=[],void(lastJobSummary=null)}const T={materialLines:f,slaebeBelob:x,extra:L,workers:[],totalHours:N},I=calculateTotals(T),C=I.timeprisUdenTillaeg,D=(I.samletAkkordsum,[]),B=[],M=[];m.forEach(((e,t)=>{const r=toNumber(e.querySelector(".worker-hours")?.value);if(r<=0)return;const a=toNumber(e.querySelector(".worker-tillaeg")?.value),o=e.querySelector(".worker-udd"),s=o?.value||"",i=e.querySelector("legend")?.textContent?.trim()||`Mand ${t+1}`,l=e.querySelector(".worker-output");let d=C+a,u=0;"udd1"===s?(d+=42.98,u=42.98):"udd2"===s&&(d+=49.38,u=49.38);const c=d*r;l&&(l.textContent=`${d.toFixed(2)} kr/t | Total: ${c.toFixed(2)} kr`),D.push({name:i,hours:r,rate:d,total:c});const m=o?.selectedOptions?.[0]?.textContent?.trim()||"";B.push({id:t+1,name:i,type:n,hours:r,rate:d,baseRate:C,mentortillaeg:a,udd:s,uddLabel:m,uddannelsesTillaeg:u,total:c}),M.push({hours:r,hourlyWithAllowances:d})}));const P=calculateTotals({...T,workers:M}),_=Number.isFinite(P.timeprisUdenTillaeg)?P.timeprisUdenTillaeg:0,H=_>0;lastJobSummary={totalHours:N,hourlyBase:H?_:0,hourlyUdd1:H?_+42.98:0,hourlyUdd2:H?_+49.38:0,hourlyUdd2Mentor:H?_+49.38+22.26:0,mentorRate:22.26};P.montoerLonMedTillaeg;const F=P.materialer+P.slaeb,j=P.projektsum,O=formatDateForDisplay(e.dato),R=document.getElementById("lonResult");if(R){R.innerHTML="";const t=document.createElement("div"),n=document.createElement("h3");n.textContent="Sagsinfo",t.appendChild(n);[{label:"Sagsnr.",value:e.sagsnummer||""},{label:"Navn",value:e.navn||""},{label:"Adresse",value:e.adresse||""},{label:"Dato",value:O}].forEach((({label:e,value:n})=>{const r=document.createElement("div"),a=document.createElement("strong");a.textContent=`${e}: `,r.appendChild(a);const o=document.createElement("span");o.textContent=n,r.appendChild(o),t.appendChild(r)})),R.appendChild(t);const r=document.createElement("h3");if(r.textContent="Materialer brugt:",R.appendChild(r),g.length>0)g.forEach((e=>{const t=document.createElement("div");t.textContent=`${e.label}: ${e.quantity} × ${e.unitPrice.toFixed(2)} kr = ${e.lineTotal.toFixed(2)} kr`,R.appendChild(t)}));else{const e=document.createElement("div");e.textContent="Ingen materialer brugt",R.appendChild(e)}const a=document.createElement("h3");if(a.textContent="Arbejdere:",R.appendChild(a),D.length>0)D.forEach((e=>{const t=document.createElement("div");t.textContent=`${e.name}: Timer: ${e.hours}, Timeløn: ${e.rate.toFixed(2)} kr/t, Total: ${e.total.toFixed(2)} kr`,R.appendChild(t)}));else{const e=document.createElement("div");e.textContent="Ingen timer registreret",R.appendChild(e)}const o=document.createElement("h3");o.textContent="Oversigt:",R.appendChild(o);[["Materialer",`${P.materialer.toFixed(2)} kr`],["Ekstraarbejde",`${P.ekstraarbejde.toFixed(2)} kr`],["Slæb",`${P.slaeb.toFixed(2)} kr`],["Samlet akkordsum",`${P.samletAkkordsum.toFixed(2)} kr`],["Timer",`${N.toFixed(1)} t`],["Timepris (uden tillæg)",`${P.timeprisUdenTillaeg.toFixed(2)} kr/t`],["Lønsum",`${P.montoerLonMedTillaeg.toFixed(2)} kr`],["Projektsum",`${j.toFixed(2)} kr`],["Materialesum (info)",`${F.toFixed(2)} kr`],["Kilometer (info)",`${v.toFixed(2)} kr`],["Tralleløft (info)",`${y.toFixed(2)} kr`]].forEach((([e,t])=>{const n=document.createElement("div"),r=document.createElement("strong");r.textContent=`${e}: `,n.appendChild(r);const a=document.createElement("span");a.textContent=t,n.appendChild(a),R.appendChild(n)}))}return laborEntries=B,lastEkompletData={sagsinfo:e,jobType:n,montagepris:w,demontagepris:.5*w,systems:a,primarySystem:o,extras:{slaebePct:s,slaebeBelob:x,slaebeFormulaText:exportMeta.slaebFormulaText||"",boringHuller:{antal:i,pris:4.7,total:h},lukHuller:{antal:l,pris:3.45,total:k},boringBeton:{antal:d,pris:11.49,total:E},opskydeligtRaekvaerk:{antal:u,pris:9.67,total:A},kilometer:{antal:c,pris:2.12,total:v},traelleloeft:{antal35:p?.n35||0,pris35:10.44,total35:10.44*(p?.n35||0),antal50:p?.n50||0,pris50:14.62,total50:14.62*(p?.n50||0),total:y}},materialer:b,arbejdere:B,totals:{materialer:P.materialer,ekstraarbejde:P.ekstraarbejde,kilometerPris:v,slaebeBelob:P.slaeb,akkordsum:P.samletAkkordsum,timer:N,akkordTimeLon:P.timeprisUdenTillaeg,loensum:P.montoerLonMedTillaeg,projektsum:j,materialeSumInfo:F,traelleSum:y},traelle:{antal35:p?.n35||0,antal50:p?.n50||0,rate35:10.44,rate50:14.62,sum:y}},syncActiveJobState(),updateTotals(!0),syncExcelSystemSelector(),"undefined"!=typeof window&&(window.__cssmateLastEkompletData=lastEkompletData,window.__beregnLonCache={materialSum:lastMaterialSum,laborSum:lastLoensum,projectSum:lastMaterialSum+lastLoensum,traelleSum:y,timestamp:Date.now()}),showLonOutputSections(),persistProjectSnapshot(),t}function buildCSVPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=collectSagsinfo();e&&(n.sagsnummer=e);const r="undefined"!=typeof window?window.__beregnLonCache:null,a=getAllData().filter((e=>toNumber(e.quantity)>0)),o=Array.isArray(laborEntries)?laborEntries:[],s=computeTraelleTotals(),i=s&&Number.isFinite(s.sum)?s.sum:0,l="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,d=a.map((e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*l}))),u=calcMaterialesum()+i,c=toNumber(document.getElementById("slaebePct")?.value),m=u*(Number.isFinite(c)?c/100:0),p={"tralleløft":i,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},y=o.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)}))),f=y.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),g=calculateTotals({materialLines:d,slaebeBelob:m,extra:p,workers:y,totalHours:f}),b=r&&Number.isFinite(r.materialSum)?r.materialSum:g.materialer,S=g.ekstraarbejde,h=g.slaeb,k=r&&Number.isFinite(r.laborSum)?r.laborSum:g.montoerLonMedTillaeg,E=r&&Number.isFinite(r.projectSum)?r.projectSum:g.projektsum,A=[];A.push("Sektion;Felt;Værdi;Antal;Pris;Linjesum"),A.push(`Sagsinfo;Sagsnummer;${escapeCSV(n.sagsnummer)};;;`),A.push(`Sagsinfo;Navn/opgave;${escapeCSV(n.navn)};;;`),A.push(`Sagsinfo;Adresse;${escapeCSV(n.adresse)};;;`),A.push(`Sagsinfo;Kunde;${escapeCSV(n.kunde)};;;`),A.push(`Sagsinfo;Dato;${escapeCSV(n.dato)};;;`);const v=(n.montoer||"").replace(/\r?\n/g,", ");A.push(`Sagsinfo;Montørnavne;${escapeCSV(v)};;;`),A.push(""),A.push("Sektion;Id;Materiale;Antal;Pris;Linjesum"),0===a.length?A.push("Materiale;;;0;0,00;0,00"):a.forEach((e=>{const t=toNumber(e.quantity);if(0===t)return;const n=toNumber(e.price),r=t*n,a=manualMaterials.indexOf(e),o=e.manual?e.name?.trim()||`Manuelt materiale ${a+1}`:e.name;A.push(`Materiale;${escapeCSV(e.id)};${escapeCSV(o)};${escapeCSV(formatNumberForCSV(t))};${escapeCSV(formatNumberForCSV(n))};${escapeCSV(formatNumberForCSV(r))}`)}));const w=window.__traelleloeft;if(w&&(w.n35>0||w.n50>0)){if(w.n35>0){const e=w.n35*w.RATE35;A.push(`Materiale;TL35;Tralleløft 0,35 m;${escapeCSV(formatNumberForCSV(w.n35))};${escapeCSV(formatNumberForCSV(w.RATE35))};${escapeCSV(formatNumberForCSV(e))}`)}if(w.n50>0){const e=w.n50*w.RATE50;A.push(`Materiale;TL50;Tralleløft 0,50 m;${escapeCSV(formatNumberForCSV(w.n50))};${escapeCSV(formatNumberForCSV(w.RATE50))};${escapeCSV(formatNumberForCSV(e))}`)}}A.push(""),A.push("Sektion;Arbejdstype;Timer;Sats;Linjesum"),0===o.length?A.push("Løn;Ingen registrering;;;"):o.forEach(((e,t)=>{const n=toNumber(e.hours),r=toNumber(e.rate),a=n*r,o=e.type||`Arbejdstype ${t+1}`;A.push(`Løn;${escapeCSV(o)};${escapeCSV(formatNumberForCSV(n))};${escapeCSV(formatNumberForCSV(r))};${escapeCSV(formatNumberForCSV(a))}`)})),A.push(""),A.push("Sektion;Total;Beløb"),A.push(`Total;Materialesum;${escapeCSV(formatNumberForCSV(b))}`),S>0&&A.push(`Total;Ekstraarbejde;${escapeCSV(formatNumberForCSV(S))}`),h>0&&A.push(`Total;Slæb;${escapeCSV(formatNumberForCSV(h))}`),A.push(`Total;Lønsum;${escapeCSV(formatNumberForCSV(k))}`),A.push(`Total;Projektsum;${escapeCSV(formatNumberForCSV(E))}`);(exportMeta.slaebFormulaText||"").trim()&&A.push(`Noter;A9 slæb-formel;${escapeCSV(exportMeta.slaebFormulaText)}`);const x=A.join("\n"),L=sanitizeFilename(n.sagsnummer||"akkordseddel")||"akkordseddel";return{content:x,baseName:L,fileName:`${L}.csv`,originalName:n.sagsnummer}}adminLoginButton&&adminLoginButton.addEventListener("click",(e=>{e.preventDefault(),login()})),"undefined"!=typeof window&&(window.cssmateBuildCSVPayload=buildCSVPayload);const AKKORD_JSON_VERSION="1.0";function buildAkkordJsonPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=t?.data||buildAkkordData({customSagsnummer:e}),{info:r,materials:a,labor:o,jobType:s,jobFactor:i,extras:l,laborTotals:d,totalHours:u,totals:c,extraInputs:m,tralleState:p,tralleSum:y,createdAt:f,systems:g,excelSystems:b,meta:S}=n,h=Array.isArray(b)?b:Array.isArray(S?.excelSystems)?S.excelSystems:getStoredExcelSystems(),k=Array.isArray(g)&&g.length?g:Array.isArray(S?.systems)?S.systems:Array.from(selectedSystemKeys),E=Array.from(new Set([...k||[],...h||[]])),A=h[0]||k[0]||getPreferredExcelSystem(),v=Array.isArray(o)?o:[],w=Array.isArray(d)?d:v.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)}))),x=Number.isFinite(u)?u:w.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),L={sagsnummer:r.sagsnummer||"",navn:r.navn||"",adresse:r.adresse||"",kunde:r.kunde||"",dato:r.dato||"",montoer:r.montoer||""},N=sanitizeFilename([L.sagsnummer||"akkordseddel",L.kunde||"",(L.dato||"").slice(0,10)].filter(Boolean).join("-"))||"akkordseddel",T=a.map((e=>{const t=toNumber(e.quantity),n=toNumber(e.price)*i;return{id:e.id,name:e.name,qty:t,unitPrice:n,lineTotal:t*n,system:inferSystemFromLine(e)||A||getPreferredExcelSystem()}})),I=toNumber(lastJobSummary?.hourlyBase??c.timeprisUdenTillaeg??c.hourlyBase),C={version:AKKORD_JSON_VERSION,type:s,jobId:r.sagsnummer||r.navn||r.adresse||N,jobName:r.navn||r.adresse||r.sagsnummer||"Akkordseddel",jobAddress:r.adresse||"",customer:r.kunde||"",address:r.adresse||"",site:r.adresse||"",worker:r.montoer||"",createdAt:f||(new Date).toISOString(),system:A||getPreferredExcelSystem(),systems:E,excelSystems:h,materials:T,extras:l,extraInputs:m||{},jobFactor:i,tralleState:p||{},tralleSum:y||0,wage:{montageHours:"montage"===s?x:0,demontageHours:"demontage"===s?x:0,numWorkers:w.length||workerCount||0,hourlyRate:I,educationLevel:w.find((e=>e.udd))?.udd||"",workers:v.map((e=>({type:e?.type||s,hours:toNumber(e?.hours),rate:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)}))),totalAkkordSum:c.samletAkkordsum},totals:{materialsSum:c.materialer,extrasSum:c.ekstraarbejde,haulSum:c.slaeb,projectSum:c.projektsum},info:L,meta:{...L,systems:E,excelSystems:h,createdAt:f||(new Date).toISOString(),version:AKKORD_JSON_VERSION}};return{content:JSON.stringify(C,null,2),baseName:N,fileName:`${N}.json`,data:C}}async function exportPDFBlob(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=t?.data||buildAkkordData({customSagsnummer:e}),{info:r,materials:a,labor:o,extras:s,tralleState:i,tralleSum:l,slaebePctInput:d,slaebeBelob:u,laborTotals:c,totalHours:m,totals:p,cache:y,extraInputs:f}=n,g=y&&Number.isFinite(y.materialSum)?y.materialSum:p.materialer,b=p.ekstraarbejde,S=(p.slaeb,y&&Number.isFinite(y.laborSum)?y.laborSum:p.montoerLonMedTillaeg),h=y&&Number.isFinite(y.projectSum)?y.projectSum:p.projektsum,k=document.createElement("div");k.className="export-preview",k.style.position="fixed",k.style.left="-9999px",k.style.top="0",k.style.background="#ffffff",k.style.color="#000000",k.style.padding="24px",k.style.width="794px",k.style.boxSizing="border-box";const E=c.filter((e=>Number.isFinite(e.hours)&&e.hours>0)).length,A=e=>new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0);const v=f.boringHuller,w=f.lukHuller,x=f.boringBeton,L=f.opskydeligt,N=f.km,T=[{id:"materials",label:"1. Materialer",format:"currency",value:g},{id:"extraWork",label:"2. Ekstra arbejde",format:"currency",value:b},{id:"extra-sled",label:"   Slæb",format:"currency",value:u,subtle:!0,info:{type:"percent",percent:d}},{id:"extra-km",label:"   Kilometer",format:"currency",value:s.km,subtle:!0,info:{type:"qtyPrice",qty:N,unitPrice:2.12,unitLabel:"km"}},{id:"extra-holes",label:"   Boring af huller",format:"currency",value:s.huller,subtle:!0,info:{type:"qtyPrice",qty:v,unitPrice:4.7}},{id:"extra-close-hole",label:"   Luk af hul",format:"currency",value:s.lukAfHul,subtle:!0,info:{type:"qtyPrice",qty:w,unitPrice:3.45}},{id:"extra-concrete",label:"   Boring i beton",format:"currency",value:s.boring,subtle:!0,info:{type:"qtyPrice",qty:x,unitPrice:11.49}},{id:"extra-folding-rail",label:"   Opslåeligt rækværk",format:"currency",value:s.opskydeligt,subtle:!0,info:{type:"qtyPrice",qty:L,unitPrice:9.67}},{id:"extra-trolley",label:"   Tralleløft",format:"currency",value:l,subtle:!0,info:{type:"trolley",qty:(i?.n35||0)+(i?.n50||0),entries:[{qty:i?.n35||0,unitPrice:10.44},{qty:i?.n50||0,unitPrice:14.62}]}},{id:"accordSum",label:"3. Samlet akkordsum",format:"currency",value:p.samletAkkordsum,emphasize:!0},{id:"hours",label:"4. Timer",format:"hours",value:m},{id:"team",label:"5. Medarbejdere & timer",format:"team",value:{workersCount:E,hours:m}}].map((e=>{const t=["review-row"];return e.subtle&&t.push("review-row--subtle"),e.emphasize&&t.push("review-row--emphasize"),`<div class="${t.join(" ")}"><span>${e.label}</span><strong>${function(e){switch(e.format){case"currency":{const t=`${formatCurrency(e.value)} kr`;if(!e.info)return t;let n="";return"percent"===e.info.type?n=`${formatNumber(e.info.percent)} %`:"qtyPrice"===e.info.type?n=`${e.info.unitLabel?`${formatNumber(e.info.qty)} ${e.info.unitLabel}`:formatNumber(e.info.qty)} × ${formatCurrency(e.info.unitPrice)} kr`:"trolley"===e.info.type&&(n=[e.info.qty?`${formatNumber(e.info.qty)} løft`:"",Array.isArray(e.info.entries)?e.info.entries.filter((e=>e&&Number(e.qty)>0)).map((e=>`${formatNumber(e.qty)} × ${formatCurrency(e.unitPrice)} kr`)).join(" · "):""].filter(Boolean).join(" · ")),n?`${t} (${n})`:t}case"hours":return`${A(e.value)} t`;case"team":{const t=Number(e.value?.workersCount)||0,n=A(e.value?.hours||0);return t?`${1===t?"1 medarbejder":`${t} medarbejdere`} · ${n} t`:`${n} t`}default:return""}}(e)}</strong></div>`})).join(""),I=(exportMeta.slaebFormulaText||"").trim()?`<p class="a9-formula-note"><strong>A9 slæb-formel:</strong> ${escapeHtml(exportMeta.slaebFormulaText).replace(/\n/g,"<br>")}</p>`:"";k.innerHTML=`\n    <style>\n      .export-preview { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }\n      .export-preview h2 { margin-top: 0; }\n      .export-preview section { margin-bottom: 16px; }\n      .export-preview ul { list-style: none; padding: 0; margin: 0; }\n      .export-preview ul li { margin-bottom: 6px; }\n      .export-preview table { width: 100%; border-collapse: collapse; margin-top: 8px; }\n      .export-preview th, .export-preview td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; font-size: 14px; }\n      .export-preview th { background: #f0f0f0; }\n      .export-preview .review-grid { display: flex; flex-direction: column; gap: 6px; }\n      .export-preview .review-row { display: flex; justify-content: space-between; gap: 12px; font-size: 14px; }\n      .export-preview .review-row--subtle { color: #4f4f4f; font-size: 13px; }\n      .export-preview .review-row--emphasize { font-weight: 600; }\n      .export-preview .review-row span { flex: 1; }\n      .export-preview .review-row strong { white-space: pre-wrap; text-align: right; }\n      .export-preview .a9-formula-note { margin-top: 10px; font-size: 13px; color: #1f2937; }\n      .export-preview .a9-formula-note strong { margin-right: 6px; }\n      .export-preview .totals { display: flex; gap: 12px; flex-wrap: wrap; }\n      .export-preview .totals div { background: #f7f7f7; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; }\n    </style>\n    <h2>Akkordseddel</h2>\n    <section>\n      <h3>Sagsinfo</h3>\n      <ul>\n        <li><strong>Sagsnummer:</strong> ${escapeHtml(r.sagsnummer)}</li>\n        <li><strong>Navn/opgave:</strong> ${escapeHtml(r.navn)}</li>\n        <li><strong>Adresse:</strong> ${escapeHtml(r.adresse)}</li>\n        <li><strong>Kunde:</strong> ${escapeHtml(r.kunde)}</li>\n        <li><strong>Dato:</strong> ${escapeHtml(r.dato)}</li>\n        <li><strong>Montørnavne:</strong> ${escapeHtml(r.montoer).replace(/\n/g,"<br>")}</li>\n      </ul>\n    </section>\n    <section>\n      <h3>Materialer</h3>\n      ${a.length?`\n        <table class="export-table">\n          <thead>\n            <tr><th>Id</th><th>Materiale</th><th>Antal</th><th>Pris</th><th>Linjesum</th></tr>\n          </thead>\n          <tbody>\n            ${a.map((e=>{const t=toNumber(e.quantity),n=toNumber(e.price),r=t*n,a=manualMaterials.indexOf(e),o=e.manual?e.name?.trim()||`Manuelt materiale ${a+1}`:e.name;return`<tr><td>${escapeHtml(e.id)}</td><td>${escapeHtml(o)}</td><td>${t.toLocaleString("da-DK",{maximumFractionDigits:2})}</td><td>${formatCurrency(n)} kr</td><td>${formatCurrency(r)} kr</td></tr>`})).join("")}\n          </tbody>\n        </table>\n      `:"<p>Ingen materialer registreret.</p>"}\n    </section>\n    <section>\n      <h3>Løn</h3>\n      ${o.length?`\n        <table class="export-table">\n          <thead>\n            <tr><th>Arbejdstype</th><th>Timer</th><th>Sats</th><th>Linjesum</th></tr>\n          </thead>\n          <tbody>\n            ${o.map(((e,t)=>{const n=toNumber(e.hours),r=toNumber(e.rate),a=n*r;return`<tr><td>${escapeHtml(e.type||`Arbejdstype ${t+1}`)}</td><td>${n.toLocaleString("da-DK",{maximumFractionDigits:2})}</td><td>${formatCurrency(r)} kr</td><td>${formatCurrency(a)} kr</td></tr>`})).join("")}\n          </tbody>\n        </table>\n      `:"<p>Ingen lønlinjer registreret.</p>"}\n    </section>\n    <section>\n      <h3>Oversigt</h3>\n      <div class="review-grid">\n        ${T}\n      </div>\n      ${I}\n    </section>\n    <section>\n      <h3>Løn & projektsum</h3>\n      <div class="totals">\n        <div><strong>Lønsum</strong><div>${formatCurrency(S)} kr</div></div>\n        <div><strong>Projektsum</strong><div>${formatCurrency(h)} kr</div></div>\n      </div>\n    </section>\n    <section>\n      <h3>Detaljer</h3>\n      ${document.getElementById("lonResult")?.innerHTML||"<p>Ingen beregning udført.</p>"}\n    </section>\n  `,document.body.appendChild(k);try{const{jsPDF:e,html2canvas:n}=await ensureExportLibsLazy(),a=await n(k,{scale:2,backgroundColor:"#ffffff"}),o=new e({unit:"px",format:[a.width,a.height]});o.addImage(a.toDataURL("image/png"),"PNG",0,0,a.width,a.height);const s=sanitizeFilename(t.baseName||r.sagsnummer||"akkordseddel");return{blob:o.output("blob"),baseName:s,fileName:`${s}.pdf`}}catch(e){return console.error("PDF eksport fejlede:",e),updateActionHint("PDF eksport fejlede. Prøv igen.","error"),null}finally{document.body.removeChild(k)}}async function exportPDF(e,t={}){const n=await exportPDFBlob(e,t);if(!n)return;const r=URL.createObjectURL(n.blob),a=document.createElement("a");a.href=r,a.download=n.fileName,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),updateActionHint("PDF er gemt til din enhed.","success")}async function exportZip(){if(validateSagsinfo())try{const{JSZip:e}=await ensureZipLibLazy();beregnLon();const t=buildCSVPayload(null,{skipValidation:!0,skipBeregn:!0});if(!t)return;const n=buildAkkordData({customSagsnummer:t.originalName||t.baseName}),r=await exportPDFBlob(t.originalName||t.baseName,{skipValidation:!0,skipBeregn:!0,data:n});if(!r)return;const a=buildAkkordJsonPayload(t.originalName||t.baseName,{skipValidation:!0,skipBeregn:!0,data:n}),o=new e;o.file(t.fileName,t.content),o.file(r.fileName,r.blob),a&&o.file(a.fileName,a.content);const s=await o.generateAsync({type:"blob"}),i=URL.createObjectURL(s),l=document.createElement("a"),d=a?.baseName||t.baseName||r.baseName||"akkordseddel";l.href=i,l.download=`${d}.zip`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(i),updateActionHint("ZIP med PDF og CSV er gemt.","success")}catch(e){console.error("ZIP eksport fejlede",e),updateActionHint("ZIP eksport fejlede. Prøv igen.","error")}else updateActionHint("Udfyld Sagsinfo for at eksportere.","error")}function exportAkkordJsonFile(){const e=buildAkkordJsonPayload();if(!e)return;triggerBlobDownload(new Blob([e.content],{type:"application/json"}),e.fileName),updateActionHint("Akkordseddel (JSON) er gemt.","success")}function importJSONProject(e){const t=new FileReader;t.onload=e=>{try{const t=e.target?.result,n=JSON.parse(t);if(!n||"object"!=typeof n)throw new Error("Ugyldigt JSON format");const r=n.data&&!n.sagsinfo?n.data:n;applyProjectSnapshot(normalizeImportedJsonSnapshot(r),{skipHint:!0}),updateActionHint("JSON sag er indlæst.","success")}catch(e){console.error("Kunne ikke importere JSON",e),updateActionHint("Kunne ikke importere JSON-filen.","error")}},t.onerror=()=>{updateActionHint("Kunne ikke læse filen.","error")},t.readAsText(e,"utf-8")}function uploadCSV(e){if(!e)return;if(!(/\.csv$/i.test(e.name)||e.type&&e.type.includes("csv")))return void updateActionHint("Vælg en gyldig CSV-fil for at importere.","error");const t=new FileReader;t.onload=e=>{try{applyCSVRows(parseCSV(e.target.result)),updateActionHint("CSV er importeret.","success")}catch(e){console.error("Kunne ikke importere CSV",e),updateActionHint("Kunne ikke importere CSV-filen.","error")}},t.readAsText(e,"utf-8")}function setupMobileKeyboardDismissal(){document.addEventListener("keydown",(e=>{if("Enter"!==e.key)return;const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.type?.toLowerCase?.()||"",r=t.inputMode?.toLowerCase?.()||"";"number"!==n&&"numeric"!==r&&"decimal"!==r||(e.preventDefault(),t.blur())})),document.addEventListener("change",(e=>{const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.type?.toLowerCase?.()||"",r=t.inputMode?.toLowerCase?.()||"";"number"!==n&&"numeric"!==r&&"decimal"!==r||"function"==typeof t.blur&&t.blur()}))}function setupServiceWorkerMessaging(){if(!("serviceWorker"in navigator))return;let e=!1;navigator.serviceWorker.addEventListener("message",(e=>{const t=e.data?.type;"CSMATE_UPDATED"!==t&&"SSCaff_NEW_VERSION"!==t||window.location.reload()})),navigator.serviceWorker.addEventListener("controllerchange",(()=>{e||(e=!0,window.location.reload())}))}function setupPWAInstallPrompt(){if("undefined"==typeof window)return;const e=document.getElementById("installBtn"),t=document.getElementById("iosInstallPrompt"),n=document.getElementById("iosInstallDismiss");if(!e&&!t)return;const r="function"==typeof window.matchMedia?window.matchMedia("(display-mode: standalone)"):null,a=()=>(r?.matches??!1)||!0===navigator.standalone;let o=!1;const s=()=>{e&&(e.setAttribute("hidden",""),e.disabled=!1,e.removeAttribute("title"))},i=()=>{e&&(o&&!a()?(e&&(e.removeAttribute("hidden"),e.disabled=!1,e.removeAttribute("title")),getDeferredInstallPromptEvent()?(e.disabled=!1,e.removeAttribute("title")):(e.disabled=!0,e.title=INSTALL_BUTTON_DISABLED_TOOLTIP)):s())},l=(e=!1)=>{if(t&&t.setAttribute("hidden",""),e)try{window.localStorage?.setItem(IOS_INSTALL_PROMPT_DISMISSED_KEY,"1")}catch(e){console.warn("Kunne ikke gemme iOS prompt flag",e)}},d=()=>{if(!t)return;const e=navigator.userAgent||"",n=/iphone|ipad|ipod/i.test(e),a=/safari/i.test(e)&&!/(crios|fxios|edgios)/i.test(e),o=(r?.matches??!1)||!0===navigator.standalone;n&&a&&!o&&!(()=>{try{return"1"===window.localStorage?.getItem(IOS_INSTALL_PROMPT_DISMISSED_KEY)}catch(e){return console.warn("Kunne ikke læse iOS prompt flag",e),!1}})()?t.removeAttribute("hidden"):t.setAttribute("hidden","")};(()=>{if(!("serviceWorker"in navigator)||!navigator.serviceWorker?.ready)return o=!0,void i();navigator.serviceWorker.ready.then((()=>{o=!0,i(),a()&&l(!0)})).catch((e=>{o=!0,i(),console.warn("Service worker blev ikke klar i tide til install-knappen",e)}))})(),window.addEventListener(PWA_INSTALL_AVAILABLE_EVENT,(()=>{i()})),window.addEventListener(PWA_INSTALL_CONSUMED_EVENT,(()=>{i()})),e?.addEventListener("click",(async()=>{const t=consumeDeferredInstallPromptEvent();if(t){e.disabled=!0,t.prompt();try{await t.userChoice}catch(e){console.warn("Install prompt failed",e)}finally{s()}}})),window.addEventListener("appinstalled",(()=>{s(),l(!0)})),r?.addEventListener&&r.addEventListener("change",(e=>{e.matches?(s(),l(!0)):(i(),d())})),n?.addEventListener("click",(()=>{l(!0)})),t?.addEventListener("keydown",(e=>{"Escape"===e.key&&l(!0)})),d(),i(),t&&t.addEventListener("click",(e=>{e.target===t&&l(!0)}))}async function hardResetApp(){if(navigator.serviceWorker){const e=await navigator.serviceWorker.getRegistrations();await Promise.all(e.map((e=>e.unregister())))}if(window.caches){const e=await caches.keys();await Promise.all(e.map((e=>caches.delete(e))))}if(window.indexedDB){const e=await(indexedDB.databases?.())||[];await Promise.all(e.map((e=>new Promise((t=>{if(!e?.name)return void t();const n=indexedDB.deleteDatabase(e.name);n.onsuccess=n.onerror=n.onblocked=()=>t()})))))}try{window.localStorage?.clear()}catch{}try{window.sessionStorage?.clear()}catch{}window.location.reload(!0)}"undefined"!=typeof window&&(window.cssmateBuildAkkordJsonPayload=(e={})=>{if("string"==typeof e)return buildAkkordJsonPayload(e,{});const{customSagsnummer:t,...n}=e||{};return buildAkkordJsonPayload(t,n)}),"undefined"!=typeof window&&(window.cssmateExportPDFBlob=exportPDFBlob);let appInitialized=!1;async function initApp(){if(appInitialized)return;appInitialized=!0;try{await ensureMaterialDatasets()}catch(e){console.error("Kunne ikke indlæse materialelisterne.",e),updateActionHint("Kunne ikke indlæse materialelisterne. Prøv at genindlæse siden.","error")}initTabs();const e=getDomElement("optaellingContainer");e&&(e.addEventListener("input",handleOptaellingInput),e.addEventListener("change",handleOptaellingInput)),addWorker(),setupGuideModal(),setupAdminControls(),setupA9Integration(),document.getElementById("btnBeregnLon")?.addEventListener("click",(()=>beregnLon())),document.getElementById("btnAddWorker")?.addEventListener("click",(()=>addWorker()));const t=getDomElement("jobHistorySelect"),n=getDomElement("btnLoadHistoryJob");t&&t.addEventListener("change",(e=>{updateHistorySummaryFromSelect();const t=Boolean(e?.target?.value);n&&(n.disabled=!t)})),n?.addEventListener("click",(()=>handleLoadCase())),["traelleloeft35","traelleloeft50"].forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>updateTotals())),t.addEventListener("change",(()=>updateTotals(!0))))})),["antalBoringHuller","antalLukHuller","antalBoringBeton","antalOpskydeligt","km","slaebePct"].forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>updateTotals())),t.addEventListener("change",(()=>updateTotals(!0))))})),sagsinfoFieldIds.forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>validateSagsinfo())),t.addEventListener("change",(()=>validateSagsinfo())))})),validateSagsinfo(),setupNumpad(),setupMobileKeyboardDismissal(),setupLazyExportPanelTriggers(),runWhenIdle((()=>{setupServiceWorkerMessaging(),setupPWAInstallPrompt()})),runWhenIdle((()=>setupZipExportHistoryHook())),document.getElementById("btnHardResetApp")?.addEventListener("click",(()=>{hardResetApp()}));const r=document.getElementById("calendarIcon");r&&r.addEventListener("click",(()=>{const e=document.getElementById("sagsdato");e&&("function"==typeof e.showPicker?e.showPicker():(e.focus(),"function"==typeof e.click&&e.click()))})),ensureMaterialDatasets().then((()=>{setupListSelectors(),renderOptaelling(),setupCSVImport(),populateRecentCases(),initExcelSystemSelector(),updateTotals(!0)})).catch((e=>{console.error("Materialelister kunne ikke indlæses",e),updateActionHint("Kunne ikke indlæse materialelisterne. Opdater siden for at prøve igen.","error")}))}function startApp(){initApp().catch((e=>{console.error("CSMate init fejlede",e),updateActionHint("Kunne ikke initialisere appen. Opdater siden for at prøve igen.","error")}))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",startApp,{once:!0}):startApp();