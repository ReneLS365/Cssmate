import{initMaterialsScrollLock}from"./src/modules/materialsscrolllock.js";import{calculateTotals}from"./src/modules/calculatetotals.js";import{normalizeKey}from"./src/lib/string-utils.js";import{EXCLUDED_MATERIAL_KEYS,shouldExcludeMaterialEntry}from"./src/lib/materials/exclusions.js";import{mergeExtrasKm,resolveKmInputValue}from"./src/lib/extras-helpers.js";import{createMaterialRow}from"./src/modules/materialrowtemplate.js";import{sha256Hex,constantTimeEquals}from"./src/lib/sha256.js";import{setupNumpad}from"./js/numpad.js";import{exportMeta,setSlaebFormulaText}from"./js/export-meta.js";import{buildAkkordData as buildSharedAkkordData}from"./js/akkord-data.js";import{buildExportModel as buildSharedExportModel}from"./js/export-model.js";import{convertMontageToDemontage}from"./js/akkord-converter.js";import{createVirtualMaterialsList}from"./src/modules/materialsvirtuallist.js";import{initClickGuard}from"./src/ui/guards/clickguard.js";import{setAdminOk,restoreAdminState,isAdminUnlocked}from"./src/state/admin.js";import{setActiveJob}from"./src/state/jobs.js";import"./boot-inline.js";function getCurrentAppVersion(){return"undefined"!=typeof window&&"string"==typeof window.CSSMATE_APP_VERSION?window.CSSMATE_APP_VERSION:"undefined"!=typeof self&&"string"==typeof self.CSSMATE_APP_VERSION?self.CSSMATE_APP_VERSION:"dev"}function showUpdateBanner(e,t){if("undefined"==typeof document)return;if(document.getElementById("cssmate-update-banner"))return;const n=document.createElement("div");if(n.id="cssmate-update-banner",n.style.position="fixed",n.style.left="0",n.style.right="0",n.style.bottom="0",n.style.zIndex="9999",n.style.padding="8px 12px",n.style.fontSize="12px",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.background="#222",n.style.color="#fff",n.innerHTML=`\n    <span>Ny version af Cssmate er klar (fra ${t} til ${e}).</span>\n    <button type="button" id="cssmate-update-btn">Opdater nu</button>\n  `,!document.body)return;document.body.appendChild(n);const a=document.getElementById("cssmate-update-btn");a&&(a.style.marginLeft="12px",a.style.padding="4px 10px",a.style.fontSize="12px",a.style.cursor="pointer",a.addEventListener("click",(()=>{"undefined"!=typeof window&&("undefined"!=typeof navigator&&"serviceWorker"in navigator?navigator.serviceWorker.getRegistrations().then((e=>Promise.all(e.map((e=>e.update()))))).finally((()=>{window.location.reload(!0)})):window.location.reload(!0))})))}function runWhenIdle(e){"function"!=typeof requestIdleCallback?setTimeout(e,150):requestIdleCallback(e,{timeout:1500})}async function ensureExportPanelModule(){return exportPanelPromise||(exportPanelPromise=import("./js/akkord-export-ui.js").then((e=>("function"==typeof e?.initExportPanel&&e.initExportPanel(),exportPanelReady=!0,e))).catch((e=>{throw exportPanelPromise=null,e})),exportPanelPromise)}function bindLazyExportAction(e,t){const n="undefined"!=typeof document?document.getElementById(e):null;n&&n.addEventListener("click",(async e=>{if(!exportPanelReady){e.preventDefault(),e.stopImmediatePropagation();try{const n=await ensureExportPanelModule(),a=n?.[t];"function"==typeof a&&a(e)}catch(e){console.error("Eksport-panel kunne ikke indlæses",e),updateActionHint("Kunne ikke indlæse eksport-funktionerne. Prøv igen.","error")}}}),{capture:!0})}function setupLazyExportPanelTriggers(){if("undefined"==typeof document)return;const e=document.querySelector(".export-panel");if(!e)return;const t=()=>{ensureExportPanelModule().catch((e=>{console.warn("Kunne ikke forberede eksportpanelet",e)})),ensureExportLibsLazy()?.catch?.((e=>console.warn("Kunne ikke loade eksportlibs",e))),ensureZipLibLazy()?.catch?.((e=>console.warn("Kunne ikke loade ZIP-lib",e)))};if(["pointerenter","touchstart","focusin"].forEach((n=>{e.addEventListener(n,t,{once:!0})})),"IntersectionObserver"in window){const n=new IntersectionObserver((e=>{e.some((e=>e.isIntersecting))&&(t(),n.disconnect())}),{rootMargin:"128px"});n.observe(e)}bindLazyExportAction("btn-export-akkord-pdf","handleExportAkkordPDF"),bindLazyExportAction("btn-import-akkord","handleImportAkkordAction"),bindLazyExportAction("btn-print-akkord","handlePrintAkkord")}async function ensureExportLibsLazy(){return exportLibsLoader||(exportLibsLoader=import("./src/features/export/lazy-libs.js").then((e=>e.ensureExportLibs()))),exportLibsLoader}async function ensureZipLibLazy(){return zipLibLoader||(zipLibLoader=import("./src/features/export/lazy-libs.js").then((e=>e.ensureZipLib()))),zipLibLoader}async function loadExcelExporter(){return excelExporterLoader||(excelExporterLoader=import("./src/export/akkord-excel.js").then((e=>e.exportAkkordExcelForActiveJob))),excelExporterLoader}"undefined"!=typeof document&&document.documentElement.classList.add("app-booting"),function(){if("undefined"==typeof window)return;const e=getCurrentAppVersion(),t="cssmate_app_version";try{const n=window.localStorage;if(!n)return;const a=n.getItem(t);a&&a!==e&&showUpdateBanner(e,a),n.setItem(t,e)}catch(e){console.warn("Unable to access localStorage for version check",e)}}();const IOS_INSTALL_PROMPT_DISMISSED_KEY="csmate.iosInstallPromptDismissed",TAB_STORAGE_KEY="csmate:lastTab",LEGACY_TAB_STORAGE_KEYS=["sscaff:lastTab","cssmate:lastActiveTab"],KNOWN_TAB_ID_ORDER=["sagsinfo","optaelling","lon","historik","hjaelp"],KNOWN_TAB_IDS=new Set(KNOWN_TAB_ID_ORDER),DEFAULT_TAB_ID=KNOWN_TAB_ID_ORDER[0],INSTALL_BUTTON_DISABLED_TOOLTIP="Tilføj via browsermenu på denne platform",PWA_INSTALL_AVAILABLE_EVENT="csmate:pwa-install-available",PWA_INSTALL_CONSUMED_EVENT="csmate:pwa-install-consumed";let DEFAULT_ADMIN_CODE_HASH="",materialsVirtualListController=null,currentTabId=null,exportPanelReady=!1,exportPanelPromise=null,exportLibsLoader=null,zipLibLoader=null,excelExporterLoader=null,tabButtons=[],tabPanels=[];const domCache=new Map;let deferredInstallPromptEvent=null,historyPersistencePaused=!1,materialsDataPromise=null,materialsUiReadyPromise=null,materialsWarmupScheduled=!1;function ensureMaterialsDataLoad(){return materialsDataPromise||(materialsDataPromise=ensureMaterialDatasets().catch((e=>{throw console.error("Kunne ikke indlæse materialelisterne.",e),updateActionHint("Kunne ikke indlæse materialelisterne. Prøv at genindlæse siden.","error"),materialsDataPromise=null,e}))),materialsDataPromise}function warmupMaterialsDataLoad(){materialsWarmupScheduled||(materialsWarmupScheduled=!0,runWhenIdle((()=>{ensureMaterialsDataLoad()?.catch((()=>{materialsWarmupScheduled=!1}))})))}function ensureMaterialsUiReady(){return materialsUiReadyPromise||(materialsUiReadyPromise=ensureMaterialsDataLoad().then((()=>{setupListSelectors(),renderOptaelling(),setupCSVImport(),populateRecentCases(),initExcelSystemSelector(),updateTotals(!0)})).catch((e=>{throw console.error("Materiale-UI kunne ikke initialiseres",e),updateActionHint("Kunne ikke initialisere materialelisterne. Opdater siden for at prøve igen.","error"),materialsUiReadyPromise=null,e}))),materialsUiReadyPromise}function setDeferredInstallPromptEvent(e){if(deferredInstallPromptEvent=e,"undefined"==typeof window||"function"!=typeof window.dispatchEvent)return;const t=e?PWA_INSTALL_AVAILABLE_EVENT:PWA_INSTALL_CONSUMED_EVENT;window.dispatchEvent(new Event(t))}function getDeferredInstallPromptEvent(){return deferredInstallPromptEvent}function consumeDeferredInstallPromptEvent(){const e=deferredInstallPromptEvent;return e&&setDeferredInstallPromptEvent(null),e}function pauseHistoryPersistence(){historyPersistencePaused=!0}function resumeHistoryPersistence(){historyPersistencePaused=!1}function isKnownTabId(e){return"string"==typeof e&&KNOWN_TAB_IDS.has(e)}function getDomElement(e){if(!e||"undefined"==typeof document||"function"!=typeof document.getElementById)return null;const t=domCache.get(e);if(t&&t.isConnected)return t;const n=document.getElementById(e);return n?domCache.set(e,n):domCache.delete(e),n}"undefined"!=typeof window&&(window.addEventListener("beforeinstallprompt",(e=>{e.preventDefault(),setDeferredInstallPromptEvent(e)})),window.addEventListener("appinstalled",(()=>{setDeferredInstallPromptEvent(null)})));const KNOWN_ADMIN_CODE_HASHES=new Set(["ff0a69fa196820f9529e3c20cfa809545e6697f5796527f7657a83bb7e6acd0d"]),KNOWN_ADMIN_CODES=new Set(["StilAce"]);async function loadDefaultAdminCode(){try{const e=await fetch("./data/tenants/hulmose.json");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();t&&"string"==typeof t._meta?.admin_code&&(DEFAULT_ADMIN_CODE_HASH=t._meta.admin_code,KNOWN_ADMIN_CODE_HASHES.add(DEFAULT_ADMIN_CODE_HASH))}catch(e){console.warn("Kunne ikke indlæse standard admin-kode",e)}}loadDefaultAdminCode();let admin=restoreAdminState();function updateSlaebFormulaInfo(e){const t=document.getElementById("slaebPercentCalcInfo");if(!t)return;const n="string"==typeof e?e.trim():"";t.textContent=n?`Formel (A9): ${n}`:""}"undefined"!=typeof document&&initClickGuard();let guideModalLastFocus=null,guideModalEscapeHandler=null;function getGuideModalElement(){return document.getElementById("guideModal")}function attachGuideModalEscapeHandler(){guideModalEscapeHandler||"undefined"==typeof document||(guideModalEscapeHandler=e=>{"Escape"===e.key&&isGuideModalOpen()&&(e.preventDefault(),closeGuideModal())},document.addEventListener("keydown",guideModalEscapeHandler))}function detachGuideModalEscapeHandler(){guideModalEscapeHandler&&"undefined"!=typeof document&&(document.removeEventListener("keydown",guideModalEscapeHandler),guideModalEscapeHandler=null)}function openGuideModal(){const e=getGuideModalElement();if(!e)return;guideModalLastFocus=document.activeElement instanceof HTMLElement?document.activeElement:null,e.removeAttribute("hidden"),e.dataset.open="true",e.classList.add("open"),e.setAttribute("aria-hidden","false");const t=e.querySelector(".modal-content");t&&"function"==typeof t.focus&&t.focus(),attachGuideModalEscapeHandler()}function closeGuideModal(){const e=getGuideModalElement();if(!e)return;e.classList.remove("open"),e.removeAttribute("data-open"),e.setAttribute("aria-hidden","true"),e.setAttribute("hidden",""),detachGuideModalEscapeHandler();const t=guideModalLastFocus;guideModalLastFocus=null,t&&document.contains(t)&&"function"==typeof t.focus&&t.focus()}function isGuideModalOpen(){const e=getGuideModalElement();return Boolean(e&&"true"===e.dataset.open)}function setupGuideModal(){const e=getGuideModalElement();if(!e)return;const t=e.querySelector(".modal-close");t&&t.addEventListener("click",(()=>closeGuideModal())),e.addEventListener("click",(t=>{t.target===e&&closeGuideModal()})),document.getElementById("btnOpenGuideModal")?.addEventListener("click",(()=>{openGuideModal()}))}function setupAdminControls(){const e=document.getElementById("btnHardResetApp");if(!e)return;const t=t=>{t?(e.removeAttribute("hidden"),e.disabled=!1):(e.setAttribute("hidden",""),e.disabled=!0)};t(isAdminUnlocked()),document.addEventListener("csmate:admin-change",(e=>{t(Boolean(e?.detail?.unlocked))}))}function getStoredTabId(){try{const e=window.localStorage;if(!e)return"";const t=e.getItem(TAB_STORAGE_KEY);if(isKnownTabId(t))return t;for(const t of LEGACY_TAB_STORAGE_KEYS){const n=e.getItem(t);if(isKnownTabId(n))return n}}catch{}return""}function focusTabByIndex(e){if(!ensureTabCollections())return;const t=(e+tabButtons.length)%tabButtons.length,n=tabButtons[t];n&&setActiveTab(n.dataset.tabId,{focus:!0})}function handleTabKeydown(e,t){const n=e.key;if("ArrowRight"!==n&&"ArrowLeft"!==n){if("Home"===n)return e.preventDefault(),void focusTabByIndex(0);if("End"===n)return e.preventDefault(),void focusTabByIndex(tabButtons.length-1);if(" "===n||"Enter"===n){e.preventDefault();const n=tabButtons[t];n&&setActiveTab(n.dataset.tabId,{focus:!0})}}else{e.preventDefault();focusTabByIndex(t+("ArrowRight"===n?1:-1))}}function refreshTabCollections(){if("undefined"==typeof document)return tabButtons=[],void(tabPanels=[]);tabButtons=Array.from(document.querySelectorAll('[role="tab"][data-tab-id]')).filter((e=>isKnownTabId(e.dataset.tabId))),tabPanels=Array.from(document.querySelectorAll('[role="tabpanel"][data-tab-panel]')).filter((e=>isKnownTabId(e.dataset.tabPanel)))}function ensureTabCollections(){return tabButtons.length&&tabPanels.length||refreshTabCollections(),tabButtons.length&&tabPanels.length}function findFirstAvailableTabId(){const e=KNOWN_TAB_ID_ORDER.find((e=>tabButtons.some((t=>t.dataset.tabId===e))));return e||(tabButtons[0]?.dataset.tabId||DEFAULT_TAB_ID)}function setActiveTab(e,{focus:t=!1}={}){if(!ensureTabCollections())return;const n=isKnownTabId(e)?e:DEFAULT_TAB_ID,a=tabButtons.find((e=>e.dataset.tabId===n))||tabButtons.find((e=>e.dataset.tabId===DEFAULT_TAB_ID))||tabButtons[0];if(!a)return void console.warn("Faneknap ikke fundet for id",e);const r=a.dataset.tabId;if(!r)return void console.warn("Faneknap mangler data-tab-id",a);const o=tabPanels.find((e=>e.dataset.tabPanel===r));if(o)if(currentTabId!==r){tabButtons.forEach((e=>{const t=e===a;e.classList.toggle("tab--active",t),e.setAttribute("aria-selected",t?"true":"false"),e.tabIndex=t?0:-1})),tabPanels.forEach((e=>{const t=e===o;e.classList.toggle("tab-panel--active",t),t?(e.removeAttribute("hidden"),e.setAttribute("aria-hidden","false")):(e.setAttribute("hidden",""),e.setAttribute("aria-hidden","true"))})),currentTabId=r;try{const e=window.localStorage;e&&isKnownTabId(r)&&(e.setItem(TAB_STORAGE_KEY,r),LEGACY_TAB_STORAGE_KEYS.forEach((t=>{try{e.setItem(t,r)}catch{}})))}catch{}"optaelling"===r&&ensureMaterialsUiReady().catch((()=>{})),"lon"===r&&ensureWorkersInitialized(),t&&"function"==typeof a.focus&&a.focus()}else t&&"function"==typeof a.focus&&a.focus();else console.warn("Tab-panel ikke fundet for id",r)}function initTabs(){if(refreshTabCollections(),!tabButtons.length||!tabPanels.length)return void console.warn("Faner kunne ikke initialiseres – mangler markup");tabButtons.forEach(((e,t)=>{const n=e.dataset.tabId,a="true"===e.getAttribute("aria-selected");e.tabIndex=a?0:-1,e.addEventListener("click",(()=>setActiveTab(n))),e.addEventListener("keydown",(e=>handleTabKeydown(e,t)))}));const e=tabButtons.find((e=>"optaelling"===e.dataset.tabId));if(e){const t=()=>warmupMaterialsDataLoad();["pointerenter","touchstart","focusin"].forEach((n=>{e.addEventListener(n,t,{once:!0,passive:!0})}))}const t=getStoredTabId();setActiveTab(tabButtons.some((e=>e.dataset.tabId===t))?t:tabButtons.find((e=>"true"===e.getAttribute("aria-selected")))?.dataset.tabId||findFirstAvailableTabId(),{focus:!1}),"undefined"!=typeof window&&(window.__cssmateSetActiveTab=(e,t)=>setActiveTab(e,t))}function setupA9Integration(){const e=document.querySelector('input[data-a9-slaeb="true"]'),t=document.querySelector(".js-slaeb-calc-link");if(t){const e=t.dataset.calcUrl||"https://cala9.netlify.app/";t.addEventListener("click",(t=>{t&&(t.preventDefault(),t.stopPropagation()),window.open(e,"_blank","noopener,noreferrer")}))}if(!e)return;e.addEventListener("a9-commit",(e=>{const t="string"==typeof e?.detail?.formulaText?e.detail.formulaText:"";setSlaebFormulaText(t),updateSlaebFormulaInfo(t)}));const n=()=>{if("1"===e.dataset.a9Commit)return;setSlaebFormulaText("");const t=e.value?.trim();updateSlaebFormulaInfo(t?`Manuel værdi: ${t}`:"")};e.addEventListener("input",n),e.addEventListener("change",n),updateSlaebFormulaInfo(exportMeta.slaebFormulaText)}function formatCurrency(e){return new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0)}function toNumber(e){if("number"==typeof e)return Number.isFinite(e)?e:0;if(null==e)return 0;const t=String(e).trim();if(!t)return 0;const n=t.replace(/\s+/g,"").replace(/'/g,""),a=n.match(/[.,]/g)||[];let r=n.replace(/[^0-9.,-]/g,"");if(a.length>1){const e=a[a.length-1],t=r.lastIndexOf(e),n=r.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=r.slice(t+1).replace(/[^0-9]/g,"");r=`${n||"0"}.${o}`}else if(1===a.length)if(/^-?\d{1,3}(?:[.,]\d{3})+$/.test(r))r=r.replace(/[.,]/g,"").replace(/(?!^)-/g,"");else{const e=a[0],t=r.lastIndexOf(e),n=r.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=r.slice(t+1).replace(/[^0-9]/g,"");r=`${n||"0"}.${o}`}else r=r.replace(/(?!^)-/g,"");const o=Number.parseFloat(r);return Number.isFinite(o)?o:0}function formatNumber(e){const t=Number.isFinite(e)?e:parseFloat(e)||0;return new Intl.NumberFormat("da-DK",{minimumFractionDigits:0,maximumFractionDigits:2}).format(t)}let workerCount=0,laborEntries=[],lastLoensum=0,lastMaterialSum=0,lastEkompletData=null,lastJobSummary=null,recentCasesCache=[];function buildHistoryKey(e){const t=e?.sagsinfo||{},n=(t.sagsnummer||"").trim().toLowerCase();if(n)return`case:${n}`;const a=(t.navn||"").trim().toLowerCase(),r=(t.kunde||"").trim().toLowerCase();return a||r?`case:${a}|${r}`:null}function syncRecentProjectsGlobal(e=recentCasesCache){if("undefined"==typeof window)return;const t=Array.isArray(e)?e.slice():[];window.__cssmateRecentProjects=t}syncRecentProjectsGlobal([]);let cachedDBPromise=null;const DEFAULT_ACTION_HINT="Udfyld Sagsinfo for at fortsætte.",DB_NAME="csmate_projects",DB_STORE="projects",TRAELLE_RATE35=10.44,TRAELLE_RATE50=14.62,BORING_HULLER_RATE=4.7,LUK_HULLER_RATE=3.45,BORING_BETON_RATE=11.49,OPSKYDELIGT_RATE=9.67,KM_RATE=2.12,TILLAEG_UDD1=42.98,TILLAEG_UDD2=49.38,DEFAULT_MENTOR_RATE=22.26,AKKORD_EXCEL_SYSTEMS=[{id:"bosta",label:"BOSTA 2025"},{id:"haki",label:"HAKI 2025"},{id:"modex",label:"MODEX 2025"},{id:"alfix",label:"ALFIX 2025"}],AKKORD_EXCEL_STORAGE_KEY="csmate.akkordExcelSystem";let systemDatasets={},dataBosta=[],dataHaki=[],dataModex=[],dataAlfix=[],systemOptions=[],systemLabelMap=new Map;const selectedSystemKeys=new Set;let excelSystemSelectionCache=new Set(["bosta"]),datasetModulePromise=null,materialsReady=!1,showOnlySelectedMaterials=!1,lastRenderShowSelected=null,lonOutputsRevealed=!1;function loadMaterialDatasetModule(){return datasetModulePromise||(datasetModulePromise=import("./dataset.js")),datasetModulePromise}function createSystemMaterialState(e){return e&&Array.isArray(e.items)?e.items.filter((e=>{const t="string"==typeof e?.category?e.category.toLowerCase():"material";if(t&&"material"!==t&&"materiale"!==t)return!1;const n=normalizeKey(String(e?.name||e?.navn||e?.beskrivelse||"").trim());return n&&!EXCLUDED_MATERIAL_KEYS.includes(n)})).map(((t,n)=>{const a=t?.name||t?.navn||t?.beskrivelse||"",r=a?.trim()||`${e.id} materiale ${n+1}`;return{id:t?.id||t?.varenr||`${e.id}-${n+1}`,name:r,price:toNumber(t?.price??t?.pris??0),unit:t?.unit||t?.enhed||"",quantity:0,systemKey:e.id,category:"string"==typeof t?.category?t.category.toLowerCase():"material"}})):[]}async function ensureMaterialDatasets(){if(systemOptions.length)return systemOptions;const e=await loadMaterialDatasetModule(),t="function"==typeof e.getAllSystems?e.getAllSystems():[];systemDatasets={},t.forEach((e=>{systemDatasets[e.id]=createSystemMaterialState(e)})),dataBosta=systemDatasets.bosta??[],dataHaki=systemDatasets.haki??[],dataModex=systemDatasets.modex??[],dataAlfix=systemDatasets.alfix??[],systemOptions=t.map((e=>({key:e.id,label:e.label,dataset:systemDatasets[e.id]??[]})));const n=Object.keys(e.MATERIAL_SYSTEMS||{}).map((t=>{const n="function"==typeof e.getSystemList?e.getSystemList(t):null;return[t,n?.label??t]}));return systemLabelMap=new Map(n),materialsReady=!0,ensureSystemSelection(),systemOptions}function ensureSystemSelection(){0===selectedSystemKeys.size&&systemOptions.length&&selectedSystemKeys.add(systemOptions[0].key)}function getSelectedSystemKeys(){return ensureSystemSelection(),Array.from(selectedSystemKeys)}function isSupportedExcelSystem(e){return!!e&&AKKORD_EXCEL_SYSTEMS.some((t=>t.id===e))}function normalizeExcelSystemId(e){return"string"==typeof e?e.trim().toLowerCase():""}function sanitizeExcelSystemSelection(e){const t=Array.isArray(e)?e:"string"==typeof e?[e]:e&&"function"==typeof e[Symbol.iterator]?Array.from(e):[],n=[];return t.forEach((e=>{const t=normalizeExcelSystemId(e);isSupportedExcelSystem(t)&&!n.includes(t)&&n.push(t)})),n}function getStoredExcelSystems(){if("undefined"==typeof localStorage)return Array.from(excelSystemSelectionCache);try{const e=localStorage.getItem(AKKORD_EXCEL_STORAGE_KEY);if(null===e)return Array.from(excelSystemSelectionCache);let t=[];try{t=JSON.parse(e)}catch{t=e?[e]:[]}const n=sanitizeExcelSystemSelection(t);return excelSystemSelectionCache=new Set(n),n}catch(e){return console.warn("Kunne ikke læse Excel-systemer fra storage",e),Array.from(excelSystemSelectionCache)}}function setStoredExcelSystems(e){const t=sanitizeExcelSystemSelection(e);if(excelSystemSelectionCache=new Set(t),"undefined"!=typeof localStorage)try{localStorage.setItem(AKKORD_EXCEL_STORAGE_KEY,JSON.stringify(t))}catch(e){console.warn("Kunne ikke gemme Excel-systemer",e)}}function getPreferredExcelSystem(){const e=getStoredExcelSystems();if(e.length>0&&isSupportedExcelSystem(e[0]))return e[0];const t=getSelectedSystemKeys().find((e=>isSupportedExcelSystem(e)));return t||(AKKORD_EXCEL_SYSTEMS[0]?.id||"bosta")}function getDatasetForSelectedSystems(e){const t=[],n=(Array.isArray(e)?e:e&&"function"==typeof e[Symbol.iterator]?Array.from(e):[]).map((e=>normalizeKey(e))),a=new Set(n),r=(e,n)=>{if(!Array.isArray(n))return;e.some((e=>a.has(normalizeKey(e))))&&t.push(n)};return r(["bosta","bostadata"],dataBosta),r(["haki","hakidata"],dataHaki),r(["modex","modexdata"],dataModex),r(["alfix","alfixdata"],dataAlfix),t.flat()}function toggleDuplicateWarning(e=[],t=[]){const n=document.getElementById("systemDuplicateWarning");if(!n)return;const a=Array.from(new Set(e.filter(Boolean))).slice(0,6),r=Array.from(new Set(t.filter(Boolean))).slice(0,6);if(0===a.length&&0===r.length)return n.textContent="",void n.setAttribute("hidden","");const o=[];a.length&&o.push(`Materialer slået sammen: ${a.join(", ")}`),r.length&&o.push(`Kontroller varenr.: ${r.join(", ")}`),n.textContent=o.join(". "),n.removeAttribute("hidden")}function aggregateSelectedSystemData(){const e=getDatasetForSelectedSystems(getSelectedSystemKeys()),t=[],n=new Map,a=new Map,r=new Set,o=new Set;return e.forEach((e=>{if(!e)return;const s=null!=e.id?String(e.id):null,i=e.name?normalizeKey(e.name):null,l=i?`${e.systemKey||"global"}::${i}`:null,u=l?a.get(l):null;if(u&&u!==e)return r.add(u.name),void r.add(e.name);const d=s?n.get(s):null;if(d&&d!==e){const t=d.name?normalizeKey(d.name):null;if(t&&i&&t===i)return r.add(d.name),void r.add(e.name);o.add(d.name),o.add(e.name)}t.push(e),s&&n.set(s,e),l&&a.set(l,e)})),toggleDuplicateWarning(Array.from(r),Array.from(o)),t}const manualMaterials=Array.from({length:3},((e,t)=>({id:`manual-${t+1}`,name:"",price:0,quantity:0,manual:!0})));function getAllData(e=!0){const t=aggregateSelectedSystemData();return e?t.concat(manualMaterials):t}function getActiveMaterialList(){return aggregateSelectedSystemData()}function getRenderMaterials(){const e=getActiveMaterialList(),t=Array.isArray(e)?e.concat(manualMaterials):manualMaterials.slice();return showOnlySelectedMaterials?t.filter((e=>toNumber(e?.quantity)>0)):t}function findMaterialById(e){const t=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const n of t){const t=n.find((t=>String(t.id)===String(e)));if(t)return t}return null}function setupListSelectors(){const e=getDomElement("listSelectors");if(!e)return;const t="systemSelectionWarning",n=systemOptions.map((e=>{const t=selectedSystemKeys.has(e.key)?"checked":"";return`\n        <label class="system-option">\n          <input type="checkbox" value="${e.key}" ${t}>\n          <span>${e.label}</span>\n        </label>\n      `})).join("");e.innerHTML=`\n    <div class="system-selector" role="group" aria-labelledby="systemSelectorLabel">\n      <span id="systemSelectorLabel" class="cell-label">Systemer</span>\n      <div class="system-selector-options">${n}</div>\n    </div>\n    <p id="${t}" class="hint system-warning" hidden>Vælg mindst ét system.</p>\n    <p id="systemDuplicateWarning" class="hint system-warning" hidden></p>\n  `,syncSystemSelectorState();const a=document.getElementById(t);e.addEventListener("change",(e=>{const t=e.target;if(!(t instanceof HTMLInputElement)||"checkbox"!==t.type)return;const{value:n}=t;if(t.checked)selectedSystemKeys.add(n);else if(selectedSystemKeys.delete(n),0===selectedSystemKeys.size)return a?.removeAttribute("hidden"),selectedSystemKeys.add(n),t.checked=!0,void updateActionHint("Vælg mindst ét system for at fortsætte optællingen.","error");a?.setAttribute("hidden","");const r=getDomElement("actionHint");r&&"Vælg mindst ét system for at fortsætte optællingen."===r.textContent&&updateActionHint(""),renderOptaelling(),updateTotals(!0)}))}function syncSystemSelectorState(){const e=getDomElement("listSelectors");e&&e.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=selectedSystemKeys.has(e.value)}))}function renderOptaelling(){const e=getDomElement("optaellingContainer");if(!e)return;const t=document.getElementById("showSelectedOnly");t&&(t.checked=showOnlySelectedMaterials,t.onchange=()=>{showOnlySelectedMaterials=t.checked,lastRenderShowSelected=null,renderOptaelling()});const n=t=>{e.textContent="";const n=document.createElement("p");n.className="empty-state",n.textContent=t,e.appendChild(n),materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null)};if(!materialsReady)return void n("Indlæser materialelister...");syncSystemSelectorState();const a=getActiveMaterialList(),r=Array.isArray(a)?a.concat(manualMaterials):manualMaterials.slice(),o=getRenderMaterials();if(!r.length)return void n("Ingen systemer valgt. Vælg et eller flere systemer for at starte optællingen.");if(!o.length)return void n("Ingen materialer med antal.");e.querySelectorAll(".empty-state").forEach((e=>e.remove()));let s=e.querySelector(".materials-list");s||(e.textContent="",s=document.createElement("div"),s.className="materials-list csm-materials-list",e.appendChild(s)),s.classList.add("csm-materials-list");const i=(e,t)=>{const n=createMaterialRow(e,{admin:admin,toNumber:toNumber,formatCurrency:formatCurrency,systemLabelMap:systemLabelMap}),a=n?.row||n;return a&&(a.dataset.index=String(t)),n};if(lastRenderShowSelected!==showOnlySelectedMaterials&&materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null),lastRenderShowSelected=showOnlySelectedMaterials,materialsVirtualListController&&materialsVirtualListController.container===s)materialsVirtualListController.controller.update(o);else{const e=createVirtualMaterialsList({container:s,items:o,renderRow:i,rowHeight:64,overscan:8});materialsVirtualListController={container:s,controller:e}}initMaterialsScrollLock(e),updateTotals(!0)}function handleOptaellingInput(e){const t=e.target;t&&t.classList&&(t.classList.contains("qty")?handleQuantityChange(e):t.classList.contains("price")?handlePriceChange(e):t.classList.contains("manual-name")&&handleManualNameChange(e))}function handleQuantityChange(e){const{id:t}=e.target.dataset;updateQty(t,e.target.value)}function handlePriceChange(e){const{id:t}=e.target.dataset;updatePrice(t,e.target.value)}function handleManualNameChange(e){const{id:t}=e.target.dataset,n=findMaterialById(t);n&&n.manual&&(n.name=e.target.value)}function findMaterialRowElement(e){const t=document.querySelectorAll(".material-row");return Array.from(t).find((t=>Array.from(t.querySelectorAll("input[data-id]")).some((t=>t.dataset.id===String(e)))))||null}function updateQty(e,t){const n=findMaterialById(e);if(!n)return;const a=toNumber(n.quantity),r=toNumber(t);if(n.quantity=r,refreshMaterialRowDisplay(e),updateTotals(),showOnlySelectedMaterials){a>0!==r>0&&renderOptaelling()}}function updatePrice(e,t){const n=findMaterialById(e);n&&(n.manual||admin)&&(n.price=toNumber(t),refreshMaterialRowDisplay(e),updateTotals())}function refreshMaterialRowDisplay(e){const t=findMaterialById(e);if(!t)return;const n=findMaterialRowElement(e);if(!n)return;const a=n.querySelector("input.qty");if(a&&document.activeElement!==a)if(t.manual){const e=null!==t.quantity&&void 0!==t.quantity&&""!==t.quantity;a.value=e?String(t.quantity):""}else{const e=null!=t.quantity?t.quantity:0;a.value=String(e)}const r=n.querySelector("input.price");if(r&&document.activeElement!==r){const e=null!==t.price&&void 0!==t.price&&""!==t.price,n=e?toNumber(t.price):"";if(t.manual)r.value=e?String(n):"",r.readOnly=!1;else{const e=toNumber(t.price);r.value=Number.isFinite(e)?e.toFixed(2):"0.00",r.readOnly=!admin}r.dataset.price=e?String(n):""}const o=n.querySelector(".mat-line");if(o)if("undefined"!=typeof window&&"function"==typeof window.updateMaterialLine)window.updateMaterialLine(n,{formatPrice:!0,shouldUpdateTotals:!1});else{const e=`${formatCurrency(toNumber(t.price)*toNumber(t.quantity))} kr`;o instanceof HTMLInputElement?o.value=e:o.textContent=e}}function calcMaterialesum(){return getAllData().reduce(((e,t)=>e+toNumber(t.price)*toNumber(t.quantity)),0)}function renderCurrency(e,t){let n=[];if("string"==typeof e?n=Array.from(document.querySelectorAll(e)):e instanceof Element?n=[e]:e&&"number"==typeof e.length&&(n=Array.from(e)),0===n.length)return;const a=`${formatCurrency(t)} kr`;n.forEach((e=>{e.textContent=a}))}let totalsUpdateTimer=null;function computeTraelleTotals(){const e=toNumber(document.getElementById("traelleloeft35")?.value),t=toNumber(document.getElementById("traelleloeft50")?.value),n={n35:e,n50:t,RATE35:10.44,RATE50:14.62,sum:10.44*e+14.62*t};return"undefined"!=typeof window&&(window.__traelleloeft=n),n}function performTotalsUpdate(){const e=computeTraelleTotals(),t=e&&Number.isFinite(e.sum)?e.sum:0,n="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,a=getAllData().map((e=>({qty:toNumber(e?.quantity),unitPrice:toNumber(e?.price)*n}))),r=calcMaterialesum()+t,o=toNumber(document.getElementById("slaebePct")?.value),s=r*(Number.isFinite(o)?o/100:0),i={"tralleløft":t,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},l=Array.isArray(laborEntries)?laborEntries.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)}))):[],u=l.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),d=calculateTotals({materialLines:a,slaebeBelob:s,extra:i,workers:l,totalHours:u});lastMaterialSum=d.samletAkkordsum,lastLoensum=d.montoerLonMedTillaeg,renderCurrency('[data-total="material"]',d.samletAkkordsum),renderCurrency('[data-total="labor"]',d.montoerLonMedTillaeg),renderCurrency('[data-total="project"]',d.projektsum);const c=document.getElementById("montagepris");c&&(c.value=r.toFixed(2));const m=document.getElementById("demontagepris");m&&(m.value=(.5*r).toFixed(2))}function updateTotals(e={}){if(!0===e||e?.immediate)return totalsUpdateTimer&&(clearTimeout(totalsUpdateTimer),totalsUpdateTimer=null),void performTotalsUpdate();totalsUpdateTimer&&clearTimeout(totalsUpdateTimer),totalsUpdateTimer=setTimeout((()=>{totalsUpdateTimer=null,performTotalsUpdate()}),80)}function updateTotal(){updateTotals()}const sagsinfoFieldIds=["sagsnummer","sagsnavn","sagsadresse","sagskunde","sagsdato","sagsmontoer"];function collectSagsinfo(){const e=e=>getDomElement(e)?.value??"";return{sagsnummer:e("sagsnummer").trim(),navn:e("sagsnavn").trim(),adresse:e("sagsadresse").trim(),kunde:e("sagskunde").trim(),dato:e("sagsdato"),montoer:e("sagsmontoer").trim()}}function setSagsinfoField(e,t){const n=getDomElement(e);n&&(n.value=t)}function updateActionHint(e="",t="info"){const n=getDomElement("actionHint");if(n){if(n.classList.remove("error","success"),!e)return n.textContent=DEFAULT_ACTION_HINT,n.style.display="",void(n.style.visibility="hidden");n.textContent=e,"error"===t?n.classList.add("error"):"success"===t&&n.classList.add("success"),n.style.display="",n.style.visibility="visible"}}function promisifyRequest(e){return e?new Promise(((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)})):Promise.resolve(void 0)}function openDB(){return cachedDBPromise||("undefined"==typeof indexedDB?(cachedDBPromise=Promise.reject(new Error("IndexedDB er ikke tilgængelig")),cachedDBPromise.catch((()=>{})),cachedDBPromise):(cachedDBPromise=new Promise(((e,t)=>{const n=indexedDB.open(DB_NAME,1);n.onupgradeneeded=e=>{const t=e.target?.result;t&&!t.objectStoreNames.contains(DB_STORE)&&t.createObjectStore(DB_STORE,{keyPath:"id",autoIncrement:!0})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error||new Error("IndexedDB kunne ikke åbnes"))})),cachedDBPromise.catch((()=>{cachedDBPromise=null})),cachedDBPromise))}async function saveProject(e){if(e)try{const t=await openDB();if(!t)return;const n=t.transaction(DB_STORE,"readwrite"),a=new Promise(((e,t)=>{n.oncomplete=()=>e(),n.onabort=()=>t(n.error||new Error("Transaktionen blev afbrudt")),n.onerror=()=>t(n.error||new Error("Transaktionen fejlede"))})),r=n.objectStore(DB_STORE),o=Date.now(),s=buildHistoryKey(e),i=await promisifyRequest(r.getAll()),l=s&&Array.isArray(i)?i.find((e=>buildHistoryKey(e?.data)===s)):null,u=l&&null!=l.id?{...l,data:e,ts:o,id:l.id}:{data:e,ts:o};null!=u.id?await promisifyRequest(r.put(u)):await promisifyRequest(r.add(u));const d=await promisifyRequest(r.getAll()),c=Array.isArray(d)?d.slice().sort(((e,t)=>(t.ts||0)-(e.ts||0))):[],m=new Set,p=[];for(const e of c){const t=buildHistoryKey(e?.data)||`id:${e?.id}`;m.has(t)?e&&null!=e.id&&await promisifyRequest(r.delete(e.id)):(m.add(t),p.push(e))}if(p.length>20){const e=p.slice(20);for(const t of e)t&&null!=t.id&&await promisifyRequest(r.delete(t.id))}await a}catch(e){console.warn("Kunne ikke gemme sag lokalt",e)}}async function deleteProjectById(e){if(!Number.isFinite(e)||e<=0)return!1;try{const t=await openDB();if(!t)return!1;const n=t.transaction(DB_STORE,"readwrite"),a=new Promise(((e,t)=>{n.oncomplete=()=>e(!0),n.onabort=()=>t(n.error||new Error("Transaktionen blev afbrudt")),n.onerror=()=>t(n.error||new Error("Transaktionen fejlede"))}));return n.objectStore(DB_STORE).delete(Number(e)),await a,!0}catch(e){return console.warn("Kunne ikke slette sag",e),!1}}async function getRecentProjects(){try{const e=await openDB();if(!e)return[];const t=e.transaction(DB_STORE,"readonly"),n=new Promise(((e,n)=>{t.oncomplete=()=>e(),t.onabort=()=>n(t.error||new Error("Transaktionen blev afbrudt")),t.onerror=()=>n(t.error||new Error("Transaktionen fejlede"))})),a=t.objectStore(DB_STORE),r=await promisifyRequest(a.getAll());return await n,Array.isArray(r)?r.filter((e=>e&&e.data)).sort(((e,t)=>(t.ts||0)-(e.ts||0))):[]}catch(e){return console.warn("Kunne ikke hente lokale sager",e),[]}}function setHistoryListBusy(e){const t=getDomElement("historyList");t&&(t.setAttribute("aria-busy",e?"true":"false"),t.classList.toggle("is-loading",Boolean(e)))}function formatHistoryTimestamp(e){if(!e)return"";const t=new Date(e);if(Number.isNaN(t.valueOf()))return"";try{return new Intl.DateTimeFormat("da-DK",{dateStyle:"medium",timeStyle:"short"}).format(t)}catch{return t.toLocaleString("da-DK")}}function renderHistoryList(e=recentCasesCache){const t=getDomElement("historyList");if(!t)return;t.innerHTML="";const n=Array.isArray(e)?e.filter((e=>e&&e.data)):[];if(!n.length){const e=document.createElement("li");return e.className="history-list__empty",e.textContent="Ingen historik endnu.",t.appendChild(e),void setHistoryListBusy(!1)}n.slice(0,10).forEach((e=>{const n=document.createElement("li");n.className="history-list__item";const a=e.data?.sagsinfo||{},r=a.navn?.trim()||a.sagsnummer?.trim()||"Sag uden navn",o=document.createElement("span");o.className="history-list__title",o.textContent=r;const s=document.createElement("span");s.className="history-list__meta";const i=[];a.sagsnummer&&i.push(a.sagsnummer);const l=Array.isArray(e.data?.systems)?e.data.systems.map((e=>systemLabelMap.get(e)||e)).filter(Boolean):[];l.length&&i.push(l.join(", "));const u=formatHistoryTimestamp(e.ts||e.data?.timestamp);u&&i.push(u);const d=e.data?.totals;if(d){const e=toNumber(d.materialSum)+toNumber(d.laborSum);e>0&&i.push(`Sum ${formatCurrency(e)}`)}s.textContent=i.join(" • "),n.appendChild(o),i.length&&n.appendChild(s);const c=document.createElement("div");c.className="history-list__actions";const m=document.createElement("button");m.type="button",m.className="history-list__delete",m.dataset.id=e.id,m.dataset.action="delete-history",m.textContent="Slet",c.appendChild(m),n.appendChild(c),t.appendChild(n)})),setHistoryListBusy(!1)}function setupHistoryListActions(){const e=getDomElement("historyList");e&&"true"!==e.dataset.boundDelete&&(e.dataset.boundDelete="true",e.addEventListener("click",(async e=>{const t=e.target instanceof HTMLElement?e.target.closest('[data-action="delete-history"]'):null;if(!t)return;const n=Number(t.dataset.id);if(!(n>0))return;if(!window.confirm("Er du sikker på, at du vil slette denne sag?"))return;t.disabled=!0;await deleteProjectById(n)?(recentCasesCache=recentCasesCache.filter((e=>Number(e?.id)!==n)),syncRecentProjectsGlobal(recentCasesCache),renderHistoryList(recentCasesCache),populateRecentCases()):t.disabled=!1})))}function findHistoryEntryById(e){return!Number.isFinite(e)||e<=0?null:recentCasesCache.find((t=>Number(t?.id)===e))||null}function buildHistorySummary(e){if(!e||!e.data)return null;const t=e.data.totals||{},n=toNumber(t.timer??t.totalHours),a=toNumber(t.hourlyBase??t.akkordTimeLon??t.timeprisUdenTillaeg),r=toNumber(t.mentorRate),o=r>0?r:22.26;let s=toNumber(t.hourlyUdd1),i=toNumber(t.hourlyUdd2),l=toNumber(t.hourlyUdd2Mentor);const u=a>0;return s>0||!u||(s=a+42.98),i>0||!u||(i=a+49.38),l>0||!u||(l=a+49.38+o),{date:formatHistoryTimestamp(e.ts||e.data.timestamp),timer:n>0?n:0,hourlyBase:u?a:0,hourlyUdd1:s>0?s:0,hourlyUdd2:i>0?i:0,hourlyUdd2Mentor:l>0?l:0}}function renderJobHistorySummary(e){const t=getDomElement("job-history-summary-body");if(!t)return;t.innerHTML="";const n=buildHistorySummary(e);if(!n){const e=document.createElement("tr"),n=document.createElement("td");return n.colSpan=6,n.textContent="Ingen historik endnu.",e.appendChild(n),void t.appendChild(e)}const a=e=>e>0?`${formatCurrency(e)} kr`:"–",r=[n.date||"–",n.timer>0?formatNumber(n.timer):"–",a(n.hourlyBase),a(n.hourlyUdd1),a(n.hourlyUdd2),a(n.hourlyUdd2Mentor)],o=document.createElement("tr");r.forEach((e=>{const t=document.createElement("td");t.textContent=e,o.appendChild(t)})),t.appendChild(o)}function updateHistorySummaryFromSelect(){const e=getDomElement("jobHistorySelect"),t=Number(e?.value);let n=null;Number.isFinite(t)&&t>0&&(n=findHistoryEntryById(t)),!n&&recentCasesCache.length&&(n=recentCasesCache[0],n&&e&&e.value!==String(n.id)&&(e.value=String(n.id))),renderJobHistorySummary(n||null);const a=getDomElement("btnLoadHistoryJob");a&&(a.disabled=!(n&&null!=n.id))}async function populateRecentCases(){const e=getDomElement("jobHistorySelect"),t=getDomElement("btnLoadHistoryJob");if(!Boolean(e||getDomElement("historyList")))return;setupHistoryListActions(),setHistoryListBusy(!0);const n=await getRecentProjects();recentCasesCache=n,syncRecentProjectsGlobal(recentCasesCache);const a=e?.value||"";if(e&&(e.innerHTML=""),renderHistoryList(n),!n.length){if(e){const t=document.createElement("option");t.value="",t.textContent="Ingen gemte sager endnu",t.disabled=!0,t.selected=!0,e.appendChild(t)}return t&&(t.disabled=!0),void renderJobHistorySummary(null)}if(!e)return renderJobHistorySummary(n[0]||null),void(t&&(t.disabled=!(n[0]&&null!=n[0].id)));n.forEach((t=>{const n=document.createElement("option");n.value=String(t.id);const a=t.data?.sagsinfo||{},r=[];a.sagsnummer&&r.push(a.sagsnummer),a.navn&&r.push(a.navn),n.textContent=r.length?r.join(" – "):`Sag #${t.id}`,e.appendChild(n)}));const r=n.find((e=>String(e.id)===a))||n[0];r&&(e.value=String(r.id)),t&&(t.disabled=!e.value),updateHistorySummaryFromSelect()}"undefined"!=typeof window&&(window.cssmateUpdateActionHint=updateActionHint);let zipHistoryBound=!1;function setupZipExportHistoryHook(){zipHistoryBound||"undefined"==typeof window||(zipHistoryBound=!0,window.addEventListener("cssmate:zip-exported",(e=>{const t=e?.detail||{};persistProjectSnapshot({type:"zip",baseName:t.baseName||"",zipName:t.zipName||"",files:Array.isArray(t.files)?t.files:[],timestamp:t.timestamp||Date.now()})})),window.addEventListener("cssmate:exported",(e=>{const t=e?.detail||{};persistProjectSnapshot({type:t.type||"export",baseName:t.baseName||"",fileName:t.fileName||"",files:Array.isArray(t.files)?t.files:[],timestamp:t.timestamp||Date.now()})})))}function collectExtrasState(){const e=e=>getDomElement(e)?.value??"",t=toNumber(e("km")),n=2.12*t;return{jobType:getDomElement("jobType")?.value||"montage",montagepris:e("montagepris"),demontagepris:e("demontagepris"),slaebePct:e("slaebePct"),slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:e("antalBoringHuller"),antalLukHuller:e("antalLukHuller"),antalBoringBeton:e("antalBoringBeton"),opskydeligtRaekvaerk:e("antalOpskydeligt"),km:n,kmBelob:n,kmAntal:t,kmIsAmount:!0,traelle35:e("traelleloeft35"),traelle50:e("traelleloeft50")}}function collectProjectSnapshot(e){const t=getAllData().map((e=>({id:e.id,name:e.name,price:toNumber(e.price),quantity:toNumber(e.quantity),manual:Boolean(e.manual),varenr:e.varenr||null}))),n=Array.isArray(laborEntries)?laborEntries.map((e=>({...e}))):[],a={materialSum:lastMaterialSum,laborSum:lastLoensum};lastJobSummary&&(a.timer=lastJobSummary.totalHours,a.hourlyBase=lastJobSummary.hourlyBase,a.hourlyUdd1=lastJobSummary.hourlyUdd1,a.hourlyUdd2=lastJobSummary.hourlyUdd2,a.hourlyUdd2Mentor=lastJobSummary.hourlyUdd2Mentor,a.mentorRate=lastJobSummary.mentorRate);const r=Date.now(),o={timestamp:r,sagsinfo:collectSagsinfo(),systems:Array.from(selectedSystemKeys),materials:t,labor:n,extras:collectExtrasState(),totals:a};return e&&"zip"===e.type&&(o.exportInfo={type:"zip",baseName:e.baseName||"",zipName:e.zipName||"",files:Array.isArray(e.files)?e.files.filter(Boolean):[],exportedAt:e.timestamp||r}),o}async function persistProjectSnapshot(e){if(!historyPersistencePaused)try{const t=collectProjectSnapshot(e);await saveProject(t),await populateRecentCases()}catch(e){console.warn("Kunne ikke gemme projekt snapshot",e)}}function applyExtrasSnapshot(e={}){const t=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t??"")},n=document.getElementById("jobType");n&&e.jobType&&(n.value=e.jobType),t("montagepris",e.montagepris),t("demontagepris",e.demontagepris),t("slaebePct",e.slaebePct),setSlaebFormulaText(e?.slaebeFormulaText??""),updateSlaebFormulaInfo(exportMeta.slaebFormulaText),t("antalBoringHuller",e.antalBoringHuller),t("antalLukHuller",e.antalLukHuller),t("antalBoringBeton",e.antalBoringBeton),t("antalOpskydeligt",e.opskydeligtRaekvaerk),t("km",resolveKmInputValue(e,2.12)),t("traelleloeft35",e.traelle35),t("traelleloeft50",e.traelle50),computeTraelleTotals()}function applyMaterialsSnapshot(e=[],t=[]){resetMaterials(),Array.isArray(t)&&t.length&&(selectedSystemKeys.clear(),t.forEach((e=>selectedSystemKeys.add(e)))),Array.isArray(e)&&e.forEach((e=>{if(shouldExcludeMaterialEntry(e))return;const t=toNumber(e?.quantity),n=toNumber(e?.price);let a=null;if(e?.id&&(a=findMaterialById(e.id)),a&&!a.manual)return a.quantity=t,void(Number.isFinite(n)&&n>0&&(a.price=n));if(e?.manual){const a=manualMaterials.find((t=>t.id===e.id))||manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));return void(a&&(a.name=e.name||a.name,a.price=Number.isFinite(n)?n:a.price,a.quantity=t))}const r=manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));r&&(r.name=e?.name||"",r.price=Number.isFinite(n)?n:0,r.quantity=t)})),renderOptaelling()}function applyLaborSnapshot(e=[]){laborEntries=Array.isArray(e)?e.map((e=>({...e}))):[],populateWorkersFromLabor(laborEntries)}function extractVersionNumber(e={}){const t=e?.version??e?.meta?.version,n=Number(t);if(Number.isFinite(n))return n;if("string"==typeof t){const e=Number.parseFloat(t);return Number.isFinite(e)?e:void 0}}function mapSagsinfoFromPayload(e={}){const t=e.meta||{},n=e.info||{};return{sagsnummer:e.jobId||n.sagsnummer||t.sagsnummer||t.caseNumber||e.caseNo||e.id||"",navn:e.jobName||n.navn||t.caseName||t.navn||e.name||e.title||"",adresse:e.jobAddress||e.address||e.site||n.adresse||n.address||t.adresse||t.address||"",kunde:e.customer||e.kunde||n.kunde||n.customer||t.customer||t.kunde||"",dato:normalizeDateValue(n.dato||n.date||t.date||e.createdAt||e.date),montoer:e.montageWorkers||e.demontageWorkers||e.worker||e.montor||n.montoer||n.montor||t.montoer||""}}function collectMaterialsFromPayload(e={},{defaultSystem:t="",priceDivisor:n=1}={}){let a=[];return Array.isArray(e.materials)?a=e.materials:Array.isArray(e.items)?a=e.items:Array.isArray(e.lines)?a=e.lines:Array.isArray(e.linjer)&&(a=e.linjer.map((e=>({id:e.varenr,name:e.navn,quantity:e.antal,unitPrice:e.stkPris,system:e.system})))),a.map(((a,r)=>{const o=toNumber(a.quantity??a.qty??a.antal??a.amount),s=toNumber(a.unitPrice??a.price??a.stkPris??a.ackUnitPrice??a.baseUnitPrice),i=n?s/n:s,l=a.system||a.systemKey||e.system||e.meta?.system||t||inferSystemFromLine(a);return{id:a.id||a.varenr||a.itemNumber||`line-${r+1}`,name:a.name||a.label||a.title||"",quantity:o,price:i,system:l}})).filter((e=>e&&(e.quantity||e.name||e.id)))}function mapWageToLaborFromPayload(e={},t){const n=e.wage||{},a=Array.isArray(n.workers)?n.workers:Array.isArray(e.workers)?e.workers:Array.isArray(e.labor)?e.labor:[],r=[];if(a.length)a.forEach((e=>{const a=toNumber(e?.hours??e?.time),o=toNumber(e?.rate??e?.hourlyWithAllowances??e?.hourlyRate),s=e?.udd||e?.education||e?.educationLevel||n.educationLevel||"",i=toNumber(e?.mentortillaeg??e?.mentorAllowance),l=e?.type||t;(a>0||o>0||l)&&r.push({type:l,hours:a,rate:o,udd:s,mentortillaeg:i})}));else{const e=toNumber(n.montageHours??n.demontageHours??n.totalHours),a=toNumber(n.hourlyRate);(e>0||a>0)&&r.push({type:t,hours:e,rate:a,udd:n.educationLevel||n.udd||"",mentortillaeg:toNumber(n.mentorAllowance)})}return r}function resolveHoleCounts(e={},t={},n={}){const a=[e.antalBoringHuller,e.huller,t.antalBoringHuller,t.huller,n.boringHuller].find((e=>null!=e)),r=[e.antalLukHuller,t.antalLukHuller,n.lukHuller,t.lukAfHul].find((e=>null!=e));return{antalBoringHuller:toNumber(a),antalLukHuller:toNumber(r)}}function mapExtrasForSnapshot(e={},t){const n=e.extras||e.akkord||{},a=e.extraInputs||{},r=n.fields||n.akkordExtras||n.snapshot||{},o=n.km||{},s=n.slaeb||{},i=n.tralle||{},l=toNumber(o.quantity??n.kmAntal??a.km),u=toNumber(o.amount??n.kmBelob??n.km),{antalBoringHuller:d,antalLukHuller:c}=resolveHoleCounts(r,n,a),m={jobType:t,montagepris:r.montagepris??n.montagepris,demontagepris:r.demontagepris??n.demontagepris,slaebePct:toNumber(s.percent??r.slaebePct??n.slaebePct??a.slaebePctInput),slaebeFormulaText:r.slaebeFormulaText??n.slaebeFormulaText,antalBoringHuller:d,antalLukHuller:c,antalBoringBeton:toNumber(r.antalBoringBeton??n.boringBeton??n.antalBoringBeton??a.boringBeton),opskydeligtRaekvaerk:toNumber(r.opskydeligtRaekvaerk??n.opskydeligt??n.opskydeligtRaekvaerk??a.opskydeligt),km:u,kmBelob:u,kmAntal:Number.isFinite(l)?l:void 0,kmIsAmount:!0,traelle35:toNumber(i.lifts35??r.traelle35??n.tralle35??n.traelle35),traelle50:toNumber(i.lifts50??r.traelle50??n.tralle50??n.traelle50),tralleSum:toNumber(i.amount??n.tralleSum??n.tralle)},p={...a,km:a.km??l,slaebePctInput:a.slaebePctInput??m.slaebePct,boringHuller:a.boringHuller??m.antalBoringHuller,lukHuller:a.lukHuller??m.antalLukHuller,boringBeton:a.boringBeton??m.antalBoringBeton,opskydeligt:a.opskydeligt??m.opskydeligtRaekvaerk},y=Array.isArray(n.extraWork)?n.extraWork:[];return y.length&&(m.extraWork=y),{extras:m,extraInputs:p}}function mapAkkordJsonV1ToSnapshot(e={}){const t=e.type||e.extras?.jobType||"montage",n="demontage"===t?.5:1,{extras:a,extraInputs:r}=mapExtrasForSnapshot(e,t),o=mapSagsinfoFromPayload(e),s=Array.isArray(e.systems)&&e.systems.length?e.systems:e.system?[e.system]:[];return{sagsinfo:o,systems:s,materials:collectMaterialsFromPayload(e,{defaultSystem:s[0]||"",priceDivisor:n||1}),labor:mapWageToLaborFromPayload(e,t),extras:a,extraInputs:r,totals:e.totals?{materialSum:toNumber(e.totals.materialsSum??e.totals.materialSum),laborSum:toNumber(e.totals.laborSum??e.totals.laborSumWithAllowance)}:e.summary?{materialSum:toNumber(e.summary.materialSum),laborSum:toNumber(e.summary.laborSum)}:void 0}}function mapAkkordJsonV2ToSnapshot(e={}){const t=(e.jobType||e.type||e.meta?.jobType||"montage").toLowerCase(),{extras:n,extraInputs:a}=mapExtrasForSnapshot(e,t),r=mapSagsinfoFromPayload(e),o=Array.isArray(e.systems)&&e.systems.length?e.systems:Array.isArray(e.meta?.systems)?e.meta.systems:e.meta?.system?[e.meta.system]:e.system?[e.system]:[];return{sagsinfo:r,systems:o,materials:collectMaterialsFromPayload(e,{defaultSystem:o[0]||"",priceDivisor:1}),labor:mapWageToLaborFromPayload(e,t),extras:n,extraInputs:a,totals:e.totals?{...e.totals}:void 0}}function normalizeLegacyJsonSnapshot(e={}){const t=e.type||e.jobType||e.extras?.jobType||"montage",n={...e.extras||{},jobType:t},a={...e.sagsinfo||e.info||{}};!a.dato&&e.createdAt&&(a.dato=normalizeDateValue(e.createdAt));const r=Array.isArray(e.systems)?e.systems:e.system?[e.system]:[],o=collectMaterialsFromPayload(e,{defaultSystem:r[0]||"",priceDivisor:1}),s=e.extraInputs||{};return{sagsinfo:a,systems:r,materials:o,labor:Array.isArray(e.labor)?e.labor:[],extras:n,extraInputs:s,totals:e.totals||e.summary}}function normalizeImportedJsonSnapshot(e={}){const t=extractVersionNumber(e);return Number.isFinite(t)&&t>=2?mapAkkordJsonV2ToSnapshot(e):Number.isFinite(t)&&t>=1?mapAkkordJsonV1ToSnapshot(e):normalizeLegacyJsonSnapshot(e)}async function applyProjectSnapshot(e,t={}){if(!e||"object"!=typeof e)return;await ensureMaterialsDataLoad();const n=e.sagsinfo||{};setSagsinfoField("sagsnummer",n.sagsnummer||""),setSagsinfoField("sagsnavn",n.navn||""),setSagsinfoField("sagsadresse",n.adresse||""),setSagsinfoField("sagskunde",n.kunde||""),setSagsinfoField("sagsdato",n.dato||""),setSagsinfoField("sagsmontoer",n.montoer||""),applyMaterialsSnapshot(e.materials,e.systems);applyExtrasSnapshot(mergeExtrasKm(e.extras||{},e.extraInputs||{},2.12)),applyLaborSnapshot(e.labor),e.totals&&(Number.isFinite(e.totals.materialSum)&&(lastMaterialSum=e.totals.materialSum),Number.isFinite(e.totals.laborSum)&&(lastLoensum=e.totals.laborSum)),updateTotals(!0),validateSagsinfo(),t?.skipHint||updateActionHint("Sag er indlæst.","success")}async function handleLoadCase(){const e=getDomElement("jobHistorySelect");if(!e)return;const t=Number(e.value);if(!Number.isFinite(t)||t<=0)return;let n=recentCasesCache.find((e=>Number(e.id)===t));if(!n){const e=await getRecentProjects();recentCasesCache=e,syncRecentProjectsGlobal(recentCasesCache),n=e.find((e=>Number(e.id)===t)),renderHistoryList(recentCasesCache)}pauseHistoryPersistence();try{n&&n.data?(await applyProjectSnapshot(n.data,{skipHint:!1}),renderJobHistorySummary(n)):updateActionHint("Kunne ikke indlæse den valgte sag.","error")}finally{resumeHistoryPersistence()}}function validateSagsinfo(){let e=!0;return sagsinfoFieldIds.forEach((t=>{const n=getDomElement(t);if(!n)return;const a=(n.value||"").trim();let r=a.length>0;"sagsdato"===t&&(r=a.length>0&&!Number.isNaN(new Date(a).valueOf())),r||(e=!1),n.classList.toggle("invalid",!r)})),["btn-export-akkord-pdf","btn-print-akkord"].forEach((t=>{const n=getDomElement(t);n&&(n.disabled=!e)})),e?updateActionHint(""):updateActionHint(DEFAULT_ACTION_HINT,"error"),e}function escapeCSV(e){if(null==e)return"";const t=String(e);return/[";\n\r]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function sanitizeFilename(e){return(e||"akkordseddel").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9-_]+/gi,"_")}function formatNumberForCSV(e){return toNumber(e).toFixed(2).replace(".",",")}function formatPercentForCSV(e){return`${toNumber(e).toFixed(2).replace(".",",")} %`}function collectJobType(){return document.getElementById("jobType")?.value||"montage"}function handleJobTypeChange(e){if("demontage"===(e?.target?.value||collectJobType()||"").toLowerCase()){const e=document.getElementById("antalBoringHuller"),t=document.getElementById("antalLukHuller");if(e&&t){const n=(t.value??"").trim(),a=toNumber(n);if(!(""!==n&&0!==a)){const n=(e.value??"").trim();if(n){const e=toNumber(n);t.value=Number.isFinite(e)?String(e):n}}}}updateTotals(!0)}function formatDateForDisplay(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.valueOf())?String(e):t.toLocaleDateString("da-DK")}function getExcelSystemInputs(){return"undefined"==typeof document?[]:Array.from(document.querySelectorAll('input[name="akkordExcelSystem"][type="checkbox"]'))}function getExcelSystemSelectionFromInputs(){const e=getExcelSystemInputs();if(0===e.length)return Array.from(excelSystemSelectionCache);return sanitizeExcelSystemSelection(e.filter((e=>e.checked)).map((e=>e.value)))}function syncExcelSystemSelector(){const e=getExcelSystemInputs();if(0===e.length)return;const t=getSelectedSystemKeys(),n=new Set(getStoredExcelSystems());e.forEach((e=>{const a=normalizeExcelSystemId(e.value);e.checked=n.has(a);const r=e.closest(".export-system-option"),o=r?.querySelector(".export-system-option__label"),s=r?.querySelector(".export-system-option__hint"),i=AKKORD_EXCEL_SYSTEMS.find((e=>e.id===a));o&&i&&(o.textContent=i.label);const l=t.includes(a);s&&(s.textContent=l?"Aktiv i sag":"Ikke aktiv i sag"),r&&r.classList.toggle("export-system-option--inactive",!l)}))}function initExcelSystemSelector(){syncExcelSystemSelector();const e=document.getElementById("akkordExcelSystemOptions");e&&e.addEventListener("change",(e=>{const t=e.target;if(!t||"function"!=typeof t.getAttribute)return;if("akkordExcelSystem"!==t.getAttribute("name"))return;setStoredExcelSystems(getExcelSystemSelectionFromInputs())}))}function requireExcelSystemSelection(){const e=getExcelSystemSelectionFromInputs();if(0===e.length){return updateActionHint('Vælg mindst ét Excel 25-ark under "Eksport & deling".',"error"),null}return e}function triggerBlobDownload(e,t){if("undefined"==typeof document)return;const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}async function downloadExcelPayloads(e,t){if(!Array.isArray(e)||0===e.length)return{count:0,zipped:!1};const n=e.filter((e=>e?.blob&&e?.fileName));if(0===n.length)return{count:0,zipped:!1};if(1===n.length)return triggerBlobDownload(n[0].blob,n[0].fileName),{count:1,zipped:!1};const{JSZip:a}=await ensureZipLibLazy(),r=new a;n.forEach((e=>{r.file(e.fileName,e.blob)}));return triggerBlobDownload(await r.generateAsync({type:"blob"}),`${sanitizeFilename(t?.sagsinfo?.sagsnummer||t?.caseNo||"akkordsedler")||"akkordsedler"}_excel.zip`),{count:n.length,zipped:!0}}function buildExcelExportMessage(e){return e&&0!==e.count?1===e.count?"1 Excel-ark blev genereret og downloadet direkte. ZIP bruges kun ved flere valg.":`${e.count} Excel-ark blev samlet i én ZIP-fil. ZIP bruges kun ved flere valg.`:""}async function exportExcelSelection(e,t){if(!e)return{count:0,zipped:!1};const n=sanitizeExcelSystemSelection(t);if(0===n.length)return{count:0,zipped:!1};const a=await loadExcelExporter();return downloadExcelPayloads("function"==typeof a?await a(e,n):[],e)}function inferSystemFromLine(e){if(!e)return"";if(e.system)return e.system;if(e.systemKey)return e.systemKey;const t=String(e.varenr||e.id||"").trim().toLowerCase();return t.startsWith("b")?"bosta":t.startsWith("h")?"haki":t.startsWith("m")?"modex":""}function buildAkkordJobSnapshot(e=lastEkompletData){const t=e||lastEkompletData;if(!t)return null;const n=collectSagsinfo(),a={...t.sagsinfo||{},...n},r=t.jobType||document.getElementById("jobType")?.value||"montage",o=a.montoer||"",s="demontage"===r?"":o,i="demontage"===r?o:"",l=a.dato?formatDateForDisplay(a.dato):"",u={id:a.sagsnummer||a.navn||a.adresse||"akkord",caseNo:a.sagsnummer||"",site:a.adresse||"",address:a.adresse||"",task:a.navn||"",title:a.navn||"",customer:a.kunde||"",date:l||a.dato||"",montageWorkers:s,demontageWorkers:i,montor:o,worker:o,system:getPreferredExcelSystem()},d=(Array.isArray(t.materialer)?t.materialer:[]).map((e=>({id:e?.varenr||e?.id||"",label:e?.name||e?.label||"",name:e?.name||e?.label||"",qty:toNumber(e?.quantity??e?.qty??0),amount:toNumber(e?.quantity??e?.qty??0),system:inferSystemFromLine(e)}))).filter((e=>e.label&&e.qty>0));return u.lines=d,u.items=d,u.materials=d,u}function buildRawAkkordData(e={}){const t=collectSagsinfo();e.customSagsnummer&&(t.sagsnummer=e.customSagsnummer);const n=getAllData().filter((e=>toNumber(e.quantity)>0)),a=Array.isArray(laborEntries)?laborEntries:[],r="undefined"!=typeof window?window.__beregnLonCache:null,o=collectJobType(),s="demontage"===o?.5:1,i=getStoredExcelSystems(),l={boringHuller:toNumber(document.getElementById("antalBoringHuller")?.value),lukHuller:toNumber(document.getElementById("antalLukHuller")?.value),boringBeton:toNumber(document.getElementById("antalBoringBeton")?.value),opskydeligt:toNumber(document.getElementById("antalOpskydeligt")?.value),km:toNumber(document.getElementById("km")?.value),slaebePctInput:toNumber(document.getElementById("slaebePct")?.value)},u=computeTraelleTotals(),d=u&&Number.isFinite(u.sum)?u.sum:0,c=n.map((e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*s}))),m=calcMaterialesum()+d,p=m*(Number.isFinite(l.slaebePctInput)?l.slaebePctInput/100:0),y={"tralleløft":d,traelle35:u?.n35||0,traelle50:u?.n50||0,huller:4.7*l.boringHuller,lukAfHul:3.45*l.lukHuller,boringBeton:11.49*l.boringBeton,boring:11.49*l.boringBeton,opskydeligt:9.67*l.opskydeligt,km:2.12*l.km,oevrige:0,slaebePct:l.slaebePctInput,slaebeBelob:p},f=mergeExtrasKm({jobType:o,slaebePct:l.slaebePctInput,slaebeBelob:p,slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:l.boringHuller,antalLukHuller:l.lukHuller,antalBoringBeton:l.boringBeton,boringBeton:y.boring,boring:y.boring,huller:y.huller,lukAfHul:y.lukAfHul,opskydeligtRaekvaerk:l.opskydeligt,opskydeligt:y.opskydeligt,km:y.km,kmBelob:y.km,kmAntal:l.km,kmIsAmount:!0,traelle35:u?.n35||0,traelle50:u?.n50||0,"tralleløft":d},l,2.12),g=a.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)}))),b=g.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),S=calculateTotals({materialLines:c,slaebeBelob:p,extra:y,workers:g,totalHours:b}),k={sagsnummer:t.sagsnummer||"akkordseddel",dato:t.dato||(new Date).toISOString(),kunde:t.kunde,adresse:t.adresse,navn:t.navn,systems:Array.from(selectedSystemKeys),excelSystems:i,createdAt:(new Date).toISOString()};return{version:"1.0",info:t,materials:n,labor:a,cache:r,jobType:o,jobFactor:s,systems:Array.from(selectedSystemKeys),excelSystems:i,tralleState:u,tralleSum:d,materialLinesForTotals:c,montageBase:m,slaebePctInput:l.slaebePctInput,slaebeBelob:p,extraInputs:l,extras:f,laborTotals:g,totalHours:b,totals:S,meta:k,createdAt:k.createdAt}}function buildAkkordData(e={}){const t=buildRawAkkordData(e);return buildSharedAkkordData(t)}function syncActiveJobState(){const e=buildAkkordJobSnapshot();return e&&setActiveJob(e),e}function normalizeDateValue(e){if(!e)return"";const t=String(e).trim();if(!t)return"";const n=t.split(/[-\/.]/);if(3===n.length){const[e,t,a]=n;if(4===e.length)return`${e}-${t.padStart(2,"0")}-${a.padStart(2,"0")}`;if(4===a.length)return`${a}-${t.padStart(2,"0")}-${e.padStart(2,"0")}`}const a=new Date(t);return Number.isNaN(a.valueOf())?"":a.toISOString().slice(0,10)}function parseCSV(e){const t=String(e).split(/\r?\n/).filter((e=>e.trim().length>0));if(0===t.length)return[];const n=t[0].includes(";")?";":",",a=e=>{const t=[];let a="",r=!1;for(let o=0;o<e.length;o++){const s=e[o];'"'===s?r&&'"'===e[o+1]?(a+='"',o++):r=!r:s!==n||r?a+=s:(t.push(a.trim()),a="")}return t.push(a.trim()),t},r=a(t[0]),o=[];for(let e=1;e<t.length;e++){const n=a(t[e]);if(n.every((e=>""===e)))continue;const s={};r.forEach(((e,t)=>{s[e]=n[t]??""})),o.push(s)}return o}function resetMaterials(){[dataBosta,dataHaki,dataModex,dataAlfix].forEach((e=>{e.forEach((e=>{e.quantity=0}))})),manualMaterials.forEach((e=>{e.name="",e.price=0,e.quantity=0}))}function resetWorkers(){workerCount=0;const e=document.getElementById("workers");e&&(e.innerHTML="")}function populateWorkersFromLabor(e){if(resetWorkers(),!Array.isArray(e)||0===e.length)return addWorker(),void updateTotals(!0);e.forEach(((e,t)=>{addWorker();const n=document.getElementById(`worker${t+1}`);if(!n)return;const a=n.querySelector(".worker-hours"),r=n.querySelector(".worker-tillaeg"),o=n.querySelector(".worker-udd");if(a&&(a.value=formatNumber(toNumber(e.hours))),r&&(r.value=formatNumber(toNumber(e.mentortillaeg))),o instanceof HTMLSelectElement){const t=(e?.udd??"").toString().trim();if(t){Array.from(o.options).some((e=>e.value===t))?o.value=t:o.options.length>0&&(o.selectedIndex=0)}else o.options.length>0&&(o.selectedIndex=0)}})),updateTotals(!0);e.some((e=>toNumber(e.hours)>0))&&"function"==typeof beregnLon&&beregnLon()}function matchMaterialByName(e){if(!e)return null;const t=normalizeKey(e),n=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const e of n){const n=e.find((e=>normalizeKey(e.name)===t));if(n)return n}return null}function assignMaterialRow(e){const t=e.id?.trim?.()||"",n=e.name?.trim?.()||"",a=toNumber(e.quantity),r=toNumber(e.price);if(!n&&!t&&0===a&&0===r)return;if(shouldExcludeMaterialEntry({id:t,name:n}))return;let o=null;if(t&&(o=findMaterialById(t)),!o&&n&&(o=matchMaterialByName(n)),o&&!o.manual)return o.quantity=a,void(r>0&&(o.price=r));const s=manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));if(!s)return;const i=manualMaterials.indexOf(s)+1;s.name=n||s.name||`Manuelt materiale ${i}`,s.quantity=a,s.price=r}function applyCSVRows(e){if(!Array.isArray(e)||0===e.length)return;resetMaterials();const t=collectSagsinfo(),n=[],a=[],r=[];if(e.forEach((e=>{const o={};Object.entries(e).forEach((([e,t])=>{o[normalizeKey(e)]=(t??"").toString().trim()}));const s=o.sagsnummer||o.sagsnr||o.sag||o.caseid;s&&(t.sagsnummer=s);const i=o.navnopgave||o.navn||o.opgave||o.projekt;i&&(t.navn=i);const l=o.adresse||o.addresse;l&&(t.adresse=l);const u=o.kunde||o.customer;u&&(t.kunde=u);const d=normalizeDateValue(o.dato||o.date);d&&(t.dato=d);const c=o.montoer||o.montor||o.montornavne||o.montornavn;c&&n.push(c);const m=o.materialenavn||o.materiale||o.varenavn||o.navn,p=o.antal||o.quantity||o.qty||o.maengde,y=o.pris||o.price||o.enhedspris||o.stkpris,f=o.id||o.materialeid||o.varenummer;(m||f||p||y)&&a.push({id:f,name:m,quantity:p,price:y});const g=o.arbejdstype||o.type||o.jobtype,b=o.timer||o.hours||o.antalttimer,S=o.sats||o.rate||o.timelon||o.timeloen;(g||b||S)&&r.push({type:g||"",hours:toNumber(b),rate:toNumber(S)})})),setSagsinfoField("sagsnummer",t.sagsnummer||""),setSagsinfoField("sagsnavn",t.navn||""),setSagsinfoField("sagsadresse",t.adresse||""),setSagsinfoField("sagskunde",t.kunde||""),setSagsinfoField("sagsdato",t.dato||""),n.length){setSagsinfoField("sagsmontoer",n.flatMap((e=>e.split(/[\n,]/))).map((e=>e.trim())).filter(Boolean).join("\n"))}a.forEach(assignMaterialRow);const o=systemOptions.filter((e=>e.dataset.some((e=>toNumber(e.quantity)>0))));if(o.length>0&&(selectedSystemKeys.clear(),o.forEach((e=>selectedSystemKeys.add(e.key)))),renderOptaelling(),laborEntries=r.filter((e=>e.hours>0||e.rate>0||e.type)),populateWorkersFromLabor(laborEntries),updateTotals(!0),laborEntries.length>0){const e=laborEntries[0].type?.toLowerCase()||"",t=document.getElementById("jobType");t&&(e.includes("demo")?t.value="demontage":e.includes("montage")&&(t.value="montage"))}validateSagsinfo()}function setupCSVImport(){const e=document.getElementById("dropArea"),t=document.getElementById("csvFileInput");if(!e||!t)return;const n=()=>t.click();["dragenter","dragover"].forEach((t=>{e.addEventListener(t,(t=>{t.preventDefault(),e.classList.add("dragover"),t.dataTransfer&&(t.dataTransfer.dropEffect="copy")}))})),["dragleave","dragend"].forEach((t=>{e.addEventListener(t,(()=>e.classList.remove("dragover")))})),e.addEventListener("drop",(n=>{n.preventDefault(),e.classList.remove("dragover");const a=n.dataTransfer?.files?.[0];a&&(handleImportFile(a),t.value="")})),e.addEventListener("click",n),e.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n())})),t.addEventListener("change",(e=>{const n=e.target.files?.[0];n&&(handleImportFile(n),t.value="")}))}async function applyImportedAkkordData(e,t={}){const n="function"==typeof t.updateActionHint?t.updateActionHint:updateActionHint;if(!e||"object"!=typeof e)return void n("Kunne ikke læse akkordseddel-data.","error");const a=e.data&&!e.materials?e.data:e,r="function"==typeof t.applySnapshot?t.applySnapshot:applyProjectSnapshot,o="function"==typeof t.persistSnapshot?t.persistSnapshot:persistProjectSnapshot,s={materials:Array.isArray(a.materials),lines:Array.isArray(a.lines),linjer:Array.isArray(a.linjer),items:Array.isArray(a.items)};console.info("Forsøger at læse materialer fra import",s);const i=normalizeImportedJsonSnapshot(a),l=(Array.isArray(i?.materials)?i.materials:[]).map(normalizeMaterialLine).filter(Boolean);if(!l.length){const e="Kunne ikke læse nogen linjer fra filen.",t=Object.keys(s).filter((e=>s[e]));throw console.warn("Ingen materialer fundet i import",{availableFields:t,materialFields:s}),n(e,"error"),new Error(e)}const u=(i.extras?.jobType||i.extraInputs?.jobType||a.jobType||a.type||"montage").toLowerCase(),d=Array.isArray(i.systems)?i.systems:[],c=l.map((e=>normalizeSystemId(e.system))).filter(Boolean),m=Array.from(new Set([...d.map(normalizeSystemId).filter(Boolean),...c])),p=m.length?m:Array.from(selectedSystemKeys),y={...i.extras||{},jobType:u},f=i.extraInputs||{},g={...i,systems:p,materials:l,extras:y,extraInputs:f,totals:i.totals||a.totals||{}};pauseHistoryPersistence();try{await r(g,{skipHint:!0})}finally{resumeHistoryPersistence()}n("Akkordseddel er importeret. Bekræft arbejdstype og tal.","success"),o({type:"import",source:a?.meta?.source||"json"})}async function handleAkkordImport(e){if(e)try{const t=await e.text();if(!t||!t.trim())throw new Error("Importfilen er tom eller uden indhold.");let n;try{n=JSON.parse(t)}catch(e){throw new Error("Ugyldig JSON-fil. Kunne ikke læse eksporten.")}if(!n||"object"!=typeof n)throw new Error("Importfilen har et ukendt format.");await applyImportedAkkordData(n)}catch(e){console.error("Kunne ikke importere akkordseddel",e);throw updateActionHint(e?.message||"Kunne ikke importere akkordseddel-filen.","error"),e}}"undefined"!=typeof window&&(window.cssmateBuildAkkordDataRaw=buildRawAkkordData),"undefined"!=typeof window&&(window.cssmateBuildAkkordData=buildAkkordData),"undefined"!=typeof window&&(window.cssmateHandleAkkordImport=handleAkkordImport);export{applyImportedAkkordData};function normalizeSystemId(e){return"string"==typeof e?e.trim().toLowerCase():e&&"string"==typeof e.name?e.name.trim().toLowerCase():e&&"string"==typeof e.id?e.id.trim().toLowerCase():""}function normalizeMaterialLine(e){if(!e||"object"!=typeof e)return null;const t=toImportNumber(e.qty??e.quantity??e.antal,0),n=normalizeSystemId(e.system),a=toImportNumber(e.unitPrice??e.price??e.pris,e.unitPrice??e.price??e.pris??0);return{...e,id:e.id||e.itemNumber||e.item||e.key||"",name:e.name||e.title||e.navn||"",quantity:t,qty:t,unitPrice:a,system:n}}function toImportNumber(e,t=0){const n=Number(e);if(Number.isFinite(n))return n;const a=Number(t);return Number.isFinite(a)?a:0}function handleImportFile(e){if(!e)return;const t=e.name||"";/\.json$/i.test(t)||e.type&&e.type.includes("json")?importJSONProject(e):uploadCSV(e)}async function verifyAdminCodeInput(e,t=null){const n="string"==typeof e?e.trim():"";if(!n)return{ok:!1,reason:"empty"};const a=new Set([...KNOWN_ADMIN_CODES,...Array.isArray(t?.KNOWN_ADMIN_CODES)?t.KNOWN_ADMIN_CODES:[],...Array.isArray(t?.admin_codes_plain)?t.admin_codes_plain:[]].filter((e=>"string"==typeof e&&e.trim().length)));for(const e of a)if(e===n)return{ok:!0,method:"plaintext"};const r=new Set([...KNOWN_ADMIN_CODE_HASHES,DEFAULT_ADMIN_CODE_HASH,t?._meta?.admin_code,...Array.isArray(t?.HASHED_ADMIN_CODES)?t.HASHED_ADMIN_CODES:[]].filter((e=>"string"==typeof e&&e.length)));if(r.size>0){const e=await sha256Hex(n);for(const t of r)if(constantTimeEquals(e,t))return{ok:!0,method:"sha256"}}return{ok:!1,reason:"no_match"}}function handleAdminLogout(e){admin=!1,setAdminOk(!1),renderOptaelling(),updateTotals(!0),e&&(e.textContent="Admin-tilstand er slået fra.",e.classList.remove("error"),e.classList.add("success"),e.removeAttribute("hidden")),updateActionHint("Admin-tilstand er slået fra.","success")}async function login(){const e=document.getElementById("adminCode"),t=document.getElementById("adminFeedback");if(!e)return;const n=e.value.trim();if(!n)return void(isAdminUnlocked()?handleAdminLogout(t):t&&(t.textContent="Indtast admin-kode for at logge ind.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden")));(await verifyAdminCodeInput(n)).ok?(admin=!0,setAdminOk(!0),e.value="",t?.classList.remove("error"),t?.classList.add("success"),t&&(t.textContent="Admin-tilstand aktiveret. Prisfelter er nu redigerbare.",t.removeAttribute("hidden")),renderOptaelling(),updateTotals(!0)):t&&(t.textContent="Forkert kode. Prøv igen.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden"))}const adminLoginButton=document.getElementById("btnAdminLogin");function ensureWorkersInitialized(){if(workerCount>0)return;const e=document.getElementById("workers");if(!e)return;e.querySelector(".worker-row")?workerCount=e.querySelectorAll(".worker-row").length:addWorker()}function addWorker(){workerCount++;const e=document.createElement("fieldset");e.className="worker-row",e.id=`worker${workerCount}`,e.innerHTML=`\n    <legend>Mand ${workerCount}</legend>\n    <div class="worker-grid">\n      <label>\n        <span>Timer</span>\n        <input type="text" class="worker-hours" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-hours-${workerCount}">\n      </label>\n      <label>\n        <span>Uddannelse</span>\n        <select class="worker-udd">\n          <option value="udd1">Udd1 (42,98 kr)</option>\n          <option value="udd2">Udd2 (49,38 kr)</option>\n        </select>\n      </label>\n      <label>\n        <span>Mentortillæg (22,26 kr/t)</span>\n        <input type="text" class="worker-tillaeg" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-tillaeg-${workerCount}">\n      </label>\n    </div>\n    <div class="worker-output" aria-live="polite"></div>\n  `,document.getElementById("workers").appendChild(e)}function debounce(e,t){let n;return(...a)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,a)),t)}}async function saveLocalData(e,t){localStorage.setItem(e,JSON.stringify(t))}async function loadLocalData(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}function showLonOutputSections(){if(lonOutputsRevealed)return;lonOutputsRevealed=!0;document.querySelectorAll("[data-lon-output]").forEach((e=>{e.hidden=!1,e.removeAttribute("hidden")}))}function beregnLon(){ensureWorkersInitialized();const e=collectSagsinfo(),t=e.sagsnummer?.trim()||"uspecified",n=document.getElementById("jobType")?.value||"montage",a="demontage"===n?.5:1,r=getSelectedSystemKeys(),o=r.map((e=>normalizeKey(e))).find((e=>["bosta","haki","modex"].includes(e)))||"",s=toNumber(document.getElementById("slaebePct")?.value),i=toNumber(document.getElementById("antalBoringHuller")?.value),l=toNumber(document.getElementById("antalLukHuller")?.value),u=toNumber(document.getElementById("antalBoringBeton")?.value),d=toNumber(document.getElementById("antalOpskydeligt")?.value),c=toNumber(document.getElementById("km")?.value),m=document.querySelectorAll(".worker-row");lastEkompletData=null,lastJobSummary=null;const p=computeTraelleTotals(),y=p&&Number.isFinite(p.sum)?p.sum:0,f=[],g=[],b=[],S=getAllData();Array.isArray(S)&&S.forEach((e=>{const t=toNumber(e?.quantity);if(t<=0)return;const n=toNumber(e?.price),r=n*a,o=t*r;f.push({qty:t,unitPrice:r});const s=manualMaterials.indexOf(e),i=e?.manual?e.name?.trim()||`Manuelt materiale ${s+1}`:e?.name;g.push({label:i,quantity:t,unitPrice:n,lineTotal:o,ackUnitPrice:r});const l=t>0?o/t:r;b.push({varenr:e?.varenr||e?.id||"",name:i,quantity:t,unitPrice:l,baseUnitPrice:n,lineTotal:o,system:e?.systemKey||"",systemKey:e?.systemKey||""})}));const k=4.7*i,h=3.45*l,E=11.49*u,A=9.67*d,v=2.12*c,w=calcMaterialesum()+y,x=w*(Number.isFinite(s)?s/100:0),L={"tralleløft":y,huller:k,boring:E,lukAfHul:h,opskydeligt:A,km:v,oevrige:0};let N=0;if(m.forEach((e=>{const t=e.querySelector(".worker-hours"),n=toNumber(t?.value);n>0&&(N+=n)})),0===N){const e=document.getElementById("lonResult");if(e){e.innerHTML="";const t=document.createElement("div");t.style.color="red",t.textContent="Indtast arbejdstimer for mindst én person",e.appendChild(t)}return laborEntries=[],void(lastJobSummary=null)}const I={materialLines:f,slaebeBelob:x,extra:L,workers:[],totalHours:N},T=calculateTotals(I),C=T.timeprisUdenTillaeg,B=(T.samletAkkordsum,[]),D=[],P=[];m.forEach(((e,t)=>{const a=toNumber(e.querySelector(".worker-hours")?.value);if(a<=0)return;const r=toNumber(e.querySelector(".worker-tillaeg")?.value),o=e.querySelector(".worker-udd"),s=o?.value||"",i=e.querySelector("legend")?.textContent?.trim()||`Mand ${t+1}`,l=e.querySelector(".worker-output");let u=C+r,d=0;"udd1"===s?(u+=42.98,d=42.98):"udd2"===s&&(u+=49.38,d=49.38);const c=u*a;l&&(l.textContent=`${u.toFixed(2)} kr/t | Total: ${c.toFixed(2)} kr`),B.push({name:i,hours:a,rate:u,total:c});const m=o?.selectedOptions?.[0]?.textContent?.trim()||"";D.push({id:t+1,name:i,type:n,hours:a,rate:u,baseRate:C,mentortillaeg:r,udd:s,uddLabel:m,uddannelsesTillaeg:d,total:c}),P.push({hours:a,hourlyWithAllowances:u})}));const M=calculateTotals({...I,workers:P}),H=Number.isFinite(M.timeprisUdenTillaeg)?M.timeprisUdenTillaeg:0,F=H>0;lastJobSummary={totalHours:N,hourlyBase:F?H:0,hourlyUdd1:F?H+42.98:0,hourlyUdd2:F?H+49.38:0,hourlyUdd2Mentor:F?H+49.38+22.26:0,mentorRate:22.26};M.montoerLonMedTillaeg;const _=M.materialer+M.slaeb,j=M.projektsum,O=formatDateForDisplay(e.dato),R=document.getElementById("lonResult");if(R){R.innerHTML="";const t=document.createElement("div"),n=document.createElement("h3");n.textContent="Sagsinfo",t.appendChild(n);[{label:"Sagsnr.",value:e.sagsnummer||""},{label:"Navn",value:e.navn||""},{label:"Adresse",value:e.adresse||""},{label:"Dato",value:O}].forEach((({label:e,value:n})=>{const a=document.createElement("div"),r=document.createElement("strong");r.textContent=`${e}: `,a.appendChild(r);const o=document.createElement("span");o.textContent=n,a.appendChild(o),t.appendChild(a)})),R.appendChild(t);const a=document.createElement("h3");if(a.textContent="Materialer brugt:",R.appendChild(a),g.length>0)g.forEach((e=>{const t=document.createElement("div");t.textContent=`${e.label}: ${e.quantity} × ${e.unitPrice.toFixed(2)} kr = ${e.lineTotal.toFixed(2)} kr`,R.appendChild(t)}));else{const e=document.createElement("div");e.textContent="Ingen materialer brugt",R.appendChild(e)}const r=document.createElement("h3");if(r.textContent="Arbejdere:",R.appendChild(r),B.length>0)B.forEach((e=>{const t=document.createElement("div");t.className="worker-payline",t.textContent=`${e.name}: Timer: ${e.hours}, Timeløn: ${e.rate.toFixed(2)} kr/t, Total: ${e.total.toFixed(2)} kr`,R.appendChild(t)}));else{const e=document.createElement("div");e.textContent="Ingen timer registreret",R.appendChild(e)}const o=document.createElement("h3");o.textContent="Oversigt:",R.appendChild(o);[["Materialer",`${M.materialer.toFixed(2)} kr`],["Ekstraarbejde",`${M.ekstraarbejde.toFixed(2)} kr`],["Slæb",`${M.slaeb.toFixed(2)} kr`],["Samlet akkordsum",`${M.samletAkkordsum.toFixed(2)} kr`],["Timer",`${N.toFixed(1)} t`],["Timepris (uden tillæg)",`${M.timeprisUdenTillaeg.toFixed(2)} kr/t`],["Lønsum",`${M.montoerLonMedTillaeg.toFixed(2)} kr`],["Projektsum",`${j.toFixed(2)} kr`],["Materialesum (info)",`${_.toFixed(2)} kr`],["Kilometer (info)",`${v.toFixed(2)} kr`],["Tralleløft (info)",`${y.toFixed(2)} kr`]].forEach((([e,t])=>{const n=document.createElement("div"),a=document.createElement("strong");a.textContent=`${e}: `,n.appendChild(a);const r=document.createElement("span");r.textContent=t,n.appendChild(r),R.appendChild(n)}))}return laborEntries=D,lastEkompletData={sagsinfo:e,jobType:n,montagepris:w,demontagepris:.5*w,systems:r,primarySystem:o,extras:{slaebePct:s,slaebeBelob:x,slaebeFormulaText:exportMeta.slaebFormulaText||"",boringHuller:{antal:i,pris:4.7,total:k},lukHuller:{antal:l,pris:3.45,total:h},boringBeton:{antal:u,pris:11.49,total:E},opskydeligtRaekvaerk:{antal:d,pris:9.67,total:A},kilometer:{antal:c,pris:2.12,total:v},traelleloeft:{antal35:p?.n35||0,pris35:10.44,total35:10.44*(p?.n35||0),antal50:p?.n50||0,pris50:14.62,total50:14.62*(p?.n50||0),total:y}},materialer:b,arbejdere:D,totals:{materialer:M.materialer,ekstraarbejde:M.ekstraarbejde,kilometerPris:v,slaebeBelob:M.slaeb,akkordsum:M.samletAkkordsum,timer:N,akkordTimeLon:M.timeprisUdenTillaeg,loensum:M.montoerLonMedTillaeg,projektsum:j,materialeSumInfo:_,traelleSum:y},traelle:{antal35:p?.n35||0,antal50:p?.n50||0,rate35:10.44,rate50:14.62,sum:y}},syncActiveJobState(),updateTotals(!0),syncExcelSystemSelector(),"undefined"!=typeof window&&(window.__cssmateLastEkompletData=lastEkompletData,window.__beregnLonCache={materialSum:lastMaterialSum,laborSum:lastLoensum,projectSum:lastMaterialSum+lastLoensum,traelleSum:y,timestamp:Date.now()}),showLonOutputSections(),persistProjectSnapshot(),t}function buildCSVPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=collectSagsinfo();e&&(n.sagsnummer=e);const a="undefined"!=typeof window?window.__beregnLonCache:null,r=getAllData().filter((e=>toNumber(e.quantity)>0)),o=Array.isArray(laborEntries)?laborEntries:[],s=computeTraelleTotals(),i=s&&Number.isFinite(s.sum)?s.sum:0,l="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,u=r.map((e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*l}))),d=calcMaterialesum()+i,c=toNumber(document.getElementById("slaebePct")?.value),m=d*(Number.isFinite(c)?c/100:0),p={"tralleløft":i,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},y=o.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)}))),f=y.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),g=calculateTotals({materialLines:u,slaebeBelob:m,extra:p,workers:y,totalHours:f}),b=a&&Number.isFinite(a.materialSum)?a.materialSum:g.materialer,S=g.ekstraarbejde,k=g.slaeb,h=a&&Number.isFinite(a.laborSum)?a.laborSum:g.montoerLonMedTillaeg,E=a&&Number.isFinite(a.projectSum)?a.projectSum:g.projektsum,A=[];A.push("Sektion;Felt;Værdi;Antal;Pris;Linjesum"),A.push(`Sagsinfo;Sagsnummer;${escapeCSV(n.sagsnummer)};;;`),A.push(`Sagsinfo;Navn/opgave;${escapeCSV(n.navn)};;;`),A.push(`Sagsinfo;Adresse;${escapeCSV(n.adresse)};;;`),A.push(`Sagsinfo;Kunde;${escapeCSV(n.kunde)};;;`),A.push(`Sagsinfo;Dato;${escapeCSV(n.dato)};;;`);const v=(n.montoer||"").replace(/\r?\n/g,", ");A.push(`Sagsinfo;Montørnavne;${escapeCSV(v)};;;`),A.push(""),A.push("Sektion;Id;Materiale;Antal;Pris;Linjesum"),0===r.length?A.push("Materiale;;;0;0,00;0,00"):r.forEach((e=>{const t=toNumber(e.quantity);if(0===t)return;const n=toNumber(e.price),a=t*n,r=manualMaterials.indexOf(e),o=e.manual?e.name?.trim()||`Manuelt materiale ${r+1}`:e.name;A.push(`Materiale;${escapeCSV(e.id)};${escapeCSV(o)};${escapeCSV(formatNumberForCSV(t))};${escapeCSV(formatNumberForCSV(n))};${escapeCSV(formatNumberForCSV(a))}`)}));const w=window.__traelleloeft;if(w&&(w.n35>0||w.n50>0)){if(w.n35>0){const e=w.n35*w.RATE35;A.push(`Materiale;TL35;Tralleløft 0,35 m;${escapeCSV(formatNumberForCSV(w.n35))};${escapeCSV(formatNumberForCSV(w.RATE35))};${escapeCSV(formatNumberForCSV(e))}`)}if(w.n50>0){const e=w.n50*w.RATE50;A.push(`Materiale;TL50;Tralleløft 0,50 m;${escapeCSV(formatNumberForCSV(w.n50))};${escapeCSV(formatNumberForCSV(w.RATE50))};${escapeCSV(formatNumberForCSV(e))}`)}}A.push(""),A.push("Sektion;Arbejdstype;Timer;Sats;Linjesum"),0===o.length?A.push("Løn;Ingen registrering;;;"):o.forEach(((e,t)=>{const n=toNumber(e.hours),a=toNumber(e.rate),r=n*a,o=e.type||`Arbejdstype ${t+1}`;A.push(`Løn;${escapeCSV(o)};${escapeCSV(formatNumberForCSV(n))};${escapeCSV(formatNumberForCSV(a))};${escapeCSV(formatNumberForCSV(r))}`)})),A.push(""),A.push("Sektion;Total;Beløb"),A.push(`Total;Materialesum;${escapeCSV(formatNumberForCSV(b))}`),S>0&&A.push(`Total;Ekstraarbejde;${escapeCSV(formatNumberForCSV(S))}`),k>0&&A.push(`Total;Slæb;${escapeCSV(formatNumberForCSV(k))}`),A.push(`Total;Lønsum;${escapeCSV(formatNumberForCSV(h))}`),A.push(`Total;Projektsum;${escapeCSV(formatNumberForCSV(E))}`);(exportMeta.slaebFormulaText||"").trim()&&A.push(`Noter;A9 slæb-formel;${escapeCSV(exportMeta.slaebFormulaText)}`);const x=A.join("\n"),L=sanitizeFilename(n.sagsnummer||"akkordseddel")||"akkordseddel";return{content:x,baseName:L,fileName:`${L}.csv`,originalName:n.sagsnummer}}adminLoginButton&&adminLoginButton.addEventListener("click",(e=>{e.preventDefault(),login()})),"undefined"!=typeof window&&(window.cssmateBuildCSVPayload=buildCSVPayload);const AKKORD_JSON_VERSION="2.0";function buildAkkordJsonPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=t?.data||buildAkkordData({customSagsnummer:e}),{info:a,materials:r,labor:o,jobType:s,jobFactor:i,extras:l,laborTotals:u,totalHours:d,totals:c,extraInputs:m,tralleState:p,tralleSum:y,createdAt:f,systems:g,excelSystems:b,meta:S}=n,k=Array.isArray(b)?b:Array.isArray(S?.excelSystems)?S.excelSystems:getStoredExcelSystems(),h=Array.isArray(g)&&g.length?g:Array.isArray(S?.systems)?S.systems:Array.from(selectedSystemKeys),E=Array.from(new Set([...h||[],...k||[]])),A=Array.isArray(o)?o:[],v=Array.isArray(u)?u:A.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)}))),w=(Number.isFinite(d)||v.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),{sagsnummer:a.sagsnummer||"",navn:a.navn||"",adresse:a.adresse||"",kunde:a.kunde||"",dato:a.dato||"",montoer:a.montoer||""}),x=buildSharedExportModel({...n,jobType:s,jobFactor:i,extras:l,extraInputs:m||{},totals:c,tralleState:p||{},tralleSum:y||0,createdAt:f||n.createdAt||(new Date).toISOString(),systems:E},{exportedAt:(new Date).toISOString()}),L=x.info||w,N=sanitizeFilename([L.sagsnummer||"akkordseddel",L.kunde||"",(L.dato||"").slice(0,10)].filter(Boolean).join("-"))||"akkordseddel",I={...x,jobType:s};return{content:JSON.stringify(I,null,2),baseName:N,fileName:`${N}.json`,data:I}}async function exportPDFBlob(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=t?.data||buildAkkordData({customSagsnummer:e}),{info:a,materials:r,labor:o,extras:s,tralleState:i,tralleSum:l,slaebePctInput:u,slaebeBelob:d,laborTotals:c,totalHours:m,totals:p,cache:y,extraInputs:f}=n,g=y&&Number.isFinite(y.materialSum)?y.materialSum:p.materialer,b=p.ekstraarbejde,S=(p.slaeb,y&&Number.isFinite(y.laborSum)?y.laborSum:p.montoerLonMedTillaeg),k=y&&Number.isFinite(y.projectSum)?y.projectSum:p.projektsum,h=document.createElement("div");h.className="export-preview",h.style.position="fixed",h.style.left="-9999px",h.style.top="0",h.style.background="#ffffff",h.style.color="#000000",h.style.padding="24px",h.style.width="794px",h.style.boxSizing="border-box";const E=c.filter((e=>Number.isFinite(e.hours)&&e.hours>0)).length,A=e=>new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0);const v=f.boringHuller,w=f.lukHuller,x=f.boringBeton,L=f.opskydeligt,N=f.km,I=[{id:"materials",label:"1. Materialer",format:"currency",value:g},{id:"extraWork",label:"2. Ekstra arbejde",format:"currency",value:b},{id:"extra-sled",label:"   Slæb",format:"currency",value:d,subtle:!0,info:{type:"percent",percent:u}},{id:"extra-km",label:"   Kilometer",format:"currency",value:s.km,subtle:!0,info:{type:"qtyPrice",qty:N,unitPrice:2.12,unitLabel:"km"}},{id:"extra-holes",label:"   Boring af huller",format:"currency",value:s.huller,subtle:!0,info:{type:"qtyPrice",qty:v,unitPrice:4.7}},{id:"extra-close-hole",label:"   Luk af hul",format:"currency",value:s.lukAfHul,subtle:!0,info:{type:"qtyPrice",qty:w,unitPrice:3.45}},{id:"extra-concrete",label:"   Boring i beton",format:"currency",value:s.boring,subtle:!0,info:{type:"qtyPrice",qty:x,unitPrice:11.49}},{id:"extra-folding-rail",label:"   Opslåeligt rækværk",format:"currency",value:s.opskydeligt,subtle:!0,info:{type:"qtyPrice",qty:L,unitPrice:9.67}},{id:"extra-trolley",label:"   Tralleløft",format:"currency",value:l,subtle:!0,info:{type:"trolley",qty:(i?.n35||0)+(i?.n50||0),entries:[{qty:i?.n35||0,unitPrice:10.44},{qty:i?.n50||0,unitPrice:14.62}]}},{id:"accordSum",label:"3. Samlet akkordsum",format:"currency",value:p.samletAkkordsum,emphasize:!0},{id:"hours",label:"4. Timer",format:"hours",value:m},{id:"team",label:"5. Medarbejdere & timer",format:"team",value:{workersCount:E,hours:m}}].map((e=>{const t=["review-row"];return e.subtle&&t.push("review-row--subtle"),e.emphasize&&t.push("review-row--emphasize"),`<div class="${t.join(" ")}"><span>${e.label}</span><strong>${function(e){switch(e.format){case"currency":{const t=`${formatCurrency(e.value)} kr`;if(!e.info)return t;let n="";return"percent"===e.info.type?n=`${formatNumber(e.info.percent)} %`:"qtyPrice"===e.info.type?n=`${e.info.unitLabel?`${formatNumber(e.info.qty)} ${e.info.unitLabel}`:formatNumber(e.info.qty)} × ${formatCurrency(e.info.unitPrice)} kr`:"trolley"===e.info.type&&(n=[e.info.qty?`${formatNumber(e.info.qty)} løft`:"",Array.isArray(e.info.entries)?e.info.entries.filter((e=>e&&Number(e.qty)>0)).map((e=>`${formatNumber(e.qty)} × ${formatCurrency(e.unitPrice)} kr`)).join(" · "):""].filter(Boolean).join(" · ")),n?`${t} (${n})`:t}case"hours":return`${A(e.value)} t`;case"team":{const t=Number(e.value?.workersCount)||0,n=A(e.value?.hours||0);return t?`${1===t?"1 medarbejder":`${t} medarbejdere`} · ${n} t`:`${n} t`}default:return""}}(e)}</strong></div>`})).join(""),T=(exportMeta.slaebFormulaText||"").trim()?`<p class="a9-formula-note"><strong>A9 slæb-formel:</strong> ${escapeHtml(exportMeta.slaebFormulaText).replace(/\n/g,"<br>")}</p>`:"";h.innerHTML=`\n    <style>\n      .export-preview { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }\n      .export-preview h2 { margin-top: 0; }\n      .export-preview section { margin-bottom: 16px; }\n      .export-preview h3 { margin: 0 0 8px; }\n      .export-preview .review-grid { display: flex; flex-direction: column; gap: 6px; }\n      .export-preview .review-row { display: flex; justify-content: space-between; gap: 12px; font-size: 14px; }\n      .export-preview .review-row--subtle { color: #4f4f4f; font-size: 13px; }\n      .export-preview .review-row--emphasize { font-weight: 600; }\n      .export-preview .review-row span { flex: 1; }\n      .export-preview .review-row strong { white-space: pre-wrap; text-align: right; }\n      .export-preview .a9-formula-note { margin-top: 10px; font-size: 13px; color: #1f2937; }\n      .export-preview .a9-formula-note strong { margin-right: 6px; }\n      .export-preview .totals { display: flex; gap: 12px; flex-wrap: wrap; }\n      .export-preview .totals div { background: #f7f7f7; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; }\n    </style>\n    <h2>Akkordseddel</h2>\n    <section>\n      <h3>Oversigt</h3>\n      <div class="review-grid">\n        ${I}\n      </div>\n      ${T}\n    </section>\n    <section>\n      <h3>Løn & projektsum</h3>\n      <div class="totals">\n        <div><strong>Lønsum</strong><div>${formatCurrency(S)} kr</div></div>\n        <div><strong>Projektsum</strong><div>${formatCurrency(k)} kr</div></div>\n      </div>\n    </section>\n  `,document.body.appendChild(h);try{const{jsPDF:e,html2canvas:n}=await ensureExportLibsLazy(),r=await n(h,{scale:2,backgroundColor:"#ffffff"}),o=new e({unit:"px",format:[r.width,r.height]});o.addImage(r.toDataURL("image/png"),"PNG",0,0,r.width,r.height);const s=sanitizeFilename(t.baseName||a.sagsnummer||"akkordseddel");return{blob:o.output("blob"),baseName:s,fileName:`${s}.pdf`}}catch(e){return console.error("PDF eksport fejlede:",e),updateActionHint("PDF eksport fejlede. Prøv igen.","error"),null}finally{document.body.removeChild(h)}}async function exportPDF(e,t={}){const n=await exportPDFBlob(e,t);if(!n)return;const a=URL.createObjectURL(n.blob),r=document.createElement("a");r.href=a,r.download=n.fileName,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),updateActionHint("PDF er gemt til din enhed.","success")}async function exportZip(){if(validateSagsinfo())try{const{JSZip:e}=await ensureZipLibLazy();beregnLon();const t=buildCSVPayload(null,{skipValidation:!0,skipBeregn:!0});if(!t)return;const n=buildAkkordData({customSagsnummer:t.originalName||t.baseName}),a=await exportPDFBlob(t.originalName||t.baseName,{skipValidation:!0,skipBeregn:!0,data:n});if(!a)return;const r=buildAkkordJsonPayload(t.originalName||t.baseName,{skipValidation:!0,skipBeregn:!0,data:n}),o=new e;o.file(t.fileName,t.content),o.file(a.fileName,a.blob),r&&o.file(r.fileName,r.content);const s=await o.generateAsync({type:"blob"}),i=URL.createObjectURL(s),l=document.createElement("a"),u=r?.baseName||t.baseName||a.baseName||"akkordseddel";l.href=i,l.download=`${u}.zip`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(i),updateActionHint("ZIP med PDF og CSV er gemt.","success")}catch(e){console.error("ZIP eksport fejlede",e),updateActionHint("ZIP eksport fejlede. Prøv igen.","error")}else updateActionHint("Udfyld Sagsinfo for at eksportere.","error")}function exportAkkordJsonFile(){const e=buildAkkordJsonPayload();if(!e)return;triggerBlobDownload(new Blob([e.content],{type:"application/json"}),e.fileName),updateActionHint("Akkordseddel (JSON) er gemt.","success")}function importJSONProject(e){const t=new FileReader;t.onload=async e=>{try{const t=e.target?.result,n=JSON.parse(t);if(!n||"object"!=typeof n)throw new Error("Ugyldigt JSON format");const a=normalizeImportedJsonSnapshot(n.data&&!n.sagsinfo?n.data:n);await applyProjectSnapshot(a,{skipHint:!0}),updateActionHint("JSON sag er indlæst.","success")}catch(e){console.error("Kunne ikke importere JSON",e),updateActionHint("Kunne ikke importere JSON-filen.","error")}},t.onerror=()=>{updateActionHint("Kunne ikke læse filen.","error")},t.readAsText(e,"utf-8")}function uploadCSV(e){if(!e)return;if(!(/\.csv$/i.test(e.name)||e.type&&e.type.includes("csv")))return void updateActionHint("Vælg en gyldig CSV-fil for at importere.","error");const t=new FileReader;t.onload=e=>{try{applyCSVRows(parseCSV(e.target.result)),updateActionHint("CSV er importeret.","success")}catch(e){console.error("Kunne ikke importere CSV",e),updateActionHint("Kunne ikke importere CSV-filen.","error")}},t.readAsText(e,"utf-8")}function setupMobileKeyboardDismissal(){document.addEventListener("keydown",(e=>{if("Enter"!==e.key)return;const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.type?.toLowerCase?.()||"",a=t.inputMode?.toLowerCase?.()||"";"number"!==n&&"numeric"!==a&&"decimal"!==a||(e.preventDefault(),t.blur())})),document.addEventListener("change",(e=>{const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.type?.toLowerCase?.()||"",a=t.inputMode?.toLowerCase?.()||"";"number"!==n&&"numeric"!==a&&"decimal"!==a||"function"==typeof t.blur&&t.blur()}))}function setupServiceWorkerMessaging(){if(!("serviceWorker"in navigator))return;let e=!1;navigator.serviceWorker.addEventListener("message",(e=>{const t=e.data?.type;"CSMATE_UPDATED"!==t&&"SSCaff_NEW_VERSION"!==t||window.location.reload()})),navigator.serviceWorker.addEventListener("controllerchange",(()=>{e||(e=!0,window.location.reload())}))}function setupPWAInstallPrompt(){if("undefined"==typeof window)return;const e=document.getElementById("installBtn"),t=document.getElementById("iosInstallPrompt"),n=document.getElementById("iosInstallDismiss");if(!e&&!t)return;const a="function"==typeof window.matchMedia?window.matchMedia("(display-mode: standalone)"):null,r=()=>(a?.matches??!1)||!0===navigator.standalone;let o=!1;const s=()=>{e&&(e.setAttribute("hidden",""),e.disabled=!1,e.removeAttribute("title"))},i=()=>{e&&(o&&!r()?(e&&(e.removeAttribute("hidden"),e.disabled=!1,e.removeAttribute("title")),getDeferredInstallPromptEvent()?(e.disabled=!1,e.removeAttribute("title")):(e.disabled=!0,e.title=INSTALL_BUTTON_DISABLED_TOOLTIP)):s())},l=(e=!1)=>{if(t&&t.setAttribute("hidden",""),e)try{window.localStorage?.setItem(IOS_INSTALL_PROMPT_DISMISSED_KEY,"1")}catch(e){console.warn("Kunne ikke gemme iOS prompt flag",e)}},u=()=>{if(!t)return;const e=navigator.userAgent||"",n=/iphone|ipad|ipod/i.test(e),r=/safari/i.test(e)&&!/(crios|fxios|edgios)/i.test(e),o=(a?.matches??!1)||!0===navigator.standalone;n&&r&&!o&&!(()=>{try{return"1"===window.localStorage?.getItem(IOS_INSTALL_PROMPT_DISMISSED_KEY)}catch(e){return console.warn("Kunne ikke læse iOS prompt flag",e),!1}})()?t.removeAttribute("hidden"):t.setAttribute("hidden","")};(()=>{if(!("serviceWorker"in navigator)||!navigator.serviceWorker?.ready)return o=!0,void i();navigator.serviceWorker.ready.then((()=>{o=!0,i(),r()&&l(!0)})).catch((e=>{o=!0,i(),console.warn("Service worker blev ikke klar i tide til install-knappen",e)}))})(),window.addEventListener(PWA_INSTALL_AVAILABLE_EVENT,(()=>{i()})),window.addEventListener(PWA_INSTALL_CONSUMED_EVENT,(()=>{i()})),e?.addEventListener("click",(async()=>{const t=consumeDeferredInstallPromptEvent();if(t){e.disabled=!0,t.prompt();try{await t.userChoice}catch(e){console.warn("Install prompt failed",e)}finally{s()}}})),window.addEventListener("appinstalled",(()=>{s(),l(!0)})),a?.addEventListener&&a.addEventListener("change",(e=>{e.matches?(s(),l(!0)):(i(),u())})),n?.addEventListener("click",(()=>{l(!0)})),t?.addEventListener("keydown",(e=>{"Escape"===e.key&&l(!0)})),u(),i(),t&&t.addEventListener("click",(e=>{e.target===t&&l(!0)}))}async function hardResetApp(){if(navigator.serviceWorker){const e=await navigator.serviceWorker.getRegistrations();await Promise.all(e.map((e=>e.unregister())))}if(window.caches){const e=await caches.keys();await Promise.all(e.map((e=>caches.delete(e))))}if(window.indexedDB){const e=await(indexedDB.databases?.())||[];await Promise.all(e.map((e=>new Promise((t=>{if(!e?.name)return void t();const n=indexedDB.deleteDatabase(e.name);n.onsuccess=n.onerror=n.onblocked=()=>t()})))))}try{window.localStorage?.clear()}catch{}try{window.sessionStorage?.clear()}catch{}window.location.reload(!0)}"undefined"!=typeof window&&(window.cssmateBuildAkkordJsonPayload=(e={})=>{if("string"==typeof e)return buildAkkordJsonPayload(e,{});const{customSagsnummer:t,...n}=e||{};return buildAkkordJsonPayload(t,n)}),"undefined"!=typeof window&&(window.cssmateExportPDFBlob=exportPDFBlob);let appInitialized=!1;function markAppReady(){"undefined"!=typeof document&&(document.documentElement.classList.remove("app-booting"),document.documentElement.classList.add("app-ready"))}async function initApp(){if(appInitialized)return;appInitialized=!0,initTabs();const e=getDomElement("optaellingContainer");e&&(e.addEventListener("input",handleOptaellingInput),e.addEventListener("change",handleOptaellingInput)),runWhenIdle((()=>{setupGuideModal(),setupAdminControls(),setupA9Integration()})),document.getElementById("btnBeregnLon")?.addEventListener("click",(()=>beregnLon())),document.getElementById("btnAddWorker")?.addEventListener("click",(()=>addWorker()));const t=getDomElement("jobHistorySelect"),n=getDomElement("btnLoadHistoryJob");t&&t.addEventListener("change",(e=>{updateHistorySummaryFromSelect();const t=Boolean(e?.target?.value);n&&(n.disabled=!t)})),n?.addEventListener("click",(()=>handleLoadCase())),["traelleloeft35","traelleloeft50"].forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>updateTotals())),t.addEventListener("change",(()=>updateTotals(!0))))})),["antalBoringHuller","antalLukHuller","antalBoringBeton","antalOpskydeligt","km","slaebePct"].forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>updateTotals())),t.addEventListener("change",(()=>updateTotals(!0))))}));const a=document.getElementById("jobType");a&&a.addEventListener("change",handleJobTypeChange),sagsinfoFieldIds.forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>validateSagsinfo())),t.addEventListener("change",(()=>validateSagsinfo())))})),validateSagsinfo(),runWhenIdle((()=>{setupNumpad(),setupMobileKeyboardDismissal(),setupLazyExportPanelTriggers()})),runWhenIdle((()=>{setupServiceWorkerMessaging(),setupPWAInstallPrompt()})),runWhenIdle((()=>setupZipExportHistoryHook())),document.getElementById("btnHardResetApp")?.addEventListener("click",(()=>{hardResetApp()}));const r=document.getElementById("calendarIcon");r&&r.addEventListener("click",(()=>{const e=document.getElementById("sagsdato");e&&("function"==typeof e.showPicker?e.showPicker():(e.focus(),"function"==typeof e.click&&e.click()))}))}async function startApp(){try{await initApp()}catch(e){console.error("CSMate init fejlede",e),updateActionHint("Kunne ikke initialisere appen. Opdater siden for at prøve igen.","error")}finally{markAppReady()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",startApp,{once:!0}):startApp();