import{initMaterialsScrollLock}from"./src/modules/materialsscrolllock.js";import{calculateTotals}from"./src/modules/calculatetotals.js";import{normalizeKey}from"./src/lib/string-utils.js";import{EXCLUDED_MATERIAL_KEYS,shouldExcludeMaterialEntry}from"./src/lib/materials/exclusions.js";import{mergeExtrasKm,resolveKmInputValue}from"./src/lib/extras-helpers.js";import{createMaterialRow}from"./src/modules/materialrowtemplate.js";import{sha256Hex,constantTimeEquals}from"./src/lib/sha256.js";import{setupNumpad}from"./js/numpad.js";import{exportMeta,setSlaebFormulaText}from"./js/export-meta.js";import{buildAkkordData as buildSharedAkkordData}from"./js/akkord-data.js";import{buildExportModel as buildSharedExportModel}from"./js/export-model.js";import{convertMontageToDemontage}from"./js/akkord-converter.js";import{createVirtualMaterialsList}from"./src/modules/materialsvirtuallist.js";import{initClickGuard}from"./src/ui/guards/clickguard.js";import{setAdminOk,restoreAdminState,isAdminUnlocked}from"./src/state/admin.js";import{setActiveJob}from"./src/state/jobs.js";import{saveDraft,loadDraft,clearDraft}from"./js/storageDraft.js";import{appendHistoryEntry,loadHistory as loadHistoryEntries,deleteHistoryEntry,migrateHistory,buildHistoryKey as computeHistoryKey}from"./js/storageHistory.js";import{normalizeHistoryEntry as baseNormalizeHistoryEntry,normalizeHistoryList,formatDateLabel,normalizeSearchValue}from"./js/history-normalizer.js";import{downloadBlob}from"./js/utils/downloadBlob.js";import{initSharedCasesPanel}from"./js/shared-cases-panel.js";import{initAuthGate}from"./src/auth/auth-gate.js";import{getAuthIdentity}from"./src/auth/auth-provider.js";import{applyBuildMetadata,updateCurrentView}from"./src/state/debug.js";import{initDebugOverlay}from"./src/ui/debug-overlay.js";import{initTeamAdminPage}from"./src/ui/team-admin-page.js";import{initAppGuard}from"./src/ui/app-guard.js";import"./boot-inline.js";function getCurrentAppVersion(){return"undefined"!=typeof window&&"string"==typeof window.CSSMATE_APP_VERSION?window.CSSMATE_APP_VERSION:"undefined"!=typeof self&&"string"==typeof self.CSSMATE_APP_VERSION?self.CSSMATE_APP_VERSION:"dev"}function showUpdateBanner(e,t){if("undefined"==typeof document)return;if("undefined"!=typeof navigator&&navigator.webdriver)return;if(document.getElementById("cssmate-update-banner"))return;const a=document.createElement("div");if(a.id="cssmate-update-banner",a.style.position="fixed",a.style.left="0",a.style.right="0",a.style.bottom="0",a.style.zIndex="9999",a.style.padding="8px 12px",a.style.fontSize="12px",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.style.background="#222",a.style.color="#fff",a.innerHTML=`\n    <span>Ny version af Cssmate er klar (fra ${t} til ${e}).</span>\n    <button type="button" id="cssmate-update-btn">Opdater nu</button>\n  `,!document.body)return;document.body.appendChild(a);const r=document.getElementById("cssmate-update-btn");r&&(r.style.marginLeft="12px",r.style.padding="4px 10px",r.style.fontSize="12px",r.style.cursor="pointer",r.addEventListener("click",(()=>{"undefined"!=typeof window&&("undefined"!=typeof navigator&&"serviceWorker"in navigator?navigator.serviceWorker.getRegistrations().then((e=>Promise.all(e.map((e=>e.update()))))).finally((()=>{window.location.reload(!0)})):window.location.reload(!0))})))}function runWhenIdle(e){"function"!=typeof requestIdleCallback?setTimeout(e,150):requestIdleCallback(e,{timeout:1500})}async function ensureExportPanelModule(){return exportPanelPromise||(exportPanelPromise=import("./js/akkord-export-ui.js").then((e=>("function"==typeof e?.initExportPanel&&e.initExportPanel(),exportPanelReady=!0,e))).catch((e=>{throw exportPanelPromise=null,e})),exportPanelPromise)}function bindLazyExportAction(e,t){const a="undefined"!=typeof document?document.getElementById(e):null;a&&a.addEventListener("click",(async e=>{if(!exportPanelReady){e.preventDefault(),e.stopImmediatePropagation();try{const a=await ensureExportPanelModule(),r=a?.[t];"function"==typeof r&&r(e)}catch(e){console.error("Eksport-panel kunne ikke indlÃ¦ses",e),updateActionHint("Kunne ikke indlÃ¦se eksport-funktionerne. PrÃ¸v igen.","error")}}}),{capture:!0})}function setupLazyExportPanelTriggers(){if("undefined"==typeof document)return;const e=document.querySelector(".export-panel");if(!e)return;const t=()=>{ensureExportPanelModule().catch((e=>{console.warn("Kunne ikke forberede eksportpanelet",e)})),ensureExportLibsLazy()?.catch?.((e=>console.warn("Kunne ikke loade eksportlibs",e))),ensureZipLibLazy()?.catch?.((e=>console.warn("Kunne ikke loade ZIP-lib",e)))};if(["pointerenter","touchstart","focusin"].forEach((a=>{e.addEventListener(a,t,{once:!0})})),"IntersectionObserver"in window){const a=new IntersectionObserver((e=>{e.some((e=>e.isIntersecting))&&(t(),a.disconnect())}),{rootMargin:"128px"});a.observe(e)}bindLazyExportAction("btn-export-akkord-pdf","handleExportAkkordPDF"),bindLazyExportAction("btn-import-akkord","handleImportAkkordAction"),bindLazyExportAction("btn-print-akkord","handlePrintAkkord")}async function ensureExportLibsLazy(){return exportLibsLoader||(exportLibsLoader=import("./src/features/export/lazy-libs.js").then((e=>e.ensureExportLibs()))),exportLibsLoader}async function ensureZipLibLazy(){return zipLibLoader||(zipLibLoader=import("./src/features/export/lazy-libs.js").then((e=>e.ensureZipLib()))),zipLibLoader}"undefined"!=typeof document&&document.documentElement.classList.add("app-booting"),initDebugOverlay(),applyBuildMetadata(),function(){if("undefined"==typeof window)return;const e=getCurrentAppVersion(),t="cssmate_app_version";try{const a=window.localStorage;if(!a)return;const r=a.getItem(t);r&&r!==e&&showUpdateBanner(e,r),a.setItem(t,e)}catch(e){console.warn("Unable to access localStorage for version check",e)}}();const IOS_INSTALL_PROMPT_DISMISSED_KEY="csmate.iosInstallPromptDismissed",TAB_STORAGE_KEY="csmate:lastTab",LEGACY_TAB_STORAGE_KEYS=["sscaff:lastTab","cssmate:lastActiveTab"],KNOWN_TAB_ID_ORDER=["sagsinfo","optaelling","lon","historik","delte-sager","team","hjaelp"],KNOWN_TAB_IDS=new Set(KNOWN_TAB_ID_ORDER),DEFAULT_TAB_ID=KNOWN_TAB_ID_ORDER[0],INSTALL_BUTTON_DISABLED_TOOLTIP="TilfÃ¸j via browsermenu pÃ¥ denne platform",PWA_INSTALL_AVAILABLE_EVENT="csmate:pwa-install-available",PWA_INSTALL_CONSUMED_EVENT="csmate:pwa-install-consumed";let DEFAULT_ADMIN_CODE_HASH="",materialsVirtualListController=null,currentTabId=null,exportPanelReady=!1,exportPanelPromise=null,exportLibsLoader=null,zipLibLoader=null,tabButtons=[],tabPanels=[],tabsInitialized=!1;const domCache=new Map;let deferredInstallPromptEvent=null,historyPersistencePaused=!1,draftPersistencePaused=!1,materialsDataPromise=null,materialsUiReadyPromise=null,materialsWarmupScheduled=!1;function ensureMaterialsDataLoad(){return materialsDataPromise||(materialsDataPromise=ensureMaterialDatasets().catch((e=>{throw console.error("Kunne ikke indlÃ¦se materialelisterne.",e),updateActionHint("Kunne ikke indlÃ¦se materialelisterne. PrÃ¸v at genindlÃ¦se siden.","error"),materialsDataPromise=null,e}))),materialsDataPromise}function warmupMaterialsDataLoad(){materialsWarmupScheduled||(materialsWarmupScheduled=!0,runWhenIdle((()=>{ensureMaterialsDataLoad()?.catch((()=>{materialsWarmupScheduled=!1}))})))}function ensureMaterialsUiReady(){return materialsUiReadyPromise||(materialsUiReadyPromise=ensureMaterialsDataLoad().then((()=>{setupListSelectors(),setupMaterialSearchUi(),renderOptaelling(),setupCSVImport(),populateRecentCases(),updateTotals(!0)})).catch((e=>{throw console.error("Materiale-UI kunne ikke initialiseres",e),updateActionHint("Kunne ikke initialisere materialelisterne. Opdater siden for at prÃ¸ve igen.","error"),materialsUiReadyPromise=null,e}))),materialsUiReadyPromise}function setDeferredInstallPromptEvent(e){if(deferredInstallPromptEvent=e,"undefined"==typeof window||"function"!=typeof window.dispatchEvent)return;const t=e?PWA_INSTALL_AVAILABLE_EVENT:PWA_INSTALL_CONSUMED_EVENT;window.dispatchEvent(new Event(t))}function getDeferredInstallPromptEvent(){return deferredInstallPromptEvent}function consumeDeferredInstallPromptEvent(){const e=deferredInstallPromptEvent;return e&&setDeferredInstallPromptEvent(null),e}function pauseHistoryPersistence(){historyPersistencePaused=!0}function resumeHistoryPersistence(){historyPersistencePaused=!1}function pauseDraftPersistence(){draftPersistencePaused=!0,draftSaveTimer&&(clearTimeout(draftSaveTimer),draftSaveTimer=null)}function resumeDraftPersistence(){draftPersistencePaused=!1}function isKnownTabId(e){return"string"==typeof e&&KNOWN_TAB_IDS.has(e)}function getDomElement(e){if(!e||"undefined"==typeof document||"function"!=typeof document.getElementById)return null;const t=domCache.get(e);if(t&&t.isConnected)return t;const a=document.getElementById(e);return a?domCache.set(e,a):domCache.delete(e),a}"undefined"!=typeof window&&(window.addEventListener("beforeinstallprompt",(e=>{e.preventDefault(),setDeferredInstallPromptEvent(e)})),window.addEventListener("appinstalled",(()=>{setDeferredInstallPromptEvent(null)})));const KNOWN_ADMIN_CODE_HASHES=new Set(["ff0a69fa196820f9529e3c20cfa809545e6697f5796527f7657a83bb7e6acd0d"]),KNOWN_ADMIN_CODES=new Set(["StilAce"]);async function loadDefaultAdminCode(){try{const e=await fetch("./data/tenants/hulmose.json");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();t&&"string"==typeof t._meta?.admin_code&&(DEFAULT_ADMIN_CODE_HASH=t._meta.admin_code,KNOWN_ADMIN_CODE_HASHES.add(DEFAULT_ADMIN_CODE_HASH))}catch(e){console.warn("Kunne ikke indlÃ¦se standard admin-kode",e)}}loadDefaultAdminCode();let admin=restoreAdminState();function updateSlaebFormulaInfo(e){const t=document.getElementById("slaebPercentCalcInfo");if(!t)return;const a="string"==typeof e?e.trim():"";t.textContent=a?`Formel (A9): ${a}`:""}"undefined"!=typeof document&&initClickGuard();let guideModalLastFocus=null,guideModalEscapeHandler=null;function getGuideModalElement(){return document.getElementById("guideModal")}function attachGuideModalEscapeHandler(){guideModalEscapeHandler||"undefined"==typeof document||(guideModalEscapeHandler=e=>{"Escape"===e.key&&isGuideModalOpen()&&(e.preventDefault(),closeGuideModal())},document.addEventListener("keydown",guideModalEscapeHandler))}function detachGuideModalEscapeHandler(){guideModalEscapeHandler&&"undefined"!=typeof document&&(document.removeEventListener("keydown",guideModalEscapeHandler),guideModalEscapeHandler=null)}function openGuideModal(){const e=getGuideModalElement();if(!e)return;guideModalLastFocus=document.activeElement instanceof HTMLElement?document.activeElement:null,e.removeAttribute("hidden"),e.dataset.open="true",e.classList.add("open"),e.setAttribute("aria-hidden","false");const t=e.querySelector(".modal-content");t&&"function"==typeof t.focus&&t.focus(),attachGuideModalEscapeHandler()}function closeGuideModal(){const e=getGuideModalElement();if(!e)return;e.classList.remove("open"),e.removeAttribute("data-open"),e.setAttribute("aria-hidden","true"),e.setAttribute("hidden",""),detachGuideModalEscapeHandler();const t=guideModalLastFocus;guideModalLastFocus=null,t&&document.contains(t)&&"function"==typeof t.focus&&t.focus()}function isGuideModalOpen(){const e=getGuideModalElement();return Boolean(e&&"true"===e.dataset.open)}function setupGuideModal(){const e=getGuideModalElement();if(!e)return;const t=e.querySelector(".modal-close");t&&t.addEventListener("click",(()=>closeGuideModal())),e.addEventListener("click",(t=>{t.target===e&&closeGuideModal()})),document.getElementById("btnOpenGuideModal")?.addEventListener("click",(()=>{openGuideModal()}))}function setupAdminControls(){const e=document.getElementById("btnHardResetApp");if(!e)return;const t=t=>{t?(e.removeAttribute("hidden"),e.disabled=!1):(e.setAttribute("hidden",""),e.disabled=!0)};t(isAdminUnlocked()),document.addEventListener("csmate:admin-change",(e=>{t(Boolean(e?.detail?.unlocked))}))}function getStoredTabId(){try{const e=window.localStorage;if(!e)return"";const t=e.getItem(TAB_STORAGE_KEY);if(isKnownTabId(t))return t;for(const t of LEGACY_TAB_STORAGE_KEYS){const a=e.getItem(t);if(isKnownTabId(a))return a}}catch{}return""}function focusTabByIndex(e){if(!ensureTabCollections())return;const t=(e+tabButtons.length)%tabButtons.length,a=tabButtons[t];a&&setActiveTab(a.dataset.tabId,{focus:!0})}function handleTabKeydown(e,t){const a=e.key;if("ArrowRight"!==a&&"ArrowLeft"!==a){if("Home"===a)return e.preventDefault(),void focusTabByIndex(0);if("End"===a)return e.preventDefault(),void focusTabByIndex(tabButtons.length-1);if(" "===a||"Enter"===a){e.preventDefault();const a=tabButtons[t];a&&setActiveTab(a.dataset.tabId,{focus:!0})}}else{e.preventDefault();focusTabByIndex(t+("ArrowRight"===a?1:-1))}}function refreshTabCollections(){if("undefined"==typeof document)return tabButtons=[],void(tabPanels=[]);tabButtons=Array.from(document.querySelectorAll('[role="tab"][data-tab-id]')).filter((e=>isKnownTabId(e.dataset.tabId)&&!e.hasAttribute("data-tab-disabled")&&!e.hidden)),tabPanels=Array.from(document.querySelectorAll('[role="tabpanel"][data-tab-panel]')).filter((e=>isKnownTabId(e.dataset.tabPanel)&&!e.hasAttribute("data-tab-disabled")))}function ensureTabCollections(){return tabButtons.length&&tabPanels.length||refreshTabCollections(),tabButtons.length&&tabPanels.length}function findFirstAvailableTabId(){const e=KNOWN_TAB_ID_ORDER.find((e=>tabButtons.some((t=>t.dataset.tabId===e))));return e||(tabButtons[0]?.dataset.tabId||DEFAULT_TAB_ID)}function ensureActiveTabAvailable(){if(!ensureTabCollections())return;tabButtons.some((e=>e.dataset.tabId===currentTabId))||setActiveTab(findFirstAvailableTabId(),{focus:!1})}function refreshTabsAndValidate(){refreshTabCollections(),ensureActiveTabAvailable()}function setActiveTab(e,{focus:t=!1}={}){if(!ensureTabCollections())return;const a=isKnownTabId(e)?e:DEFAULT_TAB_ID,r=tabButtons.find((e=>e.dataset.tabId===a))||tabButtons.find((e=>e.dataset.tabId===DEFAULT_TAB_ID))||tabButtons[0];if(!r)return void console.warn("Faneknap ikke fundet for id",e);const n=r.dataset.tabId;if(!n)return void console.warn("Faneknap mangler data-tab-id",r);const o=tabPanels.find((e=>e.dataset.tabPanel===n));if(o)if(currentTabId!==n){tabButtons.forEach((e=>{const t=e===r;e.classList.toggle("tab--active",t),e.setAttribute("aria-selected",t?"true":"false"),e.tabIndex=t?0:-1})),tabPanels.forEach((e=>{const t=e===o;e.classList.toggle("tab-panel--active",t),t?(e.removeAttribute("hidden"),e.setAttribute("aria-hidden","false")):(e.setAttribute("hidden",""),e.setAttribute("aria-hidden","true"))})),currentTabId=n,updateCurrentView(n);try{const e=window.localStorage;e&&isKnownTabId(n)&&(e.setItem(TAB_STORAGE_KEY,n),LEGACY_TAB_STORAGE_KEYS.forEach((t=>{try{e.setItem(t,n)}catch{}})))}catch{}"optaelling"===n&&ensureMaterialsUiReady().catch((()=>{})),"lon"===n&&ensureWorkersInitialized(),t&&"function"==typeof r.focus&&r.focus()}else t&&"function"==typeof r.focus&&r.focus();else console.warn("Tab-panel ikke fundet for id",n)}function initTabs(){if(tabsInitialized)return;if("undefined"!=typeof document&&"loading"===document.readyState)return void document.addEventListener("DOMContentLoaded",(()=>initTabs()),{once:!0});refreshTabCollections();const e=()=>{if(tabsInitialized)return;tabButtons.forEach(((e,t)=>{const a=e.dataset.tabId,r="true"===e.getAttribute("aria-selected");e.tabIndex=r?0:-1,e.addEventListener("click",(()=>setActiveTab(a))),e.addEventListener("keydown",(e=>handleTabKeydown(e,t)))}));const e=tabButtons.find((e=>"optaelling"===e.dataset.tabId));if(e){const t=()=>warmupMaterialsDataLoad();["pointerenter","touchstart","focusin"].forEach((a=>{e.addEventListener(a,t,{once:!0,passive:!0})}))}const t=getStoredTabId(),a=tabButtons.some((e=>e.dataset.tabId===t))?t:tabButtons.find((e=>"true"===e.getAttribute("aria-selected")))?.dataset.tabId||findFirstAvailableTabId();tabsInitialized=!0,setActiveTab(a,{focus:!1}),"undefined"!=typeof window&&(window.__cssmateSetActiveTab=(e,t)=>setActiveTab(e,t))};if(tabButtons.length&&tabPanels.length)e();else{if("undefined"==typeof document)return;if(!(document.querySelector('[role="tab"][data-tab-id]')||document.querySelector('[role="tabpanel"][data-tab-panel]')))return;const t=()=>{tabsInitialized||(refreshTabCollections(),tabButtons.length&&tabPanels.length?e():console.warn("Faner kunne ikke initialiseres â€“ mangler markup"))};"undefined"!=typeof document&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):runWhenIdle(t)}}function setupA9Integration(){const e=document.querySelector('input[data-a9-slaeb="true"]'),t=document.querySelector(".js-slaeb-calc-link");if(t){const e=t.dataset.calcUrl||"https://cala9.netlify.app/";t.addEventListener("click",(t=>{t&&(t.preventDefault(),t.stopPropagation()),window.open(e,"_blank","noopener,noreferrer")}))}if(!e)return;e.addEventListener("a9-commit",(e=>{const t="string"==typeof e?.detail?.formulaText?e.detail.formulaText:"";setSlaebFormulaText(t),updateSlaebFormulaInfo(t)}));const a=()=>{if("1"===e.dataset.a9Commit)return;setSlaebFormulaText("");const t=e.value?.trim();updateSlaebFormulaInfo(t?`Manuel vÃ¦rdi: ${t}`:"")};e.addEventListener("input",a),e.addEventListener("change",a),updateSlaebFormulaInfo(exportMeta.slaebFormulaText)}function formatCurrency(e){return new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0)}function toNumber(e){if("number"==typeof e)return Number.isFinite(e)?e:0;if(null==e)return 0;const t=String(e).trim();if(!t)return 0;const a=t.replace(/\s+/g,"").replace(/'/g,""),r=a.match(/[.,]/g)||[];let n=a.replace(/[^0-9.,-]/g,"");if(r.length>1){const e=r[r.length-1],t=n.lastIndexOf(e),a=n.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=n.slice(t+1).replace(/[^0-9]/g,"");n=`${a||"0"}.${o}`}else if(1===r.length)if(/^-?\d{1,3}(?:[.,]\d{3})+$/.test(n))n=n.replace(/[.,]/g,"").replace(/(?!^)-/g,"");else{const e=r[0],t=n.lastIndexOf(e),a=n.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=n.slice(t+1).replace(/[^0-9]/g,"");n=`${a||"0"}.${o}`}else n=n.replace(/(?!^)-/g,"");const o=Number.parseFloat(n);return Number.isFinite(o)?o:0}function formatNumber(e){const t=Number.isFinite(e)?e:parseFloat(e)||0;return new Intl.NumberFormat("da-DK",{minimumFractionDigits:0,maximumFractionDigits:2}).format(t)}"undefined"!=typeof window&&(window.__cssmateRefreshTabs=refreshTabsAndValidate);let workerCount=0,laborEntries=[],lastLoensum=0,lastMaterialSum=0,lastExportModel=null,lastEkompletData=null,lastJobSummary=null,recentCasesCache=[];function deriveSagsinfoFromEntry(e={}){const t=e.meta||{},a=e.data?.sagsinfo||{},r=e.payload?.job?.info||e.payload?.info||{};return{sagsnummer:t.sagsnummer||a.sagsnummer||r.sagsnummer||r.caseNumber||"",navn:t.navn||a.navn||r.navn||r.opgave||r.title||"",adresse:t.adresse||a.adresse||r.adresse||r.address||r.site||"",kunde:t.kunde||a.kunde||r.kunde||r.customer||"",dato:t.dato||a.dato||r.dato||r.date||"",montoer:t.montoer||a.montoer||r.montoer||r.worker||r.montor||""}}function syncRecentProjectsGlobal(e=recentCasesCache){if("undefined"==typeof window)return;const t=Array.isArray(e)?e.slice():[];window.__cssmateRecentProjects=t}syncRecentProjectsGlobal([]);let cachedDBPromise=null;const DEFAULT_ACTION_HINT="Udfyld Sagsinfo for at fortsÃ¦tte.",DB_NAME="csmate_projects",DB_STORE="projects",TRAELLE_RATE35=10.44,TRAELLE_RATE50=14.62,BORING_HULLER_RATE=4.7,LUK_HULLER_RATE=3.45,BORING_BETON_RATE=11.49,OPSKYDELIGT_RATE=9.67,KM_RATE=2.12,TILLAEG_UDD1=42.98,TILLAEG_UDD2=49.38,DEFAULT_MENTOR_RATE=22.26,historyNormalizeOptions={tillaegUdd1:42.98,tillaegUdd2:49.38,mentorRate:22.26},normalizeHistoryEntry=e=>{if(!e)return null;let t=e.data;if(!t&&e.payload)try{t=normalizeImportedJsonSnapshot(e.payload)}catch(e){console.warn("Kunne ikke normalisere historik-post",e)}const a=baseNormalizeHistoryEntry({...e,data:t},historyNormalizeOptions);return a&&!a.caseKey&&(a.caseKey=e?.caseKey||computeHistoryKey(a)||a.id),a},MATERIAL_SEARCH_DEBOUNCE_MS=130,MATERIAL_SEARCH_SUGGESTION_LIMIT=6,UI_SCALE_STORAGE_KEY="sscaff.uiScale",UI_SCALE_DEFAULT=1,UI_SCALE_MIN=.75,UI_SCALE_MAX=1.1,UI_SCALE_STEP=.05;let systemDatasets={},dataBosta=[],dataHaki=[],dataModex=[],dataAlfix=[],systemOptions=[];const SYSTEM_ACCESSIBLE_LABELS={bosta:"BOSTA 2025",haki:"HAKI 2025",modex:"MODEX 2025",alfix:"ALFIX 2025"};let systemLabelMap=new Map;const selectedSystemKeys=new Set;let datasetModulePromise=null,materialsReady=!1,showOnlySelectedMaterials=!1,lastRenderShowSelected=null,materialsSearchQuery="",materialsSearchQueryNormalized="",materialsSearchInput=null,materialsSearchClearBtn=null,materialsSearchStats=null,materialsSearchSuggestions=null,materialsSearchDebounce=null,lastMaterialBaseList=[],lastRenderedMaterials=[],detachMaterialScrollHandler=null,uiScale=1,uiScalePopover=null,uiScaleToggle=null,lonOutputsRevealed=!1,historySearchTerm="";const HISTORY_PAGE_SIZE=50;let historyVisibleCount=HISTORY_PAGE_SIZE,historyFilters={recentDays:0,requireCaseNumber:!1,requireWorkerRates:!1},openHistoryId=null,normalizedHistoryCache=[],filteredHistoryCache=[],draftSaveTimer=null,lastDraftSerialized="";const DRAFT_SAVE_DEBOUNCE=350;function clampUiScale(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.min(1.1,Math.max(.75,t)):1}function applyUiScale(e){if(uiScale=clampUiScale(e),"undefined"!=typeof document&&document.documentElement?.style){document.documentElement.style.setProperty("--uiScale",uiScale);const e=document.getElementById("uiScaleValue");e&&(e.textContent=`${Math.round(100*uiScale)}%`)}try{window.localStorage?.setItem("sscaff.uiScale",String(uiScale))}catch{}}function bootstrapUiScale(){if("undefined"==typeof window)return void applyUiScale(1);let e=1;try{const t=window.localStorage?.getItem("sscaff.uiScale"),a=Number.parseFloat(t);Number.isFinite(a)&&(e=a)}catch{}applyUiScale(e)}function changeUiScale(e){const t=Number.isFinite(e)?e:.05;applyUiScale(uiScale+t)}function setupUiScaleControls(){uiScaleToggle=document.getElementById("uiScaleToggle"),uiScalePopover=document.getElementById("uiScalePopover");const e=document.getElementById("uiScaleValue");if(e&&(e.textContent=`${Math.round(100*uiScale)}%`),!uiScaleToggle||!uiScalePopover)return;const t=e=>{uiScalePopover&&(e?(uiScalePopover.removeAttribute("hidden"),uiScaleToggle?.setAttribute("aria-expanded","true")):(uiScalePopover.setAttribute("hidden",""),uiScaleToggle?.setAttribute("aria-expanded","false")))};uiScaleToggle.addEventListener("click",(e=>{e.stopPropagation();const a=uiScalePopover?.hasAttribute("hidden");t(a)})),uiScalePopover.addEventListener("click",(e=>{const a=e.target;a instanceof HTMLElement&&(a.dataset.scale?(applyUiScale(Number.parseFloat(a.dataset.scale)),t(!1)):a.dataset.scaleStep?changeUiScale(Number.parseFloat(a.dataset.scaleStep)):a.dataset.scaleReset&&(applyUiScale(1),t(!1)))})),document.addEventListener("click",(e=>{uiScalePopover&&!uiScalePopover.hasAttribute("hidden")&&(uiScalePopover.contains(e.target)||uiScaleToggle?.contains(e.target)||t(!1))})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&uiScalePopover&&!uiScalePopover.hasAttribute("hidden")&&t(!1)}))}function loadMaterialDatasetModule(){return datasetModulePromise||(datasetModulePromise=import("./dataset.js")),datasetModulePromise}function normalizeQuery(e){return null==e?"":String(e).toLowerCase().replace(/\s+/g," ").trim()}function buildSearchKey(e){if(!e)return"";const t=[],a=e.name||e.label||"",r=e.systemKey||e.system||"",n=e.systemLabel||SYSTEM_ACCESSIBLE_LABELS[r];return a&&t.push(a),r&&t.push(r),n&&t.push(n),e.id&&t.push(e.id),normalizeQuery(t.join(" "))}function getMaterialSearchKey(e){if(!e)return"";if(e.searchKey)return e.searchKey;const t=buildSearchKey(e);return e.searchKey=t,t}function updateMaterialSearchKey(e){if(!e)return"";const t=buildSearchKey(e);return e.searchKey=t,t}function createSystemMaterialState(e){return e&&Array.isArray(e.items)?e.items.filter((e=>{const t="string"==typeof e?.category?e.category.toLowerCase():"material";if(t&&"material"!==t&&"materiale"!==t)return!1;const a=normalizeKey(String(e?.name||e?.navn||e?.beskrivelse||"").trim());return a&&!EXCLUDED_MATERIAL_KEYS.includes(a)})).map(((t,a)=>{const r=t?.name||t?.navn||t?.beskrivelse||"",n=r?.trim()||`${e.id} materiale ${a+1}`,o=t?.id||t?.varenr||`${e.id}-${a+1}`;return{id:o,name:n,price:toNumber(t?.price??t?.pris??0),unit:t?.unit||t?.enhed||"",quantity:0,systemKey:e.id,systemLabel:e.label,searchKey:buildSearchKey({name:n,id:o,systemKey:e.id,systemLabel:e.label}),category:"string"==typeof t?.category?t.category.toLowerCase():"material"}})):[]}async function ensureMaterialDatasets(){if(systemOptions.length)return systemOptions;const e=await loadMaterialDatasetModule(),t="function"==typeof e.getAllSystems?e.getAllSystems():[];systemDatasets={},t.forEach((e=>{systemDatasets[e.id]=createSystemMaterialState(e)})),dataBosta=systemDatasets.bosta??[],dataHaki=systemDatasets.haki??[],dataModex=systemDatasets.modex??[],dataAlfix=systemDatasets.alfix??[],systemOptions=t.map((e=>({key:e.id,label:e.label,dataset:systemDatasets[e.id]??[]})));const a=Object.keys(e.MATERIAL_SYSTEMS||{}).map((t=>{const a="function"==typeof e.getSystemList?e.getSystemList(t):null;return[t,a?.label??t]}));return systemLabelMap=new Map(a),materialsReady=!0,ensureSystemSelection(),systemOptions}function ensureSystemSelection(){0===selectedSystemKeys.size&&systemOptions.length&&selectedSystemKeys.add(systemOptions[0].key)}function getSelectedSystemKeys(){return ensureSystemSelection(),Array.from(selectedSystemKeys)}function getDatasetForSelectedSystems(e){const t=[],a=(Array.isArray(e)?e:e&&"function"==typeof e[Symbol.iterator]?Array.from(e):[]).map((e=>normalizeKey(e))),r=new Set(a),n=(e,a)=>{if(!Array.isArray(a))return;e.some((e=>r.has(normalizeKey(e))))&&t.push(a)};return n(["bosta","bostadata"],dataBosta),n(["haki","hakidata"],dataHaki),n(["modex","modexdata"],dataModex),n(["alfix","alfixdata"],dataAlfix),t.flat()}function toggleDuplicateWarning(e=[],t=[]){const a=document.getElementById("systemDuplicateWarning");if(!a)return;const r=Array.from(new Set(e.filter(Boolean))).slice(0,6),n=Array.from(new Set(t.filter(Boolean))).slice(0,6);if(0===r.length&&0===n.length)return a.textContent="",void a.setAttribute("hidden","");const o=[];r.length&&o.push(`Materialer slÃ¥et sammen: ${r.join(", ")}`),n.length&&o.push(`Kontroller varenr.: ${n.join(", ")}`),a.textContent=o.join(". "),a.removeAttribute("hidden")}function aggregateSelectedSystemData(){const e=getDatasetForSelectedSystems(getSelectedSystemKeys()),t=[],a=new Map,r=new Map,n=new Set,o=new Set;return e.forEach((e=>{if(!e)return;const s=null!=e.id?String(e.id):null,i=e.name?normalizeKey(e.name):null,l=i?`${e.systemKey||"global"}::${i}`:null,d=l?r.get(l):null;if(d&&d!==e)return n.add(d.name),void n.add(e.name);const u=s?a.get(s):null;if(u&&u!==e){const t=u.name?normalizeKey(u.name):null;if(t&&i&&t===i)return n.add(u.name),void n.add(e.name);o.add(u.name),o.add(e.name)}t.push(e),s&&a.set(s,e),l&&r.set(l,e)})),toggleDuplicateWarning(Array.from(n),Array.from(o)),t}bootstrapUiScale();const manualMaterials=Array.from({length:3},((e,t)=>({id:`manual-${t+1}`,name:"",price:0,quantity:0,manual:!0,searchKey:""})));function getAllData(e=!0){const t=aggregateSelectedSystemData();return e?t.concat(manualMaterials):t}function getActiveMaterialList(){return aggregateSelectedSystemData()}function getRenderMaterials(){const e=getActiveMaterialList(),t=Array.isArray(e)?e.concat(manualMaterials):manualMaterials.slice(),a=showOnlySelectedMaterials?t.filter((e=>toNumber(e?.quantity)>0)):t;if(lastMaterialBaseList=a,!materialsSearchQueryNormalized)return updateMaterialSearchStats(a.length,a.length),updateMaterialSuggestions(),a;const r=a.filter((e=>{const t=getMaterialSearchKey(e);return!!t&&t.includes(materialsSearchQueryNormalized)}));return updateMaterialSearchStats(r.length,a.length),updateMaterialSuggestions(),r}function updateMaterialSearchStats(e=0,t=0){materialsSearchStats&&(materialsSearchStats.textContent=t?`Viser ${e} / ${t}`:"")}function clearMaterialSuggestions(){materialsSearchSuggestions&&(materialsSearchSuggestions.innerHTML="",materialsSearchSuggestions.setAttribute("hidden",""))}function scrollFirstMaterialMatch(e){if(!e||!materialsVirtualListController||!materialsVirtualListController.container)return;const t=lastRenderedMaterials.findIndex((t=>{const a=getMaterialSearchKey(t);return a&&a.includes(e)}));if(t<0)return;const a=materialsVirtualListController.rowHeight||64,r=Math.max(t-1,0)*a;try{materialsVirtualListController.container.scrollTo({top:r,behavior:"smooth"})}catch{materialsVirtualListController.container.scrollTop=r}}function updateMaterialSuggestions(){if(!materialsSearchSuggestions)return;if(!materialsSearchQueryNormalized||materialsSearchQueryNormalized.length<2||0===lastMaterialBaseList.length)return void clearMaterialSuggestions();const e=[],t=new Set;for(const a of lastMaterialBaseList){const r=getMaterialSearchKey(a);if(!r||!r.includes(materialsSearchQueryNormalized))continue;const n=a.name||a.id||"Materiale",o=normalizeQuery(n);if(!t.has(o)&&(e.push(n),t.add(o),e.length>=6))break}if(!e.length)return void clearMaterialSuggestions();materialsSearchSuggestions.innerHTML="";const a=document.createDocumentFragment();e.forEach((e=>{const t=document.createElement("button");t.type="button",t.className="material-search__suggestion",t.textContent=e,t.addEventListener("click",(()=>{setMaterialSearchQuery(e,{immediate:!0}),scrollFirstMaterialMatch(materialsSearchQueryNormalized),clearMaterialSuggestions(),materialsSearchInput?.blur()})),a.appendChild(t)})),materialsSearchSuggestions.appendChild(a),materialsSearchSuggestions.removeAttribute("hidden")}function toggleMaterialSearchClear(){if(!materialsSearchClearBtn)return;const e=Boolean(materialsSearchQuery);materialsSearchClearBtn.hidden=!e}function setMaterialSearchQuery(e,{immediate:t=!0,syncInput:a=!0}={}){materialsSearchQuery=e||"",materialsSearchQueryNormalized=normalizeQuery(materialsSearchQuery),a&&materialsSearchInput&&materialsSearchInput.value!==materialsSearchQuery&&(materialsSearchInput.value=materialsSearchQuery),toggleMaterialSearchClear(),t&&renderOptaelling()}function scheduleMaterialSearchUpdate(e){materialsSearchDebounce&&clearTimeout(materialsSearchDebounce),materialsSearchDebounce=setTimeout((()=>{setMaterialSearchQuery(e)}),130)}function resetMaterialSearch(e=!0){materialsSearchDebounce&&(clearTimeout(materialsSearchDebounce),materialsSearchDebounce=null),materialsSearchQuery="",materialsSearchQueryNormalized="",materialsSearchInput&&(materialsSearchInput.value=""),toggleMaterialSearchClear(),clearMaterialSuggestions(),updateMaterialSearchStats(0,0),e&&renderOptaelling()}function attachMaterialSearchScrollHandler(e){if(detachMaterialScrollHandler&&detachMaterialScrollHandler(),!e)return;let t=e.scrollTop,a=null;const r=()=>{const r=e.scrollTop;a&&cancelAnimationFrame(a),a=requestAnimationFrame((()=>{Math.abs(r-t)>10&&document.activeElement===materialsSearchInput&&materialsSearchInput.blur(),t=r}))};e.addEventListener("scroll",r,{passive:!0}),detachMaterialScrollHandler=()=>{e.removeEventListener("scroll",r),a&&cancelAnimationFrame(a),detachMaterialScrollHandler=null}}function findMaterialById(e){const t=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const a of t){const t=a.find((t=>String(t.id)===String(e)));if(t)return t}return null}function setupListSelectors(){const e=getDomElement("listSelectors");if(!e)return;const t="systemSelectionWarning",a=systemOptions.map((e=>{const t=selectedSystemKeys.has(e.key)?"checked":"",a=SYSTEM_ACCESSIBLE_LABELS[e.key]||e.label;return`\n        <label class="system-option">\n          <input type="checkbox" value="${e.key}" ${t} aria-label="${a}">\n          <span aria-hidden="true">${e.label}</span>\n        </label>\n      `})).join("");e.innerHTML=`\n    <div class="system-selector" role="group" aria-labelledby="systemSelectorLabel">\n      <span id="systemSelectorLabel" class="cell-label">Systemer</span>\n      <div class="system-selector-options">${a}</div>\n    </div>\n    <p id="${t}" class="hint system-warning" hidden>VÃ¦lg mindst Ã©t system.</p>\n    <p id="systemDuplicateWarning" class="hint system-warning" hidden></p>\n  `,syncSystemSelectorState();const r=document.getElementById(t);e.addEventListener("change",(e=>{const t=e.target;if(!(t instanceof HTMLInputElement)||"checkbox"!==t.type)return;const{value:a}=t;if(t.checked)selectedSystemKeys.add(a);else if(selectedSystemKeys.delete(a),0===selectedSystemKeys.size)return r?.removeAttribute("hidden"),selectedSystemKeys.add(a),t.checked=!0,void updateActionHint("VÃ¦lg mindst Ã©t system for at fortsÃ¦tte optÃ¦llingen.","error");r?.setAttribute("hidden","");const n=getDomElement("actionHint");n&&"VÃ¦lg mindst Ã©t system for at fortsÃ¦tte optÃ¦llingen."===n.textContent&&updateActionHint(""),renderOptaelling(),updateTotals(!0)}))}function setupMaterialSearchUi(){const e=getDomElement("materialSearchBar");if(!e||"true"===e.dataset.ready)return;e.dataset.ready="true",e.classList.add("material-search");const t=document.createElement("div");t.className="material-search__row";const a=document.createElement("span");a.className="material-search__icon",a.setAttribute("aria-hidden","true"),a.textContent="ðŸ”";const r=document.createElement("input");r.type="search",r.placeholder="SÃ¸g materialeâ€¦",r.autocomplete="off",r.enterKeyHint="search",r.inputMode="search",r.setAttribute("aria-label","SÃ¸g efter materiale");const n=document.createElement("button");n.type="button",n.className="material-search__clear",n.textContent="Ã—",n.hidden=!0,t.append(a,r,n);const o=document.createElement("div");o.className="material-search__meta",o.setAttribute("aria-live","polite");const s=document.createElement("div");s.className="material-search__suggestions",s.setAttribute("hidden",""),e.append(t,o,s),materialsSearchInput=r,materialsSearchClearBtn=n,materialsSearchStats=o,materialsSearchSuggestions=s,r.addEventListener("input",(e=>{scheduleMaterialSearchUpdate(e?.target?.value??""),clearMaterialSuggestions()})),r.addEventListener("focus",(()=>updateMaterialSuggestions())),r.addEventListener("keydown",(e=>{"Escape"===e.key&&resetMaterialSearch()})),n.addEventListener("click",(()=>{resetMaterialSearch(),materialsSearchInput?.focus()})),toggleMaterialSearchClear()}function syncSystemSelectorState(){const e=getDomElement("listSelectors");e&&e.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=selectedSystemKeys.has(e.value)}))}function renderOptaelling(){const e=getDomElement("optaellingContainer");if(!e)return;const t=document.getElementById("showSelectedOnly");t&&(t.checked=showOnlySelectedMaterials,t.onchange=()=>{showOnlySelectedMaterials=t.checked,lastRenderShowSelected=null,renderOptaelling()});const a=t=>{e.textContent="";const a=document.createElement("p");a.className="empty-state",a.textContent=t,e.appendChild(a),materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null),detachMaterialScrollHandler&&detachMaterialScrollHandler(),lastMaterialBaseList=[],lastRenderedMaterials=[],updateMaterialSearchStats(0,0),clearMaterialSuggestions()};if(!materialsReady)return void a("IndlÃ¦ser materialelister...");syncSystemSelectorState();const r=getActiveMaterialList(),n=Array.isArray(r)?r.concat(manualMaterials):manualMaterials.slice(),o=getRenderMaterials();if(lastRenderedMaterials=o,!n.length)return void a("Ingen systemer valgt. VÃ¦lg et eller flere systemer for at starte optÃ¦llingen.");if(!o.length)return void a("Ingen materialer med antal.");e.querySelectorAll(".empty-state").forEach((e=>e.remove()));let s=e.querySelector(".materials-list");s||(e.textContent="",s=document.createElement("div"),s.className="materials-list csm-materials-list",e.appendChild(s)),s.classList.add("csm-materials-list");const i=(e,t)=>{const a=createMaterialRow(e,{admin:admin,toNumber:toNumber,formatCurrency:formatCurrency,systemLabelMap:systemLabelMap}),r=a?.row||a;return r&&(r.dataset.index=String(t)),a};if(lastRenderShowSelected!==showOnlySelectedMaterials&&materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null),lastRenderShowSelected=showOnlySelectedMaterials,materialsVirtualListController&&materialsVirtualListController.container===s)materialsVirtualListController.controller.update(o);else{const e=createVirtualMaterialsList({container:s,items:o,renderRow:i,rowHeight:64,overscan:8});materialsVirtualListController={container:s,controller:e,rowHeight:64}}attachMaterialSearchScrollHandler(s),initMaterialsScrollLock(e),updateTotals(!0)}function handleOptaellingInput(e){const t=e.target;t&&t.classList&&(t.classList.contains("qty")?handleQuantityChange(e):t.classList.contains("price")?handlePriceChange(e):t.classList.contains("manual-name")&&handleManualNameChange(e))}function handleQuantityChange(e){const{id:t}=e.target.dataset;updateQty(t,e.target.value)}function handlePriceChange(e){const{id:t}=e.target.dataset;updatePrice(t,e.target.value)}function handleManualNameChange(e){const{id:t}=e.target.dataset,a=findMaterialById(t);a&&a.manual&&(a.name=e.target.value,updateMaterialSearchKey(a),materialsSearchQueryNormalized&&renderOptaelling())}function findMaterialRowElement(e){const t=document.querySelectorAll(".material-row");return Array.from(t).find((t=>Array.from(t.querySelectorAll("input[data-id]")).some((t=>t.dataset.id===String(e)))))||null}function updateQty(e,t){const a=findMaterialById(e);if(!a)return;const r=toNumber(a.quantity),n=toNumber(t);if(a.quantity=n,refreshMaterialRowDisplay(e),updateTotals(),showOnlySelectedMaterials){r>0!==n>0&&renderOptaelling()}}function updatePrice(e,t){const a=findMaterialById(e);a&&(a.manual||admin)&&(a.price=toNumber(t),refreshMaterialRowDisplay(e),updateTotals())}function refreshMaterialRowDisplay(e){const t=findMaterialById(e);if(!t)return;const a=findMaterialRowElement(e);if(!a)return;const r=a.querySelector("input.qty");if(r&&document.activeElement!==r)if(t.manual){const e=null!==t.quantity&&void 0!==t.quantity&&""!==t.quantity;r.value=e?String(t.quantity):""}else{const e=null!=t.quantity?t.quantity:0;r.value=String(e)}const n=a.querySelector("input.price");if(n&&document.activeElement!==n){const e=null!==t.price&&void 0!==t.price&&""!==t.price,a=e?toNumber(t.price):"";if(t.manual)n.value=e?String(a):"",n.readOnly=!1;else{const e=toNumber(t.price);n.value=Number.isFinite(e)?e.toFixed(2):"0.00",n.readOnly=!admin}n.dataset.price=e?String(a):""}const o=a.querySelector(".mat-line");if(o)if("undefined"!=typeof window&&"function"==typeof window.updateMaterialLine)window.updateMaterialLine(a,{formatPrice:!0,shouldUpdateTotals:!1});else{const e=`${formatCurrency(toNumber(t.price)*toNumber(t.quantity))} kr`;o instanceof HTMLInputElement?o.value=e:o.textContent=e}}function calcMaterialesum(){return getAllData().reduce(((e,t)=>e+toNumber(t.price)*toNumber(t.quantity)),0)}function renderCurrency(e,t){let a=[];if("string"==typeof e?a=Array.from(document.querySelectorAll(e)):e instanceof Element?a=[e]:e&&"number"==typeof e.length&&(a=Array.from(e)),0===a.length)return;const r=`${formatCurrency(t)} kr`;a.forEach((e=>{e.textContent=r}))}let totalsUpdateTimer=null;function computeTraelleTotals(){const e=toNumber(document.getElementById("traelleloeft35")?.value),t=toNumber(document.getElementById("traelleloeft50")?.value),a={n35:e,n50:t,RATE35:10.44,RATE50:14.62,sum:10.44*e+14.62*t};return"undefined"!=typeof window&&(window.__traelleloeft=a),a}function performTotalsUpdate(){markExportModelDirty();const e=computeTraelleTotals(),t=e&&Number.isFinite(e.sum)?e.sum:0,a="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,r=getAllData().map((e=>({qty:toNumber(e?.quantity),unitPrice:toNumber(e?.price)*a}))),n=calcMaterialesum()+t,o=toNumber(document.getElementById("slaebePct")?.value),s=n*(Number.isFinite(o)?o/100:0),i={"trallelÃ¸ft":t,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},l=Array.isArray(laborEntries)?laborEntries.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)}))):[],d=l.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),u=calculateTotals({materialLines:r,slaebeBelob:s,extra:i,workers:l,totalHours:d});lastMaterialSum=u.samletAkkordsum,lastLoensum=u.montoerLonMedTillaeg,renderCurrency('[data-total="material"]',u.samletAkkordsum),renderCurrency('[data-total="labor"]',u.montoerLonMedTillaeg),renderCurrency('[data-total="project"]',u.projektsum);const c=document.getElementById("montagepris");c&&(c.value=n.toFixed(2));const m=document.getElementById("demontagepris");m&&(m.value=(.5*n).toFixed(2)),updateExportButtonsState(),scheduleDraftSave()}function updateTotals(e={}){if(!0===e||e?.immediate)return totalsUpdateTimer&&(clearTimeout(totalsUpdateTimer),totalsUpdateTimer=null),void performTotalsUpdate();totalsUpdateTimer&&clearTimeout(totalsUpdateTimer),totalsUpdateTimer=setTimeout((()=>{totalsUpdateTimer=null,performTotalsUpdate()}),80)}function updateTotal(){updateTotals()}function persistDraftSnapshot(){if(!draftPersistencePaused)try{const e=collectProjectSnapshot();if(!e)return;const t=JSON.stringify(e);if(t===lastDraftSerialized)return;lastDraftSerialized=t,saveDraft(e)}catch(e){console.warn("Kunne ikke gemme kladde",e)}}function scheduleDraftSave(){draftPersistencePaused||(draftSaveTimer&&clearTimeout(draftSaveTimer),draftSaveTimer=setTimeout((()=>{draftSaveTimer=null,persistDraftSnapshot()}),350))}const sagsinfoFieldIds=["sagsnummer","sagsnavn","sagsadresse","sagskunde","sagsdato","sagsmontoer"];function collectSagsinfo(){const e=e=>getDomElement(e)?.value??"";return{sagsnummer:e("sagsnummer").trim(),navn:e("sagsnavn").trim(),adresse:e("sagsadresse").trim(),kunde:e("sagskunde").trim(),dato:e("sagsdato"),montoer:e("sagsmontoer").trim()}}function collectAkkordComment(){return getDomElement("akkordComment")?.value||""}function setSagsinfoField(e,t){const a=getDomElement(e);if(!a)return;a.hasAttribute("readonly")&&a.removeAttribute("readonly");const r=t??"";a.value!==r?(a.value=r,["input","change"].forEach((e=>{a.dispatchEvent(new Event(e,{bubbles:!0}))}))):a.value=r}function updateActionHint(e="",t="info"){const a=getDomElement("actionHint");if(a){if(a.classList.remove("error","success"),!e)return a.textContent=DEFAULT_ACTION_HINT,a.style.display="",void(a.style.visibility="hidden");a.textContent=e,"error"===t?a.classList.add("error"):"success"===t&&a.classList.add("success"),a.style.display="",a.style.visibility="visible"}}function handleIndexMissingEvent(e){const t=e?.detail||{};updateActionHint(`${t.message||"Mangler Firestore index. Se console for create-index link."}${t.path?` (${t.path})`:""}`,"error")}function registerIndexMissingHandler(){"undefined"!=typeof window&&(window.removeEventListener("sscaff:index-missing",handleIndexMissingEvent),window.addEventListener("sscaff:index-missing",handleIndexMissingEvent))}function promisifyRequest(e){return e?new Promise(((t,a)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>a(e.error)})):Promise.resolve(void 0)}function openDB(){return cachedDBPromise||("undefined"==typeof indexedDB?(cachedDBPromise=Promise.reject(new Error("IndexedDB er ikke tilgÃ¦ngelig")),cachedDBPromise.catch((()=>{})),cachedDBPromise):(cachedDBPromise=new Promise(((e,t)=>{const a=indexedDB.open(DB_NAME,1);a.onupgradeneeded=e=>{const t=e.target?.result;t&&!t.objectStoreNames.contains(DB_STORE)&&t.createObjectStore(DB_STORE,{keyPath:"id",autoIncrement:!0})},a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error||new Error("IndexedDB kunne ikke Ã¥bnes"))})),cachedDBPromise.catch((()=>{cachedDBPromise=null})),cachedDBPromise))}async function saveProject(e,t={}){if(e)try{const a=buildHistoryEntryFromSnapshot(e,t);if(!a)return;appendHistoryEntry(a)}catch(e){console.warn("Kunne ikke gemme sag lokalt",e)}}async function deleteProjectById(e){if(!e)return!1;try{const t=deleteHistoryEntry(e);return recentCasesCache=t.map(normalizeHistoryEntry).filter(Boolean),syncRecentProjectsGlobal(recentCasesCache),!0}catch(e){return console.warn("Kunne ikke slette sag",e),!1}}async function getRecentProjects(){try{const e=migrateHistory();if(!Array.isArray(e))return[];return normalizeHistoryList(e,historyNormalizeOptions).map((e=>({...e,caseKey:e.caseKey||computeHistoryKey(e)||e.id})))}catch(e){return console.warn("Kunne ikke hente lokale sager",e),[]}}function setHistoryListBusy(e){const t=getDomElement("historyList");t&&(t.setAttribute("aria-busy",e?"true":"false"),t.classList.toggle("is-loading",Boolean(e)))}function setupHistorySearch(){const e=document.querySelector(".job-history__controls");if(!e||"true"===e.dataset.historySearch)return;e.dataset.historySearch="true";const t=document.createElement("div");t.className="history-search";const a=document.createElement("label");a.className="history-search__field",a.dataset.historySearch="true";const r=document.createElement("span");r.textContent="SÃ¸g";const n=document.createElement("input");n.type="search",n.placeholder="SÃ¸g i historikkenâ€¦",n.autocomplete="off";const o=debounce((()=>{historySearchTerm=n.value||"",historyVisibleCount=HISTORY_PAGE_SIZE,renderHistoryList(recentCasesCache)}),120);n.addEventListener("input",o),a.appendChild(r),a.appendChild(n);const s=document.createElement("div");s.className="history-search__filters";[{key:"recentDays",label:"Seneste 7 dage",computeNext:()=>historyFilters.recentDays?0:7},{key:"requireCaseNumber",label:"Kun med sagsnummer",computeNext:()=>!historyFilters.requireCaseNumber},{key:"requireWorkerRates",label:"Kun med timelÃ¸n pr. montÃ¸r",computeNext:()=>!historyFilters.requireWorkerRates}].forEach((e=>{const t=document.createElement("button");t.type="button",t.className="history-search__filter";const a=()=>{const a="recentDays"===e.key?Boolean(historyFilters.recentDays):Boolean(historyFilters[e.key]);t.classList.toggle("is-active",a),t.setAttribute("aria-pressed",a?"true":"false")};t.textContent=e.label,t.addEventListener("click",(()=>{historyFilters={...historyFilters,[e.key]:e.computeNext()},historyVisibleCount=HISTORY_PAGE_SIZE,a(),renderHistoryList(recentCasesCache)})),a(),s.appendChild(t)})),t.appendChild(a),t.appendChild(s),e.appendChild(t)}"undefined"!=typeof window&&(window.cssmateUpdateActionHint=updateActionHint);const formatHistoryTimestamp=e=>formatDateLabel(e,{timeZone:"undefined"!=typeof Intl?Intl.DateTimeFormat().resolvedOptions().timeZone:void 0});function matchesHistorySearch(e,t){const a=normalizeSearchValue(t);if(!a)return!0;return(Array.isArray(e?.searchValues)?e.searchValues:[]).some((e=>e&&e.includes(a)))}function filterHistoryEntries(e=[]){const t=Date.now(),a=Boolean(normalizeSearchValue(historySearchTerm));return e.filter((e=>{const r=e?.displayBaseWage?e:normalizeHistoryEntry(e);if(!r)return!1;if(historyFilters.requireCaseNumber&&!normalizeSearchValue(r?.meta?.sagsnummer))return!1;const n=Array.isArray(r.perWorker)?r.perWorker.filter((e=>e?.rate>0||e?.base>0)).length:0,o=Boolean(r?.wage?.base);if(historyFilters.requireWorkerRates&&!n&&!o)return!1;if(historyFilters.recentDays>0){const e=t-24*historyFilters.recentDays*60*60*1e3,a=r.createdAt||0;if(!a||a<e)return!1}return!(a&&!matchesHistorySearch(r,historySearchTerm))}))}function createHistoryDetailRow(e,t){const a=document.createElement("div");a.className="history-item__detail";const r=document.createElement("span");r.className="history-item__detail-label",r.textContent=e;const n=document.createElement("span");return n.className="history-item__detail-value",n.textContent=t||"â€“",a.append(r,n),a}function buildWorkerRateRows(e){const t=document.createElement("div");t.className="history-item__workers";const a=document.createElement("div");a.className="history-item__section-title",a.textContent="TimelÃ¸n pr. montÃ¸r",t.appendChild(a);const r=Array.isArray(e?.perWorker)?e.perWorker.filter((e=>e?.rate>0||e?.base>0)):[];if(r.length)r.forEach((e=>{const a=document.createElement("div");a.className="history-item__worker-row";const r=document.createElement("span");r.textContent=e.name||"MontÃ¸r";const n=document.createElement("span");n.className="history-item__worker-rate";const o=e.base>0?e.base:e.rate;n.textContent=o>0?`${formatCurrency(o)} kr/t`:"â€“",a.append(r,n),t.appendChild(a)}));else{const a=document.createElement("p");a.className="history-item__note",a.textContent=e.displayBaseWage||"â€“",t.appendChild(a)}return t}function buildWageDetails(e){const t=document.createElement("div");t.className="history-item__wages",t.appendChild(createHistoryDetailRow("Uden tillÃ¦g",e.display?.base||e.displayBaseWage||"â€“"));if([e.display?.udd1,e.display?.udd2,e.display?.udd2Mentor].some((e=>e&&"â€“"!==e)))t.appendChild(createHistoryDetailRow("Udd1",e.display?.udd1||"â€“")),t.appendChild(createHistoryDetailRow("Udd2",e.display?.udd2||"â€“")),t.appendChild(createHistoryDetailRow("Udd2 + mentor",e.display?.udd2Mentor||"â€“"));else{const e=document.createElement("p");e.className="history-item__note",e.textContent="TillÃ¦gs-data mangler",t.appendChild(e)}return t}const formatHistoryCurrency=e=>new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0);function resolveHistoryTotal(e={}){const t=e?.totals||e?.data?.totals||e?.payload?.totals||{},a=[t.projektsum,t.projectTotal,t.total,t.sum,t.projektsumInklMoms,t.projektsumExMoms,t.loensum,t.loensumTotal];for(const e of a){const t=toNumber(e);if(t>0)return t}return 0}function buildHistoryListItem(e){const t=e?.displayBaseWage?e:normalizeHistoryEntry(e);if(!t)return null;const a=deriveSagsinfoFromEntry(t),r=document.createElement("li");r.className="history-item history-row",r.dataset.id=t.id;const n=document.createElement("div");n.className="history-item__header history-row__summary",n.dataset.action="toggle-history-row",n.dataset.id=t.id,n.setAttribute("role","button"),n.tabIndex=0;const o=document.createElement("div");o.className="history-row__cell history-row__cell--date",o.textContent=t.displayDate||formatHistoryTimestamp(t.createdAt);const s=document.createElement("div");s.className="history-row__cell history-row__cell--meta";const i=[];a.sagsnummer&&i.push(a.sagsnummer);const l=[a.navn,a.kunde||a.adresse].filter(Boolean).join(" Â· ");l&&i.push(l),s.textContent=i.filter(Boolean).join(" â€” ")||a.adresse||"â€“";const d=document.createElement("div");d.className="history-row__cell history-row__cell--amount";const u=resolveHistoryTotal(t);d.textContent=u>0?`${formatHistoryCurrency(u)} kr`:"â€“";const c=document.createElement("div");c.className="history-row__cell history-row__cell--actions";const m=document.createElement("button");m.type="button",m.dataset.id=t.id,m.dataset.action="load-history",m.textContent="IndlÃ¦s",c.append(m),n.append(o,s,d,c);const p=document.createElement("div");p.className="history-item__body",p.hidden=!0;const y=document.createElement("div");y.className="history-item__info",a.sagsnummer&&y.appendChild(createHistoryDetailRow("Sagsnr.",a.sagsnummer)),a.navn&&y.appendChild(createHistoryDetailRow("Navn",a.navn)),a.kunde&&y.appendChild(createHistoryDetailRow("Kunde",a.kunde)),y.children.length&&p.appendChild(y),p.appendChild(buildWageDetails(t)),p.appendChild(buildWorkerRateRows(t));const f=document.createElement("div");f.className="history-item__actions";const g=document.createElement("button");g.type="button",g.className="history-list__delete",g.dataset.id=t.id,g.dataset.action="delete-history",g.textContent="Slet",f.append(g),p.appendChild(f);const b=openHistoryId&&String(openHistoryId)===String(t.id);return n.setAttribute("aria-expanded",b?"true":"false"),p.hidden=!b,b&&r.classList.add("is-open"),r.append(n,p),r}function setHistoryRowExpanded(e,t){const a=e?.querySelector(".history-item__body"),r=e?.querySelector(".history-item__header");e?.classList.toggle("is-open",Boolean(t)),a&&(a.hidden=!t),r&&r.setAttribute("aria-expanded",t?"true":"false")}function renderHistoryList(e=recentCasesCache){const t=getDomElement("historyList");if(!t)return;t.innerHTML="";const a=filterHistoryEntries(Array.isArray(e)?e:[]);if(filteredHistoryCache=a,openHistoryId&&!a.some((e=>String(e.id)===String(openHistoryId)))&&(openHistoryId=null),!a.length){const e=document.createElement("li");e.className="history-list__empty";const a=normalizeSearchValue(historySearchTerm)||historyFilters.recentDays||historyFilters.requireCaseNumber||historyFilters.requireWorkerRates;return e.textContent=a?"Ingen resultater for sÃ¸gningen.":"Ingen historik endnu.",t.appendChild(e),void setHistoryListBusy(!1)}const r=a.slice(0,historyVisibleCount),n=document.createDocumentFragment();if(r.forEach((e=>{const t=buildHistoryListItem(e);t&&n.appendChild(t)})),a.length>r.length){const t=document.createElement("li");t.className="history-list__more";const o=document.createElement("button");o.type="button",o.textContent=`Vis flere (${r.length}/${a.length})`,o.addEventListener("click",(()=>{historyVisibleCount+=HISTORY_PAGE_SIZE,renderHistoryList(e)})),t.appendChild(o),n.appendChild(t)}t.appendChild(n),setHistoryListBusy(!1)}function setupHistoryListActions(){const e=getDomElement("historyList");e&&"true"!==e.dataset.boundDelete&&(e.dataset.boundDelete="true",e.addEventListener("click",(async t=>{const a=t.target instanceof HTMLElement?t.target.closest('[data-action="delete-history"], [data-action="load-history"], [data-action="toggle-history-row"]'):null;if(!a)return;const r=a.dataset.action,n=a.closest(".history-item"),o=a.dataset.id||n?.dataset.id||"";if("toggle-history-row"===r){if(!n||!o)return;if(openHistoryId&&openHistoryId!==o){const t=e.querySelector(`.history-item[data-id="${CSS.escape(String(openHistoryId))}"]`);t&&setHistoryRowExpanded(t,!1)}const t=openHistoryId!==o;return setHistoryRowExpanded(n,t),void(openHistoryId=t?o:null)}if(o)if("load-history"!==r){if("delete-history"===r){if(!window.confirm("Er du sikker pÃ¥, at du vil slette denne sag?"))return;a.disabled=!0;if(!await deleteProjectById(o))return void(a.disabled=!1);recentCasesCache=recentCasesCache.filter((e=>String(e?.id)!==String(o))),syncRecentProjectsGlobal(recentCasesCache),renderHistoryList(recentCasesCache),populateRecentCases()}}else await handleLoadCase(o)})),e.addEventListener("keydown",(e=>{if(e.target instanceof HTMLElement&&("Enter"===e.key||" "===e.key)){const t=e.target.closest('[data-action="toggle-history-row"]');t&&(e.preventDefault(),t.click())}})))}function findHistoryEntryById(e){return e&&recentCasesCache.find((t=>String(t?.id)===String(e)))||null}function buildHistorySummary(e){const t=e?.displayBaseWage?e:normalizeHistoryEntry(e);if(!t)return null;const a=t.wage||{},r=e=>e?toNumber("object"==typeof e&&null!=e?e.max||e.min:e):0;return{date:t.displayDateWithAddress||t.displayDate||formatHistoryTimestamp(t.createdAt),timer:toNumber(t.hours),hourlyBase:r(a.base),hourlyUdd1:r(a.udd1),hourlyUdd2:r(a.udd2),hourlyUdd2Mentor:r(a.udd2Mentor),display:t.display,displayHours:t.displayHours}}function renderJobHistorySummary(e){const t=getDomElement("job-history-summary-body");if(!t)return;t.innerHTML="";const a=buildHistorySummary(e);if(!a){const e=document.createElement("tr"),a=document.createElement("td");return a.colSpan=6,a.textContent="Ingen historik endnu.",e.appendChild(a),void t.appendChild(e)}const r=e=>e>0?`${formatCurrency(e)} kr`:"â€“",n=[a.date||"â€“",a.displayHours||(a.timer>0?formatNumber(a.timer):"â€“"),a.display?.base||r(a.hourlyBase),a.display?.udd1||r(a.hourlyUdd1),a.display?.udd2||r(a.hourlyUdd2),a.display?.udd2Mentor||r(a.hourlyUdd2Mentor)],o=document.createElement("tr");n.forEach((e=>{const t=document.createElement("td");t.textContent=e,o.appendChild(t)})),t.appendChild(o)}function updateHistorySummaryFromSelect(){const e=getDomElement("jobHistorySelect"),t=e?.value;let a=null;t&&(a=findHistoryEntryById(t)),!a&&recentCasesCache.length&&(a=recentCasesCache[0],a&&e&&e.value!==String(a.id)&&(e.value=String(a.id))),renderJobHistorySummary(a||null);const r=getDomElement("btnLoadHistoryJob");r&&(r.disabled=!(a&&null!=a.id))}async function populateRecentCases(){const e=getDomElement("jobHistorySelect"),t=getDomElement("btnLoadHistoryJob");if(!Boolean(e||getDomElement("historyList")))return;setupHistoryListActions(),setupHistorySearch(),setHistoryListBusy(!0);const a=await getRecentProjects();recentCasesCache=a,normalizedHistoryCache=a,filteredHistoryCache=a,historyVisibleCount=HISTORY_PAGE_SIZE,syncRecentProjectsGlobal(recentCasesCache);const r=e?.value||"";if(e&&(e.innerHTML=""),renderHistoryList(a),!a.length){if(e){const t=document.createElement("option");t.value="",t.textContent="Ingen gemte sager endnu",t.disabled=!0,t.selected=!0,e.appendChild(t)}return t&&(t.disabled=!0),void renderJobHistorySummary(null)}if(!e)return renderJobHistorySummary(a[0]||null),void(t&&(t.disabled=!(a[0]&&null!=a[0].id)));a.forEach((t=>{const a=document.createElement("option");a.value=String(t.id);const r=t.data?.sagsinfo||{},n=[];r.sagsnummer&&n.push(r.sagsnummer),r.navn&&n.push(r.navn),a.textContent=n.length?n.join(" â€“ "):`Sag #${t.id}`,e.appendChild(a)}));const n=a.find((e=>String(e.id)===r))||a[0];n&&(e.value=String(n.id)),t&&(t.disabled=!e.value),updateHistorySummaryFromSelect()}let zipHistoryBound=!1;function setupZipExportHistoryHook(){if(zipHistoryBound||"undefined"==typeof window)return;zipHistoryBound=!0;const e=()=>{historyVisibleCount=HISTORY_PAGE_SIZE,populateRecentCases()};window.addEventListener("cssmate:zip-exported",(t=>{persistProjectSnapshot({type:"zip",...t?.detail||{}}).finally(e)})),window.addEventListener("cssmate:exported",(t=>{t?.detail?.historySaved&&e()}))}function collectExtrasState(){const e=e=>getDomElement(e)?.value??"",t=toNumber(e("km")),a=2.12*t;return{jobType:getDomElement("jobType")?.value||"montage",montagepris:e("montagepris"),demontagepris:e("demontagepris"),slaebePct:e("slaebePct"),slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:e("antalBoringHuller"),antalLukHuller:e("antalLukHuller"),antalBoringBeton:e("antalBoringBeton"),opskydeligtRaekvaerk:e("antalOpskydeligt"),km:a,kmBelob:a,kmAntal:t,kmIsAmount:!0,traelle35:e("traelleloeft35"),traelle50:e("traelleloeft50")}}function collectProjectSnapshot(e){const t=getAllData().map((e=>({id:e.id,name:e.name,price:toNumber(e.price),quantity:toNumber(e.quantity),manual:Boolean(e.manual),varenr:e.varenr||null}))),a=Array.isArray(laborEntries)?laborEntries.map((e=>({...e}))):[],r={materialSum:lastMaterialSum,laborSum:lastLoensum};lastJobSummary&&(r.timer=lastJobSummary.totalHours,r.hourlyBase=lastJobSummary.hourlyBase,r.hourlyUdd1=lastJobSummary.hourlyUdd1,r.hourlyUdd2=lastJobSummary.hourlyUdd2,r.hourlyUdd2Mentor=lastJobSummary.hourlyUdd2Mentor,r.mentorRate=lastJobSummary.mentorRate);const n=Date.now(),o=collectAkkordComment(),s={timestamp:n,sagsinfo:{...collectSagsinfo(),comment:o},systems:Array.from(selectedSystemKeys),materials:t,labor:a,extras:collectExtrasState(),totals:r,comment:o};return e?.jobPayload&&(s.payload=e.jobPayload),e&&"zip"===e.type&&(s.exportInfo={type:"zip",baseName:e.baseName||"",zipName:e.zipName||"",files:Array.isArray(e.files)?e.files.filter(Boolean):[],exportedAt:e.timestamp||n}),s}function buildHistoryEntryFromSnapshot(e,t={}){if(!e||"object"!=typeof e)return null;const a=deriveSagsinfoFromEntry({data:e,payload:t.jobPayload}),r=getAuthIdentity(),n={...a};r?.uid&&(n.createdByUid=r.uid,r.email&&(n.createdByEmail=r.email),r.displayName&&(n.createdByName=r.displayName));const o=t.totals||e.totals||{},s=t.timestamp||e.timestamp||Date.now(),i="undefined"!=typeof Intl?Intl.DateTimeFormat().resolvedOptions().timeZone:void 0,l=new Date(s).getTimezoneOffset();return{id:t.id,createdAt:s,createdAtMs:s,updatedAt:s,updatedAtMs:s,tzOffsetMin:l,timeZone:i,meta:n,totals:o,payload:t.jobPayload||e.payload||null,source:t.type||"export",data:e}}async function persistProjectSnapshot(e){if(!historyPersistencePaused)try{const t=buildHistoryEntryFromSnapshot(collectProjectSnapshot(e),e);if(!t)return;const a=appendHistoryEntry(t),r=normalizeHistoryEntry(a);r&&(recentCasesCache=[r,...recentCasesCache.filter((e=>String(e?.id)!==String(r.id)))],normalizedHistoryCache=recentCasesCache,filteredHistoryCache=filterHistoryEntries(normalizedHistoryCache),syncRecentProjectsGlobal(recentCasesCache),renderHistoryList(recentCasesCache)),await populateRecentCases()}catch(e){console.warn("Kunne ikke gemme projekt snapshot",e)}}function applyExtrasSnapshot(e={}){const t=(e,t)=>{const a=document.getElementById(e);a&&(a.value=t??"")},a=document.getElementById("jobType");a&&e.jobType&&(a.value=e.jobType),t("montagepris",e.montagepris),t("demontagepris",e.demontagepris),t("slaebePct",e.slaebePct),setSlaebFormulaText(e?.slaebeFormulaText??""),updateSlaebFormulaInfo(exportMeta.slaebFormulaText),t("antalBoringHuller",e.antalBoringHuller),t("antalLukHuller",e.antalLukHuller),t("antalBoringBeton",e.antalBoringBeton),t("antalOpskydeligt",e.opskydeligtRaekvaerk),t("km",resolveKmInputValue(e,2.12)),t("traelleloeft35",e.traelle35),t("traelleloeft50",e.traelle50),computeTraelleTotals()}function applyMaterialsSnapshot(e=[],t=[]){resetMaterials(),resetMaterialSearch(!1),Array.isArray(t)&&t.length&&(selectedSystemKeys.clear(),t.forEach((e=>selectedSystemKeys.add(e)))),Array.isArray(e)&&e.forEach((e=>{if(shouldExcludeMaterialEntry(e))return;const t=toNumber(e?.quantity),a=toNumber(e?.price);let r=null;if(e?.id&&(r=findMaterialById(e.id)),r&&!r.manual)return r.quantity=t,void(Number.isFinite(a)&&a>0&&(r.price=a));if(e?.manual){const r=manualMaterials.find((t=>t.id===e.id))||manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));return void(r&&(r.name=e.name||r.name,r.price=Number.isFinite(a)?a:r.price,r.quantity=t,updateMaterialSearchKey(r)))}const n=manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));n&&(n.name=e?.name||"",n.price=Number.isFinite(a)?a:0,n.quantity=t,updateMaterialSearchKey(n))})),renderOptaelling()}function applyLaborSnapshot(e=[]){laborEntries=Array.isArray(e)?e.map((e=>({...e}))):[],populateWorkersFromLabor(laborEntries)}function extractVersionNumber(e={}){const t=e?.version??e?.meta?.version,a=Number(t);if(Number.isFinite(a))return a;if("string"==typeof t){const e=Number.parseFloat(t);return Number.isFinite(e)?e:void 0}}function mapSagsinfoFromPayload(e={}){const t=e.meta||{},a=e.info||{};return{sagsnummer:e.jobId||a.sagsnummer||t.sagsnummer||t.caseNumber||e.caseNo||e.id||"",navn:e.jobName||a.navn||t.caseName||t.navn||e.name||e.title||"",adresse:e.jobAddress||e.address||e.site||a.adresse||a.address||t.adresse||t.address||"",kunde:e.customer||e.kunde||a.kunde||a.customer||t.customer||t.kunde||"",dato:normalizeDateValue(a.dato||a.date||t.date||e.createdAt||e.date),montoer:e.montageWorkers||e.demontageWorkers||e.worker||e.montor||a.montoer||a.montor||t.montoer||"",comment:e.comment||a.comment||t.comment||""}}function collectMaterialsFromPayload(e={},{defaultSystem:t="",priceDivisor:a=1}={}){let r=[];return Array.isArray(e.materials)?r=e.materials:Array.isArray(e.items)?r=e.items:Array.isArray(e.lines)?r=e.lines:Array.isArray(e.linjer)&&(r=e.linjer.map((e=>({id:e.varenr,name:e.navn,quantity:e.antal,unitPrice:e.stkPris,system:e.system})))),r.map(((r,n)=>{const o=toNumber(r.quantity??r.qty??r.antal??r.amount),s=toNumber(r.unitPrice??r.price??r.stkPris??r.ackUnitPrice??r.baseUnitPrice),i=a?s/a:s,l=r.system||r.systemKey||e.system||e.meta?.system||t||inferSystemFromLine(r);return{id:r.id||r.varenr||r.itemNumber||`line-${n+1}`,name:r.name||r.label||r.title||"",quantity:o,price:i,system:l,systemKey:l,searchKey:buildSearchKey({name:r.name||r.label||r.title||"",id:r.id||r.varenr||r.itemNumber,systemKey:l})}})).filter((e=>e&&(e.quantity||e.name||e.id)))}function mapWageToLaborFromPayload(e={},t){const a=e.wage||{},r=Array.isArray(a.workers)?a.workers:Array.isArray(e.workers)?e.workers:Array.isArray(e.labor)?e.labor:[],n=[];if(r.length)r.forEach((e=>{const r=toNumber(e?.hours??e?.time),o=toNumber(e?.rate??e?.hourlyWithAllowances??e?.hourlyRate),s=e?.udd||e?.education||e?.educationLevel||a.educationLevel||"",i=toNumber(e?.mentortillaeg??e?.mentorAllowance),l=e?.type||t;(r>0||o>0||l)&&n.push({type:l,hours:r,rate:o,udd:s,mentortillaeg:i})}));else{const e=toNumber(a.montageHours??a.demontageHours??a.totalHours),r=toNumber(a.hourlyRate);(e>0||r>0)&&n.push({type:t,hours:e,rate:r,udd:a.educationLevel||a.udd||"",mentortillaeg:toNumber(a.mentorAllowance)})}return n}function resolveHoleCounts(e={},t={},a={}){const r=[e.antalBoringHuller,e.huller,t.antalBoringHuller,t.huller,a.boringHuller].find((e=>null!=e)),n=[e.antalLukHuller,t.antalLukHuller,a.lukHuller,t.lukAfHul].find((e=>null!=e));return{antalBoringHuller:toNumber(r),antalLukHuller:toNumber(n)}}function mapExtrasForSnapshot(e={},t){const a=e.extras||e.akkord||{},r=e.extraInputs||{},n=a.fields||a.akkordExtras||a.snapshot||{},o=a.km||{},s=a.slaeb||{},i=a.tralle||{},l=toNumber(o.quantity??a.kmAntal??r.km),d=toNumber(o.amount??a.kmBelob??a.km),{antalBoringHuller:u,antalLukHuller:c}=resolveHoleCounts(n,a,r),m={jobType:t,montagepris:n.montagepris??a.montagepris,demontagepris:n.demontagepris??a.demontagepris,slaebePct:toNumber(s.percent??n.slaebePct??a.slaebePct??r.slaebePctInput),slaebeFormulaText:n.slaebeFormulaText??a.slaebeFormulaText,antalBoringHuller:u,antalLukHuller:c,antalBoringBeton:toNumber(n.antalBoringBeton??a.boringBeton??a.antalBoringBeton??r.boringBeton),opskydeligtRaekvaerk:toNumber(n.opskydeligtRaekvaerk??a.opskydeligt??a.opskydeligtRaekvaerk??r.opskydeligt),km:d,kmBelob:d,kmAntal:Number.isFinite(l)?l:void 0,kmIsAmount:!0,traelle35:toNumber(i.lifts35??n.traelle35??a.tralle35??a.traelle35),traelle50:toNumber(i.lifts50??n.traelle50??a.tralle50??a.traelle50),tralleSum:toNumber(i.amount??a.tralleSum??a.tralle)},p={...r,km:r.km??l,slaebePctInput:r.slaebePctInput??m.slaebePct,boringHuller:r.boringHuller??m.antalBoringHuller,lukHuller:r.lukHuller??m.antalLukHuller,boringBeton:r.boringBeton??m.antalBoringBeton,opskydeligt:r.opskydeligt??m.opskydeligtRaekvaerk},y=Array.isArray(a.extraWork)?a.extraWork:[];return y.length&&(m.extraWork=y),{extras:m,extraInputs:p}}function mapAkkordJsonV1ToSnapshot(e={}){const t=e.type||e.extras?.jobType||"montage",a="demontage"===t?.5:1,{extras:r,extraInputs:n}=mapExtrasForSnapshot(e,t),o=mapSagsinfoFromPayload(e),s=Array.isArray(e.systems)&&e.systems.length?e.systems:e.system?[e.system]:[];return{sagsinfo:o,systems:s,materials:collectMaterialsFromPayload(e,{defaultSystem:s[0]||"",priceDivisor:a||1}),labor:mapWageToLaborFromPayload(e,t),extras:r,extraInputs:n,totals:e.totals?{materialSum:toNumber(e.totals.materialsSum??e.totals.materialSum),laborSum:toNumber(e.totals.laborSum??e.totals.laborSumWithAllowance)}:e.summary?{materialSum:toNumber(e.summary.materialSum),laborSum:toNumber(e.summary.laborSum)}:void 0}}function mapAkkordJsonV2ToSnapshot(e={}){const t=(e.jobType||e.type||e.meta?.jobType||"montage").toLowerCase(),{extras:a,extraInputs:r}=mapExtrasForSnapshot(e,t),n=mapSagsinfoFromPayload(e),o=Array.isArray(e.systems)&&e.systems.length?e.systems:Array.isArray(e.meta?.systems)?e.meta.systems:e.meta?.system?[e.meta.system]:e.system?[e.system]:[];return{sagsinfo:n,systems:o,materials:collectMaterialsFromPayload(e,{defaultSystem:o[0]||"",priceDivisor:1}),labor:mapWageToLaborFromPayload(e,t),extras:a,extraInputs:r,totals:e.totals?{...e.totals}:void 0}}function normalizeLegacyJsonSnapshot(e={}){const t=e.type||e.jobType||e.extras?.jobType||"montage",a={...e.extras||{},jobType:t},r={...e.sagsinfo||e.info||{}};!r.dato&&e.createdAt&&(r.dato=normalizeDateValue(e.createdAt));const n=Array.isArray(e.systems)?e.systems:e.system?[e.system]:[],o=collectMaterialsFromPayload(e,{defaultSystem:n[0]||"",priceDivisor:1}),s=e.extraInputs||{};return{sagsinfo:r,systems:n,materials:o,labor:Array.isArray(e.labor)?e.labor:[],extras:a,extraInputs:s,totals:e.totals||e.summary}}function isCssmateJobSnapshot(e={}){return"string"==typeof e?.schemaVersion&&e.schemaVersion.startsWith("cssmate.job.")}function assertValidCssmateJobSnapshot(e={}){if(!isCssmateJobSnapshot(e))throw new Error("Ukendt akkordseddel-schema.");if("cssmate.job.v1"!==e.schemaVersion)throw new Error("Denne version af akkordseddel-formatet understÃ¸ttes ikke.");if(!e.job||"object"!=typeof e.job)throw new Error("Manglende job-data i eksporten.");const t=e.job;if(!(Array.isArray(t.items)||Array.isArray(t.materials)||Array.isArray(t.linjer)||Array.isArray(t.lines)))throw new Error("Eksporten indeholder ingen materialelinjer.")}function mapCssmateJobSnapshotToSnapshot(e={}){assertValidCssmateJobSnapshot(e);const t=e.exportedAt||e.job?.exportedAt;return mapAkkordJsonV2ToSnapshot({...e.job,version:e.job?.version||"2.0",meta:{...e.job?.meta||{},exportedAt:e.job?.meta?.exportedAt||t},jobType:e.job?.jobType||e.job?.meta?.jobType||e.job?.type,type:e.job?.jobType||e.job?.type})}function normalizeImportedJsonSnapshot(e={}){if(isCssmateJobSnapshot(e))return mapCssmateJobSnapshotToSnapshot(e);const t=extractVersionNumber(e);return Number.isFinite(t)&&t>=2?mapAkkordJsonV2ToSnapshot(e):Number.isFinite(t)&&t>=1?mapAkkordJsonV1ToSnapshot(e):normalizeLegacyJsonSnapshot(e)}async function applyProjectSnapshot(e,t={}){if(!e||"object"!=typeof e)return;await ensureMaterialsDataLoad();const a=e.sagsinfo||{};setSagsinfoField("sagsnummer",a.sagsnummer||""),setSagsinfoField("sagsnavn",a.navn||""),setSagsinfoField("sagsadresse",a.adresse||""),setSagsinfoField("sagskunde",a.kunde||""),setSagsinfoField("sagsdato",a.dato||""),setSagsinfoField("sagsmontoer",a.montoer||"");const r=getDomElement("akkordComment");r&&(r.value=a.comment||e.comment||""),applyMaterialsSnapshot(e.materials,e.systems);applyExtrasSnapshot(mergeExtrasKm(e.extras||{},e.extraInputs||{},2.12)),applyLaborSnapshot(e.labor),e.totals&&(Number.isFinite(e.totals.materialSum)&&(lastMaterialSum=e.totals.materialSum),Number.isFinite(e.totals.laborSum)&&(lastLoensum=e.totals.laborSum)),updateTotals(!0),validateSagsinfo(),t?.skipHint||updateActionHint("Sag er indlÃ¦st.","success")}async function handleLoadCase(e){const t=getDomElement("jobHistorySelect"),a=e||t?.value;if(!a)return;let r=recentCasesCache.find((e=>String(e.id)===String(a)));if(!r){const e=await getRecentProjects();recentCasesCache=e,syncRecentProjectsGlobal(recentCasesCache),r=e.find((e=>String(e.id)===String(a))),renderHistoryList(recentCasesCache)}pauseHistoryPersistence();try{const e=r?.payload||r?.data||null,a=e?normalizeImportedJsonSnapshot(e):r?.data;a?(await applyProjectSnapshot(a,{skipHint:!1}),renderJobHistorySummary(r),saveDraft(a),lastDraftSerialized=JSON.stringify(a),t&&(t.value=String(r.id))):updateActionHint("Kunne ikke indlÃ¦se den valgte sag.","error")}finally{resumeHistoryPersistence()}}function computeSagsinfoValidity(){let e=!0;const t=[];return sagsinfoFieldIds.forEach((a=>{const r=getDomElement(a);if(!r)return;const n=(r.value||"").trim();let o=n.length>0;if("sagsdato"===a){const e=Date.parse(n);o=n.length>0&&!Number.isNaN(e)}o||(e=!1,t.push(a))})),{isValid:e,invalidIds:t}}function hasValidExportData(){if(lastExportModel&&Array.isArray(lastExportModel.items)&&lastExportModel.items.length>0)return!0;const e=getAllData();return!(!Array.isArray(e)||!e.some((e=>toNumber(e?.quantity)>0)))||Number.isFinite(lastMaterialSum)&&lastMaterialSum>0}function hasValidExportState(e){const t="boolean"==typeof e?e:computeSagsinfoValidity().isValid,a=(document.getElementById("jobType")?.value||"").trim().length>0,r=hasValidExportData();return t&&a&&r}function updateExportButtons(e){const t=document.getElementById("btn-export-akkord-pdf"),a=document.getElementById("btn-print-akkord"),r=hasValidExportState(e);[t,a].forEach((e=>{e&&(e.disabled=!r,e.setAttribute("aria-disabled",String(!r)))}))}function updateExportButtonsState(e){updateExportButtons(e)}function markExportModelDirty(){lastExportModel=null}function validateSagsinfo(){markExportModelDirty();const e=computeSagsinfoValidity();return sagsinfoFieldIds.forEach((t=>{const a=getDomElement(t);if(!a)return;const r=!e.invalidIds.includes(t);a.classList.toggle("invalid",!r)})),updateExportButtonsState(e.isValid),e.isValid?updateActionHint(""):updateActionHint(DEFAULT_ACTION_HINT,"error"),e.isValid}function escapeCSV(e){if(null==e)return"";const t=String(e);return/[";\n\r]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function sanitizeFilename(e){return(e||"akkordseddel").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9-_]+/gi,"_")}function formatNumberForCSV(e){return toNumber(e).toFixed(2).replace(".",",")}function formatPercentForCSV(e){return`${toNumber(e).toFixed(2).replace(".",",")} %`}function collectJobType(){return document.getElementById("jobType")?.value||"montage"}function handleJobTypeChange(e){if("demontage"===(e?.target?.value||collectJobType()||"").toLowerCase()){const e=document.getElementById("antalBoringHuller"),t=document.getElementById("antalLukHuller");if(e&&t){const a=(t.value??"").trim(),r=toNumber(a);if(!(""!==a&&0!==r)){const a=(e.value??"").trim();if(a){const e=toNumber(a);t.value=Number.isFinite(e)?String(e):a}}}}updateTotals(!0),updateExportButtonsState()}function formatDateForDisplay(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.valueOf())?String(e):t.toLocaleDateString("da-DK")}function triggerBlobDownload(e,t){e&&t&&downloadBlob(e,t)}function inferSystemFromLine(e){if(!e)return"";if(e.system)return e.system;if(e.systemKey)return e.systemKey;const t=String(e.varenr||e.id||"").trim().toLowerCase();return t.startsWith("b")?"bosta":t.startsWith("h")?"haki":t.startsWith("m")?"modex":""}function buildAkkordJobSnapshot(e=lastEkompletData){const t=e||lastEkompletData;if(!t)return null;const a=collectSagsinfo(),r={...t.sagsinfo||{},...a},n=t.jobType||document.getElementById("jobType")?.value||"montage",o=r.montoer||"",s="demontage"===n?"":o,i="demontage"===n?o:"",l=r.dato?formatDateForDisplay(r.dato):"",d=Array.isArray(t.systems)?t.systems:t.system?[t.system]:[],u={id:r.sagsnummer||r.navn||r.adresse||"akkord",caseNo:r.sagsnummer||"",site:r.adresse||"",address:r.adresse||"",task:r.navn||"",title:r.navn||"",customer:r.kunde||"",date:l||r.dato||"",montageWorkers:s,demontageWorkers:i,montor:o,worker:o,system:d[0]||getSelectedSystemKeys()[0]||""},c=(Array.isArray(t.materialer)?t.materialer:[]).map((e=>({id:e?.varenr||e?.id||"",label:e?.name||e?.label||"",name:e?.name||e?.label||"",qty:toNumber(e?.quantity??e?.qty??0),amount:toNumber(e?.quantity??e?.qty??0),system:inferSystemFromLine(e)}))).filter((e=>e.label&&e.qty>0));return u.lines=c,u.items=c,u.materials=c,u}function buildRawAkkordData(e={}){const t=collectSagsinfo();e.customSagsnummer&&(t.sagsnummer=e.customSagsnummer);const a=collectAkkordComment(),r=getAllData().filter((e=>toNumber(e.quantity)>0)),n=Array.isArray(laborEntries)?laborEntries:[],o="undefined"!=typeof window?window.__beregnLonCache:null,s=collectJobType(),i="demontage"===s?.5:1,l={boringHuller:toNumber(document.getElementById("antalBoringHuller")?.value),lukHuller:toNumber(document.getElementById("antalLukHuller")?.value),boringBeton:toNumber(document.getElementById("antalBoringBeton")?.value),opskydeligt:toNumber(document.getElementById("antalOpskydeligt")?.value),km:toNumber(document.getElementById("km")?.value),slaebePctInput:toNumber(document.getElementById("slaebePct")?.value)},d=computeTraelleTotals(),u=d&&Number.isFinite(d.sum)?d.sum:0,c=r.map((e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*i}))),m=calcMaterialesum()+u,p=m*(Number.isFinite(l.slaebePctInput)?l.slaebePctInput/100:0),y={"trallelÃ¸ft":u,traelle35:d?.n35||0,traelle50:d?.n50||0,huller:4.7*l.boringHuller,lukAfHul:3.45*l.lukHuller,boringBeton:11.49*l.boringBeton,boring:11.49*l.boringBeton,opskydeligt:9.67*l.opskydeligt,km:2.12*l.km,oevrige:0,slaebePct:l.slaebePctInput,slaebeBelob:p},f=mergeExtrasKm({jobType:s,slaebePct:l.slaebePctInput,slaebeBelob:p,slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:l.boringHuller,antalLukHuller:l.lukHuller,antalBoringBeton:l.boringBeton,boringBeton:y.boring,boring:y.boring,huller:y.huller,lukAfHul:y.lukAfHul,opskydeligtRaekvaerk:l.opskydeligt,opskydeligt:y.opskydeligt,km:y.km,kmBelob:y.km,kmAntal:l.km,kmIsAmount:!0,traelle35:d?.n35||0,traelle50:d?.n50||0,"trallelÃ¸ft":u},l,2.12),g=n.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)}))),b=g.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),h=calculateTotals({materialLines:c,slaebeBelob:p,extra:y,workers:g,totalHours:b}),S={sagsnummer:t.sagsnummer||"akkordseddel",dato:t.dato||(new Date).toISOString(),kunde:t.kunde,adresse:t.adresse,navn:t.navn,systems:Array.from(selectedSystemKeys),createdAt:(new Date).toISOString(),comment:a};return{version:"1.0",info:t,materials:r,labor:n,cache:o,jobType:s,jobFactor:i,systems:Array.from(selectedSystemKeys),comment:a,tralleState:d,tralleSum:u,materialLinesForTotals:c,montageBase:m,slaebePctInput:l.slaebePctInput,slaebeBelob:p,extraInputs:l,extras:f,laborTotals:g,totalHours:b,totals:h,meta:S,createdAt:S.createdAt}}function buildAkkordData(e={}){const t=buildRawAkkordData(e),a=buildSharedAkkordData(t);return lastExportModel=a,a}function syncActiveJobState(){const e=buildAkkordJobSnapshot();return e&&setActiveJob(e),e}function normalizeDateValue(e){if(!e)return"";const t=String(e).trim();if(!t)return"";const a=t.split(/[-\/.]/);if(3===a.length){const[e,t,r]=a;if(4===e.length)return`${e}-${t.padStart(2,"0")}-${r.padStart(2,"0")}`;if(4===r.length)return`${r}-${t.padStart(2,"0")}-${e.padStart(2,"0")}`}const r=new Date(t);return Number.isNaN(r.valueOf())?"":r.toISOString().slice(0,10)}function parseCSV(e){const t=String(e).split(/\r?\n/).filter((e=>e.trim().length>0));if(0===t.length)return[];const a=t[0].includes(";")?";":",",r=e=>{const t=[];let r="",n=!1;for(let o=0;o<e.length;o++){const s=e[o];'"'===s?n&&'"'===e[o+1]?(r+='"',o++):n=!n:s!==a||n?r+=s:(t.push(r.trim()),r="")}return t.push(r.trim()),t},n=r(t[0]),o=[];for(let e=1;e<t.length;e++){const a=r(t[e]);if(a.every((e=>""===e)))continue;const s={};n.forEach(((e,t)=>{s[e]=a[t]??""})),o.push(s)}return o}function resetMaterials(){[dataBosta,dataHaki,dataModex,dataAlfix].forEach((e=>{e.forEach((e=>{e.quantity=0}))})),manualMaterials.forEach((e=>{e.name="",e.price=0,e.quantity=0,e.searchKey=""}))}function resetWorkers(){workerCount=0;const e=document.getElementById("workers");e&&(e.innerHTML="")}function populateWorkersFromLabor(e){if(resetWorkers(),!Array.isArray(e)||0===e.length)return addWorker(),void updateTotals(!0);e.forEach(((e,t)=>{addWorker();const a=document.getElementById(`worker${t+1}`);if(!a)return;const r=a.querySelector(".worker-hours"),n=a.querySelector(".worker-tillaeg"),o=a.querySelector(".worker-udd");if(r&&(r.value=formatNumber(toNumber(e.hours))),n&&(n.value=formatNumber(toNumber(e.mentortillaeg))),o instanceof HTMLSelectElement){const t=(e?.udd??"").toString().trim();if(t){Array.from(o.options).some((e=>e.value===t))?o.value=t:o.options.length>0&&(o.selectedIndex=0)}else o.options.length>0&&(o.selectedIndex=0)}})),updateTotals(!0);e.some((e=>toNumber(e.hours)>0))&&"function"==typeof beregnLon&&beregnLon()}function matchMaterialByName(e){if(!e)return null;const t=normalizeKey(e),a=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const e of a){const a=e.find((e=>normalizeKey(e.name)===t));if(a)return a}return null}function assignMaterialRow(e){const t=e.id?.trim?.()||"",a=e.name?.trim?.()||"",r=toNumber(e.quantity),n=toNumber(e.price);if(!a&&!t&&0===r&&0===n)return;if(shouldExcludeMaterialEntry({id:t,name:a}))return;let o=null;if(t&&(o=findMaterialById(t)),!o&&a&&(o=matchMaterialByName(a)),o&&!o.manual)return o.quantity=r,void(n>0&&(o.price=n));const s=manualMaterials.find((e=>!e.name&&0===e.quantity&&0===e.price));if(!s)return;const i=manualMaterials.indexOf(s)+1;s.name=a||s.name||`Manuelt materiale ${i}`,s.quantity=r,s.price=n}function applyCSVRows(e){if(!Array.isArray(e)||0===e.length)return;resetMaterials();const t=collectSagsinfo(),a=[],r=[],n=[];if(e.forEach((e=>{const o={};Object.entries(e).forEach((([e,t])=>{o[normalizeKey(e)]=(t??"").toString().trim()}));const s=o.sagsnummer||o.sagsnr||o.sag||o.caseid;s&&(t.sagsnummer=s);const i=o.navnopgave||o.navn||o.opgave||o.projekt;i&&(t.navn=i);const l=o.adresse||o.addresse;l&&(t.adresse=l);const d=o.kunde||o.customer;d&&(t.kunde=d);const u=normalizeDateValue(o.dato||o.date);u&&(t.dato=u);const c=o.montoer||o.montor||o.montornavne||o.montornavn;c&&a.push(c);const m=o.materialenavn||o.materiale||o.varenavn||o.navn,p=o.antal||o.quantity||o.qty||o.maengde,y=o.pris||o.price||o.enhedspris||o.stkpris,f=o.id||o.materialeid||o.varenummer;(m||f||p||y)&&r.push({id:f,name:m,quantity:p,price:y});const g=o.arbejdstype||o.type||o.jobtype,b=o.timer||o.hours||o.antalttimer,h=o.sats||o.rate||o.timelon||o.timeloen;(g||b||h)&&n.push({type:g||"",hours:toNumber(b),rate:toNumber(h)})})),setSagsinfoField("sagsnummer",t.sagsnummer||""),setSagsinfoField("sagsnavn",t.navn||""),setSagsinfoField("sagsadresse",t.adresse||""),setSagsinfoField("sagskunde",t.kunde||""),setSagsinfoField("sagsdato",t.dato||""),a.length){setSagsinfoField("sagsmontoer",a.flatMap((e=>e.split(/[\n,]/))).map((e=>e.trim())).filter(Boolean).join("\n"))}r.forEach(assignMaterialRow);const o=systemOptions.filter((e=>e.dataset.some((e=>toNumber(e.quantity)>0))));if(o.length>0&&(selectedSystemKeys.clear(),o.forEach((e=>selectedSystemKeys.add(e.key)))),renderOptaelling(),laborEntries=n.filter((e=>e.hours>0||e.rate>0||e.type)),populateWorkersFromLabor(laborEntries),updateTotals(!0),laborEntries.length>0){const e=laborEntries[0].type?.toLowerCase()||"",t=document.getElementById("jobType");t&&(e.includes("demo")?t.value="demontage":e.includes("montage")&&(t.value="montage"))}validateSagsinfo()}function setupCSVImport(){const e=document.getElementById("dropArea"),t=document.getElementById("csvFileInput");if(!e||!t)return;const a=()=>t.click();["dragenter","dragover"].forEach((t=>{e.addEventListener(t,(t=>{t.preventDefault(),e.classList.add("dragover"),t.dataTransfer&&(t.dataTransfer.dropEffect="copy")}))})),["dragleave","dragend"].forEach((t=>{e.addEventListener(t,(()=>e.classList.remove("dragover")))})),e.addEventListener("drop",(a=>{a.preventDefault(),e.classList.remove("dragover");const r=a.dataTransfer?.files?.[0];r&&(handleImportFile(r),t.value="")})),e.addEventListener("click",a),e.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),a())})),t.addEventListener("change",(e=>{const a=e.target.files?.[0];a&&(handleImportFile(a),t.value="")}))}async function resetCurrentJob(){pauseHistoryPersistence(),pauseDraftPersistence();try{await ensureMaterialsDataLoad(),clearDraft(),lastDraftSerialized="",selectedSystemKeys.clear(),resetMaterials(),resetMaterialSearch(!1),renderOptaelling(),laborEntries=[],resetWorkers(),addWorker(),sagsinfoFieldIds.forEach((e=>setSagsinfoField(e,""))),applyExtrasSnapshot({jobType:"montage"});const e=document.getElementById("jobType");e&&(e.value="montage"),lastMaterialSum=0,lastLoensum=0,lastJobSummary=null,updateTotals(!0),validateSagsinfo(),updateActionHint("Ny sag klar.","success")}finally{resumeDraftPersistence(),resumeHistoryPersistence()}}async function applyImportedAkkordData(e,t={}){const a="function"==typeof t.updateActionHint?t.updateActionHint:updateActionHint;if(!e||"object"!=typeof e)return void a("Kunne ikke lÃ¦se akkordseddel-data.","error");const r=e.data&&!e.materials?e.data:e,n="function"==typeof t.applySnapshot?t.applySnapshot:applyProjectSnapshot,o="function"==typeof t.persistSnapshot?t.persistSnapshot:()=>Promise.resolve(),s={materials:Array.isArray(r.materials),lines:Array.isArray(r.lines),linjer:Array.isArray(r.linjer),items:Array.isArray(r.items)};console.info("ForsÃ¸ger at lÃ¦se materialer fra import",s);const i=normalizeImportedJsonSnapshot(r),l=(Array.isArray(i?.materials)?i.materials:[]).map(normalizeMaterialLine).filter(Boolean);if(!l.length){const e="Kunne ikke lÃ¦se nogen linjer fra filen.",t=Object.keys(s).filter((e=>s[e]));throw console.warn("Ingen materialer fundet i import",{availableFields:t,materialFields:s}),a(e,"error"),new Error(e)}const d=(i.extras?.jobType||i.extraInputs?.jobType||r.jobType||r.type||"montage").toLowerCase(),u=Array.isArray(i.systems)?i.systems:[],c=l.map((e=>normalizeSystemId(e.system))).filter(Boolean),m=Array.from(new Set([...u.map(normalizeSystemId).filter(Boolean),...c])),p=m.length?m:Array.from(selectedSystemKeys),y={...i.extras||{},jobType:d},f=i.extraInputs||{},g={...i,systems:p,materials:l,extras:y,extraInputs:f,totals:i.totals||r.totals||{}};pauseHistoryPersistence();try{await n(g,{skipHint:!0})}finally{resumeHistoryPersistence()}markExportModelDirty(),a("Akkordseddel er importeret. BekrÃ¦ft arbejdstype og tal.","success"),updateExportButtonsState(),o({type:"import",source:r?.meta?.source||"json"})}async function handleAkkordImport(e){if(e)try{const t=await e.text();if(!t||!t.trim())throw new Error("Importfilen er tom eller uden indhold.");let a;try{a=JSON.parse(t)}catch(e){throw new Error("Ugyldig JSON-fil. Kunne ikke lÃ¦se eksporten.")}if(!a||"object"!=typeof a)throw new Error("Importfilen har et ukendt format.");await applyImportedAkkordData(a)}catch(e){console.error("Kunne ikke importere akkordseddel",e);throw updateActionHint(e?.message||"Kunne ikke importere akkordseddel-filen.","error"),e}}"undefined"!=typeof window&&(window.cssmateBuildAkkordDataRaw=buildRawAkkordData),"undefined"!=typeof window&&(window.cssmateBuildAkkordData=buildAkkordData),"undefined"!=typeof window&&(window.cssmateHandleAkkordImport=handleAkkordImport);export{applyImportedAkkordData};function normalizeSystemId(e){return"string"==typeof e?e.trim().toLowerCase():e&&"string"==typeof e.name?e.name.trim().toLowerCase():e&&"string"==typeof e.id?e.id.trim().toLowerCase():""}function normalizeMaterialLine(e){if(!e||"object"!=typeof e)return null;const t=toImportNumber(e.qty??e.quantity??e.antal,0),a=normalizeSystemId(e.system),r=toImportNumber(e.unitPrice??e.price??e.pris,e.unitPrice??e.price??e.pris??0);return{...e,id:e.id||e.itemNumber||e.item||e.key||"",name:e.name||e.title||e.navn||"",quantity:t,qty:t,unitPrice:r,system:a}}function toImportNumber(e,t=0){const a=Number(e);if(Number.isFinite(a))return a;const r=Number(t);return Number.isFinite(r)?r:0}function handleImportFile(e){if(!e)return;const t=e.name||"";/\.json$/i.test(t)||e.type&&e.type.includes("json")?importJSONProject(e):uploadCSV(e)}async function verifyAdminCodeInput(e,t=null){const a="string"==typeof e?e.trim():"";if(!a)return{ok:!1,reason:"empty"};const r=new Set([...KNOWN_ADMIN_CODES,...Array.isArray(t?.KNOWN_ADMIN_CODES)?t.KNOWN_ADMIN_CODES:[],...Array.isArray(t?.admin_codes_plain)?t.admin_codes_plain:[]].filter((e=>"string"==typeof e&&e.trim().length)));for(const e of r)if(e===a)return{ok:!0,method:"plaintext"};const n=new Set([...KNOWN_ADMIN_CODE_HASHES,DEFAULT_ADMIN_CODE_HASH,t?._meta?.admin_code,...Array.isArray(t?.HASHED_ADMIN_CODES)?t.HASHED_ADMIN_CODES:[]].filter((e=>"string"==typeof e&&e.length)));if(n.size>0){const e=await sha256Hex(a);for(const t of n)if(constantTimeEquals(e,t))return{ok:!0,method:"sha256"}}return{ok:!1,reason:"no_match"}}function handleAdminLogout(e){admin=!1,setAdminOk(!1),renderOptaelling(),updateTotals(!0),e&&(e.textContent="Admin-tilstand er slÃ¥et fra.",e.classList.remove("error"),e.classList.add("success"),e.removeAttribute("hidden")),updateActionHint("Admin-tilstand er slÃ¥et fra.","success")}async function login(){const e=document.getElementById("adminCode"),t=document.getElementById("adminFeedback");if(!e)return;const a=e.value.trim();if(!a)return void(isAdminUnlocked()?handleAdminLogout(t):t&&(t.textContent="Indtast admin-kode for at logge ind.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden")));(await verifyAdminCodeInput(a)).ok?(admin=!0,setAdminOk(!0),e.value="",t?.classList.remove("error"),t?.classList.add("success"),t&&(t.textContent="Admin-tilstand aktiveret. Prisfelter er nu redigerbare.",t.removeAttribute("hidden")),renderOptaelling(),updateTotals(!0)):t&&(t.textContent="Forkert kode. PrÃ¸v igen.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden"))}const adminLoginButton=document.getElementById("btnAdminLogin");function ensureWorkersInitialized(){if(workerCount>0)return;const e=document.getElementById("workers");if(!e)return;e.querySelector(".worker-row")?workerCount=e.querySelectorAll(".worker-row").length:addWorker()}function addWorker(){workerCount++;const e=document.createElement("fieldset");e.className="worker-row",e.id=`worker${workerCount}`,e.innerHTML=`\n    <legend>Mand ${workerCount}</legend>\n    <div class="worker-grid">\n      <label>\n        <span>Timer</span>\n        <input type="text" class="worker-hours" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-hours-${workerCount}">\n      </label>\n      <label>\n        <span>Uddannelse</span>\n        <select class="worker-udd">\n          <option value="udd1">Udd1 (42,98 kr)</option>\n          <option value="udd2">Udd2 (49,38 kr)</option>\n        </select>\n      </label>\n      <label>\n        <span>MentortillÃ¦g (22,26 kr/t)</span>\n        <input type="text" class="worker-tillaeg" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-tillaeg-${workerCount}">\n      </label>\n    </div>\n    <div class="worker-output" aria-live="polite"></div>\n  `,document.getElementById("workers").appendChild(e)}function debounce(e,t){let a;return(...r)=>{clearTimeout(a),a=setTimeout((()=>e.apply(this,r)),t)}}async function saveLocalData(e,t){localStorage.setItem(e,JSON.stringify(t))}async function loadLocalData(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}function showLonOutputSections(){if(lonOutputsRevealed)return;lonOutputsRevealed=!0;document.querySelectorAll("[data-lon-output]").forEach((e=>{e.hidden=!1,e.removeAttribute("hidden")})),updateExportButtonsState()}function beregnLon(){ensureWorkersInitialized();const e=collectSagsinfo(),t=e.sagsnummer?.trim()||"uspecified",a=document.getElementById("jobType")?.value||"montage",r="demontage"===a?.5:1,n=getSelectedSystemKeys(),o=n.map((e=>normalizeKey(e))).find((e=>["bosta","haki","modex"].includes(e)))||"",s=toNumber(document.getElementById("slaebePct")?.value),i=toNumber(document.getElementById("antalBoringHuller")?.value),l=toNumber(document.getElementById("antalLukHuller")?.value),d=toNumber(document.getElementById("antalBoringBeton")?.value),u=toNumber(document.getElementById("antalOpskydeligt")?.value),c=toNumber(document.getElementById("km")?.value),m=document.querySelectorAll(".worker-row");lastEkompletData=null,lastJobSummary=null;const p=computeTraelleTotals(),y=p&&Number.isFinite(p.sum)?p.sum:0,f=[],g=[],b=[],h=getAllData();Array.isArray(h)&&h.forEach((e=>{const t=toNumber(e?.quantity);if(t<=0)return;const a=toNumber(e?.price),n=a*r,o=t*n;f.push({qty:t,unitPrice:n});const s=manualMaterials.indexOf(e),i=e?.manual?e.name?.trim()||`Manuelt materiale ${s+1}`:e?.name;g.push({label:i,quantity:t,unitPrice:a,lineTotal:o,ackUnitPrice:n});const l=t>0?o/t:n;b.push({varenr:e?.varenr||e?.id||"",name:i,quantity:t,unitPrice:l,baseUnitPrice:a,lineTotal:o,system:e?.systemKey||"",systemKey:e?.systemKey||""})}));const S=4.7*i,k=3.45*l,E=11.49*d,v=9.67*u,A=2.12*c,w=calcMaterialesum()+y,L=w*(Number.isFinite(s)?s/100:0),I={"trallelÃ¸ft":y,huller:S,boring:E,lukAfHul:k,opskydeligt:v,km:A,oevrige:0};let C=0;if(m.forEach((e=>{const t=e.querySelector(".worker-hours"),a=toNumber(t?.value);a>0&&(C+=a)})),0===C){const e=document.getElementById("lonResult");if(e){e.innerHTML="";const t=document.createElement("div");t.style.color="red",t.textContent="Indtast arbejdstimer for mindst Ã©n person",e.appendChild(t)}return laborEntries=[],void(lastJobSummary=null)}const T={materialLines:f,slaebeBelob:L,extra:I,workers:[],totalHours:C},N=calculateTotals(T),x=N.timeprisUdenTillaeg,M=(N.samletAkkordsum,[]),D=[],B=[];m.forEach(((e,t)=>{const r=toNumber(e.querySelector(".worker-hours")?.value);if(r<=0)return;const n=toNumber(e.querySelector(".worker-tillaeg")?.value),o=e.querySelector(".worker-udd"),s=o?.value||"",i=e.querySelector("legend")?.textContent?.trim()||`Mand ${t+1}`,l=e.querySelector(".worker-output");let d=x+n,u=0;"udd1"===s?(d+=42.98,u=42.98):"udd2"===s&&(d+=49.38,u=49.38);const c=d*r;l&&(l.textContent=`${d.toFixed(2)} kr/t | Total: ${c.toFixed(2)} kr`),M.push({name:i,hours:r,rate:d,total:c});const m=o?.selectedOptions?.[0]?.textContent?.trim()||"";D.push({id:t+1,name:i,type:a,hours:r,rate:d,baseRate:x,mentortillaeg:n,udd:s,uddLabel:m,uddannelsesTillaeg:u,total:c}),B.push({hours:r,hourlyWithAllowances:d})}));const H=calculateTotals({...T,workers:B}),P=Number.isFinite(H.timeprisUdenTillaeg)?H.timeprisUdenTillaeg:0,_=P>0;lastJobSummary={totalHours:C,hourlyBase:_?P:0,hourlyUdd1:_?P+42.98:0,hourlyUdd2:_?P+49.38:0,hourlyUdd2Mentor:_?P+49.38+22.26:0,mentorRate:22.26};H.montoerLonMedTillaeg;const F=H.materialer+H.slaeb,j=H.projektsum,O=formatDateForDisplay(e.dato),R=document.getElementById("lonResult");if(R){R.innerHTML="";const t=document.createElement("div"),a=document.createElement("h3");a.textContent="Sagsinfo",t.appendChild(a);[{label:"Sagsnr.",value:e.sagsnummer||""},{label:"Navn",value:e.navn||""},{label:"Adresse",value:e.adresse||""},{label:"Dato",value:O}].forEach((({label:e,value:a})=>{const r=document.createElement("div"),n=document.createElement("strong");n.textContent=`${e}: `,r.appendChild(n);const o=document.createElement("span");o.textContent=a,r.appendChild(o),t.appendChild(r)})),R.appendChild(t);const r=document.createElement("h3");if(r.textContent="Materialer brugt:",R.appendChild(r),g.length>0)g.forEach((e=>{const t=document.createElement("div");t.textContent=`${e.label}: ${e.quantity} Ã— ${e.unitPrice.toFixed(2)} kr = ${e.lineTotal.toFixed(2)} kr`,R.appendChild(t)}));else{const e=document.createElement("div");e.textContent="Ingen materialer brugt",R.appendChild(e)}const n=document.createElement("h3");if(n.textContent="Arbejdere:",R.appendChild(n),M.length>0)M.forEach((e=>{const t=document.createElement("div");t.className="worker-payline",t.textContent=`${e.name}: Timer: ${e.hours}, TimelÃ¸n: ${e.rate.toFixed(2)} kr/t, Total: ${e.total.toFixed(2)} kr`,R.appendChild(t)}));else{const e=document.createElement("div");e.textContent="Ingen timer registreret",R.appendChild(e)}const o=document.createElement("h3");o.textContent="Oversigt:",R.appendChild(o);[["Materialer",`${H.materialer.toFixed(2)} kr`],["Ekstraarbejde",`${H.ekstraarbejde.toFixed(2)} kr`],["SlÃ¦b",`${H.slaeb.toFixed(2)} kr`],["Samlet akkordsum",`${H.samletAkkordsum.toFixed(2)} kr`],["Timer",`${C.toFixed(1)} t`],["Timepris (uden tillÃ¦g)",`${H.timeprisUdenTillaeg.toFixed(2)} kr/t`],["LÃ¸nsum",`${H.montoerLonMedTillaeg.toFixed(2)} kr`],["Projektsum",`${j.toFixed(2)} kr`],["Materialesum (info)",`${F.toFixed(2)} kr`],["Kilometer (info)",`${A.toFixed(2)} kr`],["TrallelÃ¸ft (info)",`${y.toFixed(2)} kr`]].forEach((([e,t])=>{const a=document.createElement("div"),r=document.createElement("strong");r.textContent=`${e}: `,a.appendChild(r);const n=document.createElement("span");n.textContent=t,a.appendChild(n),R.appendChild(a)}))}laborEntries=D,lastEkompletData={sagsinfo:e,jobType:a,montagepris:w,demontagepris:.5*w,systems:n,primarySystem:o,extras:{slaebePct:s,slaebeBelob:L,slaebeFormulaText:exportMeta.slaebFormulaText||"",boringHuller:{antal:i,pris:4.7,total:S},lukHuller:{antal:l,pris:3.45,total:k},boringBeton:{antal:d,pris:11.49,total:E},opskydeligtRaekvaerk:{antal:u,pris:9.67,total:v},kilometer:{antal:c,pris:2.12,total:A},traelleloeft:{antal35:p?.n35||0,pris35:10.44,total35:10.44*(p?.n35||0),antal50:p?.n50||0,pris50:14.62,total50:14.62*(p?.n50||0),total:y}},materialer:b,arbejdere:D,totals:{materialer:H.materialer,ekstraarbejde:H.ekstraarbejde,kilometerPris:A,slaebeBelob:H.slaeb,akkordsum:H.samletAkkordsum,timer:C,akkordTimeLon:H.timeprisUdenTillaeg,loensum:H.montoerLonMedTillaeg,projektsum:j,materialeSumInfo:F,traelleSum:y},traelle:{antal35:p?.n35||0,antal50:p?.n50||0,rate35:10.44,rate50:14.62,sum:y}},syncActiveJobState(),updateTotals(!0),"undefined"!=typeof window&&(window.__cssmateLastEkompletData=lastEkompletData,window.__beregnLonCache={materialSum:lastMaterialSum,laborSum:lastLoensum,projectSum:lastMaterialSum+lastLoensum,traelleSum:y,timestamp:Date.now()}),showLonOutputSections();try{"function"==typeof buildAkkordData&&buildAkkordData()}catch(e){console.warn("Kunne ikke opdatere eksportdata",e)}return"function"==typeof updateExportButtonsState&&updateExportButtonsState(),t}function buildCSVPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const a=collectSagsinfo();e&&(a.sagsnummer=e);const r="undefined"!=typeof window?window.__beregnLonCache:null,n=getAllData().filter((e=>toNumber(e.quantity)>0)),o=Array.isArray(laborEntries)?laborEntries:[],s=computeTraelleTotals(),i=s&&Number.isFinite(s.sum)?s.sum:0,l="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,d=n.map((e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*l}))),u=calcMaterialesum()+i,c=toNumber(document.getElementById("slaebePct")?.value),m=u*(Number.isFinite(c)?c/100:0),p={"trallelÃ¸ft":i,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},y=o.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)}))),f=y.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),g=calculateTotals({materialLines:d,slaebeBelob:m,extra:p,workers:y,totalHours:f}),b=r&&Number.isFinite(r.materialSum)?r.materialSum:g.materialer,h=g.ekstraarbejde,S=g.slaeb,k=r&&Number.isFinite(r.laborSum)?r.laborSum:g.montoerLonMedTillaeg,E=r&&Number.isFinite(r.projectSum)?r.projectSum:g.projektsum,v=[];v.push("Sektion;Felt;VÃ¦rdi;Antal;Pris;Linjesum"),v.push(`Sagsinfo;Sagsnummer;${escapeCSV(a.sagsnummer)};;;`),v.push(`Sagsinfo;Navn/opgave;${escapeCSV(a.navn)};;;`),v.push(`Sagsinfo;Adresse;${escapeCSV(a.adresse)};;;`),v.push(`Sagsinfo;Kunde;${escapeCSV(a.kunde)};;;`),v.push(`Sagsinfo;Dato;${escapeCSV(a.dato)};;;`);const A=(a.montoer||"").replace(/\r?\n/g,", ");v.push(`Sagsinfo;MontÃ¸rnavne;${escapeCSV(A)};;;`),v.push(""),v.push("Sektion;Id;Materiale;Antal;Pris;Linjesum"),0===n.length?v.push("Materiale;;;0;0,00;0,00"):n.forEach((e=>{const t=toNumber(e.quantity);if(0===t)return;const a=toNumber(e.price),r=t*a,n=manualMaterials.indexOf(e),o=e.manual?e.name?.trim()||`Manuelt materiale ${n+1}`:e.name;v.push(`Materiale;${escapeCSV(e.id)};${escapeCSV(o)};${escapeCSV(formatNumberForCSV(t))};${escapeCSV(formatNumberForCSV(a))};${escapeCSV(formatNumberForCSV(r))}`)}));const w=window.__traelleloeft;if(w&&(w.n35>0||w.n50>0)){if(w.n35>0){const e=w.n35*w.RATE35;v.push(`Materiale;TL35;TrallelÃ¸ft 0,35 m;${escapeCSV(formatNumberForCSV(w.n35))};${escapeCSV(formatNumberForCSV(w.RATE35))};${escapeCSV(formatNumberForCSV(e))}`)}if(w.n50>0){const e=w.n50*w.RATE50;v.push(`Materiale;TL50;TrallelÃ¸ft 0,50 m;${escapeCSV(formatNumberForCSV(w.n50))};${escapeCSV(formatNumberForCSV(w.RATE50))};${escapeCSV(formatNumberForCSV(e))}`)}}v.push(""),v.push("Sektion;Arbejdstype;Timer;Sats;Linjesum"),0===o.length?v.push("LÃ¸n;Ingen registrering;;;"):o.forEach(((e,t)=>{const a=toNumber(e.hours),r=toNumber(e.rate),n=a*r,o=e.type||`Arbejdstype ${t+1}`;v.push(`LÃ¸n;${escapeCSV(o)};${escapeCSV(formatNumberForCSV(a))};${escapeCSV(formatNumberForCSV(r))};${escapeCSV(formatNumberForCSV(n))}`)})),v.push(""),v.push("Sektion;Total;BelÃ¸b"),v.push(`Total;Materialesum;${escapeCSV(formatNumberForCSV(b))}`),h>0&&v.push(`Total;Ekstraarbejde;${escapeCSV(formatNumberForCSV(h))}`),S>0&&v.push(`Total;SlÃ¦b;${escapeCSV(formatNumberForCSV(S))}`),v.push(`Total;LÃ¸nsum;${escapeCSV(formatNumberForCSV(k))}`),v.push(`Total;Projektsum;${escapeCSV(formatNumberForCSV(E))}`);(exportMeta.slaebFormulaText||"").trim()&&v.push(`Noter;A9 slÃ¦b-formel;${escapeCSV(exportMeta.slaebFormulaText)}`);const L=v.join("\n"),I=sanitizeFilename(a.sagsnummer||"akkordseddel")||"akkordseddel";return{content:L,baseName:I,fileName:`${I}.csv`,originalName:a.sagsnummer}}adminLoginButton&&adminLoginButton.addEventListener("click",(e=>{e.preventDefault(),login()})),"undefined"!=typeof window&&(window.cssmateBuildCSVPayload=buildCSVPayload);const AKKORD_JSON_VERSION="2.0";function buildAkkordJsonPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const a=t?.data||buildAkkordData({customSagsnummer:e}),{info:r,materials:n,labor:o,jobType:s,jobFactor:i,extras:l,laborTotals:d,totalHours:u,totals:c,extraInputs:m,tralleState:p,tralleSum:y,createdAt:f,systems:g,meta:b,comment:h}=a,S=Array.isArray(g)&&g.length?g:Array.isArray(b?.systems)?b.systems:Array.from(selectedSystemKeys),k=h||b?.comment||r?.comment||"",E=Array.isArray(o)?o:[],v=Array.isArray(d)?d:E.map((e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)}))),A=(Number.isFinite(u)||v.reduce(((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0)),0),{sagsnummer:r.sagsnummer||"",navn:r.navn||"",adresse:r.adresse||"",kunde:r.kunde||"",dato:r.dato||"",montoer:r.montoer||"",comment:k}),w=buildSharedExportModel({...a,jobType:s,jobFactor:i,extras:l,extraInputs:m||{},totals:c,tralleState:p||{},tralleSum:y||0,createdAt:f||a.createdAt||(new Date).toISOString(),systems:S,comment:k},{exportedAt:(new Date).toISOString()}),L=w.info||A,I=sanitizeFilename([L.sagsnummer||"akkordseddel",L.kunde||"",(L.dato||"").slice(0,10)].filter(Boolean).join("-"))||"akkordseddel",C={...w,jobType:s};return{content:JSON.stringify(C,null,2),baseName:I,fileName:`${I}.json`,data:C}}async function exportPDFBlob(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const a=t?.data||buildAkkordData({customSagsnummer:e}),{info:r,materials:n,labor:o,extras:s,tralleState:i,tralleSum:l,slaebePctInput:d,slaebeBelob:u,laborTotals:c,totalHours:m,totals:p,cache:y,extraInputs:f}=a,g=y&&Number.isFinite(y.materialSum)?y.materialSum:p.materialer,b=p.ekstraarbejde,h=(p.slaeb,y&&Number.isFinite(y.laborSum)?y.laborSum:p.montoerLonMedTillaeg),S=y&&Number.isFinite(y.projectSum)?y.projectSum:p.projektsum,k=document.createElement("div");k.className="export-preview",k.style.position="fixed",k.style.left="-9999px",k.style.top="0",k.style.background="#ffffff",k.style.color="#000000",k.style.padding="24px",k.style.width="794px",k.style.boxSizing="border-box";const E=c.filter((e=>Number.isFinite(e.hours)&&e.hours>0)).length,v=e=>new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0);const A=f.boringHuller,w=f.lukHuller,L=f.boringBeton,I=f.opskydeligt,C=f.km,T=[{id:"materials",label:"1. Materialer",format:"currency",value:g},{id:"extraWork",label:"2. Ekstra arbejde",format:"currency",value:b},{id:"extra-sled",label:"   SlÃ¦b",format:"currency",value:u,subtle:!0,info:{type:"percent",percent:d}},{id:"extra-km",label:"   Kilometer",format:"currency",value:s.km,subtle:!0,info:{type:"qtyPrice",qty:C,unitPrice:2.12,unitLabel:"km"}},{id:"extra-holes",label:"   Boring af huller",format:"currency",value:s.huller,subtle:!0,info:{type:"qtyPrice",qty:A,unitPrice:4.7}},{id:"extra-close-hole",label:"   Luk af hul",format:"currency",value:s.lukAfHul,subtle:!0,info:{type:"qtyPrice",qty:w,unitPrice:3.45}},{id:"extra-concrete",label:"   Boring i beton",format:"currency",value:s.boring,subtle:!0,info:{type:"qtyPrice",qty:L,unitPrice:11.49}},{id:"extra-folding-rail",label:"   OpslÃ¥eligt rÃ¦kvÃ¦rk",format:"currency",value:s.opskydeligt,subtle:!0,info:{type:"qtyPrice",qty:I,unitPrice:9.67}},{id:"extra-trolley",label:"   TrallelÃ¸ft",format:"currency",value:l,subtle:!0,info:{type:"trolley",qty:(i?.n35||0)+(i?.n50||0),entries:[{qty:i?.n35||0,unitPrice:10.44},{qty:i?.n50||0,unitPrice:14.62}]}},{id:"accordSum",label:"3. Samlet akkordsum",format:"currency",value:p.samletAkkordsum,emphasize:!0},{id:"hours",label:"4. Timer",format:"hours",value:m},{id:"team",label:"5. Medarbejdere & timer",format:"team",value:{workersCount:E,hours:m}}].map((e=>{const t=["review-row"];return e.subtle&&t.push("review-row--subtle"),e.emphasize&&t.push("review-row--emphasize"),`<div class="${t.join(" ")}"><span>${e.label}</span><strong>${function(e){switch(e.format){case"currency":{const t=`${formatCurrency(e.value)} kr`;if(!e.info)return t;let a="";return"percent"===e.info.type?a=`${formatNumber(e.info.percent)} %`:"qtyPrice"===e.info.type?a=`${e.info.unitLabel?`${formatNumber(e.info.qty)} ${e.info.unitLabel}`:formatNumber(e.info.qty)} Ã— ${formatCurrency(e.info.unitPrice)} kr`:"trolley"===e.info.type&&(a=[e.info.qty?`${formatNumber(e.info.qty)} lÃ¸ft`:"",Array.isArray(e.info.entries)?e.info.entries.filter((e=>e&&Number(e.qty)>0)).map((e=>`${formatNumber(e.qty)} Ã— ${formatCurrency(e.unitPrice)} kr`)).join(" Â· "):""].filter(Boolean).join(" Â· ")),a?`${t} (${a})`:t}case"hours":return`${v(e.value)} t`;case"team":{const t=Number(e.value?.workersCount)||0,a=v(e.value?.hours||0);return t?`${1===t?"1 medarbejder":`${t} medarbejdere`} Â· ${a} t`:`${a} t`}default:return""}}(e)}</strong></div>`})).join(""),N=(exportMeta.slaebFormulaText||"").trim()?`<p class="a9-formula-note"><strong>A9 slÃ¦b-formel:</strong> ${escapeHtml(exportMeta.slaebFormulaText).replace(/\n/g,"<br>")}</p>`:"";k.innerHTML=`\n    <style>\n      .export-preview { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }\n      .export-preview h2 { margin-top: 0; }\n      .export-preview section { margin-bottom: 16px; }\n      .export-preview h3 { margin: 0 0 8px; }\n      .export-preview .review-grid { display: flex; flex-direction: column; gap: 6px; }\n      .export-preview .review-row { display: flex; justify-content: space-between; gap: 12px; font-size: 14px; }\n      .export-preview .review-row--subtle { color: #4f4f4f; font-size: 13px; }\n      .export-preview .review-row--emphasize { font-weight: 600; }\n      .export-preview .review-row span { flex: 1; }\n      .export-preview .review-row strong { white-space: pre-wrap; text-align: right; }\n      .export-preview .a9-formula-note { margin-top: 10px; font-size: 13px; color: #1f2937; }\n      .export-preview .a9-formula-note strong { margin-right: 6px; }\n      .export-preview .totals { display: flex; gap: 12px; flex-wrap: wrap; }\n      .export-preview .totals div { background: #f7f7f7; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; }\n    </style>\n    <h2>Akkordseddel</h2>\n    <section>\n      <h3>Oversigt</h3>\n      <div class="review-grid">\n        ${T}\n      </div>\n      ${N}\n    </section>\n    <section>\n      <h3>LÃ¸n & projektsum</h3>\n      <div class="totals">\n        <div><strong>LÃ¸nsum</strong><div>${formatCurrency(h)} kr</div></div>\n        <div><strong>Projektsum</strong><div>${formatCurrency(S)} kr</div></div>\n      </div>\n    </section>\n  `,document.body.appendChild(k);try{const{jsPDF:e,html2canvas:a}=await ensureExportLibsLazy(),n=await a(k,{scale:2,backgroundColor:"#ffffff"}),o=new e({unit:"px",format:[n.width,n.height]});o.addImage(n.toDataURL("image/png"),"PNG",0,0,n.width,n.height);const s=sanitizeFilename(t.baseName||r.sagsnummer||"akkordseddel");return{blob:o.output("blob"),baseName:s,fileName:`${s}.pdf`}}catch(e){return console.error("PDF eksport fejlede:",e),updateActionHint("PDF eksport fejlede. PrÃ¸v igen.","error"),null}finally{document.body.removeChild(k)}}async function exportPDF(e,t={}){const a=await exportPDFBlob(e,t);if(!a)return;const r=URL.createObjectURL(a.blob),n=document.createElement("a");n.href=r,n.download=a.fileName,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),updateActionHint("PDF er gemt til din enhed.","success")}function exportAkkordJsonFile(){const e=buildAkkordJsonPayload();if(!e)return;triggerBlobDownload(new Blob([e.content],{type:"application/json"}),e.fileName),updateActionHint("Akkordseddel (JSON) er gemt.","success")}function importJSONProject(e){const t=new FileReader;t.onload=async e=>{try{const t=e.target?.result,a=JSON.parse(t);if(!a||"object"!=typeof a)throw new Error("Ugyldigt JSON format");const r=normalizeImportedJsonSnapshot(a.data&&!a.sagsinfo?a.data:a);await applyProjectSnapshot(r,{skipHint:!0}),updateActionHint("JSON sag er indlÃ¦st.","success")}catch(e){console.error("Kunne ikke importere JSON",e),updateActionHint("Kunne ikke importere JSON-filen.","error")}},t.onerror=()=>{updateActionHint("Kunne ikke lÃ¦se filen.","error")},t.readAsText(e,"utf-8")}function uploadCSV(e){if(!e)return;if(!(/\.csv$/i.test(e.name)||e.type&&e.type.includes("csv")))return void updateActionHint("VÃ¦lg en gyldig CSV-fil for at importere.","error");const t=new FileReader;t.onload=e=>{try{applyCSVRows(parseCSV(e.target.result)),updateActionHint("CSV er importeret.","success")}catch(e){console.error("Kunne ikke importere CSV",e),updateActionHint("Kunne ikke importere CSV-filen.","error")}},t.readAsText(e,"utf-8")}function setupMobileKeyboardDismissal(){document.addEventListener("keydown",(e=>{if("Enter"!==e.key)return;const t=e.target;if(!(t instanceof HTMLInputElement))return;const a=t.type?.toLowerCase?.()||"",r=t.inputMode?.toLowerCase?.()||"";"number"!==a&&"numeric"!==r&&"decimal"!==r||(e.preventDefault(),t.blur())})),document.addEventListener("change",(e=>{const t=e.target;if(!(t instanceof HTMLInputElement))return;const a=t.type?.toLowerCase?.()||"",r=t.inputMode?.toLowerCase?.()||"";"number"!==a&&"numeric"!==r&&"decimal"!==r||"function"==typeof t.blur&&t.blur()}))}function setupServiceWorkerMessaging(){if(!("serviceWorker"in navigator))return;if(navigator.webdriver)return;let e=!1;navigator.serviceWorker.addEventListener("message",(e=>{const t=e.data?.type;"CSMATE_UPDATED"!==t&&"SSCaff_NEW_VERSION"!==t||window.location.reload()})),navigator.serviceWorker.addEventListener("controllerchange",(()=>{e||(e=!0,window.location.reload())}))}function setupPWAInstallPrompt(){if("undefined"==typeof window)return;const e=document.getElementById("installBtn"),t=document.getElementById("iosInstallPrompt"),a=document.getElementById("iosInstallDismiss");if(!e&&!t)return;const r="function"==typeof window.matchMedia?window.matchMedia("(display-mode: standalone)"):null,n=()=>(r?.matches??!1)||!0===navigator.standalone;let o=!1;const s=()=>{e&&(e.setAttribute("hidden",""),e.disabled=!1,e.removeAttribute("title"))},i=()=>{e&&(o&&!n()?(e&&(e.removeAttribute("hidden"),e.disabled=!1,e.removeAttribute("title")),getDeferredInstallPromptEvent()?(e.disabled=!1,e.removeAttribute("title")):(e.disabled=!0,e.title=INSTALL_BUTTON_DISABLED_TOOLTIP)):s())},l=(e=!1)=>{if(t&&t.setAttribute("hidden",""),e)try{window.localStorage?.setItem(IOS_INSTALL_PROMPT_DISMISSED_KEY,"1")}catch(e){console.warn("Kunne ikke gemme iOS prompt flag",e)}},d=()=>{if(!t)return;const e=navigator.userAgent||"",a=/iphone|ipad|ipod/i.test(e),n=/safari/i.test(e)&&!/(crios|fxios|edgios)/i.test(e),o=(r?.matches??!1)||!0===navigator.standalone;a&&n&&!o&&!(()=>{try{return"1"===window.localStorage?.getItem(IOS_INSTALL_PROMPT_DISMISSED_KEY)}catch(e){return console.warn("Kunne ikke lÃ¦se iOS prompt flag",e),!1}})()?t.removeAttribute("hidden"):t.setAttribute("hidden","")};(()=>{if(!("serviceWorker"in navigator)||!navigator.serviceWorker?.ready)return o=!0,void i();navigator.serviceWorker.ready.then((()=>{o=!0,i(),n()&&l(!0)})).catch((e=>{o=!0,i(),console.warn("Service worker blev ikke klar i tide til install-knappen",e)}))})(),window.addEventListener(PWA_INSTALL_AVAILABLE_EVENT,(()=>{i()})),window.addEventListener(PWA_INSTALL_CONSUMED_EVENT,(()=>{i()})),e?.addEventListener("click",(async()=>{const t=consumeDeferredInstallPromptEvent();if(t){e.disabled=!0,t.prompt();try{await t.userChoice}catch(e){console.warn("Install prompt failed",e)}finally{s()}}})),window.addEventListener("appinstalled",(()=>{s(),l(!0)})),r?.addEventListener&&r.addEventListener("change",(e=>{e.matches?(s(),l(!0)):(i(),d())})),a?.addEventListener("click",(()=>{l(!0)})),t?.addEventListener("keydown",(e=>{"Escape"===e.key&&l(!0)})),d(),i(),t&&t.addEventListener("click",(e=>{e.target===t&&l(!0)}))}async function hardResetApp(){if(navigator.serviceWorker){const e=await navigator.serviceWorker.getRegistrations();await Promise.all(e.map((e=>e.unregister())))}if(window.caches){const e=await caches.keys();await Promise.all(e.map((e=>caches.delete(e))))}if(window.indexedDB){const e=await(indexedDB.databases?.())||[];await Promise.all(e.map((e=>new Promise((t=>{if(!e?.name)return void t();const a=indexedDB.deleteDatabase(e.name);a.onsuccess=a.onerror=a.onblocked=()=>t()})))))}try{window.localStorage?.clear()}catch{}try{window.sessionStorage?.clear()}catch{}window.location.reload(!0)}"undefined"!=typeof window&&(window.cssmateBuildAkkordJsonPayload=(e={})=>{if("string"==typeof e)return buildAkkordJsonPayload(e,{});const{customSagsnummer:t,...a}=e||{};return buildAkkordJsonPayload(t,a)}),"undefined"!=typeof window&&(window.cssmateExportPDFBlob=exportPDFBlob);let appInitialized=!1;function markAppReady(){"undefined"!=typeof document&&(document.documentElement.classList.remove("app-booting"),document.documentElement.classList.add("app-ready"))}async function initApp(){if(appInitialized)return;appInitialized=!0,initTabs(),setupUiScaleControls();const e=getDomElement("optaellingContainer");e&&(e.addEventListener("input",handleOptaellingInput),e.addEventListener("change",handleOptaellingInput)),runWhenIdle((()=>{setupGuideModal(),setupAdminControls(),setupA9Integration(),initTeamAdminPage()})),runWhenIdle((()=>initSharedCasesPanel())),document.getElementById("btnBeregnLon")?.addEventListener("click",(()=>beregnLon())),document.getElementById("btnAddWorker")?.addEventListener("click",(()=>addWorker()));const t=getDomElement("jobHistorySelect"),a=getDomElement("btnLoadHistoryJob");t&&t.addEventListener("change",(e=>{updateHistorySummaryFromSelect();const t=Boolean(e?.target?.value);a&&(a.disabled=!t)})),a?.addEventListener("click",(()=>handleLoadCase())),["traelleloeft35","traelleloeft50"].forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>updateTotals())),t.addEventListener("change",(()=>updateTotals(!0))))})),["antalBoringHuller","antalLukHuller","antalBoringBeton","antalOpskydeligt","km","slaebePct"].forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>updateTotals())),t.addEventListener("change",(()=>updateTotals(!0))))}));const r=document.getElementById("jobType");r&&r.addEventListener("change",handleJobTypeChange),"undefined"!=typeof window&&window.addEventListener("cssmate:history:updated",(()=>{populateRecentCases()})),sagsinfoFieldIds.forEach((e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",(()=>{validateSagsinfo(),scheduleDraftSave()})),t.addEventListener("change",(()=>{validateSagsinfo(),scheduleDraftSave()})))}));const n=document.getElementById("akkordComment");if(n){const e=()=>scheduleDraftSave();n.addEventListener("input",e),n.addEventListener("change",e)}validateSagsinfo(),runWhenIdle((()=>{setupNumpad(),setupMobileKeyboardDismissal(),setupLazyExportPanelTriggers()})),runWhenIdle((()=>{setupServiceWorkerMessaging(),setupPWAInstallPrompt()})),runWhenIdle((()=>setupZipExportHistoryHook())),document.getElementById("btnHardResetApp")?.addEventListener("click",(()=>{hardResetApp()})),document.getElementById("btnNewCase")?.addEventListener("click",(async()=>{window.confirm("Nulstil sag? Dette sletter den aktuelle kladde pÃ¥ enheden.")&&await resetCurrentJob()}));const o=document.getElementById("calendarIcon");o&&o.addEventListener("click",(()=>{const e=document.getElementById("sagsdato");e&&("function"==typeof e.showPicker?e.showPicker():(e.focus(),"function"==typeof e.click&&e.click()))}))}async function restoreDraftOnLoad(){try{const e=loadDraft();if(!e)return;await applyProjectSnapshot(e,{skipHint:!0}),lastDraftSerialized=JSON.stringify(e),updateActionHint("Kladde gendannet.","success")}catch(e){console.warn("Kunne ikke gendanne kladde",e),clearDraft()}}async function startApp(){registerIndexMissingHandler();const e=initAuthGate();initAppGuard();try{const t=e?.waitForAuthReady||e?.waitForSessionReady||e?.waitForVerifiedAccess;t&&await t(),await initApp(),await restoreDraftOnLoad()}catch(e){console.error("CSMate init fejlede",e);updateActionHint(e?.message||"Kunne ikke initialisere appen. Opdater siden for at prÃ¸ve igen.","error")}finally{markAppReady()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",startApp,{once:!0}):startApp();