import{initMaterialsScrollLock}from"./src/modules/materialsscrolllock.js";import{calculateTotals}from"./src/modules/calculatetotals.js";import{normalizeKey}from"./src/lib/string-utils.js";import{EXCLUDED_MATERIAL_KEYS,shouldExcludeMaterialEntry}from"./src/lib/materials/exclusions.js";import{createMaterialRow}from"./src/modules/materialrowtemplate.js";import{sha256Hex,constantTimeEquals}from"./src/lib/sha256.js";import{ensureExportLibs,ensureZipLib,prefetchExportLibs}from"./src/features/export/lazy-libs.js";import{setupNumpad}from"./js/numpad.js";import{exportMeta,setSlaebFormulaText}from"./js/export-meta.js";import{createVirtualMaterialsList}from"./src/modules/materialsvirtuallist.js";import{initClickGuard}from"./src/ui/guards/clickguard.js";import{setAdminOk,restoreAdminState,isAdminUnlocked}from"./src/state/admin.js";import{exportAkkordExcelForActiveJob}from"./src/export/akkord-excel.js";import{setActiveJob}from"./src/state/jobs.js";import"./boot-inline.js";function getCurrentAppVersion(){return"undefined"!=typeof window&&"string"==typeof window.CSSMATE_APP_VERSION?window.CSSMATE_APP_VERSION:"undefined"!=typeof self&&"string"==typeof self.CSSMATE_APP_VERSION?self.CSSMATE_APP_VERSION:"dev"}function showUpdateBanner(e,t){if("undefined"==typeof document)return;if(document.getElementById("cssmate-update-banner"))return;const n=document.createElement("div");if(n.id="cssmate-update-banner",n.style.position="fixed",n.style.left="0",n.style.right="0",n.style.bottom="0",n.style.zIndex="9999",n.style.padding="8px 12px",n.style.fontSize="12px",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.background="#222",n.style.color="#fff",n.innerHTML=`\n    <span>Ny version af Cssmate er klar (fra ${t} til ${e}).</span>\n    <button type="button" id="cssmate-update-btn">Opdater nu</button>\n  `,!document.body)return;document.body.appendChild(n);const a=document.getElementById("cssmate-update-btn");a&&(a.style.marginLeft="12px",a.style.padding="4px 10px",a.style.fontSize="12px",a.style.cursor="pointer",a.addEventListener("click",()=>{"undefined"!=typeof window&&("undefined"!=typeof navigator&&"serviceWorker"in navigator?navigator.serviceWorker.getRegistrations().then(e=>Promise.all(e.map(e=>e.update()))).finally(()=>{window.location.reload(!0)}):window.location.reload(!0))}))}!function(){if("undefined"==typeof window)return;const e=getCurrentAppVersion(),t="cssmate_app_version";try{const n=window.localStorage;if(!n)return;const a=n.getItem(t);a&&a!==e&&showUpdateBanner(e,a),n.setItem(t,e)}catch(e){console.warn("Unable to access localStorage for version check",e)}}();const IOS_INSTALL_PROMPT_DISMISSED_KEY="csmate.iosInstallPromptDismissed",TAB_STORAGE_KEY="csmate:lastTab",LEGACY_TAB_STORAGE_KEYS=["sscaff:lastTab","cssmate:lastActiveTab"],KNOWN_TAB_ID_ORDER=["sagsinfo","optaelling","lon","historik","hjaelp"],KNOWN_TAB_IDS=new Set(KNOWN_TAB_ID_ORDER),DEFAULT_TAB_ID=KNOWN_TAB_ID_ORDER[0],INSTALL_BUTTON_DISABLED_TOOLTIP="Tilføj via browsermenu på denne platform",PWA_INSTALL_AVAILABLE_EVENT="csmate:pwa-install-available",PWA_INSTALL_CONSUMED_EVENT="csmate:pwa-install-consumed";let DEFAULT_ADMIN_CODE_HASH="",materialsVirtualListController=null,currentTabId=null,tabButtons=[],tabPanels=[];const domCache=new Map;let deferredInstallPromptEvent=null;function setDeferredInstallPromptEvent(e){if(deferredInstallPromptEvent=e,"undefined"==typeof window||"function"!=typeof window.dispatchEvent)return;const t=e?PWA_INSTALL_AVAILABLE_EVENT:PWA_INSTALL_CONSUMED_EVENT;window.dispatchEvent(new Event(t))}function getDeferredInstallPromptEvent(){return deferredInstallPromptEvent}function consumeDeferredInstallPromptEvent(){const e=deferredInstallPromptEvent;return e&&setDeferredInstallPromptEvent(null),e}function isKnownTabId(e){return"string"==typeof e&&KNOWN_TAB_IDS.has(e)}function getDomElement(e){if(!e||"undefined"==typeof document||"function"!=typeof document.getElementById)return null;const t=domCache.get(e);if(t&&t.isConnected)return t;const n=document.getElementById(e);return n?domCache.set(e,n):domCache.delete(e),n}"undefined"!=typeof window&&(window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),setDeferredInstallPromptEvent(e)}),window.addEventListener("appinstalled",()=>{setDeferredInstallPromptEvent(null)}));const KNOWN_ADMIN_CODE_HASHES=new Set(["ff0a69fa196820f9529e3c20cfa809545e6697f5796527f7657a83bb7e6acd0d"]),KNOWN_ADMIN_CODES=new Set(["StilAce"]);async function loadDefaultAdminCode(){try{const e=await fetch("./data/tenants/hulmose.json");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();t&&"string"==typeof t._meta?.admin_code&&(DEFAULT_ADMIN_CODE_HASH=t._meta.admin_code,KNOWN_ADMIN_CODE_HASHES.add(DEFAULT_ADMIN_CODE_HASH))}catch(e){console.warn("Kunne ikke indlæse standard admin-kode",e)}}loadDefaultAdminCode();let admin=restoreAdminState();function updateSlaebFormulaInfo(e){const t=document.getElementById("slaebPercentCalcInfo");if(!t)return;const n="string"==typeof e?e.trim():"";t.textContent=n?`Formel (A9): ${n}`:""}"undefined"!=typeof document&&initClickGuard();let guideModalLastFocus=null,guideModalEscapeHandler=null;function getGuideModalElement(){return document.getElementById("guideModal")}function attachGuideModalEscapeHandler(){guideModalEscapeHandler||"undefined"==typeof document||(guideModalEscapeHandler=e=>{"Escape"===e.key&&isGuideModalOpen()&&(e.preventDefault(),closeGuideModal())},document.addEventListener("keydown",guideModalEscapeHandler))}function detachGuideModalEscapeHandler(){guideModalEscapeHandler&&"undefined"!=typeof document&&(document.removeEventListener("keydown",guideModalEscapeHandler),guideModalEscapeHandler=null)}function openGuideModal(){const e=getGuideModalElement();if(!e)return;guideModalLastFocus=document.activeElement instanceof HTMLElement?document.activeElement:null,e.removeAttribute("hidden"),e.dataset.open="true",e.classList.add("open"),e.setAttribute("aria-hidden","false");const t=e.querySelector(".modal-content");t&&"function"==typeof t.focus&&t.focus(),attachGuideModalEscapeHandler()}function closeGuideModal(){const e=getGuideModalElement();if(!e)return;e.classList.remove("open"),e.removeAttribute("data-open"),e.setAttribute("aria-hidden","true"),e.setAttribute("hidden",""),detachGuideModalEscapeHandler();const t=guideModalLastFocus;guideModalLastFocus=null,t&&document.contains(t)&&"function"==typeof t.focus&&t.focus()}function isGuideModalOpen(){const e=getGuideModalElement();return Boolean(e&&"true"===e.dataset.open)}function setupGuideModal(){const e=getGuideModalElement();if(!e)return;const t=e.querySelector(".modal-close");t&&t.addEventListener("click",()=>closeGuideModal()),e.addEventListener("click",t=>{t.target===e&&closeGuideModal()}),document.getElementById("btnOpenGuideModal")?.addEventListener("click",()=>{openGuideModal()})}function setupAdminControls(){const e=document.getElementById("btnHardResetApp");if(!e)return;const t=t=>{t?(e.removeAttribute("hidden"),e.disabled=!1):(e.setAttribute("hidden",""),e.disabled=!0)};t(isAdminUnlocked()),document.addEventListener("csmate:admin-change",e=>{t(Boolean(e?.detail?.unlocked))})}function getStoredTabId(){try{const e=window.localStorage;if(!e)return"";const t=e.getItem(TAB_STORAGE_KEY);if(isKnownTabId(t))return t;for(const t of LEGACY_TAB_STORAGE_KEYS){const n=e.getItem(t);if(isKnownTabId(n))return n}}catch{}return""}function focusTabByIndex(e){if(!ensureTabCollections())return;const t=(e+tabButtons.length)%tabButtons.length,n=tabButtons[t];n&&setActiveTab(n.dataset.tabId,{focus:!0})}function handleTabKeydown(e,t){const n=e.key;if("ArrowRight"===n||"ArrowLeft"===n){e.preventDefault();return void focusTabByIndex(t+("ArrowRight"===n?1:-1))}if("Home"===n)return e.preventDefault(),void focusTabByIndex(0);if("End"===n)return e.preventDefault(),void focusTabByIndex(tabButtons.length-1);if(" "===n||"Enter"===n){e.preventDefault();const n=tabButtons[t];n&&setActiveTab(n.dataset.tabId,{focus:!0})}}function refreshTabCollections(){if("undefined"==typeof document)return tabButtons=[],void(tabPanels=[]);tabButtons=Array.from(document.querySelectorAll('[role="tab"][data-tab-id]')).filter(e=>isKnownTabId(e.dataset.tabId)),tabPanels=Array.from(document.querySelectorAll('[role="tabpanel"][data-tab-panel]')).filter(e=>isKnownTabId(e.dataset.tabPanel))}function ensureTabCollections(){return tabButtons.length&&tabPanels.length||refreshTabCollections(),tabButtons.length&&tabPanels.length}function findFirstAvailableTabId(){const e=KNOWN_TAB_ID_ORDER.find(e=>tabButtons.some(t=>t.dataset.tabId===e));return e||(tabButtons[0]?.dataset.tabId||DEFAULT_TAB_ID)}function setActiveTab(e,{focus:t=!1}={}){if(!ensureTabCollections())return;const n=isKnownTabId(e)?e:DEFAULT_TAB_ID,a=tabButtons.find(e=>e.dataset.tabId===n)||tabButtons.find(e=>e.dataset.tabId===DEFAULT_TAB_ID)||tabButtons[0];if(!a)return void console.warn("Faneknap ikke fundet for id",e);const r=a.dataset.tabId;if(!r)return void console.warn("Faneknap mangler data-tab-id",a);const o=tabPanels.find(e=>e.dataset.tabPanel===r);if(o)if(currentTabId!==r){tabButtons.forEach(e=>{const t=e===a;e.classList.toggle("tab--active",t),e.setAttribute("aria-selected",t?"true":"false"),e.tabIndex=t?0:-1}),tabPanels.forEach(e=>{const t=e===o;e.classList.toggle("tab-panel--active",t),t?(e.removeAttribute("hidden"),e.setAttribute("aria-hidden","false")):(e.setAttribute("hidden",""),e.setAttribute("aria-hidden","true"))}),currentTabId=r;try{const e=window.localStorage;e&&isKnownTabId(r)&&(e.setItem(TAB_STORAGE_KEY,r),LEGACY_TAB_STORAGE_KEYS.forEach(t=>{try{e.setItem(t,r)}catch{}}))}catch{}t&&"function"==typeof a.focus&&a.focus()}else t&&"function"==typeof a.focus&&a.focus();else console.warn("Tab-panel ikke fundet for id",r)}function initTabs(){if(refreshTabCollections(),!tabButtons.length||!tabPanels.length)return void console.warn("Faner kunne ikke initialiseres – mangler markup");tabButtons.forEach((e,t)=>{const n=e.dataset.tabId,a="true"===e.getAttribute("aria-selected");e.tabIndex=a?0:-1,e.addEventListener("click",()=>setActiveTab(n)),e.addEventListener("keydown",e=>handleTabKeydown(e,t))});const e=getStoredTabId();setActiveTab(tabButtons.some(t=>t.dataset.tabId===e)?e:tabButtons.find(e=>"true"===e.getAttribute("aria-selected"))?.dataset.tabId||findFirstAvailableTabId(),{focus:!1}),"undefined"!=typeof window&&(window.__cssmateSetActiveTab=(e,t)=>setActiveTab(e,t))}function setupA9Integration(){const e=document.querySelector('input[data-a9-slaeb="true"]'),t=document.querySelector(".js-slaeb-calc-link");if(t){const e=t.dataset.calcUrl||"https://cala9.netlify.app/";t.addEventListener("click",t=>{t&&(t.preventDefault(),t.stopPropagation()),window.open(e,"_blank","noopener,noreferrer")})}if(!e)return;e.addEventListener("a9-commit",e=>{const t="string"==typeof e?.detail?.formulaText?e.detail.formulaText:"";setSlaebFormulaText(t),updateSlaebFormulaInfo(t)});const n=()=>{if("1"===e.dataset.a9Commit)return;setSlaebFormulaText("");const t=e.value?.trim();updateSlaebFormulaInfo(t?`Manuel værdi: ${t}`:"")};e.addEventListener("input",n),e.addEventListener("change",n),updateSlaebFormulaInfo(exportMeta.slaebFormulaText)}function formatCurrency(e){return new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0)}function toNumber(e){if("number"==typeof e)return Number.isFinite(e)?e:0;if(null==e)return 0;const t=String(e).trim();if(!t)return 0;const n=t.replace(/\s+/g,"").replace(/'/g,""),a=n.match(/[.,]/g)||[];let r=n.replace(/[^0-9.,-]/g,"");if(a.length>1){const e=a[a.length-1],t=r.lastIndexOf(e),n=r.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=r.slice(t+1).replace(/[^0-9]/g,"");r=`${n||"0"}.${o}`}else if(1===a.length)if(/^-?\d{1,3}(?:[.,]\d{3})+$/.test(r))r=r.replace(/[.,]/g,"").replace(/(?!^)-/g,"");else{const e=a[0],t=r.lastIndexOf(e),n=r.slice(0,t).replace(/[.,]/g,"").replace(/(?!^)-/g,""),o=r.slice(t+1).replace(/[^0-9]/g,"");r=`${n||"0"}.${o}`}else r=r.replace(/(?!^)-/g,"");const o=Number.parseFloat(r);return Number.isFinite(o)?o:0}function formatNumber(e){const t=Number.isFinite(e)?e:parseFloat(e)||0;return new Intl.NumberFormat("da-DK",{minimumFractionDigits:0,maximumFractionDigits:2}).format(t)}let workerCount=0,laborEntries=[],lastLoensum=0,lastMaterialSum=0,lastEkompletData=null,lastJobSummary=null,recentCasesCache=[];function syncRecentProjectsGlobal(e=recentCasesCache){if("undefined"==typeof window)return;const t=Array.isArray(e)?e.slice():[];window.__cssmateRecentProjects=t}syncRecentProjectsGlobal([]);let cachedDBPromise=null;const DEFAULT_ACTION_HINT="Udfyld Sagsinfo for at fortsætte.",DB_NAME="csmate_projects",DB_STORE="projects",TRAELLE_RATE35=10.44,TRAELLE_RATE50=14.62,BORING_HULLER_RATE=4.7,LUK_HULLER_RATE=3.45,BORING_BETON_RATE=11.49,OPSKYDELIGT_RATE=9.67,KM_RATE=2.12,TILLAEG_UDD1=42.98,TILLAEG_UDD2=49.38,DEFAULT_MENTOR_RATE=22.26,AKKORD_EXCEL_SYSTEMS=[{id:"bosta",label:"BOSTA 2025"},{id:"haki",label:"HAKI 2025"},{id:"modex",label:"MODEX 2025"},{id:"alfix",label:"ALFIX 2025"}],AKKORD_EXCEL_STORAGE_KEY="csmate.akkordExcelSystem";let systemDatasets={},dataBosta=[],dataHaki=[],dataModex=[],dataAlfix=[],systemOptions=[],systemLabelMap=new Map;const selectedSystemKeys=new Set;let excelSystemSelectionCache=new Set(["bosta"]),datasetModulePromise=null,materialsReady=!1,showOnlySelectedMaterials=!1,lastRenderShowSelected=null,lonOutputsRevealed=!1;function loadMaterialDatasetModule(){return datasetModulePromise||(datasetModulePromise=import("./dataset.js")),datasetModulePromise}function createSystemMaterialState(e){return e&&Array.isArray(e.items)?e.items.filter(e=>{const t="string"==typeof e?.category?e.category.toLowerCase():"material";if(t&&"material"!==t&&"materiale"!==t)return!1;const n=normalizeKey(String(e?.name||e?.navn||e?.beskrivelse||"").trim());return n&&!EXCLUDED_MATERIAL_KEYS.includes(n)}).map((t,n)=>{const a=t?.name||t?.navn||t?.beskrivelse||"",r=a?.trim()||`${e.id} materiale ${n+1}`;return{id:t?.id||t?.varenr||`${e.id}-${n+1}`,name:r,price:toNumber(t?.price??t?.pris??0),unit:t?.unit||t?.enhed||"",quantity:0,systemKey:e.id,category:"string"==typeof t?.category?t.category.toLowerCase():"material"}}):[]}async function ensureMaterialDatasets(){if(systemOptions.length)return systemOptions;const e=await loadMaterialDatasetModule(),t="function"==typeof e.getAllSystems?e.getAllSystems():[];systemDatasets={},t.forEach(e=>{systemDatasets[e.id]=createSystemMaterialState(e)}),dataBosta=systemDatasets.bosta??[],dataHaki=systemDatasets.haki??[],dataModex=systemDatasets.modex??[],dataAlfix=systemDatasets.alfix??[],systemOptions=t.map(e=>({key:e.id,label:e.label,dataset:systemDatasets[e.id]??[]}));const n=Object.keys(e.MATERIAL_SYSTEMS||{}).map(t=>{const n="function"==typeof e.getSystemList?e.getSystemList(t):null;return[t,n?.label??t]});return systemLabelMap=new Map(n),materialsReady=!0,ensureSystemSelection(),systemOptions}function ensureSystemSelection(){0===selectedSystemKeys.size&&systemOptions.length&&selectedSystemKeys.add(systemOptions[0].key)}function getSelectedSystemKeys(){return ensureSystemSelection(),Array.from(selectedSystemKeys)}function isSupportedExcelSystem(e){return!!e&&AKKORD_EXCEL_SYSTEMS.some(t=>t.id===e)}function normalizeExcelSystemId(e){return"string"==typeof e?e.trim().toLowerCase():""}function sanitizeExcelSystemSelection(e){const t=Array.isArray(e)?e:"string"==typeof e?[e]:e&&"function"==typeof e[Symbol.iterator]?Array.from(e):[],n=[];return t.forEach(e=>{const t=normalizeExcelSystemId(e);isSupportedExcelSystem(t)&&!n.includes(t)&&n.push(t)}),n}function getStoredExcelSystems(){if("undefined"==typeof localStorage)return Array.from(excelSystemSelectionCache);try{const e=localStorage.getItem(AKKORD_EXCEL_STORAGE_KEY);if(null===e)return Array.from(excelSystemSelectionCache);let t=[];try{t=JSON.parse(e)}catch{t=e?[e]:[]}const n=sanitizeExcelSystemSelection(t);return excelSystemSelectionCache=new Set(n),n}catch(e){return console.warn("Kunne ikke læse Excel-systemer fra storage",e),Array.from(excelSystemSelectionCache)}}function setStoredExcelSystems(e){const t=sanitizeExcelSystemSelection(e);if(excelSystemSelectionCache=new Set(t),"undefined"!=typeof localStorage)try{localStorage.setItem(AKKORD_EXCEL_STORAGE_KEY,JSON.stringify(t))}catch(e){console.warn("Kunne ikke gemme Excel-systemer",e)}}function getPreferredExcelSystem(){const e=getStoredExcelSystems();if(e.length>0&&isSupportedExcelSystem(e[0]))return e[0];const t=getSelectedSystemKeys().find(e=>isSupportedExcelSystem(e));return t||(AKKORD_EXCEL_SYSTEMS[0]?.id||"bosta")}function getDatasetForSelectedSystems(e){const t=[],n=(Array.isArray(e)?e:e&&"function"==typeof e[Symbol.iterator]?Array.from(e):[]).map(e=>normalizeKey(e)),a=new Set(n),r=(e,n)=>{if(!Array.isArray(n))return;e.some(e=>a.has(normalizeKey(e)))&&t.push(n)};return r(["bosta","bostadata"],dataBosta),r(["haki","hakidata"],dataHaki),r(["modex","modexdata"],dataModex),r(["alfix","alfixdata"],dataAlfix),t.flat()}function toggleDuplicateWarning(e=[],t=[]){const n=document.getElementById("systemDuplicateWarning");if(!n)return;const a=Array.from(new Set(e.filter(Boolean))).slice(0,6),r=Array.from(new Set(t.filter(Boolean))).slice(0,6);if(0===a.length&&0===r.length)return n.textContent="",void n.setAttribute("hidden","");const o=[];a.length&&o.push(`Materialer slået sammen: ${a.join(", ")}`),r.length&&o.push(`Kontroller varenr.: ${r.join(", ")}`),n.textContent=o.join(". "),n.removeAttribute("hidden")}function aggregateSelectedSystemData(){const e=getDatasetForSelectedSystems(getSelectedSystemKeys()),t=[],n=new Map,a=new Map,r=new Set,o=new Set;return e.forEach(e=>{if(!e)return;const s=null!=e.id?String(e.id):null,i=e.name?normalizeKey(e.name):null,l=i?`${e.systemKey||"global"}::${i}`:null,d=l?a.get(l):null;if(d&&d!==e)return r.add(d.name),void r.add(e.name);const u=s?n.get(s):null;if(u&&u!==e){const t=u.name?normalizeKey(u.name):null;if(t&&i&&t===i)return r.add(u.name),void r.add(e.name);o.add(u.name),o.add(e.name)}t.push(e),s&&n.set(s,e),l&&a.set(l,e)}),toggleDuplicateWarning(Array.from(r),Array.from(o)),t}const manualMaterials=Array.from({length:3},(e,t)=>({id:`manual-${t+1}`,name:"",price:0,quantity:0,manual:!0}));function getAllData(e=!0){const t=aggregateSelectedSystemData();return e?t.concat(manualMaterials):t}function getActiveMaterialList(){return aggregateSelectedSystemData()}function getRenderMaterials(){const e=getActiveMaterialList(),t=Array.isArray(e)?e.concat(manualMaterials):manualMaterials.slice();return showOnlySelectedMaterials?t.filter(e=>toNumber(e?.quantity)>0):t}function findMaterialById(e){const t=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const n of t){const t=n.find(t=>String(t.id)===String(e));if(t)return t}return null}function setupListSelectors(){const e=getDomElement("listSelectors");if(!e)return;const t="systemSelectionWarning",n=systemOptions.map(e=>{const t=selectedSystemKeys.has(e.key)?"checked":"";return`\n        <label class="system-option">\n          <input type="checkbox" value="${e.key}" ${t}>\n          <span>${e.label}</span>\n        </label>\n      `}).join("");e.innerHTML=`\n    <div class="system-selector" role="group" aria-labelledby="systemSelectorLabel">\n      <span id="systemSelectorLabel" class="cell-label">Systemer</span>\n      <div class="system-selector-options">${n}</div>\n    </div>\n    <p id="${t}" class="hint system-warning" hidden>Vælg mindst ét system.</p>\n    <p id="systemDuplicateWarning" class="hint system-warning" hidden></p>\n  `,syncSystemSelectorState();const a=document.getElementById(t);e.addEventListener("change",e=>{const t=e.target;if(!(t instanceof HTMLInputElement)||"checkbox"!==t.type)return;const{value:n}=t;if(t.checked)selectedSystemKeys.add(n);else if(selectedSystemKeys.delete(n),0===selectedSystemKeys.size)return a?.removeAttribute("hidden"),selectedSystemKeys.add(n),t.checked=!0,void updateActionHint("Vælg mindst ét system for at fortsætte optællingen.","error");a?.setAttribute("hidden","");const r=getDomElement("actionHint");r&&"Vælg mindst ét system for at fortsætte optællingen."===r.textContent&&updateActionHint(""),renderOptaelling(),updateTotals(!0)})}function syncSystemSelectorState(){const e=getDomElement("listSelectors");e&&e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=selectedSystemKeys.has(e.value)})}function renderOptaelling(){const e=getDomElement("optaellingContainer");if(!e)return;const t=document.getElementById("showSelectedOnly");t&&(t.checked=showOnlySelectedMaterials,t.onchange=()=>{showOnlySelectedMaterials=t.checked,lastRenderShowSelected=null,renderOptaelling()});const n=t=>{e.textContent="";const n=document.createElement("p");n.className="empty-state",n.textContent=t,e.appendChild(n),materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null)};if(!materialsReady)return void n("Indlæser materialelister...");syncSystemSelectorState();const a=getActiveMaterialList(),r=Array.isArray(a)?a.concat(manualMaterials):manualMaterials.slice(),o=getRenderMaterials();if(!r.length)return void n("Ingen systemer valgt. Vælg et eller flere systemer for at starte optællingen.");if(!o.length)return void n("Ingen materialer med antal.");e.querySelectorAll(".empty-state").forEach(e=>e.remove());let s=e.querySelector(".materials-list");s||(e.textContent="",s=document.createElement("div"),s.className="materials-list csm-materials-list",e.appendChild(s)),s.classList.add("csm-materials-list");const i=(e,t)=>{const n=createMaterialRow(e,{admin:admin,toNumber:toNumber,formatCurrency:formatCurrency,systemLabelMap:systemLabelMap}),a=n?.row||n;return a&&(a.dataset.index=String(t)),n};if(lastRenderShowSelected!==showOnlySelectedMaterials&&materialsVirtualListController&&(materialsVirtualListController.controller.destroy?.(),materialsVirtualListController=null),lastRenderShowSelected=showOnlySelectedMaterials,materialsVirtualListController&&materialsVirtualListController.container===s)materialsVirtualListController.controller.update(o);else{const e=createVirtualMaterialsList({container:s,items:o,renderRow:i,rowHeight:64,overscan:8});materialsVirtualListController={container:s,controller:e}}initMaterialsScrollLock(e),updateTotals(!0)}function handleOptaellingInput(e){const t=e.target;t&&t.classList&&(t.classList.contains("qty")?handleQuantityChange(e):t.classList.contains("price")?handlePriceChange(e):t.classList.contains("manual-name")&&handleManualNameChange(e))}function handleQuantityChange(e){const{id:t}=e.target.dataset;updateQty(t,e.target.value)}function handlePriceChange(e){const{id:t}=e.target.dataset;updatePrice(t,e.target.value)}function handleManualNameChange(e){const{id:t}=e.target.dataset,n=findMaterialById(t);n&&n.manual&&(n.name=e.target.value)}function findMaterialRowElement(e){const t=document.querySelectorAll(".material-row");return Array.from(t).find(t=>Array.from(t.querySelectorAll("input[data-id]")).some(t=>t.dataset.id===String(e)))||null}function updateQty(e,t){const n=findMaterialById(e);if(!n)return;const a=toNumber(n.quantity),r=toNumber(t);if(n.quantity=r,refreshMaterialRowDisplay(e),updateTotals(),showOnlySelectedMaterials){a>0!==r>0&&renderOptaelling()}}function updatePrice(e,t){const n=findMaterialById(e);n&&(n.manual||admin)&&(n.price=toNumber(t),refreshMaterialRowDisplay(e),updateTotals())}function refreshMaterialRowDisplay(e){const t=findMaterialById(e);if(!t)return;const n=findMaterialRowElement(e);if(!n)return;const a=n.querySelector("input.qty");if(a&&document.activeElement!==a)if(t.manual){const e=null!==t.quantity&&void 0!==t.quantity&&""!==t.quantity;a.value=e?String(t.quantity):""}else{const e=null!=t.quantity?t.quantity:0;a.value=String(e)}const r=n.querySelector("input.price");if(r&&document.activeElement!==r){const e=null!==t.price&&void 0!==t.price&&""!==t.price,n=e?toNumber(t.price):"";if(t.manual)r.value=e?String(n):"",r.readOnly=!1;else{const e=toNumber(t.price);r.value=Number.isFinite(e)?e.toFixed(2):"0.00",r.readOnly=!admin}r.dataset.price=e?String(n):""}const o=n.querySelector(".mat-line");if(o)if("undefined"!=typeof window&&"function"==typeof window.updateMaterialLine)window.updateMaterialLine(n,{formatPrice:!0,shouldUpdateTotals:!1});else{const e=`${formatCurrency(toNumber(t.price)*toNumber(t.quantity))} kr`;o instanceof HTMLInputElement?o.value=e:o.textContent=e}}function calcMaterialesum(){return getAllData().reduce((e,t)=>e+toNumber(t.price)*toNumber(t.quantity),0)}function renderCurrency(e,t){let n=[];if("string"==typeof e?n=Array.from(document.querySelectorAll(e)):e instanceof Element?n=[e]:e&&"number"==typeof e.length&&(n=Array.from(e)),0===n.length)return;const a=`${formatCurrency(t)} kr`;n.forEach(e=>{e.textContent=a})}let totalsUpdateTimer=null;function computeTraelleTotals(){const e=toNumber(document.getElementById("traelleloeft35")?.value),t=toNumber(document.getElementById("traelleloeft50")?.value),n={n35:e,n50:t,RATE35:10.44,RATE50:14.62,sum:10.44*e+14.62*t};return"undefined"!=typeof window&&(window.__traelleloeft=n),n}function performTotalsUpdate(){const e=computeTraelleTotals(),t=e&&Number.isFinite(e.sum)?e.sum:0,n="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,a=getAllData().map(e=>({qty:toNumber(e?.quantity),unitPrice:toNumber(e?.price)*n})),r=calcMaterialesum()+t,o=toNumber(document.getElementById("slaebePct")?.value),s=r*(Number.isFinite(o)?o/100:0),i={"tralleløft":t,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},l=Array.isArray(laborEntries)?laborEntries.map(e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)})):[],d=l.reduce((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0),0),u=calculateTotals({materialLines:a,slaebeBelob:s,extra:i,workers:l,totalHours:d});lastMaterialSum=u.samletAkkordsum,lastLoensum=u.montoerLonMedTillaeg,renderCurrency('[data-total="material"]',u.samletAkkordsum),renderCurrency('[data-total="labor"]',u.montoerLonMedTillaeg),renderCurrency('[data-total="project"]',u.projektsum);const c=document.getElementById("montagepris");c&&(c.value=r.toFixed(2));const m=document.getElementById("demontagepris");m&&(m.value=(.5*r).toFixed(2))}function updateTotals(e={}){if(!0===e||e?.immediate)return totalsUpdateTimer&&(clearTimeout(totalsUpdateTimer),totalsUpdateTimer=null),void performTotalsUpdate();totalsUpdateTimer&&clearTimeout(totalsUpdateTimer),totalsUpdateTimer=setTimeout(()=>{totalsUpdateTimer=null,performTotalsUpdate()},80)}function updateTotal(){updateTotals()}const sagsinfoFieldIds=["sagsnummer","sagsnavn","sagsadresse","sagskunde","sagsdato","sagsmontoer"];function collectSagsinfo(){const e=e=>getDomElement(e)?.value??"";return{sagsnummer:e("sagsnummer").trim(),navn:e("sagsnavn").trim(),adresse:e("sagsadresse").trim(),kunde:e("sagskunde").trim(),dato:e("sagsdato"),montoer:e("sagsmontoer").trim()}}function setSagsinfoField(e,t){const n=getDomElement(e);n&&(n.value=t)}function updateActionHint(e="",t="info"){const n=getDomElement("actionHint");if(n){if(n.classList.remove("error","success"),!e)return n.textContent=DEFAULT_ACTION_HINT,void(n.style.display="none");n.textContent=e,"error"===t?n.classList.add("error"):"success"===t&&n.classList.add("success"),n.style.display=""}}function promisifyRequest(e){return e?new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)}):Promise.resolve(void 0)}function openDB(){return cachedDBPromise||("undefined"==typeof indexedDB?(cachedDBPromise=Promise.reject(new Error("IndexedDB er ikke tilgængelig")),cachedDBPromise.catch(()=>{}),cachedDBPromise):(cachedDBPromise=new Promise((e,t)=>{const n=indexedDB.open(DB_NAME,1);n.onupgradeneeded=e=>{const t=e.target?.result;t&&!t.objectStoreNames.contains(DB_STORE)&&t.createObjectStore(DB_STORE,{keyPath:"id",autoIncrement:!0})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error||new Error("IndexedDB kunne ikke åbnes"))}),cachedDBPromise.catch(()=>{cachedDBPromise=null}),cachedDBPromise))}async function saveProject(e){if(e)try{const t=await openDB();if(!t)return;const n=t.transaction(DB_STORE,"readwrite"),a=new Promise((e,t)=>{n.oncomplete=()=>e(),n.onabort=()=>t(n.error||new Error("Transaktionen blev afbrudt")),n.onerror=()=>t(n.error||new Error("Transaktionen fejlede"))}),r=n.objectStore(DB_STORE);await promisifyRequest(r.add({data:e,ts:Date.now()}));const o=await promisifyRequest(r.getAll());if(Array.isArray(o)&&o.length>20){o.sort((e,t)=>(e.ts||0)-(t.ts||0));const e=o.length-20;for(let t=0;t<e;t+=1){const e=o[t];e&&null!=e.id&&await promisifyRequest(r.delete(e.id))}}await a}catch(e){console.warn("Kunne ikke gemme sag lokalt",e)}}async function deleteProjectById(e){if(!Number.isFinite(e)||e<=0)return!1;try{const t=await openDB();if(!t)return!1;const n=t.transaction(DB_STORE,"readwrite"),a=new Promise((e,t)=>{n.oncomplete=()=>e(!0),n.onabort=()=>t(n.error||new Error("Transaktionen blev afbrudt")),n.onerror=()=>t(n.error||new Error("Transaktionen fejlede"))});return n.objectStore(DB_STORE).delete(Number(e)),await a,!0}catch(e){return console.warn("Kunne ikke slette sag",e),!1}}async function getRecentProjects(){try{const e=await openDB();if(!e)return[];const t=e.transaction(DB_STORE,"readonly"),n=new Promise((e,n)=>{t.oncomplete=()=>e(),t.onabort=()=>n(t.error||new Error("Transaktionen blev afbrudt")),t.onerror=()=>n(t.error||new Error("Transaktionen fejlede"))}),a=t.objectStore(DB_STORE),r=await promisifyRequest(a.getAll());return await n,Array.isArray(r)?r.filter(e=>e&&e.data).sort((e,t)=>(t.ts||0)-(e.ts||0)):[]}catch(e){return console.warn("Kunne ikke hente lokale sager",e),[]}}function setHistoryListBusy(e){const t=getDomElement("historyList");t&&t.setAttribute("aria-busy",e?"true":"false")}function formatHistoryTimestamp(e){if(!e)return"";const t=new Date(e);if(Number.isNaN(t.valueOf()))return"";try{return new Intl.DateTimeFormat("da-DK",{dateStyle:"medium",timeStyle:"short"}).format(t)}catch{return t.toLocaleString("da-DK")}}function renderHistoryList(e=recentCasesCache){const t=getDomElement("historyList");if(!t)return;t.innerHTML="";const n=Array.isArray(e)?e.filter(e=>e&&e.data):[];if(!n.length){const e=document.createElement("li");return e.className="history-list__empty",e.textContent="Ingen historik endnu.",t.appendChild(e),void setHistoryListBusy(!1)}n.slice(0,10).forEach(e=>{const n=document.createElement("li");n.className="history-list__item";const a=e.data?.sagsinfo||{},r=a.navn?.trim()||a.sagsnummer?.trim()||"Sag uden navn",o=document.createElement("span");o.className="history-list__title",o.textContent=r;const s=document.createElement("span");s.className="history-list__meta";const i=[];a.sagsnummer&&i.push(a.sagsnummer);const l=Array.isArray(e.data?.systems)?e.data.systems.map(e=>systemLabelMap.get(e)||e).filter(Boolean):[];l.length&&i.push(l.join(", "));const d=formatHistoryTimestamp(e.ts||e.data?.timestamp);d&&i.push(d);const u=e.data?.totals;if(u){const e=toNumber(u.materialSum)+toNumber(u.laborSum);e>0&&i.push(`Sum ${formatCurrency(e)}`)}s.textContent=i.join(" • "),n.appendChild(o),i.length&&n.appendChild(s);const c=document.createElement("div");c.className="history-list__actions";const m=document.createElement("button");m.type="button",m.className="history-list__delete",m.dataset.id=e.id,m.dataset.action="delete-history",m.textContent="Slet",c.appendChild(m),n.appendChild(c),t.appendChild(n)}),setHistoryListBusy(!1)}function setupHistoryListActions(){const e=getDomElement("historyList");e&&"true"!==e.dataset.boundDelete&&(e.dataset.boundDelete="true",e.addEventListener("click",async e=>{const t=e.target instanceof HTMLElement?e.target.closest('[data-action="delete-history"]'):null;if(!t)return;const n=Number(t.dataset.id);if(!(n>0))return;if(!window.confirm("Er du sikker på, at du vil slette denne sag?"))return;t.disabled=!0;await deleteProjectById(n)?(recentCasesCache=recentCasesCache.filter(e=>Number(e?.id)!==n),syncRecentProjectsGlobal(recentCasesCache),renderHistoryList(recentCasesCache),populateRecentCases()):t.disabled=!1}))}function findHistoryEntryById(e){return!Number.isFinite(e)||e<=0?null:recentCasesCache.find(t=>Number(t?.id)===e)||null}function buildHistorySummary(e){if(!e||!e.data)return null;const t=e.data.totals||{},n=toNumber(t.timer??t.totalHours),a=toNumber(t.hourlyBase??t.akkordTimeLon??t.timeprisUdenTillaeg),r=toNumber(t.mentorRate),o=r>0?r:22.26;let s=toNumber(t.hourlyUdd1),i=toNumber(t.hourlyUdd2),l=toNumber(t.hourlyUdd2Mentor);const d=a>0;return s>0||!d||(s=a+42.98),i>0||!d||(i=a+49.38),l>0||!d||(l=a+49.38+o),{date:formatHistoryTimestamp(e.ts||e.data.timestamp),timer:n>0?n:0,hourlyBase:d?a:0,hourlyUdd1:s>0?s:0,hourlyUdd2:i>0?i:0,hourlyUdd2Mentor:l>0?l:0}}function renderJobHistorySummary(e){const t=getDomElement("job-history-summary-body");if(!t)return;t.innerHTML="";const n=buildHistorySummary(e);if(!n){const e=document.createElement("tr"),n=document.createElement("td");return n.colSpan=6,n.textContent="Ingen historik endnu.",e.appendChild(n),void t.appendChild(e)}const a=e=>e>0?`${formatCurrency(e)} kr`:"–",r=[n.date||"–",n.timer>0?formatNumber(n.timer):"–",a(n.hourlyBase),a(n.hourlyUdd1),a(n.hourlyUdd2),a(n.hourlyUdd2Mentor)],o=document.createElement("tr");r.forEach(e=>{const t=document.createElement("td");t.textContent=e,o.appendChild(t)}),t.appendChild(o)}function updateHistorySummaryFromSelect(){const e=getDomElement("jobHistorySelect"),t=Number(e?.value);let n=null;Number.isFinite(t)&&t>0&&(n=findHistoryEntryById(t)),!n&&recentCasesCache.length&&(n=recentCasesCache[0],n&&e&&e.value!==String(n.id)&&(e.value=String(n.id))),renderJobHistorySummary(n||null);const a=getDomElement("btnLoadHistoryJob");a&&(a.disabled=!(n&&null!=n.id))}async function populateRecentCases(){const e=getDomElement("jobHistorySelect"),t=getDomElement("btnLoadHistoryJob");if(!Boolean(e||getDomElement("historyList")))return;setupHistoryListActions(),setHistoryListBusy(!0);const n=await getRecentProjects();recentCasesCache=n,syncRecentProjectsGlobal(recentCasesCache);const a=e?.value||"";if(e&&(e.innerHTML=""),renderHistoryList(n),!n.length){if(e){const t=document.createElement("option");t.value="",t.textContent="Ingen gemte sager endnu",t.disabled=!0,t.selected=!0,e.appendChild(t)}return t&&(t.disabled=!0),void renderJobHistorySummary(null)}if(!e)return renderJobHistorySummary(n[0]||null),void(t&&(t.disabled=!(n[0]&&null!=n[0].id)));n.forEach(t=>{const n=document.createElement("option");n.value=String(t.id);const a=t.data?.sagsinfo||{},r=[];a.sagsnummer&&r.push(a.sagsnummer),a.navn&&r.push(a.navn),n.textContent=r.length?r.join(" – "):`Sag #${t.id}`,e.appendChild(n)});const r=n.find(e=>String(e.id)===a)||n[0];r&&(e.value=String(r.id)),t&&(t.disabled=!e.value),updateHistorySummaryFromSelect()}function collectExtrasState(){const e=e=>getDomElement(e)?.value??"";return{jobType:getDomElement("jobType")?.value||"montage",montagepris:e("montagepris"),demontagepris:e("demontagepris"),slaebePct:e("slaebePct"),slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:e("antalBoringHuller"),antalLukHuller:e("antalLukHuller"),antalBoringBeton:e("antalBoringBeton"),opskydeligtRaekvaerk:e("antalOpskydeligt"),km:e("km"),traelle35:e("traelleloeft35"),traelle50:e("traelleloeft50")}}function collectProjectSnapshot(){const e=getAllData().map(e=>({id:e.id,name:e.name,price:toNumber(e.price),quantity:toNumber(e.quantity),manual:Boolean(e.manual),varenr:e.varenr||null})),t=Array.isArray(laborEntries)?laborEntries.map(e=>({...e})):[],n={materialSum:lastMaterialSum,laborSum:lastLoensum};return lastJobSummary&&(n.timer=lastJobSummary.totalHours,n.hourlyBase=lastJobSummary.hourlyBase,n.hourlyUdd1=lastJobSummary.hourlyUdd1,n.hourlyUdd2=lastJobSummary.hourlyUdd2,n.hourlyUdd2Mentor=lastJobSummary.hourlyUdd2Mentor,n.mentorRate=lastJobSummary.mentorRate),{timestamp:Date.now(),sagsinfo:collectSagsinfo(),systems:Array.from(selectedSystemKeys),materials:e,labor:t,extras:collectExtrasState(),totals:n}}async function persistProjectSnapshot(){try{const e=collectProjectSnapshot();await saveProject(e),await populateRecentCases()}catch(e){console.warn("Kunne ikke gemme projekt snapshot",e)}}function applyExtrasSnapshot(e={}){const t=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t??"")},n=document.getElementById("jobType");n&&e.jobType&&(n.value=e.jobType),t("montagepris",e.montagepris),t("demontagepris",e.demontagepris),t("slaebePct",e.slaebePct),setSlaebFormulaText(e?.slaebeFormulaText??""),updateSlaebFormulaInfo(exportMeta.slaebFormulaText),t("antalBoringHuller",e.antalBoringHuller),t("antalLukHuller",e.antalLukHuller),t("antalBoringBeton",e.antalBoringBeton),t("antalOpskydeligt",e.opskydeligtRaekvaerk),t("km",e.km),t("traelleloeft35",e.traelle35),t("traelleloeft50",e.traelle50),computeTraelleTotals()}function applyMaterialsSnapshot(e=[],t=[]){resetMaterials(),Array.isArray(t)&&t.length&&(selectedSystemKeys.clear(),t.forEach(e=>selectedSystemKeys.add(e))),Array.isArray(e)&&e.forEach(e=>{if(shouldExcludeMaterialEntry(e))return;const t=toNumber(e?.quantity),n=toNumber(e?.price);let a=null;if(e?.id&&(a=findMaterialById(e.id)),a&&!a.manual)return a.quantity=t,void(Number.isFinite(n)&&n>0&&(a.price=n));if(e?.manual){const a=manualMaterials.find(t=>t.id===e.id)||manualMaterials.find(e=>!e.name&&0===e.quantity&&0===e.price);return void(a&&(a.name=e.name||a.name,a.price=Number.isFinite(n)?n:a.price,a.quantity=t))}const r=manualMaterials.find(e=>!e.name&&0===e.quantity&&0===e.price);r&&(r.name=e?.name||"",r.price=Number.isFinite(n)?n:0,r.quantity=t)}),renderOptaelling()}function applyLaborSnapshot(e=[]){laborEntries=Array.isArray(e)?e.map(e=>({...e})):[],populateWorkersFromLabor(laborEntries)}function mapAkkordJsonV1ToSnapshot(e={}){const t=e.type||e.extras?.jobType||"montage",n="demontage"===t?.5:1,a={...e.extras||{},jobType:t},r=Array.isArray(e.wage?.workers)?e.wage.workers:[],o=r.map(e=>e?.name||e?.worker||"").filter(Boolean).join(", ");return{sagsinfo:{sagsnummer:e.jobId||e.info?.sagsnummer||"",navn:e.jobName||e.info?.navn||"",adresse:e.info?.adresse||e.info?.address||e.site||e.address||"",kunde:e.customer||e.info?.kunde||"",dato:normalizeDateValue(e.createdAt||e.info?.dato),montoer:o||e.info?.montoer||""},systems:Array.isArray(e.systems)&&e.systems.length?e.systems:e.system?[e.system]:[],materials:Array.isArray(e.materials)?e.materials.map(e=>({id:e?.id||e?.varenr||e?.lineId||"",name:e?.name||e?.label||"",quantity:toNumber(e?.qty??e?.quantity??0),price:toNumber(e?.unitPrice??e?.price??0)/n})).filter(e=>e.id||e.name):[],labor:r.length?r.map(n=>({type:n?.type||t,hours:toNumber(n?.hours??n?.time??0),rate:toNumber(n?.rate??n?.hourlyWithAllowances??e.wage?.hourlyRate),udd:n?.udd||n?.educationLevel||e.wage?.educationLevel||"",mentortillaeg:toNumber(n?.mentortillaeg)})):Array.isArray(e.labor)?e.labor:[],extras:a,totals:e.totals?{materialSum:toNumber(e.totals.materialsSum??e.totals.materialSum),laborSum:toNumber(e.totals.laborSum??e.totals.laborSumWithAllowance)}:e.summary?{materialSum:toNumber(e.summary.materialSum),laborSum:toNumber(e.summary.laborSum)}:void 0}}function normalizeLegacyJsonSnapshot(e={}){const t=e.type||e.jobType||e.extras?.jobType||"montage",n={...e.extras||{},jobType:t},a={...e.sagsinfo||e.info||{}};return!a.dato&&e.createdAt&&(a.dato=normalizeDateValue(e.createdAt)),{sagsinfo:a,systems:Array.isArray(e.systems)?e.systems:e.system?[e.system]:[],materials:Array.isArray(e.materials)?e.materials:[],labor:Array.isArray(e.labor)?e.labor:[],extras:n,totals:e.totals||e.summary}}function normalizeImportedJsonSnapshot(e={}){const t=Number(e?.version);return Number.isFinite(t)&&t>=AKKORD_JSON_VERSION?mapAkkordJsonV1ToSnapshot(e):normalizeLegacyJsonSnapshot(e)}function applyProjectSnapshot(e,t={}){if(!e||"object"!=typeof e)return;const n=e.sagsinfo||{};setSagsinfoField("sagsnummer",n.sagsnummer||""),setSagsinfoField("sagsnavn",n.navn||""),setSagsinfoField("sagsadresse",n.adresse||""),setSagsinfoField("sagskunde",n.kunde||""),setSagsinfoField("sagsdato",n.dato||""),setSagsinfoField("sagsmontoer",n.montoer||""),applyMaterialsSnapshot(e.materials,e.systems),applyExtrasSnapshot(e.extras),applyLaborSnapshot(e.labor),e.totals&&(Number.isFinite(e.totals.materialSum)&&(lastMaterialSum=e.totals.materialSum),Number.isFinite(e.totals.laborSum)&&(lastLoensum=e.totals.laborSum)),updateTotals(!0),validateSagsinfo(),t?.skipHint||updateActionHint("Sag er indlæst.","success")}async function handleLoadCase(){const e=getDomElement("jobHistorySelect");if(!e)return;const t=Number(e.value);if(!Number.isFinite(t)||t<=0)return;let n=recentCasesCache.find(e=>Number(e.id)===t);if(!n){const e=await getRecentProjects();recentCasesCache=e,syncRecentProjectsGlobal(recentCasesCache),n=e.find(e=>Number(e.id)===t),renderHistoryList(recentCasesCache)}n&&n.data?(applyProjectSnapshot(n.data,{skipHint:!1}),renderJobHistorySummary(n)):updateActionHint("Kunne ikke indlæse den valgte sag.","error")}function validateSagsinfo(){let e=!0;return sagsinfoFieldIds.forEach(t=>{const n=getDomElement(t);if(!n)return;const a=(n.value||"").trim();let r=a.length>0;"sagsdato"===t&&(r=a.length>0&&!Number.isNaN(new Date(a).valueOf())),r||(e=!1),n.classList.toggle("invalid",!r)}),["btnExportZip","btnPrint"].forEach(t=>{const n=getDomElement(t);n&&(n.disabled=!e)}),e?updateActionHint(""):updateActionHint(DEFAULT_ACTION_HINT,"error"),e}function escapeCSV(e){if(null==e)return"";const t=String(e);return/[";\n\r]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function sanitizeFilename(e){return(e||"akkordseddel").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9-_]+/gi,"_")}function formatNumberForCSV(e){return toNumber(e).toFixed(2).replace(".",",")}function formatPercentForCSV(e){return`${toNumber(e).toFixed(2).replace(".",",")} %`}function collectJobType(){return document.getElementById("jobType")?.value||"montage"}function formatDateForDisplay(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.valueOf())?String(e):t.toLocaleDateString("da-DK")}function getExcelSystemInputs(){return"undefined"==typeof document?[]:Array.from(document.querySelectorAll('input[name="akkordExcelSystem"][type="checkbox"]'))}function getExcelSystemSelectionFromInputs(){const e=getExcelSystemInputs();if(0===e.length)return Array.from(excelSystemSelectionCache);return sanitizeExcelSystemSelection(e.filter(e=>e.checked).map(e=>e.value))}function syncExcelSystemSelector(){const e=getExcelSystemInputs();if(0===e.length)return;const t=getSelectedSystemKeys(),n=new Set(getStoredExcelSystems());e.forEach(e=>{const a=normalizeExcelSystemId(e.value);e.checked=n.has(a);const r=e.closest(".export-system-option"),o=r?.querySelector(".export-system-option__label"),s=r?.querySelector(".export-system-option__hint"),i=AKKORD_EXCEL_SYSTEMS.find(e=>e.id===a);o&&i&&(o.textContent=i.label);const l=t.includes(a);s&&(s.textContent=l?"Aktiv i sag":"Ikke aktiv i sag"),r&&r.classList.toggle("export-system-option--inactive",!l)})}function initExcelSystemSelector(){syncExcelSystemSelector();const e=document.getElementById("akkordExcelSystemOptions");e&&e.addEventListener("change",e=>{const t=e.target;if(!t||"function"!=typeof t.getAttribute)return;if("akkordExcelSystem"!==t.getAttribute("name"))return;setStoredExcelSystems(getExcelSystemSelectionFromInputs())})}function requireExcelSystemSelection(){const e=getExcelSystemSelectionFromInputs();if(0===e.length){return updateActionHint('Vælg mindst ét Excel 25-ark under "Eksport & deling".',"error"),null}return e}function triggerBlobDownload(e,t){if("undefined"==typeof document)return;const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}async function downloadExcelPayloads(e,t){if(!Array.isArray(e)||0===e.length)return{count:0,zipped:!1};const n=e.filter(e=>e?.blob&&e?.fileName);if(0===n.length)return{count:0,zipped:!1};if(1===n.length)return triggerBlobDownload(n[0].blob,n[0].fileName),{count:1,zipped:!1};const{JSZip:a}=await ensureZipLib(),r=new a;n.forEach(e=>{r.file(e.fileName,e.blob)});return triggerBlobDownload(await r.generateAsync({type:"blob"}),`${sanitizeFilename(t?.sagsinfo?.sagsnummer||t?.caseNo||"akkordsedler")||"akkordsedler"}_excel.zip`),{count:n.length,zipped:!0}}function buildExcelExportMessage(e){return e&&0!==e.count?1===e.count?"1 Excel-ark blev genereret og downloadet direkte. ZIP bruges kun ved flere valg.":`${e.count} Excel-ark blev samlet i én ZIP-fil. ZIP bruges kun ved flere valg.`:""}async function exportExcelSelection(e,t){if(!e)return{count:0,zipped:!1};const n=sanitizeExcelSystemSelection(t);if(0===n.length)return{count:0,zipped:!1};return downloadExcelPayloads(await exportAkkordExcelForActiveJob(e,n),e)}function initExportButtons(){const e=()=>prefetchExportLibs(),t=document.getElementById("btnExportAkkord");t&&(t.addEventListener("click",()=>onExportPdf()),t.addEventListener("pointerenter",e,{once:!0}),t.addEventListener("focus",e,{once:!0}));const n=document.getElementById("btnExportZip");n&&(n.addEventListener("click",()=>onExportZip()),n.addEventListener("pointerenter",e,{once:!0}),n.addEventListener("focus",e,{once:!0}));const a=document.getElementById("btnExportJson");a&&a.addEventListener("click",()=>exportAkkordJsonFile());const r=document.getElementById("btnImportAkkord"),o=document.getElementById("akkordImportInput");r&&o&&(r.addEventListener("click",()=>o.click()),o.addEventListener("change",e=>{const t=e.target.files?.[0];t&&(handleAkkordImport(t),o.value="")})),initExcelSystemSelector()}async function onExportZip(){if(requireExcelSystemSelection())try{await exportZip(),updateActionHint("ZIP eksport gemt.","success")}catch(e){console.error("ZIP eksport fejlede",e),updateActionHint("Kunne ikke eksportere ZIP.","error")}}async function onExportPdf(){try{const e=collectSagsinfo(),t=[e.sagsnummer,e.navn,e.montoer].map(e=>(e||"").trim()).filter(Boolean),n=t.length?sanitizeFilename(t.join("_")):void 0;await exportPDF(void 0,{baseName:n})}catch(e){console.error("PDF eksport fejlede",e),updateActionHint("Kunne ikke eksportere PDF.","error")}}function inferSystemFromLine(e){if(!e)return"";if(e.system)return e.system;if(e.systemKey)return e.systemKey;const t=String(e.varenr||e.id||"").trim().toLowerCase();return t.startsWith("b")?"bosta":t.startsWith("h")?"haki":t.startsWith("m")?"modex":""}function buildAkkordJobSnapshot(e=lastEkompletData){const t=e||lastEkompletData;if(!t)return null;const n=collectSagsinfo(),a={...t.sagsinfo||{},...n},r=t.jobType||document.getElementById("jobType")?.value||"montage",o=a.montoer||"",s="demontage"===r?"":o,i="demontage"===r?o:"",l=a.dato?formatDateForDisplay(a.dato):"",d={id:a.sagsnummer||a.navn||a.adresse||"akkord",caseNo:a.sagsnummer||"",site:a.adresse||"",address:a.adresse||"",task:a.navn||"",title:a.navn||"",customer:a.kunde||"",date:l||a.dato||"",montageWorkers:s,demontageWorkers:i,montor:o,worker:o,system:getPreferredExcelSystem()},u=(Array.isArray(t.materialer)?t.materialer:[]).map(e=>({id:e?.varenr||e?.id||"",label:e?.name||e?.label||"",name:e?.name||e?.label||"",qty:toNumber(e?.quantity??e?.qty??0),amount:toNumber(e?.quantity??e?.qty??0),system:inferSystemFromLine(e)})).filter(e=>e.label&&e.qty>0);return d.lines=u,d.items=u,d.materials=u,d}function buildAkkordData(e={}){const t=collectSagsinfo();e.customSagsnummer&&(t.sagsnummer=e.customSagsnummer);const n=getAllData().filter(e=>toNumber(e.quantity)>0),a=Array.isArray(laborEntries)?laborEntries:[],r="undefined"!=typeof window?window.__beregnLonCache:null,o=collectJobType(),s="demontage"===o?.5:1,i={boringHuller:toNumber(document.getElementById("antalBoringHuller")?.value),lukHuller:toNumber(document.getElementById("antalLukHuller")?.value),boringBeton:toNumber(document.getElementById("antalBoringBeton")?.value),opskydeligt:toNumber(document.getElementById("antalOpskydeligt")?.value),km:toNumber(document.getElementById("km")?.value),slaebePctInput:toNumber(document.getElementById("slaebePct")?.value)},l=computeTraelleTotals(),d=l&&Number.isFinite(l.sum)?l.sum:0,u=n.map(e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*s})),c=calcMaterialesum()+d,m=c*(Number.isFinite(i.slaebePctInput)?i.slaebePctInput/100:0),p={"tralleløft":d,traelle35:l?.n35||0,traelle50:l?.n50||0,huller:4.7*i.boringHuller,lukAfHul:3.45*i.lukHuller,boringBeton:11.49*i.boringBeton,boring:11.49*i.boringBeton,opskydeligt:9.67*i.opskydeligt,km:2.12*i.km,oevrige:0,slaebePct:i.slaebePctInput,slaebeBelob:m},f={jobType:o,slaebePct:i.slaebePctInput,slaebeBelob:m,slaebeFormulaText:exportMeta.slaebFormulaText||"",antalBoringHuller:i.boringHuller,antalLukHuller:i.lukHuller,antalBoringBeton:i.boringBeton,boringBeton:p.boring,boring:p.boring,huller:p.huller,lukAfHul:p.lukAfHul,opskydeligtRaekvaerk:i.opskydeligt,opskydeligt:p.opskydeligt,km:p.km,traelle35:l?.n35||0,traelle50:l?.n50||0,"tralleløft":d},y=a.map(e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)})),g=y.reduce((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0),0),b=calculateTotals({materialLines:u,slaebeBelob:m,extra:p,workers:y,totalHours:g});return{info:t,materials:n,labor:a,cache:r,jobType:o,jobFactor:s,tralleState:l,tralleSum:d,materialLinesForTotals:u,montageBase:c,slaebePctInput:i.slaebePctInput,slaebeBelob:m,extraInputs:i,extras:f,laborTotals:y,totalHours:g,totals:b}}function syncActiveJobState(){const e=buildAkkordJobSnapshot();return e&&setActiveJob(e),e}function normalizeDateValue(e){if(!e)return"";const t=String(e).trim();if(!t)return"";const n=t.split(/[-\/.]/);if(3===n.length){const[e,t,a]=n;if(4===e.length)return`${e}-${t.padStart(2,"0")}-${a.padStart(2,"0")}`;if(4===a.length)return`${a}-${t.padStart(2,"0")}-${e.padStart(2,"0")}`}const a=new Date(t);return Number.isNaN(a.valueOf())?"":a.toISOString().slice(0,10)}function parseCSV(e){const t=String(e).split(/\r?\n/).filter(e=>e.trim().length>0);if(0===t.length)return[];const n=t[0].includes(";")?";":",",a=e=>{const t=[];let a="",r=!1;for(let o=0;o<e.length;o++){const s=e[o];'"'===s?r&&'"'===e[o+1]?(a+='"',o++):r=!r:s!==n||r?a+=s:(t.push(a.trim()),a="")}return t.push(a.trim()),t},r=a(t[0]),o=[];for(let e=1;e<t.length;e++){const n=a(t[e]);if(n.every(e=>""===e))continue;const s={};r.forEach((e,t)=>{s[e]=n[t]??""}),o.push(s)}return o}function resetMaterials(){[dataBosta,dataHaki,dataModex,dataAlfix].forEach(e=>{e.forEach(e=>{e.quantity=0})}),manualMaterials.forEach(e=>{e.name="",e.price=0,e.quantity=0})}function resetWorkers(){workerCount=0;const e=document.getElementById("workers");e&&(e.innerHTML="")}function populateWorkersFromLabor(e){if(resetWorkers(),!Array.isArray(e)||0===e.length)return addWorker(),void updateTotals(!0);e.forEach((e,t)=>{addWorker();const n=document.getElementById(`worker${t+1}`);if(!n)return;const a=n.querySelector(".worker-hours"),r=n.querySelector(".worker-tillaeg"),o=n.querySelector(".worker-udd");if(a&&(a.value=formatNumber(toNumber(e.hours))),r&&(r.value=formatNumber(toNumber(e.mentortillaeg))),o instanceof HTMLSelectElement){const t=(e?.udd??"").toString().trim();if(t){Array.from(o.options).some(e=>e.value===t)?o.value=t:o.options.length>0&&(o.selectedIndex=0)}else o.options.length>0&&(o.selectedIndex=0)}}),updateTotals(!0);e.some(e=>toNumber(e.hours)>0)&&"function"==typeof beregnLon&&beregnLon()}function matchMaterialByName(e){if(!e)return null;const t=normalizeKey(e),n=[dataBosta,dataHaki,dataModex,dataAlfix,manualMaterials];for(const e of n){const n=e.find(e=>normalizeKey(e.name)===t);if(n)return n}return null}function assignMaterialRow(e){const t=e.id?.trim?.()||"",n=e.name?.trim?.()||"",a=toNumber(e.quantity),r=toNumber(e.price);if(!n&&!t&&0===a&&0===r)return;if(shouldExcludeMaterialEntry({id:t,name:n}))return;let o=null;if(t&&(o=findMaterialById(t)),!o&&n&&(o=matchMaterialByName(n)),o&&!o.manual)return o.quantity=a,void(r>0&&(o.price=r));const s=manualMaterials.find(e=>!e.name&&0===e.quantity&&0===e.price);if(!s)return;const i=manualMaterials.indexOf(s)+1;s.name=n||s.name||`Manuelt materiale ${i}`,s.quantity=a,s.price=r}function applyCSVRows(e){if(!Array.isArray(e)||0===e.length)return;resetMaterials();const t=collectSagsinfo(),n=[],a=[],r=[];if(e.forEach(e=>{const o={};Object.entries(e).forEach(([e,t])=>{o[normalizeKey(e)]=(t??"").toString().trim()});const s=o.sagsnummer||o.sagsnr||o.sag||o.caseid;s&&(t.sagsnummer=s);const i=o.navnopgave||o.navn||o.opgave||o.projekt;i&&(t.navn=i);const l=o.adresse||o.addresse;l&&(t.adresse=l);const d=o.kunde||o.customer;d&&(t.kunde=d);const u=normalizeDateValue(o.dato||o.date);u&&(t.dato=u);const c=o.montoer||o.montor||o.montornavne||o.montornavn;c&&n.push(c);const m=o.materialenavn||o.materiale||o.varenavn||o.navn,p=o.antal||o.quantity||o.qty||o.maengde,f=o.pris||o.price||o.enhedspris||o.stkpris,y=o.id||o.materialeid||o.varenummer;(m||y||p||f)&&a.push({id:y,name:m,quantity:p,price:f});const g=o.arbejdstype||o.type||o.jobtype,b=o.timer||o.hours||o.antalttimer,S=o.sats||o.rate||o.timelon||o.timeloen;(g||b||S)&&r.push({type:g||"",hours:toNumber(b),rate:toNumber(S)})}),setSagsinfoField("sagsnummer",t.sagsnummer||""),setSagsinfoField("sagsnavn",t.navn||""),setSagsinfoField("sagsadresse",t.adresse||""),setSagsinfoField("sagskunde",t.kunde||""),setSagsinfoField("sagsdato",t.dato||""),n.length){setSagsinfoField("sagsmontoer",n.flatMap(e=>e.split(/[\n,]/)).map(e=>e.trim()).filter(Boolean).join("\n"))}a.forEach(assignMaterialRow);const o=systemOptions.filter(e=>e.dataset.some(e=>toNumber(e.quantity)>0));if(o.length>0&&(selectedSystemKeys.clear(),o.forEach(e=>selectedSystemKeys.add(e.key))),renderOptaelling(),laborEntries=r.filter(e=>e.hours>0||e.rate>0||e.type),populateWorkersFromLabor(laborEntries),updateTotals(!0),laborEntries.length>0){const e=laborEntries[0].type?.toLowerCase()||"",t=document.getElementById("jobType");t&&(e.includes("demo")?t.value="demontage":e.includes("montage")&&(t.value="montage"))}validateSagsinfo()}function setupCSVImport(){const e=document.getElementById("dropArea"),t=document.getElementById("csvFileInput");if(!e||!t)return;const n=()=>t.click();["dragenter","dragover"].forEach(t=>{e.addEventListener(t,t=>{t.preventDefault(),e.classList.add("dragover"),t.dataTransfer&&(t.dataTransfer.dropEffect="copy")})}),["dragleave","dragend"].forEach(t=>{e.addEventListener(t,()=>e.classList.remove("dragover"))}),e.addEventListener("drop",n=>{n.preventDefault(),e.classList.remove("dragover");const a=n.dataTransfer?.files?.[0];a&&(handleImportFile(a),t.value="")}),e.addEventListener("click",n),e.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n())}),t.addEventListener("change",e=>{const n=e.target.files?.[0];n&&(handleImportFile(n),t.value="")})}function applyImportedAkkordData(e){if(!e||"object"!=typeof e)return void updateActionHint("Kunne ikke læse akkordseddel-data.","error");const t=e.data&&!e.materials?e.data:e,n=(t.type||t.jobType||"montage").toLowerCase(),a=t.extras||{},r=(Array.isArray(t.materials)?t.materials:Array.isArray(t.lines)?t.lines:[]).map(e=>({id:e.id||e.varenr||"",name:e.name||e.label||e.title||"",price:toNumber(e.unitPrice??e.price),quantity:toNumber(e.qty??e.quantity??e.amount),system:e.system||e.systemKey||inferSystemFromLine(e)})).filter(e=>e.quantity>0||e.name||e.id),o=t.wage||{},s=Array.isArray(o.workers)?o.workers:Array.isArray(t.workers)?t.workers:Array.isArray(t.labor)?t.labor:[],i=[];if(s.length)s.forEach(e=>{const t=toNumber(e?.hours),a=toNumber(e?.rate??e?.hourlyWithAllowances??e?.hourlyRate),r=e?.udd||e?.education||e?.educationLevel||"",o=toNumber(e?.mentortillaeg??e?.mentorAllowance),s=e?.type||n;(t>0||a>0||s)&&i.push({type:s,hours:t,rate:a,udd:r,mentortillaeg:o})});else{const e=toNumber(o.montageHours??o.demontageHours??o.totalHours),t=toNumber(o.hourlyRate);(e>0||t>0)&&i.push({type:n,hours:e,rate:t,udd:o.educationLevel||o.udd||"",mentortillaeg:toNumber(o.mentorAllowance)})}const l=Array.isArray(t.systems)?t.systems:t.system?[normalizeExcelSystemId(t.system)]:Array.from(selectedSystemKeys),d=toNumber(a.tralleløft??a.tralleloeft??a.tralleløft);let u=a.traelle35??a.tralle35??a.tralleloeft35??a.tralleløft35,c=a.traelle50??a.tralle50??a.tralleloeft50??a.tralleløft50;if(!u&&!c&&Number.isFinite(d)&&d>0){const e=d/10.44;u=Number.isFinite(e)?e.toFixed(2):""}applyProjectSnapshot({sagsinfo:{sagsnummer:t.jobId||t.caseNo||t.id||"",navn:t.jobName||t.name||t.title||"",adresse:t.jobAddress||t.address||t.site||"",kunde:t.customer||t.kunde||"",dato:t.createdAt||t.date||"",montoer:t.montageWorkers||t.demontageWorkers||t.worker||t.montor||""},systems:l,materials:r,labor:i,extras:{jobType:n,montagepris:a.montagepris,demontagepris:a.demontagepris,slaebePct:a.slaebePct,slaebeFormulaText:a.slaebeFormulaText,antalBoringHuller:a.huller??a.antalBoringHuller??0,antalLukHuller:a.lukAfHul??a.antalLukHuller??0,antalBoringBeton:a.boringBeton??a.antalBoringBeton??0,opskydeligtRaekvaerk:a.opskydeligt??a.opskydeligtRaekvaerk??0,km:a.km??a.kilometer??0,traelle35:u,traelle50:c},totals:t.totals||{}},{skipHint:!0}),updateActionHint("Akkordseddel er importeret. Bekræft arbejdstype og tal.","success")}async function handleAkkordImport(e){if(e)try{const t=await e.text();applyImportedAkkordData(JSON.parse(t))}catch(e){console.error("Kunne ikke importere akkordseddel",e),updateActionHint("Kunne ikke importere akkordseddel-filen.","error")}}function handleImportFile(e){if(!e)return;const t=e.name||"";/\.json$/i.test(t)||e.type&&e.type.includes("json")?importJSONProject(e):uploadCSV(e)}async function verifyAdminCodeInput(e,t=null){const n="string"==typeof e?e.trim():"";if(!n)return{ok:!1,reason:"empty"};const a=new Set([...KNOWN_ADMIN_CODES,...Array.isArray(t?.KNOWN_ADMIN_CODES)?t.KNOWN_ADMIN_CODES:[],...Array.isArray(t?.admin_codes_plain)?t.admin_codes_plain:[]].filter(e=>"string"==typeof e&&e.trim().length));for(const e of a)if(e===n)return{ok:!0,method:"plaintext"};const r=new Set([...KNOWN_ADMIN_CODE_HASHES,DEFAULT_ADMIN_CODE_HASH,t?._meta?.admin_code,...Array.isArray(t?.HASHED_ADMIN_CODES)?t.HASHED_ADMIN_CODES:[]].filter(e=>"string"==typeof e&&e.length));if(r.size>0){const e=await sha256Hex(n);for(const t of r)if(constantTimeEquals(e,t))return{ok:!0,method:"sha256"}}return{ok:!1,reason:"no_match"}}function handleAdminLogout(e){admin=!1,setAdminOk(!1),renderOptaelling(),updateTotals(!0),e&&(e.textContent="Admin-tilstand er slået fra.",e.classList.remove("error"),e.classList.add("success"),e.removeAttribute("hidden")),updateActionHint("Admin-tilstand er slået fra.","success")}async function login(){const e=document.getElementById("adminCode"),t=document.getElementById("adminFeedback");if(!e)return;const n=e.value.trim();if(!n)return void(isAdminUnlocked()?handleAdminLogout(t):t&&(t.textContent="Indtast admin-kode for at logge ind.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden")));(await verifyAdminCodeInput(n)).ok?(admin=!0,setAdminOk(!0),e.value="",t?.classList.remove("error"),t?.classList.add("success"),t&&(t.textContent="Admin-tilstand aktiveret. Prisfelter er nu redigerbare.",t.removeAttribute("hidden")),renderOptaelling(),updateTotals(!0)):t&&(t.textContent="Forkert kode. Prøv igen.",t.classList.remove("success"),t.classList.add("error"),t.removeAttribute("hidden"))}const adminLoginButton=document.getElementById("btnAdminLogin");function addWorker(){workerCount++;const e=document.createElement("fieldset");e.className="worker-row",e.id=`worker${workerCount}`,e.innerHTML=`\n    <legend>Mand ${workerCount}</legend>\n    <div class="worker-grid">\n      <label>\n        <span>Timer</span>\n        <input type="text" class="worker-hours" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-hours-${workerCount}">\n      </label>\n      <label>\n        <span>Uddannelse</span>\n        <select class="worker-udd">\n          <option value="udd1">Udd1 (42,98 kr)</option>\n          <option value="udd2">Udd2 (49,38 kr)</option>\n        </select>\n      </label>\n      <label>\n        <span>Mentortillæg (22,26 kr/t)</span>\n        <input type="text" class="worker-tillaeg" value="0" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="worker-tillaeg-${workerCount}">\n      </label>\n    </div>\n    <div class="worker-output" aria-live="polite"></div>\n  `,document.getElementById("workers").appendChild(e)}function debounce(e,t){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}async function saveLocalData(e,t){localStorage.setItem(e,JSON.stringify(t))}async function loadLocalData(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}function showLonOutputSections(){if(lonOutputsRevealed)return;lonOutputsRevealed=!0;document.querySelectorAll("[data-lon-output]").forEach(e=>{e.hidden=!1,e.removeAttribute("hidden")})}function beregnLon(){const e=collectSagsinfo(),t=e.sagsnummer?.trim()||"uspecified",n=document.getElementById("jobType")?.value||"montage",a="demontage"===n?.5:1,r=getSelectedSystemKeys(),o=r.map(e=>normalizeKey(e)).find(e=>["bosta","haki","modex"].includes(e))||"",s=toNumber(document.getElementById("slaebePct")?.value),i=toNumber(document.getElementById("antalBoringHuller")?.value),l=toNumber(document.getElementById("antalLukHuller")?.value),d=toNumber(document.getElementById("antalBoringBeton")?.value),u=toNumber(document.getElementById("antalOpskydeligt")?.value),c=toNumber(document.getElementById("km")?.value),m=document.querySelectorAll(".worker-row");lastEkompletData=null,lastJobSummary=null;const p=computeTraelleTotals(),f=p&&Number.isFinite(p.sum)?p.sum:0,y=[],g=[],b=[],S=getAllData();Array.isArray(S)&&S.forEach(e=>{const t=toNumber(e?.quantity);if(t<=0)return;const n=toNumber(e?.price),r=n*a,o=t*r;y.push({qty:t,unitPrice:r});const s=manualMaterials.indexOf(e),i=e?.manual?e.name?.trim()||`Manuelt materiale ${s+1}`:e?.name;g.push({label:i,quantity:t,unitPrice:n,lineTotal:o,ackUnitPrice:r});const l=t>0?o/t:r;b.push({varenr:e?.varenr||e?.id||"",name:i,quantity:t,unitPrice:l,baseUnitPrice:n,lineTotal:o,system:e?.systemKey||"",systemKey:e?.systemKey||""})});const h=4.7*i,k=3.45*l,E=11.49*d,v=9.67*u,A=2.12*c,w=calcMaterialesum()+f,N=w*(Number.isFinite(s)?s/100:0),L={"tralleløft":f,huller:h,boring:E,lukAfHul:k,opskydeligt:v,km:A,oevrige:0};let x=0;if(m.forEach(e=>{const t=e.querySelector(".worker-hours"),n=toNumber(t?.value);n>0&&(x+=n)}),0===x){const e=document.getElementById("lonResult");if(e){e.innerHTML="";const t=document.createElement("div");t.style.color="red",t.textContent="Indtast arbejdstimer for mindst én person",e.appendChild(t)}return laborEntries=[],void(lastJobSummary=null)}const T={materialLines:y,slaebeBelob:N,extra:L,workers:[],totalHours:x},I=calculateTotals(T),C=I.timeprisUdenTillaeg,D=(I.samletAkkordsum,[]),B=[],M=[];m.forEach((e,t)=>{const a=toNumber(e.querySelector(".worker-hours")?.value);if(a<=0)return;const r=toNumber(e.querySelector(".worker-tillaeg")?.value),o=e.querySelector(".worker-udd"),s=o?.value||"",i=e.querySelector("legend")?.textContent?.trim()||`Mand ${t+1}`,l=e.querySelector(".worker-output");let d=C+r,u=0;"udd1"===s?(d+=42.98,u=42.98):"udd2"===s&&(d+=49.38,u=49.38);const c=d*a;l&&(l.textContent=`${d.toFixed(2)} kr/t | Total: ${c.toFixed(2)} kr`),D.push({name:i,hours:a,rate:d,total:c});const m=o?.selectedOptions?.[0]?.textContent?.trim()||"";B.push({id:t+1,name:i,type:n,hours:a,rate:d,baseRate:C,mentortillaeg:r,udd:s,uddLabel:m,uddannelsesTillaeg:u,total:c}),M.push({hours:a,hourlyWithAllowances:d})});const _=calculateTotals({...T,workers:M}),P=Number.isFinite(_.timeprisUdenTillaeg)?_.timeprisUdenTillaeg:0,F=P>0;lastJobSummary={totalHours:x,hourlyBase:F?P:0,hourlyUdd1:F?P+42.98:0,hourlyUdd2:F?P+49.38:0,hourlyUdd2Mentor:F?P+49.38+22.26:0,mentorRate:22.26};_.montoerLonMedTillaeg;const H=_.materialer+_.slaeb,O=_.projektsum,j=formatDateForDisplay(e.dato),R=document.getElementById("lonResult");if(R){R.innerHTML="";const t=document.createElement("div"),n=document.createElement("h3");n.textContent="Sagsinfo",t.appendChild(n);[{label:"Sagsnr.",value:e.sagsnummer||""},{label:"Navn",value:e.navn||""},{label:"Adresse",value:e.adresse||""},{label:"Dato",value:j}].forEach(({label:e,value:n})=>{const a=document.createElement("div"),r=document.createElement("strong");r.textContent=`${e}: `,a.appendChild(r);const o=document.createElement("span");o.textContent=n,a.appendChild(o),t.appendChild(a)}),R.appendChild(t);const a=document.createElement("h3");if(a.textContent="Materialer brugt:",R.appendChild(a),g.length>0)g.forEach(e=>{const t=document.createElement("div");t.textContent=`${e.label}: ${e.quantity} × ${e.unitPrice.toFixed(2)} kr = ${e.lineTotal.toFixed(2)} kr`,R.appendChild(t)});else{const e=document.createElement("div");e.textContent="Ingen materialer brugt",R.appendChild(e)}const r=document.createElement("h3");if(r.textContent="Arbejdere:",R.appendChild(r),D.length>0)D.forEach(e=>{const t=document.createElement("div");t.textContent=`${e.name}: Timer: ${e.hours}, Timeløn: ${e.rate.toFixed(2)} kr/t, Total: ${e.total.toFixed(2)} kr`,R.appendChild(t)});else{const e=document.createElement("div");e.textContent="Ingen timer registreret",R.appendChild(e)}const o=document.createElement("h3");o.textContent="Oversigt:",R.appendChild(o);[["Materialer",`${_.materialer.toFixed(2)} kr`],["Ekstraarbejde",`${_.ekstraarbejde.toFixed(2)} kr`],["Slæb",`${_.slaeb.toFixed(2)} kr`],["Samlet akkordsum",`${_.samletAkkordsum.toFixed(2)} kr`],["Timer",`${x.toFixed(1)} t`],["Timepris (uden tillæg)",`${_.timeprisUdenTillaeg.toFixed(2)} kr/t`],["Lønsum",`${_.montoerLonMedTillaeg.toFixed(2)} kr`],["Projektsum",`${O.toFixed(2)} kr`],["Materialesum (info)",`${H.toFixed(2)} kr`],["Kilometer (info)",`${A.toFixed(2)} kr`],["Tralleløft (info)",`${f.toFixed(2)} kr`]].forEach(([e,t])=>{const n=document.createElement("div"),a=document.createElement("strong");a.textContent=`${e}: `,n.appendChild(a);const r=document.createElement("span");r.textContent=t,n.appendChild(r),R.appendChild(n)})}return laborEntries=B,lastEkompletData={sagsinfo:e,jobType:n,montagepris:w,demontagepris:.5*w,systems:r,primarySystem:o,extras:{slaebePct:s,slaebeBelob:N,slaebeFormulaText:exportMeta.slaebFormulaText||"",boringHuller:{antal:i,pris:4.7,total:h},lukHuller:{antal:l,pris:3.45,total:k},boringBeton:{antal:d,pris:11.49,total:E},opskydeligtRaekvaerk:{antal:u,pris:9.67,total:v},kilometer:{antal:c,pris:2.12,total:A},traelleloeft:{antal35:p?.n35||0,pris35:10.44,total35:10.44*(p?.n35||0),antal50:p?.n50||0,pris50:14.62,total50:14.62*(p?.n50||0),total:f}},materialer:b,arbejdere:B,totals:{materialer:_.materialer,ekstraarbejde:_.ekstraarbejde,kilometerPris:A,slaebeBelob:_.slaeb,akkordsum:_.samletAkkordsum,timer:x,akkordTimeLon:_.timeprisUdenTillaeg,loensum:_.montoerLonMedTillaeg,projektsum:O,materialeSumInfo:H,traelleSum:f},traelle:{antal35:p?.n35||0,antal50:p?.n50||0,rate35:10.44,rate50:14.62,sum:f}},syncActiveJobState(),updateTotals(!0),syncExcelSystemSelector(),"undefined"!=typeof window&&(window.__cssmateLastEkompletData=lastEkompletData,window.__beregnLonCache={materialSum:lastMaterialSum,laborSum:lastLoensum,projectSum:lastMaterialSum+lastLoensum,traelleSum:f,timestamp:Date.now()}),showLonOutputSections(),persistProjectSnapshot(),t}function buildCSVPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=collectSagsinfo();e&&(n.sagsnummer=e);const a="undefined"!=typeof window?window.__beregnLonCache:null,r=getAllData().filter(e=>toNumber(e.quantity)>0),o=Array.isArray(laborEntries)?laborEntries:[],s=computeTraelleTotals(),i=s&&Number.isFinite(s.sum)?s.sum:0,l="demontage"===(document.getElementById("jobType")?.value||"montage")?.5:1,d=r.map(e=>({qty:toNumber(e.quantity),unitPrice:toNumber(e.price)*l})),u=calcMaterialesum()+i,c=toNumber(document.getElementById("slaebePct")?.value),m=u*(Number.isFinite(c)?c/100:0),p={"tralleløft":i,huller:4.7*toNumber(document.getElementById("antalBoringHuller")?.value),boring:11.49*toNumber(document.getElementById("antalBoringBeton")?.value),lukAfHul:3.45*toNumber(document.getElementById("antalLukHuller")?.value),opskydeligt:9.67*toNumber(document.getElementById("antalOpskydeligt")?.value),km:2.12*toNumber(document.getElementById("km")?.value),oevrige:0},f=o.map(e=>({hours:toNumber(e?.hours),hourlyWithAllowances:toNumber(e?.rate)})),y=f.reduce((e,t)=>e+(Number.isFinite(t.hours)?t.hours:0),0),g=calculateTotals({materialLines:d,slaebeBelob:m,extra:p,workers:f,totalHours:y}),b=a&&Number.isFinite(a.materialSum)?a.materialSum:g.materialer,S=g.ekstraarbejde,h=g.slaeb,k=a&&Number.isFinite(a.laborSum)?a.laborSum:g.montoerLonMedTillaeg,E=a&&Number.isFinite(a.projectSum)?a.projectSum:g.projektsum,v=[];v.push("Sektion;Felt;Værdi;Antal;Pris;Linjesum"),v.push(`Sagsinfo;Sagsnummer;${escapeCSV(n.sagsnummer)};;;`),v.push(`Sagsinfo;Navn/opgave;${escapeCSV(n.navn)};;;`),v.push(`Sagsinfo;Adresse;${escapeCSV(n.adresse)};;;`),v.push(`Sagsinfo;Kunde;${escapeCSV(n.kunde)};;;`),v.push(`Sagsinfo;Dato;${escapeCSV(n.dato)};;;`);const A=(n.montoer||"").replace(/\r?\n/g,", ");v.push(`Sagsinfo;Montørnavne;${escapeCSV(A)};;;`),v.push(""),v.push("Sektion;Id;Materiale;Antal;Pris;Linjesum"),0===r.length?v.push("Materiale;;;0;0,00;0,00"):r.forEach(e=>{const t=toNumber(e.quantity);if(0===t)return;const n=toNumber(e.price),a=t*n,r=manualMaterials.indexOf(e),o=e.manual?e.name?.trim()||`Manuelt materiale ${r+1}`:e.name;v.push(`Materiale;${escapeCSV(e.id)};${escapeCSV(o)};${escapeCSV(formatNumberForCSV(t))};${escapeCSV(formatNumberForCSV(n))};${escapeCSV(formatNumberForCSV(a))}`)});const w=window.__traelleloeft;if(w&&(w.n35>0||w.n50>0)){if(w.n35>0){const e=w.n35*w.RATE35;v.push(`Materiale;TL35;Tralleløft 0,35 m;${escapeCSV(formatNumberForCSV(w.n35))};${escapeCSV(formatNumberForCSV(w.RATE35))};${escapeCSV(formatNumberForCSV(e))}`)}if(w.n50>0){const e=w.n50*w.RATE50;v.push(`Materiale;TL50;Tralleløft 0,50 m;${escapeCSV(formatNumberForCSV(w.n50))};${escapeCSV(formatNumberForCSV(w.RATE50))};${escapeCSV(formatNumberForCSV(e))}`)}}v.push(""),v.push("Sektion;Arbejdstype;Timer;Sats;Linjesum"),0===o.length?v.push("Løn;Ingen registrering;;;"):o.forEach((e,t)=>{const n=toNumber(e.hours),a=toNumber(e.rate),r=n*a,o=e.type||`Arbejdstype ${t+1}`;v.push(`Løn;${escapeCSV(o)};${escapeCSV(formatNumberForCSV(n))};${escapeCSV(formatNumberForCSV(a))};${escapeCSV(formatNumberForCSV(r))}`)}),v.push(""),v.push("Sektion;Total;Beløb"),v.push(`Total;Materialesum;${escapeCSV(formatNumberForCSV(b))}`),S>0&&v.push(`Total;Ekstraarbejde;${escapeCSV(formatNumberForCSV(S))}`),h>0&&v.push(`Total;Slæb;${escapeCSV(formatNumberForCSV(h))}`),v.push(`Total;Lønsum;${escapeCSV(formatNumberForCSV(k))}`),v.push(`Total;Projektsum;${escapeCSV(formatNumberForCSV(E))}`);(exportMeta.slaebFormulaText||"").trim()&&v.push(`Noter;A9 slæb-formel;${escapeCSV(exportMeta.slaebFormulaText)}`);const N=v.join("\n"),L=sanitizeFilename(n.sagsnummer||"akkordseddel")||"akkordseddel";return{content:N,baseName:L,fileName:`${L}.csv`,originalName:n.sagsnummer}}adminLoginButton&&adminLoginButton.addEventListener("click",e=>{e.preventDefault(),login()});const AKKORD_JSON_VERSION=1;function buildAkkordJsonPayload(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=t?.data||buildAkkordData({customSagsnummer:e}),{info:a,materials:r,labor:o,jobType:s,jobFactor:i,extras:l,laborTotals:d,totalHours:u,totals:c}=n,m=sanitizeFilename(a.sagsnummer||"akkordseddel")||"akkordseddel",p=r.map(e=>{const t=toNumber(e.quantity),n=toNumber(e.price)*i;return{id:e.id,name:e.name,qty:t,unitPrice:n,lineTotal:t*n,system:inferSystemFromLine(e)||getPreferredExcelSystem()}}),f=toNumber(lastJobSummary?.hourlyBase??c.timeprisUdenTillaeg??c.hourlyBase),y={version:AKKORD_JSON_VERSION,type:s,jobId:a.sagsnummer||a.navn||a.adresse||m,jobName:a.navn||a.adresse||a.sagsnummer||"Akkordseddel",createdAt:(new Date).toISOString(),system:getPreferredExcelSystem(),systems:Array.from(selectedSystemKeys),materials:p,extras:l,wage:{montageHours:"montage"===s?u:0,demontageHours:"demontage"===s?u:0,numWorkers:d.length||workerCount||0,hourlyRate:f,educationLevel:d.find(e=>e.udd)?.udd||"",workers:o.map(e=>({type:e?.type||s,hours:toNumber(e?.hours),rate:toNumber(e?.rate),udd:e?.udd||"",mentortillaeg:toNumber(e?.mentortillaeg)})),totalAkkordSum:c.samletAkkordsum},totals:{materialsSum:c.materialer,extrasSum:c.ekstraarbejde,haulSum:c.slaeb,projectSum:c.projektsum}};return{content:JSON.stringify(y,null,2),baseName:m,fileName:`${m}.json`,data:y}}async function exportPDFBlob(e,t={}){if(!t?.skipValidation&&!validateSagsinfo())return updateActionHint("Udfyld Sagsinfo for at eksportere.","error"),null;t?.skipBeregn||beregnLon();const n=t?.data||buildAkkordData({customSagsnummer:e}),{info:a,materials:r,labor:o,extras:s,tralleState:i,tralleSum:l,slaebePctInput:d,slaebeBelob:u,laborTotals:c,totalHours:m,totals:p,cache:f,extraInputs:y}=n,g=f&&Number.isFinite(f.materialSum)?f.materialSum:p.materialer,b=p.ekstraarbejde,S=(p.slaeb,f&&Number.isFinite(f.laborSum)?f.laborSum:p.montoerLonMedTillaeg),h=f&&Number.isFinite(f.projectSum)?f.projectSum:p.projektsum,k=document.createElement("div");k.className="export-preview",k.style.position="fixed",k.style.left="-9999px",k.style.top="0",k.style.background="#ffffff",k.style.color="#000000",k.style.padding="24px",k.style.width="794px",k.style.boxSizing="border-box";const E=c.filter(e=>Number.isFinite(e.hours)&&e.hours>0).length,v=e=>new Intl.NumberFormat("da-DK",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e||0);const A=y.boringHuller,w=y.lukHuller,N=y.boringBeton,L=y.opskydeligt,x=y.km,T=[{id:"materials",label:"1. Materialer",format:"currency",value:g},{id:"extraWork",label:"2. Ekstra arbejde",format:"currency",value:b},{id:"extra-sled",label:"   Slæb",format:"currency",value:u,subtle:!0,info:{type:"percent",percent:d}},{id:"extra-km",label:"   Kilometer",format:"currency",value:s.km,subtle:!0,info:{type:"qtyPrice",qty:x,unitPrice:2.12,unitLabel:"km"}},{id:"extra-holes",label:"   Boring af huller",format:"currency",value:s.huller,subtle:!0,info:{type:"qtyPrice",qty:A,unitPrice:4.7}},{id:"extra-close-hole",label:"   Luk af hul",format:"currency",value:s.lukAfHul,subtle:!0,info:{type:"qtyPrice",qty:w,unitPrice:3.45}},{id:"extra-concrete",label:"   Boring i beton",format:"currency",value:s.boring,subtle:!0,info:{type:"qtyPrice",qty:N,unitPrice:11.49}},{id:"extra-folding-rail",label:"   Opslåeligt rækværk",format:"currency",value:s.opskydeligt,subtle:!0,info:{type:"qtyPrice",qty:L,unitPrice:9.67}},{id:"extra-trolley",label:"   Tralleløft",format:"currency",value:l,subtle:!0,info:{type:"trolley",qty:(i?.n35||0)+(i?.n50||0),entries:[{qty:i?.n35||0,unitPrice:10.44},{qty:i?.n50||0,unitPrice:14.62}]}},{id:"accordSum",label:"3. Samlet akkordsum",format:"currency",value:p.samletAkkordsum,emphasize:!0},{id:"hours",label:"4. Timer",format:"hours",value:m},{id:"team",label:"5. Medarbejdere & timer",format:"team",value:{workersCount:E,hours:m}}].map(e=>{const t=["review-row"];return e.subtle&&t.push("review-row--subtle"),e.emphasize&&t.push("review-row--emphasize"),`<div class="${t.join(" ")}"><span>${e.label}</span><strong>${function(e){switch(e.format){case"currency":{const t=`${formatCurrency(e.value)} kr`;if(!e.info)return t;let n="";return"percent"===e.info.type?n=`${formatNumber(e.info.percent)} %`:"qtyPrice"===e.info.type?n=`${e.info.unitLabel?`${formatNumber(e.info.qty)} ${e.info.unitLabel}`:formatNumber(e.info.qty)} × ${formatCurrency(e.info.unitPrice)} kr`:"trolley"===e.info.type&&(n=[e.info.qty?`${formatNumber(e.info.qty)} løft`:"",Array.isArray(e.info.entries)?e.info.entries.filter(e=>e&&Number(e.qty)>0).map(e=>`${formatNumber(e.qty)} × ${formatCurrency(e.unitPrice)} kr`).join(" · "):""].filter(Boolean).join(" · ")),n?`${t} (${n})`:t}case"hours":return`${v(e.value)} t`;case"team":{const t=Number(e.value?.workersCount)||0,n=v(e.value?.hours||0);return t?`${1===t?"1 medarbejder":`${t} medarbejdere`} · ${n} t`:`${n} t`}default:return""}}(e)}</strong></div>`}).join(""),I=(exportMeta.slaebFormulaText||"").trim()?`<p class="a9-formula-note"><strong>A9 slæb-formel:</strong> ${escapeHtml(exportMeta.slaebFormulaText).replace(/\n/g,"<br>")}</p>`:"";k.innerHTML=`\n    <style>\n      .export-preview { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }\n      .export-preview h2 { margin-top: 0; }\n      .export-preview section { margin-bottom: 16px; }\n      .export-preview ul { list-style: none; padding: 0; margin: 0; }\n      .export-preview ul li { margin-bottom: 6px; }\n      .export-preview table { width: 100%; border-collapse: collapse; margin-top: 8px; }\n      .export-preview th, .export-preview td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; font-size: 14px; }\n      .export-preview th { background: #f0f0f0; }\n      .export-preview .review-grid { display: flex; flex-direction: column; gap: 6px; }\n      .export-preview .review-row { display: flex; justify-content: space-between; gap: 12px; font-size: 14px; }\n      .export-preview .review-row--subtle { color: #4f4f4f; font-size: 13px; }\n      .export-preview .review-row--emphasize { font-weight: 600; }\n      .export-preview .review-row span { flex: 1; }\n      .export-preview .review-row strong { white-space: pre-wrap; text-align: right; }\n      .export-preview .a9-formula-note { margin-top: 10px; font-size: 13px; color: #1f2937; }\n      .export-preview .a9-formula-note strong { margin-right: 6px; }\n      .export-preview .totals { display: flex; gap: 12px; flex-wrap: wrap; }\n      .export-preview .totals div { background: #f7f7f7; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; }\n    </style>\n    <h2>Akkordseddel</h2>\n    <section>\n      <h3>Sagsinfo</h3>\n      <ul>\n        <li><strong>Sagsnummer:</strong> ${escapeHtml(a.sagsnummer)}</li>\n        <li><strong>Navn/opgave:</strong> ${escapeHtml(a.navn)}</li>\n        <li><strong>Adresse:</strong> ${escapeHtml(a.adresse)}</li>\n        <li><strong>Kunde:</strong> ${escapeHtml(a.kunde)}</li>\n        <li><strong>Dato:</strong> ${escapeHtml(a.dato)}</li>\n        <li><strong>Montørnavne:</strong> ${escapeHtml(a.montoer).replace(/\n/g,"<br>")}</li>\n      </ul>\n    </section>\n    <section>\n      <h3>Materialer</h3>\n      ${r.length?`\n        <table class="export-table">\n          <thead>\n            <tr><th>Id</th><th>Materiale</th><th>Antal</th><th>Pris</th><th>Linjesum</th></tr>\n          </thead>\n          <tbody>\n            ${r.map(e=>{const t=toNumber(e.quantity),n=toNumber(e.price),a=t*n,r=manualMaterials.indexOf(e),o=e.manual?e.name?.trim()||`Manuelt materiale ${r+1}`:e.name;return`<tr><td>${escapeHtml(e.id)}</td><td>${escapeHtml(o)}</td><td>${t.toLocaleString("da-DK",{maximumFractionDigits:2})}</td><td>${formatCurrency(n)} kr</td><td>${formatCurrency(a)} kr</td></tr>`}).join("")}\n          </tbody>\n        </table>\n      `:"<p>Ingen materialer registreret.</p>"}\n    </section>\n    <section>\n      <h3>Løn</h3>\n      ${o.length?`\n        <table class="export-table">\n          <thead>\n            <tr><th>Arbejdstype</th><th>Timer</th><th>Sats</th><th>Linjesum</th></tr>\n          </thead>\n          <tbody>\n            ${o.map((e,t)=>{const n=toNumber(e.hours),a=toNumber(e.rate),r=n*a;return`<tr><td>${escapeHtml(e.type||`Arbejdstype ${t+1}`)}</td><td>${n.toLocaleString("da-DK",{maximumFractionDigits:2})}</td><td>${formatCurrency(a)} kr</td><td>${formatCurrency(r)} kr</td></tr>`}).join("")}\n          </tbody>\n        </table>\n      `:"<p>Ingen lønlinjer registreret.</p>"}\n    </section>\n    <section>\n      <h3>Oversigt</h3>\n      <div class="review-grid">\n        ${T}\n      </div>\n      ${I}\n    </section>\n    <section>\n      <h3>Løn & projektsum</h3>\n      <div class="totals">\n        <div><strong>Lønsum</strong><div>${formatCurrency(S)} kr</div></div>\n        <div><strong>Projektsum</strong><div>${formatCurrency(h)} kr</div></div>\n      </div>\n    </section>\n    <section>\n      <h3>Detaljer</h3>\n      ${document.getElementById("lonResult")?.innerHTML||"<p>Ingen beregning udført.</p>"}\n    </section>\n  `,document.body.appendChild(k);try{const{jsPDF:e,html2canvas:n}=await ensureExportLibs(),r=await n(k,{scale:2,backgroundColor:"#ffffff"}),o=new e({unit:"px",format:[r.width,r.height]});o.addImage(r.toDataURL("image/png"),"PNG",0,0,r.width,r.height);const s=sanitizeFilename(t.baseName||a.sagsnummer||"akkordseddel");return{blob:o.output("blob"),baseName:s,fileName:`${s}.pdf`}}catch(e){return console.error("PDF eksport fejlede:",e),updateActionHint("PDF eksport fejlede. Prøv igen.","error"),null}finally{document.body.removeChild(k)}}async function exportPDF(e,t={}){const n=await exportPDFBlob(e,t);if(!n)return;const a=URL.createObjectURL(n.blob),r=document.createElement("a");r.href=a,r.download=n.fileName,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),updateActionHint("PDF er gemt til din enhed.","success")}async function exportZip(){if(validateSagsinfo())try{const{JSZip:e}=await ensureZipLib();beregnLon();const t=buildCSVPayload(null,{skipValidation:!0,skipBeregn:!0});if(!t)return;const n=buildAkkordData({customSagsnummer:t.originalName||t.baseName}),a=await exportPDFBlob(t.originalName||t.baseName,{skipValidation:!0,skipBeregn:!0,data:n});if(!a)return;const r=buildAkkordJsonPayload(t.originalName||t.baseName,{skipValidation:!0,skipBeregn:!0,data:n}),o=new e;o.file(t.fileName,t.content),o.file(a.fileName,a.blob),r&&o.file(r.fileName,r.content);const s=await o.generateAsync({type:"blob"}),i=URL.createObjectURL(s),l=document.createElement("a"),d=r?.baseName||t.baseName||a.baseName||"akkordseddel";l.href=i,l.download=`${d}.zip`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(i),updateActionHint("ZIP med PDF og CSV er gemt.","success")}catch(e){console.error("ZIP eksport fejlede",e),updateActionHint("ZIP eksport fejlede. Prøv igen.","error")}else updateActionHint("Udfyld Sagsinfo for at eksportere.","error")}function exportAkkordJsonFile(){const e=buildAkkordJsonPayload();if(!e)return;triggerBlobDownload(new Blob([e.content],{type:"application/json"}),e.fileName),updateActionHint("Akkordseddel (JSON) er gemt.","success")}function importJSONProject(e){const t=new FileReader;t.onload=e=>{try{const t=e.target?.result,n=JSON.parse(t);if(!n||"object"!=typeof n)throw new Error("Ugyldigt JSON format");const a=n.data&&!n.sagsinfo?n.data:n;applyProjectSnapshot(normalizeImportedJsonSnapshot(a),{skipHint:!0}),updateActionHint("JSON sag er indlæst.","success")}catch(e){console.error("Kunne ikke importere JSON",e),updateActionHint("Kunne ikke importere JSON-filen.","error")}},t.onerror=()=>{updateActionHint("Kunne ikke læse filen.","error")},t.readAsText(e,"utf-8")}function uploadCSV(e){if(!e)return;if(!(/\.csv$/i.test(e.name)||e.type&&e.type.includes("csv")))return void updateActionHint("Vælg en gyldig CSV-fil for at importere.","error");const t=new FileReader;t.onload=e=>{try{applyCSVRows(parseCSV(e.target.result)),updateActionHint("CSV er importeret.","success")}catch(e){console.error("Kunne ikke importere CSV",e),updateActionHint("Kunne ikke importere CSV-filen.","error")}},t.readAsText(e,"utf-8")}function setupMobileKeyboardDismissal(){document.addEventListener("keydown",e=>{if("Enter"!==e.key)return;const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.type?.toLowerCase?.()||"",a=t.inputMode?.toLowerCase?.()||"";"number"!==n&&"numeric"!==a&&"decimal"!==a||(e.preventDefault(),t.blur())}),document.addEventListener("change",e=>{const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.type?.toLowerCase?.()||"",a=t.inputMode?.toLowerCase?.()||"";"number"!==n&&"numeric"!==a&&"decimal"!==a||"function"==typeof t.blur&&t.blur()})}function setupServiceWorkerMessaging(){if(!("serviceWorker"in navigator))return;let e=!1;navigator.serviceWorker.addEventListener("message",e=>{const t=e.data?.type;"CSMATE_UPDATED"!==t&&"SSCaff_NEW_VERSION"!==t||window.location.reload()}),navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(e=!0,window.location.reload())})}function setupPWAInstallPrompt(){if("undefined"==typeof window)return;const e=document.getElementById("installBtn"),t=document.getElementById("iosInstallPrompt"),n=document.getElementById("iosInstallDismiss");if(!e&&!t)return;const a="function"==typeof window.matchMedia?window.matchMedia("(display-mode: standalone)"):null,r=()=>(a?.matches??!1)||!0===navigator.standalone;let o=!1;const s=()=>{e&&(e.setAttribute("hidden",""),e.disabled=!1,e.removeAttribute("title"))},i=()=>{e&&(o&&!r()?(e&&(e.removeAttribute("hidden"),e.disabled=!1,e.removeAttribute("title")),getDeferredInstallPromptEvent()?(e.disabled=!1,e.removeAttribute("title")):(e.disabled=!0,e.title=INSTALL_BUTTON_DISABLED_TOOLTIP)):s())},l=(e=!1)=>{if(t&&t.setAttribute("hidden",""),e)try{window.localStorage?.setItem(IOS_INSTALL_PROMPT_DISMISSED_KEY,"1")}catch(e){console.warn("Kunne ikke gemme iOS prompt flag",e)}},d=()=>{if(!t)return;const e=navigator.userAgent||"",n=/iphone|ipad|ipod/i.test(e),r=/safari/i.test(e)&&!/(crios|fxios|edgios)/i.test(e),o=(a?.matches??!1)||!0===navigator.standalone;n&&r&&!o&&!(()=>{try{return"1"===window.localStorage?.getItem(IOS_INSTALL_PROMPT_DISMISSED_KEY)}catch(e){return console.warn("Kunne ikke læse iOS prompt flag",e),!1}})()?t.removeAttribute("hidden"):t.setAttribute("hidden","")};(()=>{if(!("serviceWorker"in navigator)||!navigator.serviceWorker?.ready)return o=!0,void i();navigator.serviceWorker.ready.then(()=>{o=!0,i(),r()&&l(!0)}).catch(e=>{o=!0,i(),console.warn("Service worker blev ikke klar i tide til install-knappen",e)})})(),window.addEventListener(PWA_INSTALL_AVAILABLE_EVENT,()=>{i()}),window.addEventListener(PWA_INSTALL_CONSUMED_EVENT,()=>{i()}),e?.addEventListener("click",async()=>{const t=consumeDeferredInstallPromptEvent();if(t){e.disabled=!0,t.prompt();try{await t.userChoice}catch(e){console.warn("Install prompt failed",e)}finally{s()}}}),window.addEventListener("appinstalled",()=>{s(),l(!0)}),a?.addEventListener&&a.addEventListener("change",e=>{e.matches?(s(),l(!0)):(i(),d())}),n?.addEventListener("click",()=>{l(!0)}),t?.addEventListener("keydown",e=>{"Escape"===e.key&&l(!0)}),d(),i(),t&&t.addEventListener("click",e=>{e.target===t&&l(!0)})}async function hardResetApp(){if(navigator.serviceWorker){const e=await navigator.serviceWorker.getRegistrations();await Promise.all(e.map(e=>e.unregister()))}if(window.caches){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}if(window.indexedDB){const e=await(indexedDB.databases?.())||[];await Promise.all(e.map(e=>new Promise(t=>{if(!e?.name)return void t();const n=indexedDB.deleteDatabase(e.name);n.onsuccess=n.onerror=n.onblocked=()=>t()})))}try{window.localStorage?.clear()}catch{}try{window.sessionStorage?.clear()}catch{}window.location.reload(!0)}let appInitialized=!1;async function initApp(){if(appInitialized)return;appInitialized=!0;try{await ensureMaterialDatasets()}catch(e){console.error("Kunne ikke indlæse materialelisterne.",e),updateActionHint("Kunne ikke indlæse materialelisterne. Prøv at genindlæse siden.","error")}initTabs();const e=getDomElement("optaellingContainer");e&&(e.addEventListener("input",handleOptaellingInput),e.addEventListener("change",handleOptaellingInput)),addWorker(),setupGuideModal(),setupAdminControls(),setupA9Integration(),document.getElementById("btnBeregnLon")?.addEventListener("click",()=>beregnLon()),document.getElementById("btnPrint")?.addEventListener("click",()=>{validateSagsinfo()?window.print():updateActionHint("Udfyld Sagsinfo for at kunne printe.","error")}),document.getElementById("btnAddWorker")?.addEventListener("click",()=>addWorker());const t=getDomElement("jobHistorySelect"),n=getDomElement("btnLoadHistoryJob");t&&t.addEventListener("change",e=>{updateHistorySummaryFromSelect();const t=Boolean(e?.target?.value);n&&(n.disabled=!t)}),n?.addEventListener("click",()=>handleLoadCase()),["traelleloeft35","traelleloeft50"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",()=>updateTotals()),t.addEventListener("change",()=>updateTotals(!0)))}),sagsinfoFieldIds.forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",()=>validateSagsinfo()),t.addEventListener("change",()=>validateSagsinfo()))}),validateSagsinfo(),setupNumpad(),setupMobileKeyboardDismissal(),setupServiceWorkerMessaging(),setupPWAInstallPrompt(),document.getElementById("btnHardResetApp")?.addEventListener("click",()=>{hardResetApp()});const a=document.getElementById("calendarIcon");a&&a.addEventListener("click",()=>{const e=document.getElementById("sagsdato");e&&("function"==typeof e.showPicker?e.showPicker():(e.focus(),"function"==typeof e.click&&e.click()))}),ensureMaterialDatasets().then(()=>{setupListSelectors(),renderOptaelling(),setupCSVImport(),populateRecentCases(),initExportButtons(),updateTotals(!0)}).catch(e=>{console.error("Materialelister kunne ikke indlæses",e),updateActionHint("Kunne ikke indlæse materialelisterne. Opdater siden for at prøve igen.","error")})}function startApp(){initApp().catch(e=>{console.error("CSMate init fejlede",e),updateActionHint("Kunne ikke initialisere appen. Opdater siden for at prøve igen.","error")})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",startApp,{once:!0}):startApp();