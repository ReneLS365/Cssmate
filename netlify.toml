# Netlify config (optimized, stable)
# Key fixes:
# - Lighthouse audits "/" to avoid occasional /index.html 404
# - SPA fallback redirect keeps client routing working
# - Build/publish points to the staged output ".netlify_publish"

[functions]
  included_files = [
    "migrations/*.sql",
    "migrations/**/*.sql",
    "netlify/functions/migrations/*.sql",
    "netlify/functions/migrations/**/*.sql",
    "netlify/functions/_shared/migrations/*.sql"
  ]
  [functions.emails]
    included_files = ["./emails/**"]

[build]
  command = "npm run build"
  publish = ".netlify_publish"

  [build.environment]
    NODE_VERSION = "22"

[[plugins]]
  package = "netlify-plugin-a11y"
  [plugins.inputs]
    checkPaths = []
    resultMode = "warn"

[[plugins]]
  package = "@netlify/plugin-lighthouse"
  [plugins.inputs]
    [[plugins.inputs.audits]]
      path = "/"

[[plugins]]
  package = "netlify-plugin-no-more-404"
  [plugins.inputs]
    on404 = "warn"

[[headers]]
  for = "/reset"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/reset.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/service-worker.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/manifest.webmanifest"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/js/*"
  [headers.values]
    Cache-Control = "public, max-age=3600, stale-while-revalidate=86400"

[[headers]]
  for = "/css/*"
  [headers.values]
    Cache-Control = "public, max-age=3600, stale-while-revalidate=86400"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=3600, stale-while-revalidate=86400"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=3600, stale-while-revalidate=86400"

[[redirects]]
  from = "/admin"
  to = "/admin.html"
  status = 200

[[redirects]]
  from = "/reset"
  to = "/reset.html"
  status = 200

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200

[[redirects]]
  from = "//*"
  to = "/:splat"
  status = 301
  force = true

# SPA fallback
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[context.deploy-preview]
  command = "npm run build"
  publish = ".netlify_publish"

[context.branch-deploy]
  command = "npm run build"
  publish = ".netlify_publish"

[context.production.functions]
  included_files = [
    "migrations/*.sql",
    "migrations/**/*.sql",
    "netlify/functions/migrations/*.sql",
    "netlify/functions/migrations/**/*.sql",
    "netlify/functions/_shared/migrations/*.sql"
  ]
  [context.production.functions.emails]
    included_files = ["./emails/**"]

[context.main.functions]
  included_files = [
    "migrations/*.sql",
    "migrations/**/*.sql",
    "netlify/functions/migrations/*.sql",
    "netlify/functions/migrations/**/*.sql",
    "netlify/functions/_shared/migrations/*.sql"
  ]
  [context.main.functions.emails]
    included_files = ["./emails/**"]
