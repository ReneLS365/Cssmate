import { writeFileSync } from 'node:fs'

const targetPath = 'js/firebase-env.js'

const required = ['VITE_FIREBASE_API_KEY', 'VITE_FIREBASE_AUTH_DOMAIN', 'VITE_FIREBASE_PROJECT_ID', 'VITE_FIREBASE_APP_ID']
const optional = ['VITE_FIREBASE_STORAGE_BUCKET', 'VITE_FIREBASE_MESSAGING_SENDER_ID', 'VITE_FIREBASE_MEASUREMENT_ID']

const missing = required.filter((name) => !process.env[name])

if (missing.length) {
  console.warn(`[firebase-env] Missing environment variables: ${missing.join(', ')}`)
}

const keyMap = {
  VITE_FIREBASE_API_KEY: 'apiKey',
  VITE_FIREBASE_AUTH_DOMAIN: 'authDomain',
  VITE_FIREBASE_PROJECT_ID: 'projectId',
  VITE_FIREBASE_APP_ID: 'appId',
  VITE_FIREBASE_STORAGE_BUCKET: 'storageBucket',
  VITE_FIREBASE_MESSAGING_SENDER_ID: 'messagingSenderId',
  VITE_FIREBASE_MEASUREMENT_ID: 'measurementId',
}

const config = {}
Object.entries(keyMap).forEach(([envKey, targetKey]) => {
  if (process.env[envKey]) {
    config[targetKey] = process.env[envKey]
  }
})

const providers = (process.env.VITE_FIREBASE_AUTH_PROVIDERS || 'google')
  .split(',')
  .map((entry) => entry.trim())
  .filter(Boolean)

const payload = `// Auto-generated by scripts/generate-firebase-config.js
// Do not edit this file manually; values are injected from Netlify/CI env vars.
window.FIREBASE_CONFIG = ${JSON.stringify(config, null, 2)};
window.FIREBASE_AUTH_PROVIDERS = ${JSON.stringify(providers, null, 2)};
`

writeFileSync(targetPath, payload, 'utf8')
console.log(`[firebase-env] Wrote Firebase config to ${targetPath}`)
