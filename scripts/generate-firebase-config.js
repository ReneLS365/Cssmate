import { writeFileSync } from 'node:fs'

const targetPath = 'js/firebase-env.js'

const appCheckEnvKey = 'VITE_FIREBASE_RECAPTCHA_V3_SITE_KEY'
const deprecatedAppCheckEnvKey = 'VITE_FIREBASE_APP_CHECK_SITE_KEY'
const appCheckEnabledEnvKey = 'VITE_APP_CHECK_ENABLED'
const adminEmailsEnvKey = 'VITE_ADMIN_EMAILS'
const authAllowedHostsEnvKey = 'VITE_FIREBASE_AUTH_ALLOWED_HOSTS'
const defaultAdminEmails = ['mr.lion1995@gmail.com']

if (!process.env[appCheckEnvKey]) {
  console.warn('[firebase-env] Missing environment variable VITE_FIREBASE_RECAPTCHA_V3_SITE_KEY. App Check will be disabled unless the key is set.')
}

const providers = (process.env.VITE_FIREBASE_AUTH_PROVIDERS || 'google')
  .split(',')
  .map((entry) => entry.trim())
  .filter(Boolean)

const appCheckSiteKey = process.env[appCheckEnvKey] || process.env[deprecatedAppCheckEnvKey] || ''
const appCheckEnabledRaw = process.env[appCheckEnabledEnvKey]
const appCheckEnabled = typeof appCheckEnabledRaw === 'string' ? appCheckEnabledRaw : 'true'
const adminEmails = (process.env[adminEmailsEnvKey] || '')
  .split(',')
  .map((entry) => entry.trim().toLowerCase())
  .filter(Boolean)
const resolvedAdminEmails = adminEmails.length ? adminEmails : defaultAdminEmails
const authAllowedHosts = (process.env[authAllowedHostsEnvKey] || '')
  .split(',')
  .map((entry) => entry.trim())
  .filter(Boolean)

const payload = `// Auto-generated by scripts/generate-firebase-config.js
// Do not edit this file manually; values are injected from Netlify/CI env vars.
window.FIREBASE_AUTH_PROVIDERS = ${JSON.stringify(providers, null, 2)};
window.FIREBASE_RECAPTCHA_V3_SITE_KEY = ${JSON.stringify(appCheckSiteKey)};
window.FIREBASE_APP_CHECK_SITE_KEY = ${JSON.stringify(appCheckSiteKey)}; // Backwards compatibility
window.FIREBASE_APP_CHECK_ENABLED = ${JSON.stringify(appCheckEnabled)};
window.SHARED_ADMIN_EMAILS = ${JSON.stringify(resolvedAdminEmails, null, 2)};
window.FIREBASE_AUTH_ALLOWED_HOSTS = ${JSON.stringify(authAllowedHosts.join(','))};
`

writeFileSync(targetPath, payload, 'utf8')
console.log(`[firebase-env] Wrote Firebase config to ${targetPath}`)
