import { writeFileSync } from 'node:fs'

const targetPath = 'js/firebase-env.js'

const firebaseEnvKeyMap = {
  apiKey: 'VITE_FIREBASE_API_KEY',
  authDomain: 'VITE_FIREBASE_AUTH_DOMAIN',
  projectId: 'VITE_FIREBASE_PROJECT_ID',
  appId: 'VITE_FIREBASE_APP_ID',
  storageBucket: 'VITE_FIREBASE_STORAGE_BUCKET',
  messagingSenderId: 'VITE_FIREBASE_MESSAGING_SENDER_ID',
  measurementId: 'VITE_FIREBASE_MEASUREMENT_ID'
}
const requiredFirebaseKeys = ['apiKey', 'authDomain', 'projectId', 'appId']
const skipFirebaseConfigCheckEnvKey = 'CSSMATE_SKIP_FIREBASE_ENV_CHECK'

const appCheckEnvKey = 'VITE_FIREBASE_RECAPTCHA_V3_SITE_KEY'
const deprecatedAppCheckEnvKey = 'VITE_FIREBASE_APP_CHECK_SITE_KEY'
const appCheckEnabledEnvKey = 'VITE_APP_CHECK_ENABLED'
const adminEmailsEnvKey = 'VITE_ADMIN_EMAILS'
const authAllowedHostsEnvKey = 'VITE_FIREBASE_AUTH_ALLOWED_HOSTS'
const defaultAdminEmails = ['mr.lion1995@gmail.com']

if (!process.env[appCheckEnvKey]) {
  console.warn('[firebase-env] Missing environment variable VITE_FIREBASE_RECAPTCHA_V3_SITE_KEY. App Check will be disabled unless the key is set.')
}

const providers = (process.env.VITE_FIREBASE_AUTH_PROVIDERS || 'google')
  .split(',')
  .map((entry) => entry.trim())
  .filter(Boolean)

const firebaseConfigValues = Object.fromEntries(
  Object.entries(firebaseEnvKeyMap).map(([configKey, envKey]) => {
    const rawValue = process.env[envKey]
    const trimmedValue = typeof rawValue === 'string' ? rawValue.trim() : ''
    return [configKey, trimmedValue]
  })
)
const missingFirebaseEnvKeys = requiredFirebaseKeys
  .filter((configKey) => !firebaseConfigValues[configKey])
  .map((configKey) => firebaseEnvKeyMap[configKey])
if (missingFirebaseEnvKeys.length && process.env[skipFirebaseConfigCheckEnvKey] !== '1') {
  console.error(`[firebase-env] Missing required Firebase env vars: ${missingFirebaseEnvKeys.join(', ')}`)
  console.error(`[firebase-env] Set ${skipFirebaseConfigCheckEnvKey}=1 to bypass this check (not recommended).`)
  process.exit(1)
}

const firebaseConfig = Object.fromEntries(
  Object.entries(firebaseConfigValues).filter(([, value]) => value)
)

const appCheckSiteKey = process.env[appCheckEnvKey] || process.env[deprecatedAppCheckEnvKey] || ''
const appCheckEnabledRaw = process.env[appCheckEnabledEnvKey]
const appCheckEnabled = typeof appCheckEnabledRaw === 'string' ? appCheckEnabledRaw : 'true'
const adminEmails = (process.env[adminEmailsEnvKey] || '')
  .split(',')
  .map((entry) => entry.trim().toLowerCase())
  .filter(Boolean)
const resolvedAdminEmails = adminEmails.length ? adminEmails : defaultAdminEmails
const authAllowedHosts = (process.env[authAllowedHostsEnvKey] || '')
  .split(',')
  .map((entry) => entry.trim())
  .filter(Boolean)

const payload = `// Auto-generated by scripts/generate-firebase-config.js
// Do not edit this file manually; values are injected from Netlify/CI env vars.
window.FIREBASE_CONFIG = ${JSON.stringify(firebaseConfig, null, 2)};
window.FIREBASE_CONFIG_SOURCE = "netlify-env";
window.FIREBASE_AUTH_PROVIDERS = ${JSON.stringify(providers, null, 2)};
window.FIREBASE_RECAPTCHA_V3_SITE_KEY = ${JSON.stringify(appCheckSiteKey)};
window.FIREBASE_APP_CHECK_SITE_KEY = ${JSON.stringify(appCheckSiteKey)}; // Backwards compatibility
window.FIREBASE_APP_CHECK_ENABLED = ${JSON.stringify(appCheckEnabled)};
window.SHARED_ADMIN_EMAILS = ${JSON.stringify(resolvedAdminEmails, null, 2)};
window.FIREBASE_AUTH_ALLOWED_HOSTS = ${JSON.stringify(authAllowedHosts.join(','))};
`

writeFileSync(targetPath, payload, 'utf8')
console.log(`[firebase-env] Wrote Firebase config to ${targetPath}`)
