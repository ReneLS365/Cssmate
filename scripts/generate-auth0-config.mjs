#!/usr/bin/env node
import fs from 'node:fs'
import path from 'node:path'

const ROOT = process.cwd()
const OUT_FILE = path.join(ROOT, 'auth0-config.js')

function readEnv(key) {
  const value = process.env[key]
  if (value == null) return ''
  const normalized = String(value).trim()
  return normalized
}

const config = {
  VITE_AUTH0_DOMAIN: readEnv('VITE_AUTH0_DOMAIN'),
  VITE_AUTH0_CLIENT_ID: readEnv('VITE_AUTH0_CLIENT_ID'),
  VITE_AUTH0_AUDIENCE: readEnv('VITE_AUTH0_AUDIENCE'),
  VITE_ADMIN_EMAIL: readEnv('VITE_ADMIN_EMAIL'),
  VITE_ADMIN_EMAILS: readEnv('VITE_ADMIN_EMAILS'),
  VITE_AUTH0_REDIRECT_URI: readEnv('VITE_AUTH0_REDIRECT_URI'),
  VITE_E2E_BYPASS_AUTH: readEnv('VITE_E2E_BYPASS_AUTH'),
}

const isProduction = process.env.NODE_ENV === 'production' || process.env.CONTEXT === 'production'
if (config.VITE_E2E_BYPASS_AUTH && isProduction) {
  throw new Error('VITE_E2E_BYPASS_AUTH must not be set for production builds.')
}

const contents = `// Auto-generated by scripts/generate-auth0-config.mjs
(function () {
  const config = ${JSON.stringify(config, null, 2)}
  if (typeof window !== 'undefined') {
    window.__ENV__ = Object.assign({}, window.__ENV__ || {}, config)
    Object.assign(window, config)
  }
})()
`

fs.writeFileSync(OUT_FILE, contents, 'utf8')
console.log(`[auth0-config] wrote ${path.relative(ROOT, OUT_FILE)}`)
